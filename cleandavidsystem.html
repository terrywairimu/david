<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%);
            --tertiary-gradient: linear-gradient(135deg, #3f3f42 20%,  #37058f48 10%, #000000 70%);
            --background-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --quad-gradient: linear-gradient(135deg, #3b82f6 30%, #2dd4bf 60%);
            --card-bg: rgba(255, 255, 255, 0.829);
            --glass-bg: rgba(0, 0, 0, 0);
            --sidebar-bg: rgba(31, 41, 55, 0.95);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #e7e5d8;
            --text-primary-light: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-image: url('https://img.freepik.com/free-vector/white-minimal-hexagons-background_79603-1452.jpg?t=st=1738523537~exp=1738527137~hmac=3fbcf7240de7da982ebc9206f2a13fe728553b9eb22c9415c78d13a658b2ee88&w=740');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
        }

        .sidebar {
            background: var(--tertiary-gradient);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: white;
            height: 100vh;
            padding: 2rem 1.5rem;
            transition: all 0.3s;
            border-radius: 0 24px 24px 0;
            position: relative;
            top: 0;
        }

        .sidebar h3 {
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.7);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .sidebar .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar .nav-link:hover::before {
            opacity: 1;
        }

        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background: var(--glass-bg);
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            background: var(--primary-gradient);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .sidebar .nav-link i {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 1rem;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover i, .sidebar .nav-link.active i {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .sidebar .nav-link span {
            font-size: 0.95rem;
        }

        .content {
            padding: 1rem;
            background-color: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
        }

        /* Base Card Styles */
        .card {
            background: transparent;
            border: none;
            overflow: visible;
        }

        .card-body {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.05);
        }

        .card > .card-header {
            background: var(--tertiary-gradient);
            color: white;
            border: none;
            padding: 1.1rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
            border-radius: 24px !important;
            margin-bottom: 1.1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card > .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            z-index: -1;
            pointer-events: none;
            border-radius: 24px;
        }

        #clientCards .client-stats {
            background: rgba(255, 255, 255, 0);
            backdrop-filter: blur(2px);
            padding: 0.2rem;
            border-radius: 16px;
            margin-bottom: 0.6rem;
        }

        #clientCards .client-stats .label {
            color: rgb(0, 0, 0);
            font-size: 1.0rem;
            font-weight: 400;
        }

        #clientCards .client-stats .value {
            color: rgb(0, 0, 0);
            font-size: 1.0rem;
            font-weight: 500;
        }

        #clientCards .buttons-container {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
            padding: 0;
            margin: 0;
        }

        #clientCards .btn-glass {
            padding: 0.55rem 0.5rem;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
            border-radius: 16px;
            background: linear-gradient(135deg, #6365f131 30%, #8a5cf636 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgb(0, 0, 0);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
            cursor: pointer;
            min-width: 0;
            white-space: nowrap;
        }

        #clientCards .btn-glass:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #clientCards .btn-glass i {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        #clientCards .btn-glass:hover i {
            transform: scale(1.1);
        }

        .btn-primary {
            background: var(--tertiary-gradient);
            border: none;
            border-radius: 16px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .btn-add {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 12px 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.3);
        }

        .btn-delete {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .table {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
        }

        .table th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
            font-weight: 600;
            border: none;
            padding: 12px;
        }

        .table td {
            border-color: rgba(99, 102, 241, 0.1);
            padding: 12px;
            vertical-align: middle;
        }

        input[type="text"], input[type="number"], select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            padding: 10px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        .analytics-container {
            padding: 0rem !important;
        }

        .chart-container {
            position: relative !important;
            height: 400px !important;
            padding: 0rem !important;
            border-radius: 16px !important;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 1rem;
        }

        canvas {
            padding: 0rem !important;
            margin: 0rem !important;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            background: var(--tertiary-gradient);
            color: rgb(255, 255, 255);
            border-bottom: none;
            border-radius: 24px 24px 0 0;
        }

        .modal-footer {
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }

        .form-label {
            color: var(--text-tertiary);
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .status-paid {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .status-cancelled {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        @media (max-width: 768px) {
            .sidebar {
                padding: 1.5rem 1rem;
            }

            .sidebar .nav-link {
                padding: 0.75rem 1rem;
            }

            .sidebar .nav-link i {
                margin-right: 10px;
                padding: 0.75rem;
            }

            #clientCards .buttons-container {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            #clientCards .btn-glass {
                width: 100%;
                padding: 0.75rem;
                font-size: 0.9rem;
                gap: 8px;
            }

            #clientCards .btn-glass i {
                font-size: 1rem;
            }
        }

        .sales-summary-card {
            border: none;
            border-radius: 24px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .sales-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .sales-summary-card .card-body {
            padding: 1.5rem;
        }

        .sales-summary-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sales-summary-card .icon-box i {
            font-size: 1.5rem;
            color: white;
        }

        .sales-summary-card.total-sales {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .sales-summary-card.today-sales {
            background: linear-gradient(135deg, #56f178 0%, #328346 100%) !important;
        }

        .sales-summary-card.items-sold {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .sales-summary-card.avg-sale {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .sales-summary-card h6 {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .sales-summary-card h2 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        #salesTable tbody tr {
            transition: all 0.2s ease;
        }

        #salesTable tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
            transform: translateX(5px);
        }

        .export-btn {
            padding: 0.6rem;
            border: none;
            background: var(--tertiary-gradient);
            color: white;
            font-weight: 500;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .action-btn i {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        #purchaseFilter {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1rem;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        #purchaseFilter:hover {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%234b5563' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        #purchaseFilter:focus {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233b82f6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }

        /* Stock Section Styles */
        .stock-summary-card {
            border: none;
            border-radius: 24px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .stock-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stock-summary-card .card-body {
            padding: 1.5rem;
        }

        .stock-summary-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stock-summary-card .icon-box i {
            font-size: 1.5rem;
            color: white;
        }

        .stock-summary-card.total-items {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .stock-summary-card.in-stock {
            background: linear-gradient(135deg, #00ff37 0%, #328a32 100%);
        }

        .stock-summary-card.low-stock {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stock-summary-card.out-of-stock {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .stock-summary-card h6 {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .stock-summary-card h2 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .stock-summary-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stock-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .stock-summary-card.active {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .stock-summary-card.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
        }

        #stockSearch::placeholder {
            color: #9ca3af;
        }

        #stockTable tbody tr {
            transition: all 0.2s ease;
        }

        #stockTable tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
            transform: translateX(5px);
        }

        .stock-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .stock-status-in {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .stock-status-low {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }

        .stock-status-out {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }

        .summary-card {
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .summary-card .card-body {
            padding: 1.5rem;
        }

        .summary-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .summary-card .icon-box i {
            font-size: 1.5rem;
            color: white;
        }

        .revenue-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }

        .expenses-card {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .profit-card {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .gross-profit-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .table-card {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        /* Client Cards Styling */
        #clientCards .card {
            border-radius: 24px;
            transition: all 0.3s ease;
        }

        #clientCards .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        #clientCards .card-body {
            padding: 0.5rem;
        }

        #clientCards .client-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        #clientCards .client-title h5 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        #clientCards .client-title .client-location {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-primary);
        }

        #clientCards .client-stats {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(8px);
            padding: 1.2rem;
            border-radius: 16px;   
        }

        #clientCards .client-stats .d-flex {
            margin-bottom: 1rem;
        }

        #clientCards .client-stats .d-flex:last-child {
            margin-bottom: 0;
        }

        #clientCards .client-stats .label {
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
        }

        #clientCards .client-stats .value {
            font-size: 0.95rem;
            font-weight: 600;
        }

        #clientCards .client-stats .text-success { color: #10b981 !important; }
        #clientCards .client-stats .text-warning { color: #f59e0b !important; }
        #clientCards .client-stats .text-danger { color: #ef4444 !important; }
        #clientCards .client-stats .text-info { color: #3b82f6 !important; }

        #clientCards .buttons-container {
            display: flex;
            justify-content: space-between;
            gap: 0.8rem;
            padding: 0;
            margin: 0;
        }

        #clientCards .btn-glass {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            font-weight: 500;
            letter-spacing: 0.3px;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex: 1;
            cursor: pointer;
            min-width: 0;
            white-space: nowrap;
        }

        #clientCards .btn-glass:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        #clientCards .btn-glass i {
            font-size: 1rem;
            transition: transform 0.3s ease;
        }

        #clientCards .btn-glass:hover i {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            #clientCards .card-body {
                padding: 1.2rem;
            }

            #clientCards .client-stats {
                padding: 1rem;
            }

            #clientCards .buttons-container {
                flex-direction: column;
                gap: 0.6rem;
            }
            
            #clientCards .btn-glass {
                width: 100%;
                padding: 0.7rem;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <h3>
                    <i class="fas fa-chart-line me-2"></i>
                    Dashboard
                </h3>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-section="clientCards">
                        <i class="fas fa-users"></i>
                        <span>Clients</span>
                    </a>
                    <a class="nav-link" href="#" data-section="quotationsSection">
                        <i class="fas fa-file-invoice-dollar"></i>
                        <span>Quotations</span>
                    </a>
                    <a class="nav-link" href="#" data-section="expensesSection">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Expenses</span>
                    </a>
                    <a class="nav-link" href="#" data-section="paymentsSection">
                        <i class="fas fa-money-bill-alt"></i>
                        <span>Payments</span>
                    </a>
                    <a class="nav-link" href="#" data-section="salesSection">
                        <i class="fas fa-cart-shopping"></i>
                        <span>Sales</span>
                    </a>
                    <a class="nav-link" href="#" data-section="purchasesSection">
                        <i class="fas fa-shopping-basket"></i>
                        <span>Purchases</span>
                    </a>
                    <a class="nav-link" href="#" data-section="stockSection">
                        <i class="fas fa-boxes"></i>
                        <span>Stock</span>
                    </a>
                    <a class="nav-link" href="#" data-section="reportsSection">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </a>
                    <a class="nav-link" href="#" data-section="reportingSection">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </a>
                    <a class="nav-link" href="#">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </nav>
                <div class="mt-auto text-center text-white-50 small py-3">
                    <p class="mb-0">© 2025 Client Management</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-10 content">
                <!-- Client Cards Section -->
                <div id="clientCards" class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Client Management</h2>
                            <button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newClientModal">
                                <i class="fas fa-user-plus me-2"></i>
                                Add New Client
                            </button>
                        </div>
                    </div>
                    <div class="row g-4" id="clientCardsContainer">
                        <!-- Client cards will be dynamically added here -->
                    </div>
                </div>

                <!-- Add these sections after the clientCards section in the main content area -->
                <div id="quotationsSection" class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="mb-0">Client Quotations</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="quotationsTable" class="table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Unit</th>
                                        <th>Quantity</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn-add mt-3" onclick="addRow('quotationsTable')">
                            <i class="fas fa-plus"></i>
                            Add Row
                        </button>
                    </div>
                </div>

                <div id="expensesSection" class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="mb-0">Expenses</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="expensesTable" class="table">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Unit</th>
                                        <th>Quantity</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                        <th>Account</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <button class="btn-add mt-3" onclick="addRow('expensesTable')">
                            <i class="fas fa-plus"></i>
                            Add Row
                        </button>
                    </div>
                </div>

                <div id="paymentsSection" class="card" style="display: none;">
                    <div class="card-header">
                        <h2>Client Payments</h2>
                    </div>
                    <div class="card-body">
                        <form id="paymentForm">
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <label for="clientSelect" class="form-label text-dark">Client</label>
                                    <select id="clientSelect" class="form-select" required>
                                        <!-- Options will be populated dynamically -->
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="paymentAmount" class="form-label text-dark">Amount Paid (KES)</label>
                                    <input type="number" id="paymentAmount" class="form-control" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="paymentDate" class="form-label text-dark">Date Paid</label>
                                    <input type="date" id="paymentDate" class="form-control" required>
                                </div>
                                <div class="col-md-3">
                                    <label for="paymentAccount" class="form-label text-dark">Account Credited</label>
                                    <select id="paymentAccount" class="form-select" required>
                                        <option value="bank">Bank</option>
                                        <option value="david">David</option>
                                        <option value="kim">Kim</option>
                                    </select>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-add">Add Payment</button>
                        </form>

                        <div class="mt-4">
                            <h3>Account Summaries</h3>
                            <div class="row" id="accountSummaries">
                                <!-- Account summaries will be populated dynamically -->
                            </div>
                        </div>

                        <div class="mt-4">
                            <h3>Payment History</h3>
                            <div class="table-responsive">
                                <table id="paymentHistoryTable" class="table">
                                    <thead>
                                        <tr>
                                            <th>Client</th>
                                            <th>Amount (KES)</th>
                                            <th>Date</th>
                                            <th>Account</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Payment history will be populated dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add this after the payments section -->
                <div id="salesSection" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Sales Management</h2>
                            <button type="button" class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newSaleModal">
                                <i class="fas fa-cart-shopping"></i>
                                Add New Sale
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Sales Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card sales-summary-card total-sales">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Total Sales</h6>
                                                <h2 class="mb-0 text-white" id="totalSalesAmount">KES 0.00</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-shopping-cart"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card sales-summary-card today-sales">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Today's Sales</h6>
                                                <h2 class="mb-0 text-white" id="todaySalesAmount">KES 0.00</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card sales-summary-card items-sold">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Items Sold</h6>
                                                <h2 class="mb-0 text-white" id="totalItemsSold">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-box"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card sales-summary-card avg-sale">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Average Sale</h6>
                                                <h2 class="mb-0 text-white" id="averageSaleAmount">KES 0.00</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 py-2" id="salesSearch" 
                                        placeholder="Search sales..." oninput="filterSales()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="clientFilter" onchange="filterSales()">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="salesDateFilter" onchange="handleDateFilter('sales')">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                </select>
                                <input type="date" id="salesSpecificDate" class="form-control border-0 py-2 shadow-sm mt-2" 
                                    style="display: none;" onchange="filterSales()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportSalesReport()">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Sales Table -->
                        <div class="table-responsive">
                            <table class="table" id="salesTable">
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Items</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Sales data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Add this after the sales section -->
                <div id="purchasesSection" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Purchase Management</h2>
                            <button type="button" class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newPurchaseModal">
                                <i class="fas fa-shopping-basket"></i>
                                Add New Purchase
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Purchase Summary Cards -->
                        <div class="row mb-4">
                            <!-- Total Purchases Amount -->
                            <div class="col-md-3">
                                <div class="card sales-summary-card" style="background: var(--primary-gradient);">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Total Purchases</h6>
                                                <h2 class="mb-0 text-white" id="totalPurchasesAmount">KES 0.00</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-shopping-basket"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Number of Purchase Orders -->
                            <div class="col-md-3">
                                <div class="card sales-summary-card" style="background: var(--secondary-gradient);">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Purchase Orders</h6>
                                                <h2 class="mb-0 text-white" id="totalPurchaseOrders">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-file-invoice"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Average Purchase Value -->
                            <div class="col-md-3">
                                <div class="card sales-summary-card" style="background: var(--primary-gradient);">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Average Purchase</h6>
                                                <h2 class="mb-0 text-white" id="avgPurchaseValue">KES 0.00</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-calculator"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Monthly Purchase Trend -->
                            <div class="col-md-3">
                                <div class="card sales-summary-card" style="background: var(--secondary-gradient);">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Monthly Trend</h6>
                                                <h2 class="mb-0 text-white" id="monthlyPurchaseTrend">
                                                    <span id="trendPercentage">0%</span>
                                                    <i class="fas fa-arrow-up ms-2" id="trendIcon"></i>
                                                </h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions Bar -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 py-2" id="purchaseSearch" 
                                        placeholder="Search purchases..." oninput="filterPurchases()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="supplierFilter" onchange="filterPurchases()">
                                    <option value="">All Suppliers</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="purchasesDateFilter" onchange="handleDateFilter('purchases')">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                </select>
                                <input type="date" id="purchasesSpecificDate" class="form-control border-0 py-2 shadow-sm mt-2" 
                                    style="display: none;" onchange="filterPurchases()">
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportPurchaseReport()">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Purchases Table -->
                        <div class="table-responsive">
                            <table class="table" id="purchasesTable">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Items</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Purchase data will be dynamically added here -->
                                </tbody>
                            </table>
                            <div id="purchaseTotal" class="mt-3 text-end fw-bold">Total: KES 0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Stock Section -->
                <div id="stockSection" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Stock Management</h2>
                            <button type="button" class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newStockModal">
                                <i class="fas fa-boxes"></i>
                                Add New Item
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Stock Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card stock-summary-card total-items" onclick="filterByCard('all')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Total Items</h6>
                                                <h2 class="mb-0 text-white" id="totalItems">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-boxes"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stock-summary-card in-stock" onclick="filterByCard('inStock')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">In Stock</h6>
                                                <h2 class="mb-0 text-white" id="inStock">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stock-summary-card low-stock" onclick="filterByCard('lowStock')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Low Stock</h6>
                                                <h2 class="mb-0 text-white" id="lowStock">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stock-summary-card out-of-stock" onclick="filterByCard('outOfStock')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Out of Stock</h6>
                                                <h2 class="mb-0 text-white" id="outOfStock">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-times-circle"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 py-2" id="stockSearch" 
                                        placeholder="Search items..." oninput="filterStock()">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="categoryFilter" onchange="filterStock()">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="stockStatusFilter" onchange="filterStock()">
                                    <option value="">All Status</option>
                                    <option value="in">In Stock</option>
                                    <option value="low">Low Stock</option>
                                    <option value="out">Out of Stock</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportStockReport()">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Stock Table -->
                        <div class="table-responsive">
                            <table class="table" id="stockTable">
                                <thead>
                                    <tr>
                                        <th>Item Code</th>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total Value</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Stock items will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- New Stock Item Modal -->
                <div class="modal fade" id="newStockModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add New Stock Item</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="newStockForm">
                                    <div class="mb-3">
                                        <label for="itemCode" class="form-label">Item Code</label>
                                        <input type="text" class="form-control" id="itemCode" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label for="itemName" class="form-label">Item Name</label>
                                        <input type="text" class="form-control" id="itemName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="itemCategory" class="form-label">Category</label>
                                        <select class="form-select" id="itemCategory" required>
                                            <option value="">Select Category</option>
                                            <option value="wood">Wood</option>
                                            <option value="hardware">Hardware</option>
                                            <option value="tools">Tools</option>
                                            <option value="finishes">Finishes</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="itemQuantity" class="form-label">Initial Quantity</label>
                                        <input type="number" class="form-control" id="itemQuantity" min="0" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="itemMinStock" class="form-label">Minimum Stock Level</label>
                                        <input type="number" class="form-control" id="itemMinStock" min="0" required>
                                    </div>
                                    <div class="mb-3">
                                        <label for="itemPrice" class="form-label">Unit Price (KES)</label>
                                        <input type="number" class="form-control" id="itemPrice" min="0" step="0.01" required>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveStockItem()">Save Item</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add this before the closing div of the main content area -->
                <div id="reportingSection" class="card" style="display: none;">
                    <div class="card-header">
                        <h2 class="mb-0">Financial Analytics</h2>
                    </div>
                    <div class="card-body analytics-container">
                        <!-- Summary Cards -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <div class="card summary-card revenue-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-2">Total Revenue</h6>
                                                <h3 class="text-white mb-0" id="totalRevenue">KES 0.00</h3>
                                                <div class="mt-2">
                                                    <small class="text-white-50" id="revenueGrowth">+0% vs last month</small>
                                                </div>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-dollar-sign"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card summary-card expenses-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-2">Total Expenses</h6>
                                                <h3 class="text-white mb-0" id="totalExpenses">KES 0.00</h3>
                                                <div class="mt-2">
                                                    <small class="text-white-50" id="expensesGrowth">+0% vs last month</small>
                                                </div>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-money-bill-wave"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card summary-card profit-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-2">Net Profit</h6>
                                                <h3 class="text-white mb-0" id="netProfit">KES 0.00</h3>
                                                <div class="mt-2">
                                                    <small class="text-white-50" id="profitGrowth">+0% vs last month</small>
                                                </div>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-chart-pie"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card summary-card gross-profit-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-2">Gross Profit</h6>
                                                <h3 class="text-white mb-0" id="grossProfit">KES 0.00</h3>
                                                <div class="mt-2">
                                                    <small class="text-white-50" id="grossProfitMargin">0% margin</small>
                                                </div>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-chart-line"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Charts -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <canvas id="revenueExpenseChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container">
                                    <canvas id="profitMarginChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="chart-container">
                                    <canvas id="monthlyTrendsChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="chart-container">
                                    <canvas id="expenseBreakdownChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Additional Financial Charts -->
                        <div class="row g-3 mt-4">
                            <div class="col-md-6">
                                <div class="chart-container" style="position: relative; height: 400px; background: var(--glass-bg); padding: 1.5rem; border-radius: 16px;">
                                    <canvas id="overallFinancials"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="chart-container" style="position: relative; height: 400px; background: var(--glass-bg); padding: 1.5rem; border-radius: 16px;">
                                    <canvas id="clientComparison"></canvas>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="chart-container" style="position: relative; height: 400px; background: var(--glass-bg); padding: 1.5rem; border-radius: 16px;">
                                    <canvas id="monthlyTrends"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- New Client Modal -->
    <div class="modal fade" id="newClientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newClientForm">
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Client Name</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="clientLocation" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="saveNewClient">Save Client</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Sale Modal -->
    <div class="modal fade" id="newSaleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newSaleForm">
                        <!-- Client Information -->
                        <div class="mb-4">
                            <label class="form-label">Client Information</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <select class="form-select" id="saleClientSelect" required>
                                        <option value="">Select Client</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="saleInvoiceNumber" 
                                        placeholder="Invoice Number" required readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Items Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label mb-0">Items</label>
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSaleItem()">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                            <div id="saleItemsContainer">
                                <!-- Items will be added here dynamically -->
                            </div>
                        </div>

                        <!-- Totals -->
                        <div class="row">
                            <div class="col-md-6 offset-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>Subtotal:</span>
                                            <span id="saleSubtotal">KES 0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <span>VAT (16%):</span>
                                            <span id="saleVat">KES 0.00</span>
                                        </div>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <span>Total:</span>
                                            <span id="saleTotal">KES 0.00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSale()">Save Sale</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Purchase Modal -->
    <div class="modal fade" id="newPurchaseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Purchase</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newPurchaseForm">
                        <!-- Supplier Information -->
                        <div class="mb-4">
                            <label class="form-label">Supplier Information</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="purchaseSupplier" placeholder="Supplier Name" required>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" class="form-control" id="purchaseOrderNumber" 
                                        placeholder="Order Number" required readonly>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table" id="purchaseItemsTable">
                                <thead>
                                    <tr>
                                        <th>Item</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Items will be added here -->
                                </tbody>
                            </table>
                            <div id="purchaseTotal" class="mt-3 text-end fw-bold">Total: KES 0.00</div>
                        </div>
                        <button type="button" class="btn btn-add mt-3" onclick="addPurchaseItem()">
                            <i class="fas fa-plus"></i> Add Item
                        </button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="savePurchase()">Save Purchase</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        // Global variables
        let clients = [];
        let payments = [];
        let sales = [];
        let stockItems = [];
        let purchases = [];

        // Load initial data
        function loadClients() {
            const storedClients = localStorage.getItem('clients');
            if (storedClients) {
                clients = JSON.parse(storedClients);
            } else {
                clients = [
                    { id: 1, name: "Acme Corp", location: "New York", quotationAmount: 10000, paidAmount: 5000, expenses: 2000, quotations: [], expenseItems: [] },
                    { id: 2, name: "Globex", location: "London", quotationAmount: 15000, paidAmount: 10000, expenses: 3000, quotations: [], expenseItems: [] },
                ];
                saveClients();
            }
            loadPayments();
            loadSales();
            loadPurchases();
            renderClientCards();
        }

        // Save clients to localStorage
        function saveClients() {
            localStorage.setItem('clients', JSON.stringify(clients));
        }

        // Create client card
        function createClientCard(client) {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-4'; // Changed from g-3 to mb-4 for better spacing
            card.innerHTML = `
                <div class="card h-100">
                    <div class="card-body">
                        <div class="client-title mt-0 mb-3">
                            <h5><i class="fas fa-user ms-1 me-2"></i>${client.name}</h5>
                            <div class="client-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${client.location}
                            </div>
                        </div>
                        <div class="client-stats">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="label">Quotation Amount</span>
                                <span class="value">KES ${client.quotationAmount.toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="label">Paid Amount</span>
                                <span class="value text-success">KES ${client.paidAmount.toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="label">Balance</span>
                                <span class="value text-warning">KES ${(client.quotationAmount - client.paidAmount).toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="label">Expenses</span>
                                <span class="value text-danger">KES ${client.expenses.toFixed(2)}</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="label">Profit</span>
                                <span class="value text-info">KES ${(client.paidAmount - client.expenses).toFixed(2)}</span>
                            </div>
                        </div>
                        <div class="buttons-container mt-3">
                            <button class="btn-glass" onclick="manageQuotation(${client.id})">
                                <i class="fas fa-file-invoice"></i>
                                <span>Quotation</span>
                            </button>
                            <button class="btn-glass" onclick="manageExpenses(${client.id})">
                                <i class="fas fa-money-bill-wave"></i>
                                <span>Expenses</span>
                            </button>
                            <button class="btn-glass" onclick="managePayments(${client.id})">
                                <i class="fas fa-money-bill-alt"></i>
                                <span>Payments</span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('clientCardsContainer').appendChild(card);
        }

        // Render all client cards
        function renderClientCards() {
            const clientCardsContainer = document.getElementById('clientCardsContainer');
            if (!clientCardsContainer) {
                console.error('Client cards container not found');
                return;
            }
            clientCardsContainer.innerHTML = '';
            clientCardsContainer.className = 'row g-4'; // Add proper grid class
            [...clients].reverse().forEach(client => createClientCard(client));
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            loadClients();
            
            // New client form submission
            document.getElementById('saveNewClient').addEventListener('click', function() {
                const name = document.getElementById('clientName').value;
                const location = document.getElementById('clientLocation').value;
                
                if (name && location) {
                    const newClient = {
                        id: clients.length + 1,
                        name: name,
                        location: location,
                        quotationAmount: 0,
                        paidAmount: 0,
                        expenses: 0,
                        quotations: [],
                        expenseItems: []
                    };
                    
                    clients.unshift(newClient);
                    saveClients();
                    renderClientCards();
                    
                    document.getElementById('newClientForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('newClientModal')).hide();
                }
            });

            // Initialize Bootstrap components
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content > div').forEach(div => {
                div.style.display = 'none';
            });
            
            // Show selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                
                // If showing purchases section, reload the data
                if (sectionId === 'purchasesSection') {
                    loadPurchases();
                }
            }
            
            // Update active state in sidebar
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                }
            });
        }

        // Add click handlers for navigation
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section');
                if (sectionId) {
                    showSection(sectionId);
                }
            });
        });

        // Load payments from localStorage
        function loadPayments() {
            const storedPayments = localStorage.getItem('payments');
            if (storedPayments) {
                payments = JSON.parse(storedPayments);
            }
            populateClientSelect();
            renderPaymentHistory();
            updateAccountSummaries();
        }

        // Save payments to localStorage
        function savePayments() {
            localStorage.setItem('payments', JSON.stringify(payments));
        }

        // Populate client select dropdown
        function populateClientSelect() {
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = '<option value="">Select a client</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
        }

        // Add new payment
        function addPayment(event) {
            event.preventDefault();
            const clientId = parseInt(document.getElementById('clientSelect').value);
            const amount = parseFloat(document.getElementById('paymentAmount').value);
            const date = document.getElementById('paymentDate').value;
            const account = document.getElementById('paymentAccount').value;

            if (!clientId || !amount || !date || !account) {
                alert('Please fill in all fields');
                return;
            }

            const payment = {
                id: payments.length + 1,
                clientId: clientId,
                amount: amount,
                date: date,
                account: account
            };

            payments.push(payment);
            savePayments();

            const client = clients.find(c => c.id === clientId);
            if (client) {
                client.paidAmount += amount;
                saveClients();
                renderClientCards();
            }

            renderPaymentHistory();
            updateAccountSummaries();
            document.getElementById('paymentForm').reset();
        }

        // Render payment history
        function renderPaymentHistory(clientId = null) {
            const tbody = document.getElementById('paymentHistoryTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            const filteredPayments = clientId 
                ? payments.filter(payment => payment.clientId === parseInt(clientId))
                : payments;

            filteredPayments.forEach(payment => {
                const client = clients.find(c => c.id === payment.clientId);
                if (client) {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${client.name}</td>
                        <td>KES ${payment.amount.toFixed(2)}</td>
                        <td>${payment.date}</td>
                        <td>${payment.account}</td>
                    `;
                }
            });
        }

        // Update account summaries
        function updateAccountSummaries(clientId = null) {
            const accountSummaries = {
                bank: { total: 0, payments: [] },
                david: { total: 0, payments: [] },
                kim: { total: 0, payments: [] }
            };

            const filteredPayments = clientId 
                ? payments.filter(payment => payment.clientId === parseInt(clientId))
                : payments;

            filteredPayments.forEach(payment => {
                accountSummaries[payment.account].total += payment.amount;
                accountSummaries[payment.account].payments.push({
                    date: payment.date,
                    amount: payment.amount
                });
            });

            const summariesContainer = document.getElementById('accountSummaries');
            summariesContainer.innerHTML = '';

            for (const [account, data] of Object.entries(accountSummaries)) {
                const col = document.createElement('div');
                col.className = 'col-md-4 mb-3';
                
                let paymentsHtml = '';
                data.payments.sort((a, b) => new Date(b.date) - new Date(a.date))
                    .forEach(payment => {
                        paymentsHtml += `
                            <div class="mb-2">
                                <div class="d-flex justify-content-between">
                                    <span>${payment.date}</span>
                                    <span>KES ${payment.amount.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    });

                col.innerHTML = `
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">${account.charAt(0).toUpperCase() + account.slice(1)}</h5>
                            <div class="payment-breakdown">
                                ${paymentsHtml}
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Total:</strong>
                                <strong>KES ${data.total.toFixed(2)}</strong>
                            </div>
                        </div>
                    </div>
                `;
                summariesContainer.appendChild(col);
            }
        }

        // Manage quotations
        function manageQuotation(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const quotationSection = document.getElementById('quotationsSection');
            quotationSection.querySelector('.card-header h2').textContent = `${client.name}'s Quotation`;
            
            showSection('quotationsSection');
            const tbody = document.getElementById('quotationsTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            if (client.quotations && client.quotations.length > 0) {
                client.quotations.forEach(item => addRow('quotationsTable', item));
            } else {
                addRow('quotationsTable');
            }

            document.getElementById('quotationsTable').dataset.clientId = clientId;
        }

        // Manage expenses
        function manageExpenses(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const expensesSection = document.getElementById('expensesSection');
            expensesSection.querySelector('.card-header h2').textContent = `${client.name}'s Expenses`;
            
            showSection('expensesSection');
            const tbody = document.getElementById('expensesTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            if (client.expenseItems && client.expenseItems.length > 0) {
                client.expenseItems.forEach(item => addRow('expensesTable', item));
            } else {
                addRow('expensesTable');
            }

            document.getElementById('expensesTable').dataset.clientId = clientId;
        }

        // Manage payments
        function managePayments(clientId) {
            const client = clients.find(c => c.id === clientId);
            if (!client) return;

            const paymentsSection = document.getElementById('paymentsSection');
            paymentsSection.querySelector('.card-header h2').textContent = `${client.name}'s Payments`;
            
            showSection('paymentsSection');
            document.getElementById('clientSelect').value = clientId;
            renderPaymentHistory(clientId);
            updateAccountSummaries(clientId);
        }

        // Add row to table
        function addRow(tableId, item = {}) {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            const totalRow = tbody.querySelector('.total-row');
            const newRow = tbody.insertRow(totalRow ? totalRow.rowIndex - 1 : -1);
            const isExpenseTable = tableId === 'expensesTable';

            newRow.innerHTML = `
                <td><input type="text" class="form-control description" value="${item.description || ''}" onchange="updateAmount(this)"></td>
                <td><input type="text" class="form-control unit" value="${item.unit || ''}" onchange="updateAmount(this)"></td>
                <td><input type="number" class="form-control quantity" value="${item.quantity || ''}" onchange="updateAmount(this)"></td>
                <td><input type="number" class="form-control rate" value="${item.rate || ''}" onchange="updateAmount(this)"></td>
                <td class="amount">${item.amount || '0.00'}</td>
                ${isExpenseTable ? `
                <td>
                    <select class="form-control account">
                        <option value="david" ${item.account === 'david' ? 'selected' : ''}>David</option>
                        <option value="kim" ${item.account === 'kim' ? 'selected' : ''}>Kim</option>
                        <option value="bank" ${item.account === 'bank' ? 'selected' : ''}>Bank</option>
                    </select>
                </td>` : ''}
                <td>
                    <button class="btn-delete" onclick="deleteRow(this)">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;

            if (!totalRow) {
                const newTotalRow = tbody.insertRow(-1);
                newTotalRow.className = 'total-row';
                const colSpan = isExpenseTable ? 4 : 4;
                newTotalRow.innerHTML = `
                    <td colspan="${colSpan}" class="text-end"><strong>Total Amount:</strong></td>
                    <td class="total-amount">KES <span id="${tableId === 'quotationsTable' ? 'quotationTotal' : 'expenseTotal'}">0.00</span></td>
                    <td${isExpenseTable ? ' colspan="2"' : ''}></td>
                `;
            }

            updateTotal(tableId);
        }

        // Delete row from table
        function deleteRow(btn) {
            const row = btn.closest('tr');
            if (!row.classList.contains('total-row')) {
                const tableId = row.closest('table').id;
                row.remove();
                updateTotal(tableId);
            }
        }

        // Update amount in row
        function updateAmount(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const rate = parseFloat(row.querySelector('.rate').value) || 0;
            const amount = quantity * rate;
            row.querySelector('.amount').textContent = amount.toFixed(2);

            const table = row.closest('table');
            const tableId = table.id;
            const clientId = parseInt(table.dataset.clientId);
            updateTotal(tableId);

            if (clientId) {
                const client = clients.find(c => c.id === clientId);
                if (client) {
                    const items = [];
                    table.querySelectorAll('tbody tr:not(.total-row)').forEach(row => {
                        const item = {
                            description: row.querySelector('.description').value,
                            unit: row.querySelector('.unit').value,
                            quantity: parseFloat(row.querySelector('.quantity').value) || 0,
                            rate: parseFloat(row.querySelector('.rate').value) || 0,
                            amount: parseFloat(row.querySelector('.amount').textContent) || 0
                        };
                        if (tableId === 'expensesTable') {
                            item.account = row.querySelector('.account').value;
                        }
                        items.push(item);
                    });

                    if (tableId === 'quotationsTable') {
                        client.quotations = items;
                        client.quotationAmount = items.reduce((sum, item) => sum + item.amount, 0);
                    } else if (tableId === 'expensesTable') {
                        client.expenseItems = items;
                        client.expenses = items.reduce((sum, item) => sum + item.amount, 0);
                    }

                    saveClients();
                    renderClientCards();
                }
            }
        }

        // Update total in table
        function updateTotal(tableId) {
            const table = document.getElementById(tableId);
            const amounts = table.querySelectorAll('.amount');
            let total = 0;

            amounts.forEach(amount => {
                if (!amount.closest('tr').classList.contains('total-row')) {
                    total += parseFloat(amount.textContent) || 0;
                }
            });

            const totalElement = document.getElementById(tableId === 'quotationsTable' ? 'quotationTotal' : 'expenseTotal');
            if (totalElement) {
                totalElement.textContent = total.toFixed(2);
            }
        }

        // Add event listener for payment form
        document.getElementById('paymentForm').addEventListener('submit', addPayment);

        // Load sales from localStorage
        function loadSales() {
            const storedSales = localStorage.getItem('sales');
            if (storedSales) {
                sales = JSON.parse(storedSales);
            }
            loadStockItems();
            updateSalesSummary();
            loadSalesTable();
        }

        // Load stock items
        function loadStockItems() {
            const storedStock = localStorage.getItem('stockItems');
            if (storedStock) {
                try {
                    stockItems = JSON.parse(storedStock);
                    if (!Array.isArray(stockItems)) {
                        console.error('Stored stock items is not an array');
                        stockItems = [];
                    }
                    // Ensure all items have required properties
                    stockItems = stockItems.map(item => ({
                        code: item.code || generateItemCode(),
                        name: item.name || 'Unknown Item',
                        category: item.category || 'Uncategorized',
                        quantity: item.quantity || 0,
                        minStock: item.minStock || 0,
                        price: item.price || 0
                    }));
                } catch (error) {
                    console.error('Error parsing stock items:', error);
                    stockItems = [];
                }
            } else {
                // Initialize with sample data if empty
                stockItems = [
                    {
                        code: generateItemCode(),
                        name: "Mahogany Wood",
                        category: "wood",
                        quantity: 50,
                        minStock: 10,
                        price: 1000
                    }
                ];
                saveStockItems();
            }
            updateStockStatistics();
            loadStockTable();
            populateCategoryFilter();
        }

        function saveStockItems() {
            localStorage.setItem('stockItems', JSON.stringify(stockItems));
        }

        function updateStockStatistics() {
            const totalItems = stockItems.length;
            const inStockCount = stockItems.filter(item => item.quantity > item.minStock).length;
            const lowStockCount = stockItems.filter(item => item.quantity > 0 && item.quantity <= item.minStock).length;
            const outOfStockCount = stockItems.filter(item => item.quantity === 0).length;

            document.getElementById('totalItems').textContent = totalItems;
            document.getElementById('inStock').textContent = inStockCount;
            document.getElementById('lowStock').textContent = lowStockCount;
            document.getElementById('outOfStock').textContent = outOfStockCount;

            // Remove active class from all cards
            document.querySelectorAll('.stock-summary-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        // Load stock table
        function loadStockTable(filter = 'all') {
            const tbody = document.getElementById('stockTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.error('Stock table tbody not found');
                return;
            }
            tbody.innerHTML = '';

            let filteredItems = [...stockItems];

            // Apply card filter
            switch(filter) {
                case 'inStock':
                    filteredItems = stockItems.filter(item => item && item.quantity > (item.minStock || 0));
                    break;
                case 'lowStock':
                    filteredItems = stockItems.filter(item => item && item.quantity > 0 && item.quantity <= (item.minStock || 0));
                    break;
                case 'outOfStock':
                    filteredItems = stockItems.filter(item => item && item.quantity === 0);
                    break;
            }

            filteredItems.forEach(item => {
                if (!item) return;
                
                const row = tbody.insertRow();
                const totalValue = (item.quantity || 0) * (item.price || 0);
                let status;
                let statusClass;

                if (!item.quantity || item.quantity === 0) {
                    status = 'Out of Stock';
                    statusClass = 'stock-status-out';
                } else if (item.quantity <= (item.minStock || 0)) {
                    status = 'Low Stock';
                    statusClass = 'stock-status-low';
                } else {
                    status = 'In Stock';
                    statusClass = 'stock-status-in';
                }

                const category = item.category || 'Uncategorized';
                const formattedCategory = category.charAt(0).toUpperCase() + category.slice(1);

                row.innerHTML = `
                    <td>${item.code || 'N/A'}</td>
                    <td>${item.name || 'Unknown'}</td>
                    <td>${formattedCategory}</td>
                    <td>${item.quantity || 0}</td>
                    <td>KES ${(item.price || 0).toFixed(2)}</td>
                    <td>KES ${totalValue.toFixed(2)}</td>
                    <td><span class="stock-status ${statusClass}">${status}</span></td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="action-btn" onclick="editStockItem('${item.code}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="deleteStockItem('${item.code}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
        }

        function filterStock() {
            const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
            const statusFilter = document.getElementById('stockStatusFilter').value;
            const tbody = document.getElementById('stockTable').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                const category = row.cells[2].textContent.toLowerCase();
                const status = row.cells[7].textContent.toLowerCase();
                
                const matchesSearch = text.includes(searchTerm);
                const matchesCategory = !categoryFilter || category === categoryFilter;
                const matchesStatus = !statusFilter || status.includes(statusFilter);

                row.style.display = (matchesSearch && matchesCategory && matchesStatus) ? '' : 'none';
            }
        }

        function filterByCard(filterType) {
            // Remove active class from all cards
            document.querySelectorAll('.stock-summary-card').forEach(card => {
                card.classList.remove('active');
            });

            // Add active class to clicked card
            let activeCard;
            switch(filterType) {
                case 'all':
                    activeCard = document.querySelector('.stock-summary-card.total-items');
                    break;
                case 'inStock':
                    activeCard = document.querySelector('.stock-summary-card.in-stock');
                    break;
                case 'lowStock':
                    activeCard = document.querySelector('.stock-summary-card.low-stock');
                    break;
                case 'outOfStock':
                    activeCard = document.querySelector('.stock-summary-card.out-of-stock');
                    break;
            }
            if (activeCard) {
                activeCard.classList.add('active');
            }

            loadStockTable(filterType);
        }

        // Populate category filter with proper error handling
        function populateCategoryFilter() {
            const categoryFilter = document.getElementById('categoryFilter');
            if (!categoryFilter) {
                console.error('Category filter element not found');
                return;
            }
            
            categoryFilter.innerHTML = '<option value="">All Categories</option>';
            
            if (!Array.isArray(stockItems)) {
                console.error('Stock items is not an array');
                return;
            }
            
            const categories = [...new Set(stockItems
                .filter(item => item && item.category) // Filter out items with no category
                .map(item => item.category.toLowerCase()))]
                .sort();
                
            categories.forEach(category => {
                if (category) {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                    categoryFilter.appendChild(option);
                }
            });
        }

        function saveStockItem() {
            const form = document.getElementById('newStockForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const itemCode = document.getElementById('itemCode').value || generateItemCode();
            const name = document.getElementById('itemName').value;
            const category = document.getElementById('itemCategory').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value);
            const minStock = parseInt(document.getElementById('itemMinStock').value);
            const price = parseFloat(document.getElementById('itemPrice').value);

            const item = {
                code: itemCode,
                name: name,
                category: category,
                quantity: quantity,
                minStock: minStock,
                price: price
            };

            const existingIndex = stockItems.findIndex(i => i.code === itemCode);
            if (existingIndex >= 0) {
                stockItems[existingIndex] = item;
            } else {
                stockItems.push(item);
            }

            saveStockItems();
            updateStockStatistics();
            loadStockTable();
            populateCategoryFilter();

            const modal = bootstrap.Modal.getInstance(document.getElementById('newStockModal'));
            modal.hide();
            form.reset();
        }

        function editStockItem(itemCode) {
            const item = stockItems.find(i => i.code === itemCode);
            if (!item) return;

            document.getElementById('itemCode').value = item.code;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemCategory').value = item.category;
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemMinStock').value = item.minStock;
            document.getElementById('itemPrice').value = item.price;

            const modal = new bootstrap.Modal(document.getElementById('newStockModal'));
            modal.show();
        }

        function deleteStockItem(itemCode) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            const index = stockItems.findIndex(i => i.code === itemCode);
            if (index >= 0) {
                stockItems.splice(index, 1);
                saveStockItems();
                updateStockStatistics();
                loadStockTable();
                populateCategoryFilter();
            }
        }

        function exportStockReport() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Stock Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary
            doc.setFontSize(14);
            doc.text('Stock Summary', 20, 45);
            doc.setFontSize(12);
            doc.text(`Total Items: ${document.getElementById('totalItems').textContent}`, 20, 55);
            doc.text(`In Stock: ${document.getElementById('inStock').textContent}`, 20, 62);
            doc.text(`Low Stock: ${document.getElementById('lowStock').textContent}`, 20, 69);
            doc.text(`Out of Stock: ${document.getElementById('outOfStock').textContent}`, 20, 76);

            // Add stock table
            const headers = [['Code', 'Name', 'Category', 'Quantity', 'Min Stock', 'Unit Price', 'Total Value', 'Status']];
            const data = [];
            
            document.querySelectorAll('#stockTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent,
                    row.cells[5].textContent,
                    row.cells[6].textContent,
                    row.cells[7].textContent
                ]);
            });

            doc.autoTable({
                startY: 85,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save('stock_report.pdf');
        }

        // Initialize stock section
        document.addEventListener('DOMContentLoaded', function() {
            const newStockModal = document.getElementById('newStockModal');
            if (newStockModal) {
                newStockModal.addEventListener('show.bs.modal', function() {
                    const form = document.getElementById('newStockForm');
                    form.reset();
                    document.getElementById('itemCode').value = generateItemCode();
                });
            }

            // Load stock data when showing stock section
            document.querySelector('[data-section="stockSection"]').addEventListener('click', function() {
                loadStockItems();
            });
        });

        // Save sales to localStorage
        function saveSales() {
            localStorage.setItem('sales', JSON.stringify(sales));
        }

        // Generate invoice number
        function generateInvoiceNumber() {
            const prefix = 'INV';
            const timestamp = new Date().getTime().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}-${timestamp}-${random}`;
        }

        // Initialize new sale modal
        function initNewSaleModal() {
            document.getElementById('saleInvoiceNumber').value = generateInvoiceNumber();
            document.getElementById('saleItemsContainer').innerHTML = '';
            document.getElementById('saleSubtotal').textContent = 'KES 0.00';
            document.getElementById('saleVat').textContent = 'KES 0.00';
            document.getElementById('saleTotal').textContent = 'KES 0.00';
            
            // Populate client select
            const clientSelect = document.getElementById('saleClientSelect');
            clientSelect.innerHTML = '<option value="">Select Client</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
        }

        // Add sale item row
        function addSaleItem() {
            const container = document.getElementById('saleItemsContainer');
            const itemRow = document.createElement('div');
            itemRow.className = 'row g-3 align-items-center mb-3';
            itemRow.innerHTML = `
                <div class="col-md-4">
                    <select class="form-select item-select" onchange="updateItemDetails(this)" required>
                        <option value="">Select Item</option>
                        ${getStockItemsOptions()}
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control item-quantity" min="1" value="1" 
                        onchange="updateItemTotal(this)" required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control item-price" readonly>
                </div>
                <div class="col-md-3">
                    <input type="number" class="form-control item-total" readonly>
                </div>
                <div class="col-md-1">
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.row').remove(); updateSaleTotals();">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            container.appendChild(itemRow);
        }

        // Get stock items options
        function getStockItemsOptions() {
            return stockItems.map(item => 
                `<option value="${item.code}" data-price="${item.price}">${item.name}</option>`
            ).join('');
        }

        // Update item details when selected
        function updateItemDetails(select) {
            const row = select.closest('.row');
            const selectedOption = select.options[select.selectedIndex];
            const price = parseFloat(selectedOption.dataset.price) || 0;
            const stockCode = select.value;
            
            // Get stock item to show available quantity
            const stockItem = stockItems.find(item => item.code === stockCode);
            const quantityInput = row.querySelector('.item-quantity');
            
            if (stockItem) {
                // Add/update stock info display
                let stockInfo = row.querySelector('.stock-info');
                if (!stockInfo) {
                    stockInfo = document.createElement('small');
                    stockInfo.className = 'stock-info text-muted ms-2';
                    quantityInput.parentNode.appendChild(stockInfo);
                }
                stockInfo.textContent = `Available: ${stockItem.quantity}`;
                
                // Set max quantity
                quantityInput.max = stockItem.quantity;
                
                // Add validation on quantity change
                quantityInput.onchange = () => validateQuantity(quantityInput, stockCode);
            }
            
            row.querySelector('.item-price').value = price.toFixed(2);
            updateItemTotal(quantityInput);
        }

        // Update item total
        function updateItemTotal(input) {
            const row = input.closest('.row');
            const quantity = parseFloat(input.value) || 0;
            const price = parseFloat(row.querySelector('.item-price').value) || 0;
            const total = quantity * price;
            
            row.querySelector('.item-total').value = total.toFixed(2);
            updateSaleTotals();
        }

        // Update sale totals
        function updateSaleTotals() {
            let subtotal = 0;
            document.querySelectorAll('.item-total').forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });
            
            const vat = subtotal * 0.16;
            const total = subtotal + vat;
            
            document.getElementById('saleSubtotal').textContent = `KES ${subtotal.toFixed(2)}`;
            document.getElementById('saleVat').textContent = `KES ${vat.toFixed(2)}`;
            document.getElementById('saleTotal').textContent = `KES ${total.toFixed(2)}`;
        }

        // Save sale
        function saveSale() {
            const form = document.getElementById('newSaleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const clientId = document.getElementById('saleClientSelect').value;
            const items = [];
            let subtotal = 0;

            document.querySelectorAll('#saleItemsContainer .row').forEach(row => {
                const select = row.querySelector('.item-select');
                const quantity = parseInt(row.querySelector('.item-quantity').value);
                const price = parseFloat(row.querySelector('.item-price').value);
                const total = quantity * price;
                
                subtotal += total;

                items.push({
                    itemId: select.value,
                    name: select.options[select.selectedIndex].text,
                    quantity: quantity,
                    price: price,
                    total: total
                });
            });

            const vat = subtotal * 0.16;
            const total = subtotal + vat;

            const sale = {
                id: sales.length + 1,
                invoiceNumber: document.getElementById('saleInvoiceNumber').value,
                date: new Date().toISOString(),
                clientId: clientId,
                clientName: document.getElementById('saleClientSelect').options[document.getElementById('saleClientSelect').selectedIndex].text,
                items: items,
                subtotal: subtotal,
                vat: vat,
                total: total,
                status: 'Pending'
            };

            sales.push(sale);
            saveSales();
            updateStockQuantities(items);
            updateSalesSummary();
            loadSalesTable();

            const modal = bootstrap.Modal.getInstance(document.getElementById('newSaleModal'));
            modal.hide();
        }

        // Update stock quantities
        function updateStockQuantities(items) {
            items.forEach(item => {
                const stockItem = stockItems.find(s => s.code === item.itemId);
                if (stockItem) {
                    stockItem.quantity -= item.quantity;
                }
            });
            localStorage.setItem('stockItems', JSON.stringify(stockItems));
        }

        // Update sales summary
        function updateSalesSummary() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let totalSales = 0;
            let todaySales = 0;
            let totalItems = 0;

            sales.forEach(sale => {
                totalSales += sale.total;
                totalItems += sale.items.reduce((sum, item) => sum + item.quantity, 0);
                
                if (new Date(sale.date) >= today) {
                    todaySales += sale.total;
                }
            });

            const avgSale = sales.length > 0 ? totalSales / sales.length : 0;

            document.getElementById('totalSalesAmount').textContent = `KES ${totalSales.toFixed(2)}`;
            document.getElementById('todaySalesAmount').textContent = `KES ${todaySales.toFixed(2)}`;
            document.getElementById('totalItemsSold').textContent = totalItems;
            document.getElementById('averageSaleAmount').textContent = `KES ${avgSale.toFixed(2)}`;
        }

        // Load sales table
        function loadSalesTable() {
            const tbody = document.getElementById('salesTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.error('Sales table tbody not found');
                return;
            }
            tbody.innerHTML = '';

            // Populate client filter
            const clientFilter = document.getElementById('clientFilter');
            if (clientFilter) {
                clientFilter.innerHTML = '<option value="">All Clients</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.name.toLowerCase();
                    option.textContent = client.name;
                    clientFilter.appendChild(option);
                });
            }

            if (!Array.isArray(sales)) {
                console.error('Sales is not an array');
                return;
            }

            sales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                if (!sale) return;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${sale.invoiceNumber || 'N/A'}</td>
                    <td>${new Date(sale.date).toLocaleDateString()}</td>
                    <td>${sale.clientName || 'Unknown'}</td>
                    <td>${(sale.items || []).length}</td>
                    <td>KES ${(sale.total || 0).toFixed(2)}</td>
                    <td><span class="status-badge status-${(sale.status || '').toLowerCase()}">${sale.status || 'Pending'}</span></td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="action-btn" onclick="viewSaleDetails('${sale.invoiceNumber}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn" onclick="printInvoice('${sale.invoiceNumber}')">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
        }

        // Filter sales
        function filterSales() {
            const searchTerm = document.getElementById('salesSearch').value.toLowerCase();
            const clientFilter = document.getElementById('clientFilter').value.toLowerCase();
            const dateFilter = document.getElementById('salesDateFilter').value;
            const specificDate = document.getElementById('salesSpecificDate').value;
            const tbody = document.getElementById('salesTable').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                const client = row.cells[2].textContent.toLowerCase();
                const dateCell = row.cells[1].textContent;
                const [day, month, year] = dateCell.split('/');
                const date = new Date(year, month - 1, day); // Convert to Date object
                
                const matchesSearch = text.includes(searchTerm);
                const matchesClient = !clientFilter || client === clientFilter;
                let matchesDate = true;

                if (dateFilter === 'specific' && specificDate) {
                    const selectedDate = new Date(specificDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    const rowDate = new Date(date);
                    rowDate.setHours(0, 0, 0, 0);
                    matchesDate = rowDate.getTime() === selectedDate.getTime();
                } else {
                    matchesDate = !dateFilter || checkDateFilter(date, dateFilter);
                }

                row.style.display = (matchesSearch && matchesClient && matchesDate) ? '' : 'none';
            }
        }

        // Handle date filter
        function handleDateFilter(type = 'sales') {
            const dateFilter = document.getElementById(`${type}DateFilter`);
            const specificDate = document.getElementById(`${type}SpecificDate`);
            
            if (!dateFilter || !specificDate) {
                console.error(`Date filter elements not found for type: ${type}`);
                return;
            }
            
            if (dateFilter.value === 'specific') {
                specificDate.style.display = 'block';
                // Set to today's date in local timezone
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                specificDate.value = `${year}-${month}-${day}`;
            } else {
                specificDate.style.display = 'none';
            }
            
            if (type === 'sales') {
                filterSales();
            } else if (type === 'purchases') {
                filterPurchases();
            }
        }

        // Unified date filter check for both sales and purchases
        function checkDateFilter(date, filter) {
            // Convert input date to Date object if it's a string
            const inputDate = typeof date === 'string' ? new Date(date) : date;
            
            // Set to start of day for accurate comparison
            const targetDate = new Date(inputDate);
            targetDate.setHours(0, 0, 0, 0);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Calculate start of week (Sunday)
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());
            startOfWeek.setHours(0, 0, 0, 0);

            // Calculate start of month
            const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            startOfMonth.setHours(0, 0, 0, 0);

            // Calculate start of year
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            startOfYear.setHours(0, 0, 0, 0);

            switch(filter) {
                case 'today':
                    return targetDate.getTime() === today.getTime();
                case 'week':
                    return targetDate >= startOfWeek && targetDate <= today;
                case 'month':
                    return targetDate >= startOfMonth;
                case 'year':
                    return targetDate >= startOfYear;
                default:
                    return true;
            }
        }

        // Export sales report
        function exportSalesReport() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Sales Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary
            doc.setFontSize(14);
            doc.text('Sales Summary', 20, 45);
            doc.setFontSize(12);
            doc.text(`Total Sales: ${document.getElementById('totalSalesAmount').textContent}`, 20, 55);
            doc.text(`Today's Sales: ${document.getElementById('todaySalesAmount').textContent}`, 20, 62);
            doc.text(`Items Sold: ${document.getElementById('totalItemsSold').textContent}`, 20, 69);
            doc.text(`Average Sale: ${document.getElementById('averageSaleAmount').textContent}`, 20, 76);

            // Add sales table
            const headers = [['Invoice #', 'Date', 'Client', 'Total Amount', 'Status']];
            const data = [];
            
            document.querySelectorAll('#salesTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[4].textContent,
                    row.cells[5].textContent
                ]);
            });

            doc.autoTable({
                startY: 90,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save('sales_report.pdf');
        }

        // Initialize sales section
        document.addEventListener('DOMContentLoaded', function() {
            loadSales();
            
            // Initialize new sale modal
            const newSaleModal = document.getElementById('newSaleModal');
            if (newSaleModal) {
                newSaleModal.addEventListener('show.bs.modal', function() {
                    initNewSaleModal();
                });
            }
        });

        // Update the validateQuantity function
        function validateQuantity(input, stockCode) {
            const stockItem = stockItems.find(item => item.code === stockCode);
            if (!stockItem) return;

            const quantity = parseInt(input.value) || 0;
            if (quantity > stockItem.quantity) {
                alert(`Cannot exceed available stock (${stockItem.quantity} items available)`);
                input.value = stockItem.quantity;
                updateItemTotal(input);
            }
        }

        // Add these new functions for sale actions
        function viewSaleDetails(invoiceNumber) {
            const sale = sales.find(s => s.invoiceNumber === invoiceNumber);
            if (!sale) return;

            const modalContent = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Sale Details - Invoice #${sale.invoiceNumber}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Date:</strong> ${new Date(sale.date).toLocaleDateString()}</p>
                                    <p><strong>Client:</strong> ${sale.clientName}</p>
                                </div>
                                <div class="col-md-6 text-end">
                                    <p><strong>Status:</strong> <span class="status-badge status-${sale.status.toLowerCase()}">${sale.status}</span></p>
                                </div>
                            </div>
                            
                            <div class="table-responsive mb-3">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sale.items.map(item => `
                                            <tr>
                                                <td>${item.name}</td>
                                                <td>${item.quantity}</td>
                                                <td>KES ${item.price.toFixed(2)}</td>
                                                <td>KES ${item.total.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 offset-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between mb-2">
                                                <strong>Subtotal:</strong>
                                                <span>KES ${sale.subtotal.toFixed(2)}</span>
                                            </div>
                                            <div class="d-flex justify-content-between mb-2">
                                                <strong>VAT (16%):</strong>
                                                <span>KES ${sale.vat.toFixed(2)}</span>
                                            </div>
                                            <div class="d-flex justify-content-between fw-bold">
                                                <strong>Total:</strong>
                                                <span>KES ${sale.total.toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="printInvoice('${sale.invoiceNumber}')">
                                <i class="fas fa-print me-2"></i>Print Invoice
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const viewModal = document.createElement('div');
            viewModal.className = 'modal fade';
            viewModal.innerHTML = modalContent;
            document.body.appendChild(viewModal);

            const modal = new bootstrap.Modal(viewModal);
            modal.show();

            viewModal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(viewModal);
            });
        }

        function printInvoice(invoiceNumber) {
            const sale = sales.find(s => s.invoiceNumber === invoiceNumber);
            if (!sale) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice #${sale.invoiceNumber}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @media print {
                            .no-print {
                                display: none;
                            }
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                        }
                        .company-name {
                            font-size: 24px;
                            font-weight: bold;
                        }
                        .invoice-details {
                            margin-bottom: 20px;
                        }
                        .table th {
                            background-color: #f8f9fa;
                        }
                    </style>
                </head>
                <body>
                    <div class="container p-4">
                        <div class="header">
                            <div class="company-name">Cabinet Master Styles And Finishes</div>
                            <div>cabinetmasterstylesandfinishes@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone: 0729554475</div>
                        </div>

                        <div class="invoice-details">
                            <div class="row">
                                <div class="col-6">
                                    <h2>INVOICE</h2>
                                    <p><strong>Invoice #:</strong> ${sale.invoiceNumber}</p>
                                    <p><strong>Date:</strong> ${new Date(sale.date).toLocaleDateString()}</p>
                                    <p><strong>Client:</strong> ${sale.clientName}</p>
                                </div>
                            </div>
                        </div>

                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sale.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.price.toFixed(2)}</td>
                                        <td>KES ${item.total.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="row">
                            <div class="col-6 offset-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Subtotal:</strong></td>
                                        <td class="text-end">KES ${sale.subtotal.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>VAT (16%):</strong></td>
                                        <td class="text-end">KES ${sale.vat.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Total:</strong></td>
                                        <td class="text-end"><strong>KES ${sale.total.toFixed(2)}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <p>Thank you for your business!</p>
                        </div>

                        <div class="text-center mt-4 no-print">
                            <button onclick="window.print()" class="btn btn-primary">Print Invoice</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // Generate unique item code
        function generateItemCode() {
            const prefix = 'ITM';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}-${timestamp}-${random}`;
        }

        // Load purchases from localStorage
        function loadPurchases() {
            try {
                const storedPurchases = localStorage.getItem('purchases');
                if (storedPurchases) {
                    purchases = JSON.parse(storedPurchases);
                    if (!Array.isArray(purchases)) {
                        console.error('Stored purchases is not an array');
                        purchases = [];
                    }
                } else {
                    // Initialize with sample data if empty
                    purchases = [
                        {
                            id: Date.now(),
                            date: new Date().toISOString(),
                            supplier: "Wood Suppliers Ltd",
                            items: [
                                {
                                    name: "Mahogany Wood",
                                    quantity: 50,
                                    price: 1000,
                                    total: 50000
                                }
                            ],
                            total: 50000,
                            status: "Completed"
                        }
                    ];
                    localStorage.setItem('purchases', JSON.stringify(purchases));
                }
                updatePurchaseStatistics();
                loadPurchasesTable();
                populateSupplierFilter();
            } catch (error) {
                console.error('Error loading purchases:', error);
                purchases = [];
                loadPurchasesTable();
                populateSupplierFilter();
            }
        }

        // Filter purchases
        function filterPurchases() {
            const searchTerm = document.getElementById('purchaseSearch').value.toLowerCase();
            const supplierFilter = document.getElementById('supplierFilter').value.toLowerCase();
            const dateFilter = document.getElementById('purchasesDateFilter').value;
            const specificDate = document.getElementById('purchasesSpecificDate').value;
            const tbody = document.getElementById('purchasesTable').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                const supplier = row.cells[2].textContent.toLowerCase();
                const dateCell = row.cells[1].textContent;
                const [day, month, year] = dateCell.split('/');
                const date = new Date(year, month - 1, day); // Convert to Date object
                
                const matchesSearch = text.includes(searchTerm);
                const matchesSupplier = !supplierFilter || supplier === supplierFilter;
                let matchesDate = true;

                if (dateFilter === 'specific' && specificDate) {
                    const selectedDate = new Date(specificDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    const rowDate = new Date(date);
                    rowDate.setHours(0, 0, 0, 0);
                    matchesDate = rowDate.getTime() === selectedDate.getTime();
                } else {
                    matchesDate = !dateFilter || checkDateFilter(date, dateFilter);
                }

                row.style.display = (matchesSearch && matchesSupplier && matchesDate) ? '' : 'none';
            }
        }

        // Generate purchase order number
        function generatePurchaseOrderNumber() {
            const prefix = 'PO';
            const timestamp = Date.now().toString().slice(-6);
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `${prefix}-${timestamp}-${random}`;
        }

        // Load purchases table
        function loadPurchasesTable() {
            const tbody = document.getElementById('purchasesTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.error('Purchases table tbody not found');
                return;
            }
            tbody.innerHTML = '';

            if (!Array.isArray(purchases)) {
                console.error('Purchases is not an array');
                return;
            }

            // Sort purchases by date (newest first)
            purchases
                .filter(purchase => purchase && purchase.date)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .forEach(purchase => {
                    if (!purchase || !purchase.supplier) return;
                    
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${purchase.orderNumber || 'N/A'}</td>
                        <td>${new Date(purchase.date).toLocaleDateString()}</td>
                        <td>${purchase.supplier}</td>
                        <td>${(purchase.items || []).length}</td>
                        <td>KES ${(purchase.total || 0).toFixed(2)}</td>
                        <td><span class="status-badge status-${(purchase.status || '').toLowerCase()}">${purchase.status || 'Unknown'}</span></td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="action-btn" onclick="viewPurchaseDetails(${purchase.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="printPurchaseOrder(${purchase.id})">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });
        }

        // Save purchase
        function savePurchase() {
            const form = document.getElementById('newPurchaseForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const supplier = document.getElementById('purchaseSupplier').value;
            const orderNumber = document.getElementById('purchaseOrderNumber').value;
            const items = [];
            let total = 0;

            const itemRows = document.querySelectorAll('#purchaseItemsTable tbody tr');
            if (itemRows.length === 0) {
                alert('Please add at least one item to the purchase');
                return;
            }

            itemRows.forEach(row => {
                const itemName = row.querySelector('.item-name').value;
                const quantity = parseFloat(row.querySelector('.quantity').value);
                const price = parseFloat(row.querySelector('.price').value);
                const itemTotal = quantity * price;

                if (!itemName || !quantity || !price) {
                    alert('Please fill in all item details');
                    return;
                }

                items.push({
                    name: itemName,
                    quantity: quantity,
                    price: price,
                    total: itemTotal
                });

                total += itemTotal;

                // Update stock
                updateStockOnPurchase(itemName, quantity, price);
            });

            // Use local timezone for date
            const now = new Date();
            const purchase = {
                id: Date.now(),
                orderNumber: orderNumber,
                date: now.toISOString(), // Store in ISO format for consistency
                supplier: supplier,
                items: items,
                total: total,
                status: 'Completed'
            };

            // Add to purchases array and save
            purchases.push(purchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));

            // Update UI
            updatePurchaseStatistics();
            loadPurchasesTable();
            populateSupplierFilter();

            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('newPurchaseModal'));
            modal.hide();
            form.reset();

            // Clear the items table
            document.getElementById('purchaseItemsTable').getElementsByTagName('tbody')[0].innerHTML = '';
            // Remove the total if it exists
            const totalElement = document.getElementById('purchaseTotal');
            if (totalElement) totalElement.remove();
        }

        // Export purchase report
        function exportPurchaseReport() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Purchase Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary
            doc.setFontSize(14);
            doc.text('Purchase Summary', 20, 45);
            doc.setFontSize(12);
            doc.text(`Total Purchases: ${document.getElementById('totalPurchasesAmount').textContent}`, 20, 55);
            doc.text(`Purchase Orders: ${document.getElementById('totalPurchaseOrders').textContent}`, 20, 62);
            doc.text(`Average Purchase: ${document.getElementById('avgPurchaseValue').textContent}`, 20, 69);

            // Add purchases table
            const headers = [['Date', 'Supplier', 'Items', 'Total Amount', 'Status']];
            const data = [];
            
            document.querySelectorAll('#purchasesTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent
                ]);
            });

            doc.autoTable({
                startY: 80,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save('purchase_report.pdf');
        }

        // Initialize purchases section
        document.addEventListener('DOMContentLoaded', function() {
            loadPurchases();
            
            // Initialize new purchase modal
            const newPurchaseModal = document.getElementById('newPurchaseModal');
            if (newPurchaseModal) {
                newPurchaseModal.addEventListener('show.bs.modal', function() {
                    // Clear previous data
                    document.getElementById('purchaseSupplier').value = '';
                    document.getElementById('purchaseOrderNumber').value = generatePurchaseOrderNumber();
                    document.getElementById('purchaseItemsTable').getElementsByTagName('tbody')[0].innerHTML = '';
                    const totalElement = document.getElementById('purchaseTotal');
                    if (totalElement) totalElement.remove();
                });
            }
        });

        // Update stock on purchase
        function updateStockOnPurchase(itemName, quantity, price) {
            let stockItem = stockItems.find(item => item.name.toLowerCase() === itemName.toLowerCase());
            if (stockItem) {
                stockItem.quantity += quantity;
                stockItem.price = price; // Update with latest purchase price
            } else {
                stockItem = {
                    code: generateItemCode(),
                    name: itemName,
                    quantity: quantity,
                    price: price,
                    minStock: 5 // Default minimum stock level
                };
                stockItems.push(stockItem);
            }
            localStorage.setItem('stockItems', JSON.stringify(stockItems));
        }

        // Populate supplier filter
        function populateSupplierFilter() {
            const supplierFilter = document.getElementById('supplierFilter');
            if (!supplierFilter) {
                console.error('Supplier filter element not found');
                return;
            }
            
            supplierFilter.innerHTML = '<option value="">All Suppliers</option>';
            
            if (!Array.isArray(purchases)) {
                console.error('Purchases is not an array');
                return;
            }
            
            const uniqueSuppliers = [...new Set(purchases
                .filter(p => p && p.supplier) // Filter out null/undefined suppliers
                .map(p => p.supplier))];
                
            uniqueSuppliers.sort().forEach(supplier => {
                if (supplier) { // Only add valid suppliers
                    const option = document.createElement('option');
                    option.value = supplier.toLowerCase();
                    option.textContent = supplier;
                    supplierFilter.appendChild(option);
                }
            });
        }

        // Update purchase statistics
        function updatePurchaseStatistics() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const lastMonth = new Date();
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            lastMonth.setDate(1);

            const thisMonth = new Date();
            thisMonth.setDate(1);

            let totalPurchases = 0;
            let thisMonthPurchases = 0;
            let lastMonthPurchases = 0;

            purchases.forEach(purchase => {
                const purchaseDate = new Date(purchase.date);
                totalPurchases += purchase.total;

                if (purchaseDate >= thisMonth) {
                    thisMonthPurchases += purchase.total;
                } else if (purchaseDate >= lastMonth && purchaseDate < thisMonth) {
                    lastMonthPurchases += purchase.total;
                }
            });

            const avgPurchase = purchases.length > 0 ? totalPurchases / purchases.length : 0;
            const trendPercentage = lastMonthPurchases > 0 ? 
                ((thisMonthPurchases - lastMonthPurchases) / lastMonthPurchases) * 100 : 0;

            document.getElementById('totalPurchasesAmount').textContent = `KES ${totalPurchases.toFixed(2)}`;
            document.getElementById('totalPurchaseOrders').textContent = purchases.length;
            document.getElementById('avgPurchaseValue').textContent = `KES ${avgPurchase.toFixed(2)}`;
            document.getElementById('trendPercentage').textContent = `${Math.abs(trendPercentage).toFixed(1)}%`;
            
            const trendIcon = document.getElementById('trendIcon');
            trendIcon.className = `fas fa-arrow-${trendPercentage >= 0 ? 'up' : 'down'} ms-2`;
            trendIcon.style.color = trendPercentage >= 0 ? '#4ade80' : '#ef4444';
        }

        // View purchase details
        function viewPurchaseDetails(purchaseId) {
            const purchase = purchases.find(p => p.id === parseInt(purchaseId));
            if (!purchase) return;

            const modalContent = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Purchase Details - Order #${purchase.id}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <p><strong>Date:</strong> ${new Date(purchase.date).toLocaleDateString()}</p>
                                    <p><strong>Supplier:</strong> ${purchase.supplier}</p>
                                </div>
                                <div class="col-md-6 text-end">
                                    <p><strong>Status:</strong> <span class="status-badge status-${purchase.status.toLowerCase()}">${purchase.status}</span></p>
                                </div>
                            </div>
                            
                            <div class="table-responsive mb-3">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Item</th>
                                            <th>Quantity</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${purchase.items.map(item => `
                                            <tr>
                                                <td>${item.name}</td>
                                                <td>${item.quantity}</td>
                                                <td>KES ${item.price.toFixed(2)}</td>
                                                <td>KES ${item.total.toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 offset-md-6">
                                    <div class="card bg-light">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between fw-bold">
                                                <strong>Total:</strong>
                                                <span>KES ${purchase.total.toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="printPurchaseOrder(${purchase.id})">
                                <i class="fas fa-print me-2"></i>Print Order
                            </button>
                        </div>
                    </div>
                </div>
            `;

            const viewModal = document.createElement('div');
            viewModal.className = 'modal fade';
            viewModal.innerHTML = modalContent;
            document.body.appendChild(viewModal);

            const modal = new bootstrap.Modal(viewModal);
            modal.show();

            viewModal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(viewModal);
            });
        }

        // Print purchase order
        function printPurchaseOrder(purchaseId) {
            const purchase = purchases.find(p => p.id === parseInt(purchaseId));
            if (!purchase) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Purchase Order #${purchase.id}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @media print {
                            .no-print {
                                display: none;
                            }
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                        }
                        .company-name {
                            font-size: 24px;
                            font-weight: bold;
                        }
                        .order-details {
                            margin-bottom: 20px;
                        }
                        .table th {
                            background-color: #f8f9fa;
                        }
                    </style>
                </head>
                <body>
                    <div class="container p-4">
                        <div class="header">
                            <div class="company-name">Cabinet Master Styles And Finishes</div>
                            <div>cabinetmasterstylesandfinishes@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone: 0729554475</div>
                        </div>

                        <div class="order-details">
                            <div class="row">
                                <div class="col-6">
                                    <h2>PURCHASE ORDER</h2>
                                    <p><strong>Order #:</strong> ${purchase.id}</p>
                                    <p><strong>Date:</strong> ${new Date(purchase.date).toLocaleDateString()}</p>
                                    <p><strong>Supplier:</strong> ${purchase.supplier}</p>
                                </div>
                            </div>
                        </div>

                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${purchase.items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.price.toFixed(2)}</td>
                                        <td>KES ${item.total.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="row">
                            <div class="col-6 offset-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Total:</strong></td>
                                        <td class="text-end"><strong>KES ${purchase.total.toFixed(2)}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <p>Thank you for your business!</p>
                        </div>

                        <div class="text-center mt-4 no-print">
                            <button onclick="window.print()" class="btn btn-primary">Print Order</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // Add purchase item row
        function addPurchaseItem() {
            const tbody = document.getElementById('purchaseItemsTable').getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control item-name" required></td>
                <td><input type="number" class="form-control quantity" min="1" value="1" onchange="updatePurchaseItemTotal(this)" required></td>
                <td><input type="number" class="form-control price" step="0.01" onchange="updatePurchaseItemTotal(this)" required></td>
                <td class="total">0.00</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('tr').remove(); updatePurchaseTotals();">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            updatePurchaseTotals();
        }

        // Update purchase item total
        function updatePurchaseItemTotal(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const price = parseFloat(row.querySelector('.price').value) || 0;
            const total = quantity * price;
            row.querySelector('.total').textContent = total.toFixed(2);
            updatePurchaseTotals();
        }

        // Update purchase totals
        function updatePurchaseTotals() {
            let total = 0;
            document.querySelectorAll('#purchaseItemsTable tbody tr').forEach(row => {
                total += parseFloat(row.querySelector('.total').textContent) || 0;
            });
            
            let totalElement = document.getElementById('purchaseTotal');
            if (!totalElement) {
                totalElement = document.createElement('div');
                totalElement.id = 'purchaseTotal';
                totalElement.className = 'mt-3 text-end fw-bold';
                document.getElementById('purchaseItemsTable').parentElement.appendChild(totalElement);
            }
            totalElement.textContent = `Total: KES ${total.toFixed(2)}`;
        }

        // Save purchase
        function savePurchase() {
            const form = document.getElementById('newPurchaseForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const supplier = document.getElementById('purchaseSupplier').value;
            const orderNumber = document.getElementById('purchaseOrderNumber').value;
            const items = [];
            let total = 0;

            const itemRows = document.querySelectorAll('#purchaseItemsTable tbody tr');
            if (itemRows.length === 0) {
                alert('Please add at least one item to the purchase');
                return;
            }

            itemRows.forEach(row => {
                const itemName = row.querySelector('.item-name').value;
                const quantity = parseFloat(row.querySelector('.quantity').value);
                const price = parseFloat(row.querySelector('.price').value);
                const itemTotal = quantity * price;

                if (!itemName || !quantity || !price) {
                    alert('Please fill in all item details');
                    return;
                }

                items.push({
                    name: itemName,
                    quantity: quantity,
                    price: price,
                    total: itemTotal
                });

                total += itemTotal;

                // Update stock
                updateStockOnPurchase(itemName, quantity, price);
            });

            // Use local timezone for date
            const now = new Date();
            const purchase = {
                id: Date.now(),
                orderNumber: orderNumber,
                date: now.toISOString(), // Store in ISO format for consistency
                supplier: supplier,
                items: items,
                total: total,
                status: 'Completed'
            };

            // Add to purchases array and save
            purchases.push(purchase);
            localStorage.setItem('purchases', JSON.stringify(purchases));

            // Update UI
            updatePurchaseStatistics();
            loadPurchasesTable();
            populateSupplierFilter();

            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('newPurchaseModal'));
            modal.hide();
            form.reset();

            // Clear the items table
            document.getElementById('purchaseItemsTable').getElementsByTagName('tbody')[0].innerHTML = '';
            // Remove the total if it exists
            const totalElement = document.getElementById('purchaseTotal');
            if (totalElement) totalElement.remove();
        }

        // Initialize date filters
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sales date filter
            const salesDateFilter = document.getElementById('salesDateFilter');
            const salesSpecificDate = document.getElementById('salesSpecificDate');
            if (salesDateFilter && salesSpecificDate) {
                salesDateFilter.addEventListener('change', () => handleDateFilter('sales'));
                salesSpecificDate.addEventListener('change', filterSales);
            }

            // Initialize purchases date filter
            const purchasesDateFilter = document.getElementById('purchasesDateFilter');
            const purchasesSpecificDate = document.getElementById('purchasesSpecificDate');
            if (purchasesDateFilter && purchasesSpecificDate) {
                purchasesDateFilter.addEventListener('change', () => handleDateFilter('purchases'));
                purchasesSpecificDate.addEventListener('change', filterPurchases);
            }
        });

        // Existing code ...

        // Analytics Functions
        let revenueExpenseChart, profitMarginChart, monthlyTrendsChart, expenseBreakdownChart;

        function initializeAnalytics() {
            // Initialize existing charts
            initializeRevenueExpenseChart();
            initializeProfitMarginChart();
            initializeMonthlyTrendsChart();
            initializeExpenseBreakdownChart();
            
            // Initialize new charts
            renderOverallFinancials();
            renderClientComparison();
            renderMonthlyTrends();
            
            // Update analytics data
            updateAnalytics();

            // Set up auto-refresh every 5 minutes
            setInterval(updateAnalytics, 300000);
        }

        function updateAnalytics() {
            const data = calculateFinancialData();
            updateSummaryCards(data);
            updateCharts(data);
        }

        function calculateFinancialData() {
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Get last month's date range
            const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
            const lastMonthYear = lastMonth.getFullYear();
            const lastMonthNum = lastMonth.getMonth();

            // Calculate current month's revenue
            const currentMonthSales = sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            }).reduce((total, sale) => total + sale.total, 0);

            // Calculate last month's revenue
            const lastMonthSales = sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === lastMonthNum && saleDate.getFullYear() === lastMonthYear;
            }).reduce((total, sale) => total + sale.total, 0);

            // Calculate expenses
            const currentMonthExpenses = calculateTotalExpenses(currentMonth, currentYear);
            const lastMonthExpenses = calculateTotalExpenses(lastMonthNum, lastMonthYear);

            // Calculate profits
            const currentMonthGrossProfit = currentMonthSales - currentMonthExpenses;
            const lastMonthGrossProfit = lastMonthSales - lastMonthExpenses;
            const currentMonthNetProfit = currentMonthGrossProfit; // Simplified, can add more deductions if needed

            // Calculate growth percentages
            const revenueGrowth = calculateGrowthPercentage(lastMonthSales, currentMonthSales);
            const expensesGrowth = calculateGrowthPercentage(lastMonthExpenses, currentMonthExpenses);
            const profitGrowth = calculateGrowthPercentage(lastMonthGrossProfit, currentMonthGrossProfit);

            // Calculate monthly trends (last 6 months)
            const monthlyTrends = calculateMonthlyTrends();

            return {
                currentMonth: {
                    revenue: currentMonthSales,
                    expenses: currentMonthExpenses,
                    grossProfit: currentMonthGrossProfit,
                    netProfit: currentMonthNetProfit
                },
                growth: {
                    revenue: revenueGrowth,
                    expenses: expensesGrowth,
                    profit: profitGrowth
                },
                monthlyTrends: monthlyTrends,
                expenseBreakdown: calculateExpenseBreakdown()
            };
        }

        function calculateTotalExpenses(month, year) {
            // Sum all expenses for the given month
            return clients.reduce((total, client) => {
                const clientExpenses = client.expenseItems || [];
                const monthExpenses = clientExpenses.filter(expense => {
                    // Assuming expense date is tracked, adjust if needed
                    const expenseDate = new Date(expense.date || new Date());
                    return expenseDate.getMonth() === month && expenseDate.getFullYear() === year;
                }).reduce((sum, expense) => sum + (expense.amount || 0), 0);
                return total + monthExpenses;
            }, 0);
        }

        function calculateGrowthPercentage(oldValue, newValue) {
            if (oldValue === 0) return newValue === 0 ? 0 : 100;
            return ((newValue - oldValue) / oldValue) * 100;
        }

        function calculateMonthlyTrends() {
            const months = [];
            const revenues = [];
            const expenses = [];
            const profits = [];

            // Get data for the last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const month = date.getMonth();
                const year = date.getFullYear();

                const monthRevenue = sales.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate.getMonth() === month && saleDate.getFullYear() === year;
                }).reduce((total, sale) => total + sale.total, 0);

                const monthExpenses = calculateTotalExpenses(month, year);
                const monthProfit = monthRevenue - monthExpenses;

                months.push(date.toLocaleString('default', { month: 'short' }));
                revenues.push(monthRevenue);
                expenses.push(monthExpenses);
                profits.push(monthProfit);
            }

            return { months, revenues, expenses, profits };
        }

        function calculateExpenseBreakdown() {
            const categories = {};
            
            clients.forEach(client => {
                (client.expenseItems || []).forEach(expense => {
                    const category = expense.category || 'Other';
                    categories[category] = (categories[category] || 0) + (expense.amount || 0);
                });
            });

            return categories;
        }

        function updateSummaryCards(data) {
            // Update amounts
            document.getElementById('totalRevenue').textContent = `KES ${data.currentMonth.revenue.toFixed(2)}`;
            document.getElementById('totalExpenses').textContent = `KES ${data.currentMonth.expenses.toFixed(2)}`;
            document.getElementById('grossProfit').textContent = `KES ${data.currentMonth.grossProfit.toFixed(2)}`;
            document.getElementById('netProfit').textContent = `KES ${data.currentMonth.netProfit.toFixed(2)}`;

            // Update growth indicators
            document.getElementById('revenueGrowth').textContent = 
                `${data.growth.revenue >= 0 ? '+' : ''}${data.growth.revenue.toFixed(1)}% vs last month`;
            document.getElementById('expensesGrowth').textContent = 
                `${data.growth.expenses >= 0 ? '+' : ''}${data.growth.expenses.toFixed(1)}% vs last month`;
            document.getElementById('profitGrowth').textContent = 
                `${data.growth.profit >= 0 ? '+' : ''}${data.growth.profit.toFixed(1)}% vs last month`;

            // Update gross profit margin
            const grossProfitMargin = (data.currentMonth.grossProfit / data.currentMonth.revenue * 100) || 0;
            document.getElementById('grossProfitMargin').textContent = `${grossProfitMargin.toFixed(1)}% margin`;
        }

        function updateCharts(data) {
            // Update Revenue vs Expense Chart
            revenueExpenseChart.data.datasets[0].data = data.monthlyTrends.revenues;
            revenueExpenseChart.data.datasets[1].data = data.monthlyTrends.expenses;
            revenueExpenseChart.data.labels = data.monthlyTrends.months;
            revenueExpenseChart.update();

            // Update Profit Margin Chart
            const profitMargins = data.monthlyTrends.revenues.map((revenue, index) => 
                revenue === 0 ? 0 : (data.monthlyTrends.profits[index] / revenue * 100)
            );
            profitMarginChart.data.datasets[0].data = profitMargins;
            profitMarginChart.data.labels = data.monthlyTrends.months;
            profitMarginChart.update();

            // Update Monthly Trends Chart
            monthlyTrendsChart.data.datasets[0].data = data.monthlyTrends.profits;
            monthlyTrendsChart.data.labels = data.monthlyTrends.months;
            monthlyTrendsChart.update();

            // Update Expense Breakdown Chart
            const expenseData = Object.values(data.expenseBreakdown);
            const expenseLabels = Object.keys(data.expenseBreakdown);
            expenseBreakdownChart.data.datasets[0].data = expenseData;
            expenseBreakdownChart.data.labels = expenseLabels;
            expenseBreakdownChart.update();
        }

        function initializeRevenueExpenseChart() {
            const ctx = document.getElementById('revenueExpenseChart').getContext('2d');
            revenueExpenseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Revenue',
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        data: [],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }, {
                        label: 'Expenses',
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        data: [],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Revenue vs Expenses',
                            font: {
                                size: 16,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            padding: 20
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: value => `KES ${value.toLocaleString()}`,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeProfitMarginChart() {
            const ctx = document.getElementById('profitMarginChart').getContext('2d');
            profitMarginChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Profit Margin',
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        data: [],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Profit Margin Trend',
                            font: {
                                size: 16,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            padding: 20
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: value => `${value}%`,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeMonthlyTrendsChart() {
            const ctx = document.getElementById('monthlyTrendsChart').getContext('2d');
            monthlyTrendsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Net Profit',
                        backgroundColor: '#8b5cf6',
                        data: [],
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Monthly Profit Trend',
                            font: {
                                size: 16,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            padding: 20
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: value => `KES ${value.toLocaleString()}`,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeExpenseBreakdownChart() {
            const ctx = document.getElementById('expenseBreakdownChart').getContext('2d');
            expenseBreakdownChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',  // Indigo
                            'rgba(239, 68, 68, 0.8)',   // Red
                            'rgba(16, 185, 129, 0.8)',  // Emerald
                            'rgba(245, 158, 11, 0.8)',  // Amber
                            'rgba(139, 92, 246, 0.8)',  // Purple
                            'rgba(236, 72, 153, 0.8)'   // Pink
                        ],
                        borderWidth: 0,
                        offset: 4,
                        borderRadius: 5,
                        spacing: 2,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '65%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 12
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const total = data.datasets[0].data.reduce((acc, val) => acc + val, 0);
                                            const percentage = ((value / total) * 100).toFixed(1);
                                            return {
                                                text: `${label} - KES ${value.toLocaleString()} (${percentage}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: isNaN(value) || value === 0,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Expense Categories',
                            font: {
                                size: 16,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            padding: {
                                top: 10,
                                bottom: 30
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return `KES ${value.toLocaleString()} (${percentage}%)`;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: {
                            top: 20,
                            bottom: 20,
                            left: 20,
                            right: 20
                        }
                    }
                }
            });
        }

        // Initialize analytics when showing the reporting section
        document.querySelector('[data-section="reportingSection"]').addEventListener('click', function() {
            if (!revenueExpenseChart) {
                initializeAnalytics();
            } else {
                updateAnalytics();
            }
        });

        function renderOverallFinancials() {
            console.log('Rendering overall financials...');
            const canvas = document.getElementById('overallFinancials');
            if (!canvas) {
                console.error('Overall financials canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');
            
            // Clear any existing chart
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            const totalQuotations = clients.reduce((sum, client) => sum + client.quotationAmount, 0);
            const totalPaid = clients.reduce((sum, client) => sum + client.paidAmount, 0);
            const totalExpenses = clients.reduce((sum, client) => sum + client.expenses, 0);
            const totalProfit = totalPaid - totalExpenses;

            const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient1.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
            gradient1.addColorStop(1, 'rgba(99, 102, 241, 0.2)');

            const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient2.addColorStop(0, 'rgba(74, 222, 128, 0.8)');
            gradient2.addColorStop(1, 'rgba(74, 222, 128, 0.2)');

            const gradient3 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient3.addColorStop(0, 'rgba(251, 191, 36, 0.8)');
            gradient3.addColorStop(1, 'rgba(251, 191, 36, 0.2)');

            const gradient4 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient4.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
            gradient4.addColorStop(1, 'rgba(239, 68, 68, 0.2)');

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Total Quotations', 'Total Paid', 'Total Profit', 'Total Expenses'],
                    datasets: [{
                        data: [totalQuotations, totalPaid, totalProfit, totalExpenses],
                        backgroundColor: [gradient1, gradient2, gradient3, gradient4],
                        borderWidth: 0,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Financial Overview',
                            font: {
                                size: 16,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            padding: 20
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `KES ${context.raw.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    cutout: '65%'
                }
            });
        }

        function renderClientComparison() {
            const canvas = document.getElementById('clientComparison');
            if (!canvas) {
                console.error('Client comparison canvas not found');
                return;
            }
            const ctx = canvas.getContext('2d');

            // Clear any existing chart
            const existingChart = Chart.getChart(canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            const clientNames = clients.map(client => client.name);
            const quotationAmounts = clients.map(client => client.quotationAmount);
            const paidAmounts = clients.map(client => client.paidAmount);
            const expenseAmounts = clients.map(client => client.expenses);

            const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient1.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
            gradient1.addColorStop(1, 'rgba(99, 102, 241, 0.2)');

            const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient2.addColorStop(0, 'rgba(74, 222, 128, 0.8)');
            gradient2.addColorStop(1, 'rgba(74, 222, 128, 0.2)');

            const gradient3 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient3.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
            gradient3.addColorStop(1, 'rgba(239, 68, 68, 0.2)');

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: clientNames,
                    datasets: [
                        {
                            label: 'Quotation Amount',
                            data: quotationAmounts,
                            backgroundColor: gradient1,
                            borderRadius: 5
                        },
                        {
                            label: 'Paid Amount',
                            data: paidAmounts,
                            backgroundColor: gradient2,
                            borderRadius: 5
                        },
                        {
                            label: 'Expenses',
                            data: expenseAmounts,
                            backgroundColor: gradient3,
                            borderRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Client Financial Comparison',
                            font: {
                                size: 16,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            padding: 20
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: value => `KES ${value.toLocaleString()}`,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderMonthlyTrends() {
            const ctx = document.getElementById('monthlyTrends').getContext('2d');
            
            // Clear any existing chart
            const existingChart = Chart.getChart(ctx.canvas);
            if (existingChart) {
                existingChart.destroy();
            }

            // Calculate monthly data from actual payments and expenses
            const monthlyData = calculateMonthlyData();

            const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient1.addColorStop(0, 'rgba(99, 102, 241, 0.8)');
            gradient1.addColorStop(1, 'rgba(99, 102, 241, 0.2)');

            const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient2.addColorStop(0, 'rgba(239, 68, 68, 0.8)');
            gradient2.addColorStop(1, 'rgba(239, 68, 68, 0.2)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthlyData.labels,
                    datasets: [
                        {
                            label: 'Payments',
                            data: monthlyData.payments,
                            borderColor: 'rgba(99, 102, 241, 1)',
                            backgroundColor: gradient1,
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Expenses',
                            data: monthlyData.expenses,
                            borderColor: 'rgba(239, 68, 68, 1)',
                            backgroundColor: gradient2,
                            fill: true,
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12,
                                    family: "'Inter', sans-serif"
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Monthly Payment & Expense Trends',
                            font: {
                                size: 16,
                                family: "'Inter', sans-serif",
                                weight: '600'
                            },
                            padding: 20
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                callback: value => `KES ${value.toLocaleString()}`,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function calculateMonthlyData() {
            const last6Months = [];
            const payments = [];
            const expenses = [];
            
            // Get the last 6 months
            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                last6Months.push(date.toLocaleString('default', { month: 'short' }));
                
                // Calculate total payments for this month
                const monthPayments = calculateMonthlyPayments(date);
                payments.push(monthPayments);
                
                // Calculate total expenses for this month
                const monthExpenses = calculateMonthlyExpenses(date);
                expenses.push(monthExpenses);
            }
            
            return {
                labels: last6Months,
                payments: payments,
                expenses: expenses
            };
        }

        function calculateMonthlyPayments(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            return payments.reduce((total, payment) => {
                const paymentDate = new Date(payment.date);
                if (paymentDate.getFullYear() === year && paymentDate.getMonth() === month) {
                    return total + payment.amount;
                }
                return total;
            }, 0);
        }

        function calculateMonthlyExpenses(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            return clients.reduce((total, client) => {
                return total + (client.expenseItems || []).reduce((clientTotal, expense) => {
                    const expenseDate = new Date(expense.date);
                    if (expenseDate.getFullYear() === year && expenseDate.getMonth() === month) {
                        return clientTotal + expense.amount;
                    }
                    return clientTotal;
                }, 0);
            }, 0);
        }
    </script>
</body>
</html> 