<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%);
            --tertiary-gradient: linear-gradient(135deg, #3f3f42 20%,  #37058f48 10%, #000000 70%);
            --background-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --quad-gradient: linear-gradient(135deg, #3b82f6 30%, #2dd4bf 60%);
            --card-bg: rgba(255, 255, 255, 0.829);
            --glass-bg: rgba(0, 0, 0, 0);
            --sidebar-bg: rgba(31, 41, 55, 0.95);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-tertiary: #e7e5d8;
            --text-primary-light: #ffffff;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-image: url('https://img.freepik.com/free-vector/white-minimal-hexagons-background_79603-1452.jpg?t=st=1738523537~exp=1738527137~hmac=3fbcf7240de7da982ebc9206f2a13fe728553b9eb22c9415c78d13a658b2ee88&w=740');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Update sidebar styles */
        .sidebar {
            background: var(--tertiary-gradient);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: white;
            height: 100vh;
            padding: 0.75rem 0.75rem;
            transition: all 0.3s;
            border-radius: 0 24px 24px 0;
            position: fixed;
            top: 0;
            left: 0;
            width: 16.666667%; /* col-md-2 equivalent */
            display: flex;
            flex-direction: column;
            z-index: 1030;
        }

        .sidebar h3 {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            flex-shrink: 0;
        }

        .sidebar nav {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-height: 0;
        }

        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.7);
            padding: 1rem 1rem;
            border-radius: 22px;
            margin-bottom: 0.25rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
        }

        .sidebar .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .sidebar .nav-link:hover::before {
            opacity: 1;
        }

        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            color: white;
            background: var(--glass-bg);
            transform: translateX(5px);
        }

        .sidebar .nav-link.active {
            background: var(--primary-gradient);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .sidebar .nav-link i {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 11px;
            padding: 1rem;
            transition: all 0.3s;
        }

        .sidebar .nav-link:hover i, .sidebar .nav-link.active i {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .sidebar .nav-link span {
            font-size: 0.95rem;
        }

        /* Update content styles to accommodate fixed sidebar */
        .content {
            padding: 1rem;
            margin-left: 16.666667%; /* Match sidebar width */
            min-height: 100vh;
            background-color: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%) !important;
            transition: margin-left 0.3s;
        }

        /* Responsive adjustments */
        @media (max-width: 1200px) {
            .sidebar {
                width: 20%;
            }
            .content {
                margin-left: 20%;
            }
        }

        @media (max-width: 992px) {
            .sidebar {
                width: 25%;
            }
            .content {
                margin-left: 25%;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
                overflow-y: auto; /* Only allow scrolling on mobile */
            }
            
            .sidebar.show {
                transform: translateX(0);
            }
            
            .content {
                margin-left: 0;
            }
            
            .sidebar nav {
                gap: 0.5rem;
            }
            
            .sidebar .nav-link {
                padding: 1rem 1rem;
                margin-bottom: 0.5rem;
            }
            
            .sidebar .nav-link i {
                margin-right: 10px;
                padding: 0.75rem;
            }
            
            .sidebar h3 {
                font-size: 1.1rem;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
            }
        }

        /* Add toggle button for mobile */
        .sidebar-toggle {
            display: none;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1031;
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 24px;
            cursor: pointer;
            height: 60px;
            width: 60px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2)
        }

        /* Purchase Modal Dropdown Styles */
        .item-search-container {
            position: relative;
        }

        .item-search-container .dropdown-menu {
            position: absolute;
            top: 100% !important;
            left: 0 !important;
            width: 100%;
            margin-top: 2px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: white;
            z-index: 1050;
            transform: none !important;
        }

        .supplier-search-container {
            position: relative;
        }

        .supplier-list {
            position: absolute;
            top: 100% !important;
            left: 0 !important;
            width: 100% !important;
            margin-top: 2px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            background: white;
            z-index: 1050;
            transform: none !important;
            display: none;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .supplier-list.show {
            display: block;
        }

        .supplier-list .dropdown-item {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            margin: 2px;
            transition: all 0.2s ease;
        }

        .supplier-list .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        @media (max-width: 768px) {
            .sidebar-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Base Card Styles */
        .card {
            background: transparent;
            border: none;
            overflow: visible;
            border-radius: 24px !important;
        }

        .card-body {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 1.0rem;
            background: rgba(255, 255, 255, 0.05);
        }

        .card > .card-header {
            background: var(--tertiary-gradient);
            color: white;
            border: none;
            padding: 1.1rem;
            position: relative;
            overflow: hidden;
            z-index: 1;
            border-radius: 24px !important;
            margin-bottom: 1.1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card > .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 100%);
            z-index: -1;
            pointer-events: none;
            border-radius: 24px;
        }

        .btn-add {
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 16px;
            padding: 12px 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(45, 212, 191, 0.3);
        }

        .table {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
        }

        .table th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
            font-weight: 600;
            border: none;
            padding: 12px;
        }

        .table td {
            border-color: rgba(99, 102, 241, 0.1);
            padding: 12px;
            vertical-align: middle;
        }

        .export-btn {
            padding: 0.6rem;
            border: none;
            background: var(--tertiary-gradient);
            color: white;
            font-weight: 500;
            border-radius: 16px;
            height: 45px;
            transition: all 0.3s ease;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
        }

        .action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .action-btn i {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .action-btn i.fa-edit {
            color: var(--text-secondary);
        }

        .action-btn i.fa-trash {
            color: #ef4444;
        }

        input[type="text"], input[type="tel"], select {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            padding: 10px;
            transition: all 0.3s;
        }

        input[type="text"]:focus, input[type="tel"]:focus, select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            outline: none;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            background: var(--tertiary-gradient);
            color: rgb(255, 255, 255);
            border-bottom: none;
            border-radius: 24px 24px 0 0;
        }

        .modal-footer {
            border-top: 1px solid rgba(99, 102, 241, 0.1);
        }

        .form-label {
            color: var(--text-tertiary);
        }

        #registerTable tbody tr {
            transition: all 0.2s ease;
        }

        #registerTable tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
            transform: translateX(5px);
        }

        #clientSearchResults {
            max-height: 200px;
            overflow-y: auto;
        }

        .dropdown-menu {
            border: 1px solid rgba(99, 102, 241, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
        }

        .dropdown-item {
            padding: 0.5rem 1rem;
            transition: all 0.2s;
        }

        .dropdown-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        /* Client Search Styles */
        .client-search-wrapper {
            position: relative;
        }

        .client-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            background: white;
            border: 1px solid rgba(99, 102, 241, 0.1);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
        }

        .client-search-results .dropdown-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: var(--text-primary) !important;
        }

        .client-search-results .dropdown-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .client-search-results .dropdown-item .text-muted {
            color: var(--text-primary) !important;
            opacity: 0.8;
        }

        .client-search-results mark {
            background: rgba(99, 102, 241, 0.2);
            padding: 0.1em 0;
            border-radius: 2px;
            color: var(--text-primary);
        }

        .table-condensed td {
            padding-right: 0;
            max-width: 300px;
        }

        .table-condensed td:first-child {
            width: auto;
            padding-right: 0;
        }

        .table-condensed td:nth-child(2) {
            padding-left: 8px;
        }

        .table-condensed {
            width: 100%;
            table-layout: fixed;
        }

        .table-condensed th:first-child,
        .table-condensed td:first-child {
            width: 40%;
        }

        .table-condensed th:not(:first-child),
        .table-condensed td:not(:first-child) {
            width: 15%;
        }

        .labour-percentage {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 4px;
            padding: 2px 4px;
            min-width: 40px;
            outline: none;
        }

        .labour-percentage:focus {
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            margin: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #e0e0e0;
            transition: 0.4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: var(--primary-gradient);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .modal-body {
            color: white;
        }

        .modal-body .form-label {
            color: white;
        }

        .modal-body .table {
            color: white;
        }

        .modal-body .table th {
            color: rgb(233, 231, 238) !important;
            background: rgba(99, 102, 241, 0.2) !important;
        }

        .modal-body .small.text-muted {
            color: rgba(255, 255, 255, 0.75) !important;
        }

        .modal-body .card-body {
            color: var(--text-primary); 
            border-radius: 24px !important; /* Keep the grand total section text color unchanged */
        }

        .modal-body .table td strong {
            color: white;
        }

        /* Update modal input styles */
        .modal-body input[type="text"],
        .modal-body input[type="tel"],
        .modal-body input[type="number"],
        .modal-body select {
            color: var(--text-primary);
            background: white;
        }

        /* Ensure client search results are visible in modal */
        .modal-body .client-search-results {
            display: none;
            background: white;
            color: rgb(0, 0, 0);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-body .client-search-results .dropdown-item {
            color: rgb(0, 0, 0) !important;
        }

        .modal-body .client-search-results .dropdown-item:hover {
            background: rgba(245, 242, 242, 0.1);
        }

        .modal-body .client-search-results .dropdown-item .text-dark {
            color: rgba(0, 0, 0, 0.9) !important;
        }

        .modal-body .client-search-results mark {
            background: rgba(99, 102, 241, 0.3);
            color: rgb(2, 2, 2);
            padding: 0.1em 0.2em;
            border-radius: 2px;
        }

        /* Modern A4 Document Styles */
        .a4-document {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 10mm;
            margin: 0 auto;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
            position: relative;
            font-size: 12pt;
            color: #000;
            line-height: 1.6;
        }

        /* Hover-triggered action icons for edit quotation view */
        .a4-document .quotation-table tbody tr {
            position: relative;
        }

        .a4-document .quotation-table tbody tr .hover-action {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.2s ease;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border: none;
            cursor: pointer;
            color: #666;
            z-index: 10;
            visibility: hidden;
        }

        .a4-document .quotation-table tbody tr:hover .hover-action {
            opacity: 1;
            visibility: visible;
        }

        .a4-document .quotation-table tbody tr .hover-action.add-row {
            left: -33px;
        }

        .a4-document .quotation-table tbody tr .hover-action.delete-row {
            right: -33px;
        }

        .a4-document .quotation-table tbody tr .hover-action:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .a4-document .quotation-table tbody tr .hover-action.add-row:hover {
            background: var(--primary-gradient);
            color: white;
        }

        .a4-document .quotation-table tbody tr .hover-action.delete-row:hover {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .a4-document .document-header {
            text-align: center;
            margin-bottom: 0;
            padding: 0 0 20px 0;
            border-bottom: 2px solid  #c77036;
            position: relative;
            top: -10mm;
            margin-left: -10mm;
            margin-right: -10mm;
            padding-left: 10mm;
            padding-right: 10mm;
        }

        .a4-document .company-name {
            font-size: 28pt;
            font-weight: 700;
            margin-bottom: 6px;
            letter-spacing: -0.5px;
            background-image: linear-gradient(130deg, #a75a11e3 30%, #ff6600 90%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .a4-document .company-details {
            color: #666;
            font-size: 12pt;
            line-height: 1.4;
        }

        .a4-document .document-info {
            display: flex;
            justify-content: space-around;
            gap: 80px;
            position: relative;
            top: -10mm;
            margin-left: -10mm;
            margin-right: -10mm;
            padding: 20px 10mm 0;
            background: white;
        }

        .a4-document .document-info-group {
            flex: 1;
        }

        .a4-document .document-info-group h3 {
            font-size: 18pt;
            font-weight: 600;
            margin-bottom: 0px;
            color:  #666;
        }

        .a4-document .info-row {
            display: flex;
            align-items: left;
            margin-bottom: 0px;
            gap: 6px;
        }

        .a4-document .info-label {
            min-width: 100px;
            color: #666;
            flex: 1;
            background: transparent;
            border: none;
            padding: 4px 0;
            font-size: 11pt;
            transition: border-color 0.2s;
        }

        .a4-document .info-value {
            flex: 1;
            background: transparent;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            padding: 4px 0;
            font-size: 11pt;
            color: #1a1a1a;
            transition: border-color 0.2s;
        }

        .a4-document .info-value:focus {
            outline: none;
            border-bottom-color: #6366f1;
        }

        .a4-document .info-value[readonly] {
            background: transparent;
            border-bottom: 1px solid #e0e0e0;
        }

        .a4-document .section-title {
            font-size: 14pt;
            font-weight: 600;
            color: #1a1a1a;
            margin: 30px 0 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .a4-document .section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #f0f0f0;
        }

        .a4-document .quotation-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
        }

        .a4-document .quotation-table th {
            background: #f8f9fa;
            color: #666;
            text-align: left;
            font-weight: 600;
            font-size: 11pt;
            border-bottom: 2px solid #e9ecef;
            padding: 12px;
        }

        .a4-document .quotation-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            background: transparent;
        }

        .a4-document .quotation-table th:nth-child(1),
        .a4-document .quotation-table td:nth-child(1) {
            width: 33.33%; /* 4/12 */
        }

        .a4-document .quotation-table th:nth-child(2),
        .a4-document .quotation-table td:nth-child(2) {
            width: 16.67%; /* 2/12 */
        }

        .a4-document .quotation-table th:nth-child(3),
        .a4-document .quotation-table td:nth-child(3) {
            width: 16.67%; /* 2/12 */
        }

        .a4-document .quotation-table th:nth-child(4),
        .a4-document .quotation-table td:nth-child(4) {
            width: 16.67%; /* 2/12 */
        }

        .a4-document .quotation-table th:nth-child(5),
        .a4-document .quotation-table td:nth-child(5) {
            width: 16.67%; /* 2/12 */
        }

        .a4-document .quotation-table input {
            width: 100%;
            background: transparent;
            border: none;
            padding: 4px 0;
            color: #1a1a1a;
            font-size: 11pt;
        }

        .a4-document .quotation-table input:focus {
            outline: none;
            background: rgba(99, 102, 241, 0.05);
        }

        .a4-document .quotation-table tr:hover {
            background: rgba(248, 249, 250, 0.5);
        }

        .a4-document .totals-section {
            margin-top: 40px;
            margin-left: auto;
            width: 300px;
        }

        .a4-document .total-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 11pt;
            color: #666;
        }

        .a4-document .total-row.grand-total {
            font-weight: 700;
            font-size: 14pt;
            color: #1a1a1a;
            border-top: 2px solid #e9ecef;
            margin-top: 8px;
            padding-top: 16px;
        }

        .a4-document .terms-section {
            margin-top: 60px;
            color: #666;
            font-size: 11pt;
        }

        .a4-document .terms-section h5 {
            color: #1a1a1a;
            font-size: 12pt;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .a4-document .terms-section ol {
            padding-left: 20px;
            line-height: 1.6;
        }

        .a4-document .labour-percentage {
            width: 100% !important;
            text-align: left;
            background: transparent;
            border: none;
            border-bottom: 1px solid #e0e0e0;
            color: #1a1a1a;
            font-size: 11pt;
            padding: 4px 0;
        }

        .a4-document .labour-percentage:focus {
            outline: none;
            border-bottom-color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
        }

        .a4-document .toggle-switch-container {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #666;
            font-size: 11pt;
        }

        /* Update modal styles for A4 layout */
        .modal.a4-modal .modal-dialog {
            max-width: 210mm;
            margin: 20px auto;
            padding: 0;
        }

        .modal.a4-modal .modal-content {
            background: #f8f9fa;
            border: none;
            border-radius: 12px;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            padding: 0;
            margin: 0;
        }

        .modal.a4-modal .modal-body {
            padding: 0;
            margin: 0;
            background: white;
            width: 100%;
        }

        .modal.a4-modal .modal-header {
            border-radius: 12px 12px 0 0;
            padding: 20px;
            background: var(--tertiary-gradient);
            margin: 0;
            width: 100%;
        }

        .modal.a4-modal .modal-footer {
            border-radius: 0 0 12px 12px;
            padding: 20px;
            background: white;
            margin: 0;
            width: 100%;
        }

        .modal.a4-modal .a4-document {
            width: 100%;
            margin: 0;
            box-shadow: none;
            border-radius: 0;
            padding: 10mm;
        }

        .modal.a4-modal form.a4-document {
            background: white;
        }

        .a4-document .quotation-table tfoot tr td {
            border: none;
            padding: 8px 12px;
            background: transparent;
        }

        .a4-document .quotation-table tfoot tr:first-child td {
            padding-top: 16px;
        }

        .a4-document .quotation-table tfoot tr:last-child td {
            padding-bottom: 16px;
        }

        /* Add this after your existing styles */
        .modal#makePaymentModal .form-control,
        .modal#makePaymentModal .form-select,
        .modal#makePaymentModal .input-group {
            border-radius: 16px;
            height: 45px;
        }

        .modal#makePaymentModal .input-group-text {
            border-radius: 16px 0 0 16px;
            border: none;
            background: #f8f9fa;
        }

        .modal#makePaymentModal .input-group .form-control {
            border-radius: 0 16px 16px 0;
        }

        .modal#makePaymentModal .input-group .btn-light {
            border-radius: 16px;
            margin-left: 8px;
            background: #f8f9fa;
            border: none;
            width: 45px;
            height: 45px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal#makePaymentModal table input.form-control,
        .modal#makePaymentModal table select.form-select {
            width: 100%;
            height: 45px;
        }

        .modal#makePaymentModal .client-search-results {
            border-radius: 16px;
            margin-top: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .modal#makePaymentModal .client-search-results .dropdown-item:first-child {
            border-radius: 16px 16px 0 0;
        }

        .modal#makePaymentModal .client-search-results .dropdown-item:last-child {
            border-radius: 0 0 16px 16px;
        }

        /* Payment Section Specific Styles */
        #paymentsSection .table th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
            font-weight: 600;
            border: none;
            padding: 12px;
        }

        #paymentsSection .table td {
            border-color: rgba(99, 102, 241, 0.1);
            padding: 12px;
            vertical-align: middle;
        }

        #paymentsSection .table tbody tr {
            transition: all 0.2s ease;
        }

        #paymentsSection .table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
            transform: translateX(5px);
        }

        #paymentsSection .action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            background: none;
            color: var(--text-secondary);
        }

        #paymentsSection .action-btn:hover {
            background: rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        #paymentsSection .action-btn i {
            font-size: 1rem;
            color: var(--text-secondary);
        }

        /* Payment Filter Styles */
        #paymentsSection .input-group-text,
        #paymentsSection .form-control,
        #paymentsSection .form-select,
        #paymentsSection .export-btn {
            height: 45px !important;
            display: flex;
            align-items: center;
        }

        #paymentsSection .input-group {
            height: 45px !important;
        }

        #paymentsSection .input-group-text {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 16px;
        }

        #paymentsSection .form-control,
        #paymentsSection .form-select {
            padding: 0 16px;
        }

        #paymentsSection .export-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 500;
        }

        /* Add this to your existing styles */
        .btn-add.active {
            background: linear-gradient(135deg, #4c00ff 0%, #830bf3 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

         /* Stock Section Styles */
         .stock-summary-card {
            border: none;
            border-radius: 24px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .stock-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .stock-summary-card .card-body {
            padding: 1.5rem;
        }

        .stock-summary-card .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stock-summary-card .icon-box i {
            font-size: 1.5rem;
            color: white;
        }

        .stock-summary-card.total-items {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }

        .stock-summary-card.in-stock {
            background: linear-gradient(135deg, #00ff37 0%, #328a32 100%);
        }

        .stock-summary-card.low-stock {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .stock-summary-card.out-of-stock {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .stock-summary-card h6 {
            font-size: 0.875rem;
            font-weight: 500;
            opacity: 0.9;
        }

        .stock-summary-card h2 {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .stock-summary-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .stock-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .stock-summary-card.active {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .stock-summary-card.active::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 2px;
        }
        .supplier-dropdown:hover {
        background: var(--primary-gradient) !important;
        }
    
        .supplier-dropdown:hover i {
        color: white !important;
        }
        .item-dropdown:hover {
        background: var(--primary-gradient) !important;
        }
    
        .item-dropdown:hover i {
        color: white !important;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar">
                <h3>
                    <i class="fas fa-chart-line me-2"></i>
                    Dashboard
                </h3>
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#" data-section="registerSection">
                        <i class="fas fa-user-plus"></i>
                        <span>Register</span>
                    </a>
                    <a class="nav-link" href="#" data-section="salesSection">
                        <i class="fas fa-cart-shopping"></i>
                        <span>Sales</span>
                    </a>
                    <a class="nav-link" href="#" data-section="paymentsSection">
                        <i class="fas fa-money-bill-alt"></i>
                        <span>Payments</span>
                    </a>
                    <a class="nav-link" href="#" data-section="expensesSection">
                        <i class="fas fa-money-bill-wave"></i>
                        <span>Expenses</span>
                    </a>
                    <a class="nav-link" href="#" data-section="purchasesSection">
                        <i class="fas fa-shopping-basket"></i>
                        <span>Purchases</span>
                    </a>
                    <a class="nav-link" href="#" data-section="stockSection">
                        <i class="fas fa-boxes"></i>
                        <span>Stock</span>
                    </a>
                    <a class="nav-link" href="#" data-section="reportsSection">
                        <i class="fas fa-file-alt"></i>
                        <span>Reports</span>
                    </a>
                    <a class="nav-link" href="#" data-section="analyticsSection">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </a>
                </nav>
                <div class="text-center text-white-50 small">
                    <p class="mb-0">© 2025 Client Management</p>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-md-10 content">
                <!-- Register Section -->
                <div id="registerSection" class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Register Management</h2>
                            <div class="d-flex gap-2">
                                <button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newClientModal">
                                    <i class="fas fa-user-plus me-2"></i>
                                    Add New Client
                                </button>
                                <button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newSupplierModal">
                                    <i class="fas fa-truck me-2"></i>
                                    Add New Supplier
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0 py-2" id="registerSearch" 
                                        placeholder="Search..." oninput="filterRegisterTable()" 
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="registerTypeFilter" onchange="filterRegisterTable()"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Types</option>
                                    <option value="client">Clients</option>
                                    <option value="supplier">Suppliers</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 py-2 shadow-sm" id="registerLocationFilter" onchange="filterRegisterTable()"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Locations</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportRegisterData()"
                                    style="border-radius: 16px; height: 45px; transition: all 0.3s ease;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Register Table -->
                        <div class="table-responsive">
                            <table class="table" id="registerTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Phone Number</th>
                                        <th>Location</th>
                                        <th>PIN Number</th>
                                        <th>Date Added</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sales Section -->
                <div id="salesSection" class="card" style="display: none;">
                    <!-- Main Sales Header -->
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Sales Management</h2>
                            <div class="d-flex gap-2">
                                <button class="btn btn-add" onclick="showQuotationsView()" id="quotationsBtn">
                                    <i class="fas fa-file-invoice me-2"></i>
                                    Quotation
                                </button>
                                <button class="btn btn-add" onclick="showSalesOrderView()" id="salesOrderBtn">
                                    <i class="fas fa-clipboard-list me-2"></i>
                                    Sales Order
                                </button>
                                <button class="btn btn-add"  onclick="showinvoiceView()" id="invoiceBtn">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>
                                    Invoice
                                </button>
                                <button class="btn btn-add" onclick="showCashSaleView()" id="cashSaleBtn">
                                    <i class="fas fa-cash-register me-2"></i>
                                    Cash Sale
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Quotations View -->
                    <div id="quotationsView" class="card-body">
                        <!-- Add New Quotation Button -->
                        <div class="d-flex mb-4">
                            <button class="btn btn-add" onclick="showNewQuotationModal()">
                                <i class="fas fa-plus me-2"></i>
                                Add New Quotation
                            </button>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0" id="quotationSearch" 
                                        placeholder="Search quotations..." oninput="filterQuotations()"
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="quotationClientFilter" 
                                    onchange="filterQuotations()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="quotationDateFilter" 
                                    onchange="handleDateFilter('quotation')" 
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                    <option value="period">Specific Period</option>
                                </select>
                                <input type="date" id="quotationSpecificDate" class="form-control border-0 shadow-sm mt-2" 
                                    style="display: none; border-radius: 16px; height: 45px;" onchange="filterQuotations()">
                                <div id="quotationPeriodDates" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="quotationPeriodStartDate" class="form-control" onchange="filterQuotations()">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="quotationPeriodEndDate" class="form-control" onchange="filterQuotations()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportQuotations()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Quotations Table -->
                        <div class="table-responsive">
                            <table class="table" id="quotationsTable">
                                <thead>
                                    <tr>
                                        <th>Quotation #</th>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Sales Order View -->
                    <div id="salesOrderView" class="card-body" style="display: none;">
                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0" id="salesOrderSearch" 
                                        placeholder="Search orders..." oninput="filterSalesOrders()"
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="salesOrderClientFilter" 
                                    onchange="filterSalesOrders()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="salesOrderDateFilter" 
                                    onchange="handleDateFilter('salesOrder')" 
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                    <option value="period">Specific Period</option>
                                </select>
                                <input type="date" id="salesOrderSpecificDate" class="form-control border-0 shadow-sm mt-2" 
                                    style="display: none; border-radius: 16px; height: 45px;" onchange="filterSalesOrders()">
                                <div id="salesOrderPeriodDates" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="salesOrderPeriodStartDate" class="form-control" onchange="filterSalesOrders()">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="salesOrderPeriodEndDate" class="form-control" onchange="filterSalesOrders()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportSalesOrders()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Sales Orders Table -->
                        <div class="table-responsive">
                            <table class="table" id="salesOrdersTable">
                                <thead>
                                    <tr>
                                        <th>Order #</th>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Total Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- invoice View -->

                <div id="invoiceView" class="card-body" style="display: none;">
                    <!-- Search and Filter Controls -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="input-group shadow-sm">
                                <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0" id="invoiceSearch" 
                                    placeholder="Search invoices..." oninput="filterInvoices()"
                                    style="border-radius: 0 16px 16px 0; height: 45px;">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select border-0 shadow-sm" id="invoiceClientFilter" 
                                onchange="filterInvoices()"
                                style="border-radius: 16px; height: 45px;">
                                <option value="">All Clients</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select border-0 shadow-sm" id="invoiceDateFilter" 
                                onchange="handleDateFilter('invoice')"
                                style="border-radius: 16px; height: 45px;">
                                <option value="">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                                <option value="specific">Specific Date</option>
                                <option value="period">Specific Period</option>
                            </select>
                            <input type="date" id="invoiceSpecificDate" class="form-control border-0 shadow-sm mt-2" style="display: none; border-radius: 16px; height: 45px;"
                            onchange="filterInvoices()">
                            <div id="invoicePeriodDates" style="display: none;">
                                <div class="input-group mt-2">
                                    <span class="input-group-text">From</span>
                                    <input type="date" id="invoicePeriodStartDate" class="form-control" onchange="filterInvoices()">
                                    <span class="input-group-text">To</span>
                                    <input type="date" id="invoicePeriodEndDate" class="form-control" onchange="filterInvoices()">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn w-100 shadow-sm export-btn" onclick="exportInvoices()" 
                                style="border-radius: 16px; height: 45px;">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Invoices Table -->
                    <div class="table-responsive">
                        <table class="table" id="invoicesTable">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Total Amount</th>
                                    <th>Balance</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Invoice data will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Cash Sale View -->
                <div id="cashSaleView" class="card-body" style="display: none;">
                    <!-- Search and Filter Controls -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="input-group shadow-sm">
                                <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                    <i class="fas fa-search text-muted"></i>
                                </span>
                                <input type="text" class="form-control border-0" id="cashSaleSearch" 
                                    placeholder="Search cash sales..." oninput="filterCashSales()"
                                    style="border-radius: 0 16px 16px 0; height: 45px;">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select border-0 shadow-sm" id="cashSaleClientFilter" 
                                onchange="filterCashSales()"
                                style="border-radius: 16px; height: 45px;">
                                <option value="">All Clients</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select border-0 shadow-sm" id="cashSaleDateFilter" 
                                onchange="handleDateFilter('cashSale')"
                                style="border-radius: 16px; height: 45px;">
                                <option value="">All Dates</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="year">This Year</option>
                                <option value="specific">Specific Date</option>
                                <option value="period">Specific Period</option>
                            </select>
                            <input type="date" id="cashSaleSpecificDate" class="form-control border-0 shadow-sm mt-2" style="display: none; border-radius: 16px; height: 45px;"
                            onchange="filterCashSales()">
                            <div id="cashSalePeriodDates" style="display: none;">
                                <div class="input-group mt-2">
                                    <span class="input-group-text">From</span>
                                    <input type="date" id="cashSalePeriodStartDate" class="form-control" onchange="filterCashSales()">
                                    <span class="input-group-text">To</span>
                                    <input type="date" id="cashSalePeriodEndDate" class="form-control" onchange="filterCashSales()">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button class="btn w-100 shadow-sm export-btn" onclick="exportCashSales()" 
                                style="border-radius: 16px; height: 45px;">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                        </div>
                    </div>

                    <!-- Cash Sales Table -->
                    <div class="table-responsive">
                        <table class="table" id="cashSalesTable">
                            <thead>
                                <tr>
                                    <th>Receipt #</th>
                                    <th>Date</th>
                                    <th>Client</th>
                                    <th>Total Amount</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Cash sale data will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payments Section -->
                <div id="paymentsSection" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Payments Management</h2>
                            <div class="d-flex gap-3">
                                <button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#makePaymentModal">
                                    <i class="fas fa-money-bill me-2"></i>
                                    Make Payment
                                </button>
                                <button class="btn btn-add">
                                    <i class="fas fa-file-invoice-dollar me-2"></i>
                                    Account Summary
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0" id="paymentsSearch" 
                                        placeholder="Search payments..." oninput="filterPayments()"
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="paymentClientFilter" 
                                    onchange="filterPayments()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="paymentsDateFilter" 
                                    onchange="handleDateFilter('payments')" 
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                    <option value="period">Specific Period</option>
                                </select>
                                <input type="date" id="paymentsSpecificDate" class="form-control border-0 shadow-sm mt-2" 
                                    style="display: none; border-radius: 16px; height: 45px;" onchange="filterPayments()">
                                <div id="paymentsPeriodDates" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="paymentsPeriodStartDate" class="form-control" onchange="filterPayments()">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="paymentsPeriodEndDate" class="form-control" onchange="filterPayments()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportPaymentsReport()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Payments Table -->
                        <div class="table-responsive">
                            <table class="table" id="paymentsTable">
                                <thead>
                                    <tr>
                                        <th>Payment #</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Paid To</th>
                                        <th>Description</th>
                                        <th>Amount</th>
                                        <th>Account Credited</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Payment data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Make Payment Modal -->
                <div class="modal fade" id="makePaymentModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Make Payment</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="paymentForm">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="position-relative">
                                                <label class="form-label">Client</label>
                                                <div class="client-search-wrapper">
                                                    <div class="input-group">
                                                        <span class="input-group-text">
                                                            <i class="fas fa-search"></i>
                                                        </span>
                                                        <input type="text" class="form-control" id="paymentClientSearch" 
                                                            placeholder="Search client..." autocomplete="off" required>
                                                        <button class="btn btn-light" type="button" onclick="togglePaymentClientDropdown()">
                                                            <i class="fas fa-chevron-down"></i>
                                                        </button>
                                                    </div>
                                                    <div class="client-search-results" id="paymentClientSearchResults">
                                                        <!-- Client suggestions will be added here -->
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Payment Date</label>
                                            <input type="date" class="form-control" id="paymentDate" required>
                                        </div>
                                    </div>

                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <colgroup>
                                                <col style="width: 35%;">
                                                <col style="width: 20%;">
                                                <col style="width: 25%;">
                                                <col style="width: 20%;">
                                            </colgroup>
                                            <thead>
                                                <tr>
                                                    <th>Description</th>
                                                    <th>Amount</th>
                                                    <th>Paid To</th>
                                                    <th>Account Credited</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>
                                                        <input type="text" class="form-control" name="description" required>
                                                    </td>
                                                    <td>
                                                        <input type="number" class="form-control" name="amount" step="0.01" required>
                                                    </td>
                                                    <td>
                                                        <select class="form-select" name="paidTo" required>
                                                            <option value="">Select Quotation</option>
                                                        </select>
                                                    </td>
                                                    <td>
                                                        <select class="form-select" name="account" required>
                                                            <option value="">Select Account</option>
                                                            <option value="kim">Kim</option>
                                                            <option value="david">David</option>
                                                            <option value="bank">Bank</option>
                                                        </select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-add" onclick="savePayment()">Save Payment</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Purchases Section -->
                <div id="purchasesSection" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Purchase Management</h2>
                            <button type="button" class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newPurchaseModal">
                                <i class="fas fa-shopping-basket"></i>
                                Add New Purchase
                            </button>
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0" id="purchaseSearch" 
                                        placeholder="Search purchases..." oninput="filterPurchases(); renderPurchasesTable();"
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="supplierFilter" 
                                    onchange="filterPurchases(); renderPurchasesTable();"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Suppliers</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="purchasesDateFilter" 
                                    onchange="handleDateFilter('purchases')"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                    <option value="period">Specific Period</option>
                                </select>
                                <input type="date" id="purchasesSpecificDate" class="form-control border-0 shadow-sm mt-2" 
                                    style="display: none; border-radius: 16px; height: 45px;"
                                    onchange="filterPurchases(); renderPurchasesTable();">
                                <div id="purchasesPeriodDates" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="purchasesPeriodStartDate" class="form-control" 
                                            onchange="filterPurchases(); renderPurchasesTable();">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="purchasesPeriodEndDate" class="form-control" 
                                            onchange="filterPurchases(); renderPurchasesTable();">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportPurchaseReport()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Purchases Table -->
                        <div class="table-responsive">
                            <table class="table" id="purchasesTable">
                                <thead>
                                    <tr>
                                        <th>Order Number</th>
                                        <th>Date</th>
                                        <th>Supplier</th>
                                        <th>Items</th>
                                        <th>Total Amount</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Purchase data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Stock Section -->
                <div id="stockSection" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Stock Management</h2>
                            <div class="d-flex gap-3">
                                <button class="btn btn-add" data-bs-toggle="modal" data-bs-target="#newStockItemModal">
                                    <i class="fas fa-box-open me-2"></i>
                                    Add New Item
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Stock Summary Cards -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card stock-summary-card total-items" onclick="filterByCard('all')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Total Items</h6>
                                                <h2 class="mb-0 text-white" id="totalItems">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-boxes"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stock-summary-card in-stock" onclick="filterByCard('inStock')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">In Stock</h6>
                                                <h2 class="mb-0 text-white" id="inStock">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stock-summary-card low-stock" onclick="filterByCard('lowStock')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Low Stock</h6>
                                                <h2 class="mb-0 text-white" id="lowStock">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-exclamation-triangle"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card stock-summary-card out-of-stock" onclick="filterByCard('outOfStock')" style="cursor: pointer;">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="text-white mb-1">Out of Stock</h6>
                                                <h2 class="mb-0 text-white" id="outOfStock">0</h2>
                                            </div>
                                            <div class="icon-box">
                                                <i class="fas fa-times-circle"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0" id="stockSearch" 
                                        placeholder="Search stock..." oninput="filterStock()"
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="stockCategoryFilter" 
                                    onchange="filterStock()"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="stockDateFilter" 
                                    onchange="handleDateFilter('stock')"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Dates</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                    <option value="period">Specific Period</option>
                                </select>
                                <input type="date" id="stockSpecificDate" class="form-control border-0 shadow-sm mt-2" 
                                    style="display: none; border-radius: 16px; height: 45px;" onchange="filterStock()">
                                <div id="stockPeriodDates" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="stockPeriodStartDate" class="form-control" onchange="filterStock()">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="stockPeriodEndDate" class="form-control" onchange="filterStock()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportStockToPDF()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Stock Table -->
                        <div class="table-responsive">
                            <table class="table" id="stockTable">
                                <thead>
                                    <tr>
                                        <th>Item Code</th>
                                        <th>Product</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total Value</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Stock data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <!-- expenses Section -->
                 <div id="expensesSection" class="card" style="display: none;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h2 class="mb-0">Expenses Management</h2>
                            <div class="d-flex gap-3">
                                <button class="btn btn-add active" id="clientExpensesTabBtn" onclick="switchExpensesTab('client')">
                                    <i class="fas fa-user-tag me-2"></i>
                                    Client Expenses
                                </button>
                                <button class="btn btn-add" id="companyExpensesTabBtn" onclick="switchExpensesTab('company')">
                                    <i class="fas fa-building me-2"></i>
                                    Company Expenses
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body" id="clientExpensesContent">
                         <!-- Add New Client Button -->
                         <div class="d-flex mb-4">
                            <button class="btn btn-add" onclick="showclientExpensesModal()">
                                <i class="fas fa-plus me-2"></i>
                                Add New Client Expenses
                            </button>
                        </div>
                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0" id="clientExpensesSearch" 
                                        placeholder="Search client expenses..." oninput="filterClientExpenses()"
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="clientExpensesTypeFilter" 
                                    onchange="filterClientExpenses()"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Clients</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="clientExpensesDateFilter" 
                                    onchange="handleDateFilter('clientExpenses')"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                    <option value="period">Specific Period</option>
                                </select>
                                <input type="date" id="clientExpensesSpecificDate" class="form-control border-0 shadow-sm mt-2" 
                                    style="display: none; border-radius: 16px; height: 45px;" onchange="filterClientExpenses()">
                                <div id="clientExpensesPeriodDates" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="clientExpensesPeriodStartDate" class="form-control" onchange="filterClientExpenses()">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="clientExpensesPeriodEndDate" class="form-control" onchange="filterClientExpenses()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportclientExpensesReport()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Client Expenses Table -->
                        <div class="table-responsive">
                            <table class="table" id="clientExpensesTable">
                                <thead>
                                    <tr>
                                        <th>Expense #</th>
                                        <th>Date</th>
                                        <th>Client</th>
                                        <th>Description</th>
                                        <th>Unit</th>
                                        <th>Quantity</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                        <th>Account debited</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Client Expenses data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-body" id="companyExpensesContent" style="display: none;">
                         <!-- Add New Company Expense Button -->
                         <div class="d-flex mb-4">
                            <button class="btn btn-add" onclick="showCompanyExpensesModal()">
                                <i class="fas fa-plus me-2"></i>
                                Add New Company Expense
                            </button>
                        </div>
                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text" class="form-control border-0" id="companyExpensesSearch" 
                                        placeholder="Search company expenses..." oninput="filterCompanyExpenses()"
                                        style="border-radius: 0 16px 16px 0; height: 45px;">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="companyExpensesTypeFilter" 
                                    onchange="filterCompanyExpenses()"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="">All Categories</option>
                                    <option value="utilities">Utilities</option>
                                    <option value="rent">Rent</option>
                                    <option value="supplies">Office Supplies</option>
                                    <option value="perdm">Fare,meals&Accomodation</option>
                                    <option value="salaries">Salaries & Wages</option>
                                    <option value="maintenance">Repair & Maintenance</option>
                                    <option value="fuel">Fuel</option>
                                    <option value="other">Miscellaneous</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select border-0 shadow-sm" id="companyExpensesDateFilter" 
                                    onchange="handleDateFilter('companyExpenses')"
                                    style="border-radius: 16px; height: 45px;">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="year">This Year</option>
                                    <option value="specific">Specific Date</option>
                                    <option value="period">Specific Period</option>
                                </select>
                                <input type="date" id="companyExpensesSpecificDate" class="form-control border-0 shadow-sm mt-2" 
                                    style="display: none; border-radius: 16px; height: 45px;" onchange="filterCompanyExpenses()">
                                <div id="companyExpensesPeriodDates" style="display: none;">
                                    <div class="input-group mt-2">
                                        <span class="input-group-text">From</span>
                                        <input type="date" id="companyExpensesPeriodStartDate" class="form-control" onchange="filterCompanyExpenses()">
                                        <span class="input-group-text">To</span>
                                        <input type="date" id="companyExpensesPeriodEndDate" class="form-control" onchange="filterCompanyExpenses()">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button class="btn w-100 shadow-sm export-btn" onclick="exportCompanyExpensesReport()" 
                                    style="border-radius: 16px; height: 45px;">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>

                        <!-- Company Expenses Table -->
                        <div class="table-responsive">
                            <table class="table" id="companyExpensesTable">
                                <thead>
                                    <tr>
                                        <th>Expense #</th>
                                        <th>Date</th>
                                        <th>Department</th>
                                        <th>Category</th>
                                        <th>Description</th>
                                        <th>Unit</th>
                                        <th>Quantity</th>
                                        <th>Rate</th>
                                        <th>Amount</th>
                                        <th>Account debited</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Company Expenses data will be dynamically added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
    <!-- all purchase,stock and expenses modals will be added here -->
    <div id="analyticsSection" class="card" style="display: none;">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Analytics Dashboard</h2>
                <div class="d-flex gap-2">
                    <select class="form-select shadow-sm" id="analyticsDateRange" style="border-radius: 16px; height: 45px; width: 200px;">
                        <option value="week">Last 7 Days</option>
                        <option value="month" selected>Last 30 Days</option>
                        <option value="quarter">Last 90 Days</option>
                        <option value="year">Last 365 Days</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Analytics Overview Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-white mb-0">Total Sales</h6>
                                <div class="icon-box" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-line text-white"></i>
                                </div>
                            </div>
                            <h3 class="text-white mb-1" id="totalSalesAmount">KES 0.00</h3>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-white text-primary me-2" id="salesGrowthBadge">+0%</span>
                                <small class="text-white opacity-75">vs previous period</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #3b82f6 0%, #2dd4bf 100%);">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-white mb-0">Total Expenses</h6>
                                <div class="icon-box" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-money-bill-wave text-white"></i>
                                </div>
                            </div>
                            <h3 class="text-white mb-1" id="totalExpensesAmount">KES 0.00</h3>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-white text-primary me-2" id="expensesGrowthBadge">+0%</span>
                                <small class="text-white opacity-75">vs previous period</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-white mb-0">Net Profit</h6>
                                <div class="icon-box" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-wallet text-white"></i>
                                </div>
                            </div>
                            <h3 class="text-white mb-1" id="netProfitAmount">KES 0.00</h3>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-white text-primary me-2" id="profitGrowthBadge">+0%</span>
                                <small class="text-white opacity-75">vs previous period</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none; background: linear-gradient(135deg, #10b981 0%, #34d399 100%);">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-white mb-0">New Clients</h6>
                                <div class="icon-box" style="background: rgba(255, 255, 255, 0.2); border-radius: 12px; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-users text-white"></i>
                                </div>
                            </div>
                            <h3 class="text-white mb-1" id="newClientsCount">0</h3>
                            <div class="d-flex align-items-center">
                                <span class="badge bg-white text-primary me-2" id="clientsGrowthBadge">+0%</span>
                                <small class="text-white opacity-75">vs previous period</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Charts Row -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="card-title mb-0">Sales & Expenses Trend</h5>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-outline-primary active" data-period="daily">Daily</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-period="weekly">Weekly</button>
                                    <button type="button" class="btn btn-sm btn-outline-primary" data-period="monthly">Monthly</button>
                                </div>
                            </div>
                            <div>
                                <canvas id="salesExpensesChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-4">Sales Distribution</h5>
                            <div>
                                <canvas id="salesDistributionChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    
            <!-- Bottom Charts Row -->
            <div class="row">
                <div class="col-md-4">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-4">Top Clients</h5>
                            <div>
                                <canvas id="topClientsChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-4">Expense Categories</h5>
                            <div>
                                <canvas id="expenseCategoriesChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <h5 class="card-title mb-4">Stock Value</h5>
                            <div>
                                <canvas id="stockValueChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="reportsSection" class="card" style="display: none;">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Reports</h2>
            </div>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Sales Reports</h5>
                                <div class="icon-box" style="background: rgba(99, 102, 241, 0.1); border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-line" style="color: #6366f1; font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <p class="card-text text-muted mb-4">Generate comprehensive sales reports by time period, client, or product category.</p>
                            <div class="d-grid">
                                <button class="btn btn-primary" onclick="generateSalesReport()">Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Expense Reports</h5>
                                <div class="icon-box" style="background: rgba(239, 68, 68, 0.1); border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-money-bill-wave" style="color: #ef4444; font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <p class="card-text text-muted mb-4">Track and analyze expenses by category, department, or date range.</p>
                            <div class="d-grid">
                                <button class="btn btn-danger" onclick="generateExpenseReport()">Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Inventory Reports</h5>
                                <div class="icon-box" style="background: rgba(16, 185, 129, 0.1); border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-boxes" style="color: #10b981; font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <p class="card-text text-muted mb-4">Track inventory levels, movement, and valuation by category or item.</p>
                            <div class="d-grid">
                                <button class="btn btn-success" onclick="generateInventoryReport()">Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Client Reports</h5>
                                <div class="icon-box" style="background: rgba(59, 130, 246, 0.1); border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-users" style="color: #3b82f6; font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <p class="card-text text-muted mb-4">Analyze client activity, sales history, and outstanding balances.</p>
                            <div class="d-grid">
                                <button class="btn btn-info" onclick="generateClientReport()">Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Financial Summary</h5>
                                <div class="icon-box" style="background: rgba(245, 158, 11, 0.1); border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-wallet" style="color: #f59e0b; font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <p class="card-text text-muted mb-4">Get full financial summaries including profit & loss statements and balance sheets.</p>
                            <div class="d-grid">
                                <button class="btn btn-warning text-white" onclick="generateFinancialReport()">Generate Report</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm h-100" style="border-radius: 16px; border: none;">
                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Custom Reports</h5>
                                <div class="icon-box" style="background: rgba(236, 72, 153, 0.1); border-radius: 12px; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-cogs" style="color: #ec4899; font-size: 1.25rem;"></i>
                                </div>
                            </div>
                            <p class="card-text text-muted mb-4">Create custom reports with your specific requirements and filters.</p>
                            <div class="d-grid">
                                <button class="btn btn-secondary" onclick="generateCustomReport()">Create Custom Report</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Client Modal -->
    <div class="modal fade" id="newClientModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Client</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newClientForm">
                        <div class="mb-3">
                            <label for="clientName" class="form-label">Client Name</label>
                            <input type="text" class="form-control" id="clientName" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="clientPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="clientPin" class="form-label">PIN Number</label>
                            <input type="text" class="form-control" id="clientPin" placeholder="Optional">
                        </div>
                        <div class="mb-3">
                            <label for="clientLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="clientLocation" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-add" onclick="saveClient()">Save Client</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Expenses Modal -->
    <div class="modal fade" id="clientExpensesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Add New Client Expenses</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="clientExpensesForm">
                        <!-- Client Selection Section -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Client</label>
                                    <div class="position-relative">
                                        <div class="input-group shadow-sm">
                                            <input type="text" class="form-control border-0" 
                                                id="expenseClientSearch" 
                                                placeholder="Search client..."
                                                style="border-radius: 16px 0 0 16px; height: 45px; padding-left: 15px;"
                                                autocomplete="off"
                                                required>
                                            <button class="btn btn-light border-0 dropdown-toggle" type="button" 
                                                onclick="toggleExpenseClientDropdown()"
                                                style="border-radius: 0 16px 16px 0; height: 45px; background: white;">
                                                <i class="fas fa-user-tag text-muted"></i>
                                            </button>
                                        </div>
                                        <div id="expenseClientSearchResults" 
                                            class="shadow-sm" 
                                            style="display: none; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000; background: white; border-radius: 16px; margin-top: 5px; border: 1px solid #e0e0e0;">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Quotation</label>
                                    <select class="form-select border-0 shadow-sm" 
                                        id="expenseQuotationSelect"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                        <option value="">Select Quotation</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Expense Details Section -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-control border-0 shadow-sm" 
                                        id="expenseDate" 
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Account Debited</label>
                                    <select class="form-select border-0 shadow-sm" 
                                        id="expenseAccount"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                        <option value="">Select Account</option>
                                        <option value="David">David</option>
                                        <option value="Kim">Kim</option>
                                        <option value="bank">Bank</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Expense Items Section -->
                        <div class="mb-4">
                            <label class="form-label">Expense Items</label>
                            <div id="expenseItemsContainer">
                                <div class="expense-item mb-3">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control border-0 shadow-sm description" 
                                                placeholder="Description"
                                                style="border-radius: 16px; height: 45px;"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" class="form-control border-0 shadow-sm unit" 
                                                placeholder="Unit"
                                                style="border-radius: 16px; height: 45px;"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control border-0 shadow-sm quantity" 
                                                placeholder="Quantity" 
                                                min="1"
                                                style="border-radius: 16px; height: 45px;"
                                                onchange="updateExpenseItemTotal(this)"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control border-0 shadow-sm rate" 
                                                placeholder="Rate" 
                                                step="0.01" 
                                                min="0"
                                                style="border-radius: 16px; height: 45px;"
                                                onchange="updateExpenseItemTotal(this)"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="d-flex align-items-center h-100">
                                                <span class="amount me-2">0.00</span>
                                                <button type="button" class="btn btn-sm btn-danger" 
                                                    onclick="removeExpenseItem(this)"
                                                    style="border-radius: 12px; width: 35px; height: 35px;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-add mt-2" onclick="addExpenseItem()"
                                style="border-radius: 16px; height: 45px;">
                                <i class="fas fa-plus me-2"></i>Add Item
                            </button>
                        </div>

                        <!-- Total Section -->
                        <div class="row mb-3">
                            <div class="col-md-8"></div>
                            <div class="col-md-4">
                                <label class="form-label">Total Amount</label>
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0" 
                                        style="background: white; border-radius: 16px 0 0 16px; height: 45px;">
                                        KES
                                    </span>
                                    <input type="number" class="form-control border-0" 
                                        id="expenseTotal" 
                                        readonly 
                                        style="border-radius: 0 16px 16px 0; height: 45px; text-align: right;">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        style="border-radius: 12px; height: 45px;">
                        Close
                    </button>
                    <button type="button" class="btn btn-add" onclick="saveClientExpense()" 
                        style="border-radius: 12px; height: 45px;">
                        Save Expense
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Company Expenses Modal -->
    <div class="modal fade" id="companyExpensesModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Add New Company Expenses</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="companyExpensesForm">
                        <!-- Department and Category Selection Section -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Department</label>
                                    <select class="form-select border-0 shadow-sm" 
                                        id="expenseDepartment"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                        <option value="">Select Department</option>
                                        <option value="administration">Administration</option>
                                        <option value="operations">Operations</option>
                                        <option value="marketing">Marketing</option>
                                        <option value="finance">Finance</option>
                                        <option value="it">IT</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Category</label>
                                    <select class="form-select border-0 shadow-sm" 
                                        id="expenseCategory"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                        <option value="">Select Category</option>
                                        <option value="utilities">Utilities</option>
                                        <option value="rent">Rent</option>
                                        <option value="supplies">Office Supplies</option>
                                        <option value="perdm">Fare, meals & Accommodation</option>
                                        <option value="salaries">Salaries & Wages</option>
                                        <option value="maintenance">Repair & Maintenance</option>
                                        <option value="fuel">Fuel</option>
                                        <option value="other">Miscellaneous</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Expense Details Section -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Date</label>
                                    <input type="date" class="form-control border-0 shadow-sm" 
                                        id="companyExpenseDate" 
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Account Debited</label>
                                    <select class="form-select border-0 shadow-sm" 
                                        id="companyExpenseAccount"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                        <option value="">Select Account</option>
                                        <option value="David">David</option>
                                        <option value="Kim">Kim</option>
                                        <option value="bank">Bank</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Expense Items Section -->
                        <div class="mb-4">
                            <label class="form-label">Expense Items</label>
                            <div id="companyExpenseItemsContainer">
                                <div class="expense-item mb-3">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control border-0 shadow-sm description" 
                                                placeholder="Description"
                                                style="border-radius: 16px; height: 45px;"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="text" class="form-control border-0 shadow-sm unit" 
                                                placeholder="Unit"
                                                style="border-radius: 16px; height: 45px;"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control border-0 shadow-sm quantity" 
                                                placeholder="Quantity" 
                                                min="1"
                                                style="border-radius: 16px; height: 45px;"
                                                onchange="updateCompanyExpenseItemTotal(this)"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <input type="number" class="form-control border-0 shadow-sm rate" 
                                                placeholder="Rate" 
                                                min="0"
                                                style="border-radius: 16px; height: 45px;"
                                                onchange="updateCompanyExpenseItemTotal(this)"
                                                required>
                                        </div>
                                        <div class="col-md-2">
                                            <div class="d-flex align-items-center h-100">
                                                <span class="amount me-2">0.00</span>
                                                <button type="button" class="btn btn-sm btn-danger" 
                                                    onclick="removeCompanyExpenseItem(this)"
                                                    style="border-radius: 12px; width: 35px; height: 35px;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Add Item Button -->
                            <button type="button" class="btn btn-add mt-2" onclick="addCompanyExpenseItem()"
                                style="border-radius: 12px; height: 45px;">
                                <i class="fas fa-plus me-2"></i>Add Item
                            </button>
                        </div>

                        <!-- Total Amount Section -->
                        <div class="row mb-3">
                            <div class="col-md-8"></div>
                            <div class="col-md-4">
                                <label class="form-label">Total Amount</label>
                                <div class="input-group shadow-sm">
                                    <span class="input-group-text border-0" 
                                        style="background: white; border-radius: 16px 0 0 16px; height: 45px;">
                                        KES
                                    </span>
                                    <input type="number" class="form-control border-0" 
                                        id="companyExpenseTotal" 
                                        readonly 
                                        style="border-radius: 0 16px 16px 0; height: 45px; text-align: right;">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        style="border-radius: 12px; height: 45px;">
                        Close
                    </button>
                    <button type="button" class="btn btn-add" onclick="saveCompanyExpense()" 
                        style="border-radius: 12px; height: 45px;">
                        Save Expense
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Stock Item Modal -->
    <div class="modal fade" id="newStockItemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Add New Stock Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newStockItemForm">
                        <!-- Item Details Section -->
                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Item Name</label>
                                    <input type="text" class="form-control border-0 shadow-sm" 
                                        id="stockItemName" 
                                        placeholder="Enter item name"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Category</label>
                                    <select class="form-select border-0 shadow-sm" 
                                        id="stockItemCategory"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                        <option value="">Select Category</option>
                                        <option value="electronics">Electronics</option>
                                        <option value="office">Office Supplies</option>
                                        <option value="furniture">Furniture</option>
                                        <option value="tools">Tools & Equipment</option>
                                        <option value="consumables">Consumables</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Unit of Measure</label>
                                    <input type="text" class="form-control border-0 shadow-sm" 
                                        id="stockItemUnit" 
                                        placeholder="e.g., pieces, boxes, kg"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Minimum Stock Level</label>
                                    <input type="number" class="form-control border-0 shadow-sm" 
                                        id="stockItemMinLevel" 
                                        placeholder="Minimum quantity"
                                        min="0"
                                        style="border-radius: 16px; height: 45px;"
                                        required>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label">Description</label>
                            <textarea class="form-control border-0 shadow-sm" 
                                id="stockItemDescription" 
                                rows="3"
                                style="border-radius: 16px;"
                                placeholder="Enter item description"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        style="border-radius: 12px; height: 45px;">
                        Close
                    </button>
                    <button type="button" class="btn btn-add" onclick="saveStockItem()" 
                        style="border-radius: 12px; height: 45px;">
                        Save Item
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Stock In Modal -->
    <div class="modal fade" id="stockInModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Stock In Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stockInForm">
                        <input type="hidden" id="stockInItemId">
                        <div class="mb-3">
                            <label for="stockInProductName" class="form-label">Product Name</label>
                            <input type="text" class="form-control border-0 shadow-sm" id="stockInProductName" readonly>
                                </div>
                        <div class="mb-3">
                            <label for="stockInCurrentQty" class="form-label">Current Quantity</label>
                            <input type="text" class="form-control border-0 shadow-sm" id="stockInCurrentQty" readonly>
                                        </div>
                        <div class="mb-3">
                            <label for="stockInQuantity" class="form-label">Quantity to Add *</label>
                            <input type="number" class="form-control border-0 shadow-sm" id="stockInQuantity" min="1" required>
                                        </div>
                        <div class="mb-3">
                            <label for="stockInPrice" class="form-label">Purchase Price (KES) *</label>
                            <input type="number" class="form-control border-0 shadow-sm" id="stockInPrice" min="0" step="0.01" required>
                                    </div>
                        <div class="mb-3">
                            <label for="stockInBatch" class="form-label">Batch Number</label>
                            <input type="text" class="form-control border-0 shadow-sm" id="stockInBatch">
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        style="border-radius: 12px; height: 45px;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-add" onclick="submitStockIn()" 
                        style="border-radius: 12px; height: 45px;">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- Stock Out Modal -->
    <div class="modal fade" id="stockOutModal" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Stock Out Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="stockOutForm">
                        <input type="hidden" id="stockOutItemId">
                        <div class="mb-3">
                            <label for="stockOutProductName" class="form-label">Product Name</label>
                            <input type="text" class="form-control" id="stockOutProductName" readonly>
                                </div>
                        <div class="mb-3">
                            <label for="stockOutCurrentQty" class="form-label">Current Quantity</label>
                            <input type="text" class="form-control" id="stockOutCurrentQty" readonly>
                                </div>
                        <div class="mb-3">
                            <label for="stockOutQuantity" class="form-label">Quantity to Remove</label>
                            <input type="number" class="form-control" id="stockOutQuantity" min="1" required>
                            </div>
                        <div class="mb-3">
                            <label for="stockOutReason" class="form-label">Reason</label>
                            <textarea class="form-control" id="stockOutReason" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                        style="border-radius: 12px; height: 45px;">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-add" onclick="submitStockOut()" 
                        style="border-radius: 12px; height: 45px;">
                        Submit
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- New Supplier Modal -->
    <div class="modal fade" id="newSupplierModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Supplier</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newSupplierForm">
                        <div class="mb-3">
                            <label for="supplierName" class="form-label">Supplier Name</label>
                            <input type="text" class="form-control" id="supplierName" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="supplierPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="supplierLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="supplierLocation" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-add" onclick="saveSupplier()">Save Supplier</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <input type="hidden" id="editType">
                        <div class="mb-3">
                            <label for="editName" class="form-label">Name</label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="editPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPin" class="form-label">PIN Number</label>
                            <input type="text" class="form-control" id="editPin" placeholder="Optional">
                        </div>
                        <div class="mb-3">
                            <label for="editLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="editLocation" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Quotation Modal -->
    <div class="modal fade" id="newQuotationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">New Quotation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newQuotationForm">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="position-relative">
                                    <label class="form-label">Client</label>
                                    <div class="client-search-wrapper">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" class="form-control" id="clientSearch" name="clientSearch"
                                                placeholder="Search client..." autocomplete="off" form="newQuotationForm" required>
                                            <button class="btn btn-light" type="button" onclick="toggleClientDropdown()">
                                                <i class="fas fa-chevron-down"></i>
                                            </button>
                                        </div>
                                        <div class="client-search-results" id="clientSearchResults">
                                            <!-- Client suggestions will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Quotation #</label>
                                <input type="text" class="form-control" id="quotationNumber" readonly>
                            </div>
                        </div>

                        <!-- Kitchen Cabinets Section -->
                        <h4 class="mb-3">Kitchen Cabinets</h4>
                        <div class="table-responsive mb-1">
                            <table class="table table-striped table-condensed" id="cabinetItemsTable">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Units</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Cabinet items will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td><strong>SUBTOTAL</strong></td>
                                        <td><strong><span id="cabinetSubtotal">0.00</span></strong></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td><strong>ADD LABOUR</strong></td>
                                        <td>%</td>
                                        <td contenteditable="true" class="labour-percentage" onblur="updateLabourAmount()">30</td>
                                        <td></td>
                                        <td><span id="labourAmount">0.00</span></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td><strong>TOTAL</strong></td>
                                        <td><strong><span id="cabinetTotal">0.00</span></strong></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="6">
                                            <button type="button" class="btn btn-add" onclick="addItemRow('cabinetItemsTable')">
                                                <i class="fas fa-plus me-2"></i>Add Cabinet Item
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Worktop Section -->
                        <h4 class="mb-3">Worktop</h4>
                        <div class="table-responsive mb-1">
                            <table class="table table-striped table-condensed" id="worktopItemsTable">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Units</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Worktop items will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td><strong>TOTAL</strong></td>
                                        <td><strong><span id="worktopTotal">0.00</span></strong></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="6">
                                            <button type="button" class="btn btn-add" onclick="addItemRow('worktopItemsTable')">
                                                <i class="fas fa-plus me-2"></i>Add Worktop Item
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Accessories Section -->
                        <h4 class="mb-3 d-flex justify-content-between align-items-center">
                            <span>Accessories</span>
                            <div class="toggle-switch-container">
                                <span class="small text-muted">Include Accessories</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="accessoriesToggle" onchange="toggleAccessories(this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </h4>
                        <div class="table-responsive mb-1">
                            <table class="table table-striped table-condensed" id="accessoriesItemsTable">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Units</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Accessories items will be added here -->
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td><strong>TOTAL</strong></td>
                                        <td><strong><span id="accessoriesTotal">0.00</span></strong></td>
                                        <td></td>
                                    </tr>
                                    <tr>
                                        <td colspan="6">
                                            <button type="button" class="btn btn-add" onclick="addItemRow('accessoriesItemsTable')">
                                                <i class="fas fa-plus me-2"></i>Add Accessory Item
                                            </button>
                                        </td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Grand Total Section -->
                        <div class="row mt-4">
                            <div class="col-md-6 offset-md-6">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between mb-2">
                                            <strong>Cabinets Total:</strong>
                                            <span>KES <span id="grandCabinetTotal">0.00</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2">
                                            <strong>Worktop Total:</strong>
                                            <span>KES <span id="grandWorktopTotal">0.00</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between mb-2" data-accessories-total style="display: none;">
                                            <strong>Accessories Total:</strong>
                                            <span>KES <span id="grandAccessoriesTotal">0.00</span></span>
                                        </div>
                                        <div class="d-flex justify-content-between fw-bold">
                                            <strong>GRAND TOTAL:</strong>
                                            <span>KES <span id="grandTotal">0.00</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-add" onclick="saveQuotation()">Save Quotation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Modal -->
<div class="modal fade" id="newPurchaseModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="newPurchaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="newPurchaseModalLabel">Add New Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body pt-2">
                <form id="purchaseForm" class="needs-validation" novalidate>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="purchaseDate" class="form-label">Purchase Date</label>
                            <input type="date" class="form-control border-0 shadow-sm" id="purchaseDate" required 
                                style="border-radius: 16px; height: 45px;">
                            <div class="invalid-feedback">Please select a date.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="supplierSearch" class="form-label">Supplier</label>
                            <div class="input-group shadow-sm supplier-search-container">
                                <input type="text" class="form-control border-0" id="supplierSearch" required
                                    placeholder="Search supplier..." 
                                    style="border-radius: 16px 0 0 16px; height: 45px;">
                                <button class="btn btn-outline-secondary border-0 supplier-dropdown" type="button" 
                                    style="border-radius: 0 16px 16px 0; height: 45px; width: 20%; background: white; transition: all 0.3s ease;">
                                    <i class="fas fa-truck" style="color: #6c757d; transition: all 0.3s ease;"></i>
                                </button>
                                <ul class="dropdown-menu supplier-list" style="width: 100%; max-height: 300px; overflow-y: auto; overflow-x: hidden; margin-top: 2px;">
                                </ul>
                            </div>
                            <div class="invalid-feedback">Please select a supplier.</div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="purchaseOrderNumber" class="form-label">Purchase Order Number</label>
                            <input type="text" class="form-control border-0 shadow-sm" id="purchaseOrderNumber" readonly 
                                style="border-radius: 16px; height: 45px;">
                        </div>
                        <div class="col-md-6">
                            <label for="paymentMethod" class="form-label">Payment Method</label>
                            <select class="form-select border-0 shadow-sm" id="paymentMethod" required 
                                style="border-radius: 16px; height: 45px;">
                                <option value="">Select Payment Method</option>
                                <option value="David">David</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="Kim">Kim</option>
                                <option value="credit">Credit</option>
                            </select>
                            <div class="invalid-feedback">Please select a payment method.</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Items</label>
                        <div id="purchaseItems" class="mb-2">
                            <div class="row mb-2 purchase-item">
                                <div class="col-md-4">
                                    <div class="input-group shadow-sm item-search-container">
                                        <input type="text" class="form-control border-0 item-search" 
                                            placeholder="Search and select item..." required 
                                            style="border-radius: 16px 0 0 16px; height: 45px;">
                                        <button class="btn btn-outline-secondary border-0 item-dropdown dropdown-toggle" type="button" 
                                            style="border-radius: 0 16px 16px 0; height: 45px; width: 20%; background: white; transition: all 0.3s ease;">
                                            <i class="fas fa-box" style="color: #6c757d; transition: all 0.3s ease;"></i>
                                        </button>
                                        <ul class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto;">
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <select class="form-select border-0 shadow-sm unit-select" required 
                                        style="border-radius: 16px; height: 45px;">
                                        <option value="">Units</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control border-0 shadow-sm quantity-input" 
                                        placeholder="Qty" min="1" required 
                                        style="border-radius: 16px; height: 45px;"
                                        onchange="updatePurchaseItemTotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control border-0 shadow-sm price-input" 
                                        placeholder="Unit Price" step="0.01" min="0" required 
                                        style="border-radius: 16px; height: 45px;"
                                        onchange="updatePurchaseItemTotal(this)">
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control border-0 shadow-sm total-input" 
                                        placeholder="Total" step="0.01" min="0" readonly 
                                        style="border-radius: 16px; height: 45px;">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm remove-item" 
                                        onclick="removePurchaseItemRow(this)"
                                        style="height: 45px; width: 45px; border-radius: 12px;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="text-start mb-3">
                            <button type="button" class="btn btn-add shadow-sm" id="addPurchaseItemBtn" 
                                style="border-radius: 16px; height: 45px;">
                                <i class="fas fa-plus me-2"></i>Add Item
                            </button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-8">
                        </div>
                        <div class="col-md-4">
                            <label for="total" class="form-label">Total</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text border-0" style="background: white; border-radius: 16px 0 0 16px; height: 45px;">KES</span>
                                <input type="number" class="form-control border-0" id="total" readonly 
                                    style="border-radius: 0 16px 16px 0; height: 45px; text-align: right;">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" 
                    style="border-radius: 12px; height: 45px;">Close</button>
                <button type="button" class="btn btn-add shadow-sm" onclick="savePurchase()" 
                    style="border-radius: 12px; height: 45px;">Save Purchase</button>
            </div>
        </div>
    </div>
</div>
</div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Function to switch between expenses tabs
        function switchExpensesTab(tab) {
            // Hide all content sections
            document.getElementById('clientExpensesContent').style.display = 'none';
            document.getElementById('companyExpensesContent').style.display = 'none';
            
            // Remove active class from all tabs
            document.getElementById('clientExpensesTabBtn').classList.remove('active');
            document.getElementById('companyExpensesTabBtn').classList.remove('active');
            
            // Show selected content and activate tab
            if (tab === 'client') {
                document.getElementById('clientExpensesContent').style.display = 'block';
                document.getElementById('clientExpensesTabBtn').classList.add('active');
            } else {
                document.getElementById('companyExpensesContent').style.display = 'block';
                document.getElementById('companyExpensesTabBtn').classList.add('active');
            }
        }

        // Initialize with client expenses tab active when expenses section is shown
        document.addEventListener('DOMContentLoaded', function() {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.target.id === 'expensesSection' && 
                        mutation.target.style.display !== 'none') {
                        switchExpensesTab('client');
                    }
                });
            });

            const expensesSection = document.getElementById('expensesSection');
            if (expensesSection) {
                observer.observe(expensesSection, { 
                    attributes: true, 
                    attributeFilter: ['style'] 
                });
            }
        });

        // Cache for the background image
        let backgroundImageCache = null;
        let backgroundImagePromise = null;

        // Function to add background image to PDF
        async function addBackgroundToPDF(doc) {
            const backgroundUrl = 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png';
            
            try {
                // Use cached image if available
                if (backgroundImageCache) {
                    doc.addImage(backgroundImageCache, 'PNG', 0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight(), '', 'FAST');
                    return;
                }

                // Use existing promise if image is being loaded
                if (!backgroundImagePromise) {
                    backgroundImagePromise = loadImage(backgroundUrl);
                }

                // Wait for image to load
                backgroundImageCache = await backgroundImagePromise;
                doc.addImage(backgroundImageCache, 'PNG', 0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight(), '', 'FAST');
            } catch (error) {
                console.error('Error adding background:', error);
            }
        }

        // Optimized helper function to load image
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => resolve(img.src);
                img.onerror = reject;
                img.src = url;
            });
        }

        // Preload the background image when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Preload background image
            const backgroundUrl = 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png';
            backgroundImagePromise = loadImage(backgroundUrl);
            backgroundImagePromise.then(src => {
                backgroundImageCache = src;
            }).catch(error => {
                console.error('Error preloading background image:', error);
            });

            // ... rest of your DOMContentLoaded code ...
        });

        // Initialize jsPDF
        window.jsPDF = window.jspdf.jsPDF;

        // Navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.content > div').forEach(div => {
                div.style.display = 'none';
            });
            
            // Show selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.style.display = 'block';
                
                // Special handling for stock section to ensure summary cards are displayed
                if (sectionId === 'stockSection') {
                    updateStockSummaryCards();
                }
            }
            
            // Update active state in sidebar
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === sectionId) {
                    link.classList.add('active');
                }
            });
        }

        // Add click handlers for navigation
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const sectionId = this.getAttribute('data-section');
                if (sectionId) {
                    showSection(sectionId);
                    
                    // Ensure stock summary cards are updated when switching to stock section
                    if (sectionId === 'stockSection') {
                        updateStockSummaryCards();
                    }
                }
            });
        });

        // Global variables for register data
        let registeredEntities = [];
        let quotations = [];

        // Load initial data
        function loadRegisteredEntities() {
            const storedData = localStorage.getItem('registeredEntities');
            if (storedData) {
                registeredEntities = JSON.parse(storedData);
            }
            renderRegisterTable();
            updateLocationFilter();
            loadQuotations();
        }

        // Save data to localStorage
        function saveRegisteredEntities() {
            localStorage.setItem('registeredEntities', JSON.stringify(registeredEntities));
        }

        // Save new client
        function saveClient() {
            const form = document.getElementById('newClientForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const newClient = {
                id: Date.now(),
                type: 'client',
                name: document.getElementById('clientName').value,
                phone: document.getElementById('clientPhone').value,
                pin: document.getElementById('clientPin').value || null,
                location: document.getElementById('clientLocation').value,
                dateAdded: new Date().toISOString()
            };

            registeredEntities.push(newClient);
            saveRegisteredEntities();
            renderRegisterTable();
            updateLocationFilter();

            const modal = bootstrap.Modal.getInstance(document.getElementById('newClientModal'));
            modal.hide();
            form.reset();
        }

        // Save new supplier
        function saveSupplier() {
            const form = document.getElementById('newSupplierForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const newSupplier = {
                id: Date.now(),
                type: 'supplier',
                name: document.getElementById('supplierName').value,
                phone: document.getElementById('supplierPhone').value,
                location: document.getElementById('supplierLocation').value,
                dateAdded: new Date().toISOString()
            };

            registeredEntities.push(newSupplier);
            saveRegisteredEntities();
            renderRegisterTable();
            updateLocationFilter();

            const modal = bootstrap.Modal.getInstance(document.getElementById('newSupplierModal'));
            modal.hide();
            form.reset();
        }

        // Render register table
        function renderRegisterTable() {
            const tbody = document.getElementById('registerTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            // Sort registeredEntities by date in descending order (latest first)
            const sortedEntities = [...registeredEntities].sort((a, b) => 
                new Date(b.dateAdded) - new Date(a.dateAdded)
            );

            sortedEntities.forEach(entity => {
                const row = tbody.insertRow();
                
                // Define type styles similar to stock status but with appropriate colors
                let typeStyle = '';
                if (entity.type === 'client') {
                    typeStyle = 'background-color: #e3f2fd; color: #1976d2; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
                } else {
                    typeStyle = 'background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
                }
                
                row.innerHTML = `
                    <td>${entity.name}</td>
                    <td><span style="${typeStyle}">${entity.type.charAt(0).toUpperCase() + entity.type.slice(1)}</span></td>
                    <td>${entity.phone}</td>
                    <td>${entity.location}</td>
                    <td>${entity.type === 'client' && entity.pin ? entity.pin : '-'}</td>
                    <td>${new Date(entity.dateAdded).toLocaleDateString()}</td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="action-btn" onclick="editEntity(${entity.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="deleteEntity(${entity.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
            });
        }

        // Filter register table
        function filterRegisterTable() {
            const searchTerm = document.getElementById('registerSearch').value.toLowerCase();
            const typeFilter = document.getElementById('registerTypeFilter').value;
            const locationFilter = document.getElementById('registerLocationFilter').value;
            const tbody = document.getElementById('registerTable').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');

            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                const type = row.cells[1].textContent.toLowerCase();
                const location = row.cells[3].textContent.toLowerCase();

                const matchesSearch = text.includes(searchTerm);
                const matchesType = !typeFilter || type === typeFilter;
                const matchesLocation = !locationFilter || location === locationFilter.toLowerCase();

                row.style.display = (matchesSearch && matchesType && matchesLocation) ? '' : 'none';
            }
        }

        // Update location filter options
        function updateLocationFilter() {
            const locationFilter = document.getElementById('registerLocationFilter');
            const locations = [...new Set(registeredEntities.map(entity => entity.location))];
            
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            locations.sort().forEach(location => {
                const option = document.createElement('option');
                option.value = location;
                option.textContent = location;
                locationFilter.appendChild(option);
            });
        }

        // Edit entity
        function editEntity(id) {
            const entity = registeredEntities.find(e => e.id === id);
            if (!entity) return;

            document.getElementById('editId').value = entity.id;
            document.getElementById('editType').value = entity.type;
            document.getElementById('editName').value = entity.name;
            document.getElementById('editPhone').value = entity.phone;
            document.getElementById('editPin').value = entity.pin || '';
            document.getElementById('editLocation').value = entity.location;

            const modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }

        // Save edit
        function saveEdit() {
            const form = document.getElementById('editForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const id = parseInt(document.getElementById('editId').value);
            const index = registeredEntities.findIndex(e => e.id === id);
            if (index === -1) return;

            registeredEntities[index] = {
                ...registeredEntities[index],
                name: document.getElementById('editName').value,
                phone: document.getElementById('editPhone').value,
                pin: document.getElementById('editPin').value || null,
                location: document.getElementById('editLocation').value
            };

            saveRegisteredEntities();
            renderRegisterTable();
            updateLocationFilter();

            const modal = bootstrap.Modal.getInstance(document.getElementById('editModal'));
            modal.hide();
        }

        // Delete entity
        function deleteEntity(id) {
            if (!confirm('Are you sure you want to delete this entry?')) return;

            const index = registeredEntities.findIndex(e => e.id === id);
            if (index === -1) return;

            registeredEntities.splice(index, 1);
            saveRegisteredEntities();
            renderRegisterTable();
            updateLocationFilter();
        }

        // Export register data
        function exportRegisterData() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Register Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add table
            const headers = [['Name', 'Type', 'Phone', 'Location', 'PIN Number', 'Date Added']];
            const data = registeredEntities.map(entity => [
                entity.name,
                entity.type,
                entity.phone,
                entity.location,
                entity.type === 'client' && entity.pin ? entity.pin : '-',
                new Date(entity.dateAdded).toLocaleDateString()
            ]);

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 40,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            doc.save('register_report.pdf');
        }

        // Show quotations view
        function showQuotationsView() {
            // Store active view
            localStorage.setItem('activeSalesView', 'quotations');
            
            // Hide all views
            document.getElementById('salesOrderView').style.display = 'none';
            document.getElementById('quotationsView').style.display = 'block';
            document.getElementById('invoiceView').style.display = 'none';
            document.getElementById('cashSaleView').style.display = 'none';
            
            // Update button states
            document.getElementById('quotationsBtn').classList.add('active');
            document.getElementById('salesOrderBtn').classList.remove('active');
            document.getElementById('invoiceBtn').classList.remove('active');
            document.getElementById('cashSaleBtn').classList.remove('active');
        }

        // Show sales order view
        function showSalesOrderView() {
            // Store active view
            localStorage.setItem('activeSalesView', 'salesOrder');
            
            // Hide all views
            document.getElementById('quotationsView').style.display = 'none';
            document.getElementById('salesOrderView').style.display = 'block';
            document.getElementById('invoiceView').style.display = 'none';
            document.getElementById('cashSaleView').style.display = 'none';
            
            // Update button states
            document.getElementById('salesOrderBtn').classList.add('active');
            document.getElementById('quotationsBtn').classList.remove('active');
            document.getElementById('invoiceBtn').classList.remove('active');
            document.getElementById('cashSaleBtn').classList.remove('active');
        }

        // Show invoice view
        function showinvoiceView() {
            // Store active view
            localStorage.setItem('activeSalesView', 'invoice');
            
            // Hide all views
            document.getElementById('quotationsView').style.display = 'none';
            document.getElementById('salesOrderView').style.display = 'none';
            document.getElementById('invoiceView').style.display = 'block';
            document.getElementById('cashSaleView').style.display = 'none';
            
            // Update button states
            document.getElementById('invoiceBtn').classList.add('active');
            document.getElementById('quotationsBtn').classList.remove('active');
            document.getElementById('salesOrderBtn').classList.remove('active');
            document.getElementById('cashSaleBtn').classList.remove('active');
        }

        // Show cash sale view
        function showCashSaleView() {
            // Store active view
            localStorage.setItem('activeSalesView', 'cashSale');
            
            // Hide all views
            document.getElementById('quotationsView').style.display = 'none';
            document.getElementById('salesOrderView').style.display = 'none';
            document.getElementById('invoiceView').style.display = 'none';
            document.getElementById('cashSaleView').style.display = 'block';
            
            // Update button states
            document.getElementById('cashSaleBtn').classList.add('active');
            document.getElementById('quotationsBtn').classList.remove('active');
            document.getElementById('salesOrderBtn').classList.remove('active');
            document.getElementById('invoiceBtn').classList.remove('active');
        }

        // Show sales section
        function showSalesSection() {
            // Hide all sections
            document.querySelectorAll('.content > div').forEach(div => {
                div.style.display = 'none';
            });
            
            // Show sales section
            document.getElementById('salesSection').style.display = 'block';
            
            // Restore active view
            const activeView = localStorage.getItem('activeSalesView') || 'quotations';
            switch(activeView) {
                case 'quotations':
                    showQuotationsView();
                    break;
                case 'salesOrder':
                    showSalesOrderView();
                    break;
                case 'invoice':
                    showinvoiceView();
                    break;
                case 'cashSale':
                    showCashSaleView();
                    break;
                default:
                    showQuotationsView();
            }
            
            // Update active section button
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector('[data-section="salesSection"]').classList.add('active');
        }

        // Generate quotation number
        function generateQuotationNumber() {
            return getNextNumber('QT');
        }

        // Show new quotation modal
        function showNewQuotationModal() {
            // Reset modal to default state
            resetQuotationModal();
            
            // Reset form and title
            document.getElementById('newQuotationForm').reset();
            document.querySelector('#newQuotationModal .modal-title').textContent = 'New Quotation';
            
            // Clear client search
            const clientSearch = document.getElementById('clientSearch');
            clientSearch.value = '';
            delete clientSearch.dataset.clientId;
            delete clientSearch.dataset.clientPhone;
            delete clientSearch.dataset.clientLocation;

            // Clear all tables and totals
            document.getElementById('cabinetItemsTable').getElementsByTagName('tbody')[0].innerHTML = '';
            document.getElementById('worktopItemsTable').getElementsByTagName('tbody')[0].innerHTML = '';
            document.getElementById('accessoriesItemsTable').getElementsByTagName('tbody')[0].innerHTML = '';
            
            // Reset all totals
            document.getElementById('cabinetSubtotal').textContent = '0.00';
            document.getElementById('labourAmount').textContent = '0.00';
            document.getElementById('cabinetTotal').textContent = '0.00';
            document.getElementById('worktopTotal').textContent = '0.00';
            document.getElementById('accessoriesTotal').textContent = '0.00';
            document.getElementById('grandCabinetTotal').textContent = '0.00';
            document.getElementById('grandWorktopTotal').textContent = '0.00';
            document.getElementById('grandAccessoriesTotal').textContent = '0.00';
            document.getElementById('grandTotal').textContent = '0.00';

            // Generate new quotation number and clear edit ID
            const quotationNumber = document.getElementById('quotationNumber');
            quotationNumber.value = generateQuotationNumber();
            delete quotationNumber.dataset.editId;
            
            // Add initial row only for cabinet and worktop tables
            addItemRow('cabinetItemsTable');
            addItemRow('worktopItemsTable');

            // Hide accessories by default
            document.getElementById('accessoriesToggle').checked = false;
            toggleAccessories(false);

            // Update modal footer with Save button
            document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="saveQuotation()">Save Quotation</button>
            `;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('newQuotationModal'));
            modal.show();
        }

        // Function to reset quotation modal to default state
        function resetQuotationModal() {
            const modal = document.getElementById('newQuotationModal');
            
            // Remove A4 modal class if it exists
            modal.classList.remove('a4-modal');
            
            // Reset modal body to original structure
            modal.querySelector('.modal-body').innerHTML = `
                <form id="newQuotationForm">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="position-relative">
                                <label class="form-label">Client</label>
                                <div class="client-search-wrapper">
                                    <div class="input-group shadow-sm">
                                        <span class="input-group-text border-0 bg-white" style="border-radius: 16px 0 0 16px; height: 45px;">
                                            <i class="fas fa-search text-muted"></i>
                                        </span>
                                        <input type="text" class="form-control border-0" 
                                            id="clientSearch" 
                                            placeholder="Search client..."
                                            style="border-radius: 0; height: 45px;"
                                            autocomplete="off"
                                            required>
                                        <button class="btn btn-light border-0" type="button" 
                                            onclick="toggleClientDropdown()"
                                            style="border-radius: 0 16px 16px 0; height: 45px;">
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                    </div>
                                    <div id="clientSearchResults" class="client-search-results shadow-sm" style="display: none; max-height: 200px; overflow-y: auto; position: absolute; width: 100%; z-index: 1000; background: white; border-radius: 16px; margin-top: 5px;">
                                        <!-- Search results will be dynamically added here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quotation #</label>
                            <input type="text" class="form-control" id="quotationNumber" readonly>
                        </div>
                    </div>

                    <!-- Kitchen Cabinets Section -->
                    <h4 class="mb-3">Kitchen Cabinets</h4>
                    <div class="table-responsive mb-1">
                        <table class="table table-striped table-condensed" id="cabinetItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Units</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Cabinet items will be added here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"></td>
                                    <td><strong>SUBTOTAL</strong></td>
                                    <td><strong><span id="cabinetSubtotal">0.00</span></strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td><strong>ADD LABOUR</strong></td>
                                    <td>%</td>
                                    <td contenteditable="true" class="labour-percentage" onblur="updateLabourAmount()">30</td>
                                    <td></td>
                                    <td><span id="labourAmount">0.00</span></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="3"></td>
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong><span id="cabinetTotal">0.00</span></strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <button type="button" class="btn btn-add" onclick="addItemRow('cabinetItemsTable')">
                                            <i class="fas fa-plus me-2"></i>Add Cabinet Item
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Worktop Section -->
                    <h4 class="mb-3">Worktop</h4>
                    <div class="table-responsive mb-1">
                        <table class="table table-striped table-condensed" id="worktopItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Units</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Worktop items will be added here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"></td>
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong><span id="worktopTotal">0.00</span></strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <button type="button" class="btn btn-add" onclick="addItemRow('worktopItemsTable')">
                                            <i class="fas fa-plus me-2"></i>Add Worktop Item
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Accessories Section -->
                    <h4 class="mb-3 d-flex justify-content-between align-items-center">
                        <span>Accessories</span>
                        <div class="toggle-switch-container">
                            <span class="small text-muted">Include Accessories</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="accessoriesToggle" onchange="toggleAccessories(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </h4>
                    <div class="table-responsive mb-1">
                        <table class="table table-striped table-condensed" id="accessoriesItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Units</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Accessories items will be added here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"></td>
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong><span id="accessoriesTotal">0.00</span></strong></td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="6">
                                        <button type="button" class="btn btn-add" onclick="addItemRow('accessoriesItemsTable')">
                                            <i class="fas fa-plus me-2"></i>Add Accessory Item
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- Grand Total Section -->
                    <div class="row mt-4">
                        <div class="col-md-6 offset-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <strong>Cabinets Total:</strong>
                                        <span>KES <span id="grandCabinetTotal">0.00</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <strong>Worktop Total:</strong>
                                        <span>KES <span id="grandWorktopTotal">0.00</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2" data-accessories-total style="display: none;">
                                        <strong>Accessories Total:</strong>
                                        <span>KES <span id="grandAccessoriesTotal">0.00</span></span>
                                    </div>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <strong>GRAND TOTAL:</strong>
                                        <span>KES <span id="grandTotal">0.00</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            `;

            // Re-attach the client search event listener
            document.getElementById('clientSearch').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const resultsContainer = document.getElementById('clientSearchResults');
                
                if (searchTerm.length > 0) {
                    const filteredClients = registeredEntities
                        .filter(entity => 
                            entity.type === 'client' && 
                            entity.name.toLowerCase().includes(searchTerm)
                        )
                        .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

                    if (filteredClients.length > 0) {
                        resultsContainer.innerHTML = filteredClients
                            .map(client => `
                                <div class="dropdown-item" onclick="selectClient('${client.id}', '${client.name}', '${client.phone}', '${client.location}')">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${highlightMatch(client.name, searchTerm)}</strong>
                                            <div class="small text-dark">${client.location}</div>
                                        </div>
                                        <div class="small text-dark">${client.phone}</div>
                                    </div>
                                </div>
                            `).join('');
                        resultsContainer.style.display = 'block';
                    } else {
                        resultsContainer.innerHTML = '<div class="dropdown-item">No clients found</div>';
                        resultsContainer.style.display = 'block';
                    }
                } else {
                    resultsContainer.style.display = 'none';
                }
            });
        }

        // Update the modal initialization
        document.getElementById('newQuotationModal').addEventListener('hide.bs.modal', function() {
            // Clear form when modal is closed
            document.getElementById('newQuotationForm').reset();
            document.getElementById('cabinetItemsTable').getElementsByTagName('tbody')[0].innerHTML = '';
            document.getElementById('cabinetSubtotal').textContent = '0.00';
            document.getElementById('labourAmount').textContent = '0.00';
            document.getElementById('cabinetTotal').textContent = '0.00';
            document.getElementById('worktopTotal').textContent = '0.00';
            document.getElementById('accessoriesTotal').textContent = '0.00';
            document.getElementById('grandCabinetTotal').textContent = '0.00';
            document.getElementById('grandWorktopTotal').textContent = '0.00';
            document.getElementById('grandAccessoriesTotal').textContent = '0.00';
            document.getElementById('grandTotal').textContent = '0.00';
            delete document.getElementById('quotationNumber').dataset.editId;
            
            // Reset accessories visibility
            const accessoriesToggle = document.getElementById('accessoriesToggle');
            if (accessoriesToggle) {
                accessoriesToggle.checked = false;
                toggleAccessories(false);
            }
        });

        // Update the client search functionality
        document.getElementById('clientSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('clientSearchResults');
            
            if (searchTerm.length > 0) {
                const filteredClients = registeredEntities
                    .filter(entity => 
                        entity.type === 'client' && 
                        entity.name.toLowerCase().includes(searchTerm)
                    )
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

                if (filteredClients.length > 0) {
                    resultsContainer.innerHTML = filteredClients
                        .map(client => `
                            <div class="dropdown-item" onclick="selectClient('${client.id}', '${client.name}', '${client.phone}', '${client.location}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${highlightMatch(client.name, searchTerm)}</strong>
                                        <div class="small text-dark">${client.location}</div>
                                    </div>
                                    <div class="small text-dark">${client.phone}</div>
                                </div>
                            </div>
                        `).join('');
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.innerHTML = '<div class="dropdown-item">No clients found</div>';
                    resultsContainer.style.display = 'block';
                }
            } else {
                resultsContainer.style.display = 'none';
            }
        });

        // Add helper function to highlight matching text
        function highlightMatch(text, searchTerm) {
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        // Update select client function
        function selectClient(id, name, phone, location) {
            const input = document.getElementById('clientSearch');
            input.value = name;
            input.dataset.clientId = id;
            input.dataset.clientPhone = phone;
            input.dataset.clientLocation = location;
            
            // Hide dropdown
            document.getElementById('clientSearchResults').style.display = 'none';
        }

        // Add function to toggle client dropdown
        function toggleClientDropdown() {
            const resultsContainer = document.getElementById('clientSearchResults');
            const isVisible = resultsContainer.style.display === 'block';
            
            if (!isVisible) {
                const filteredClients = registeredEntities
                    .filter(entity => entity.type === 'client')
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

                resultsContainer.innerHTML = filteredClients
                    .map(client => `
                        <div class="dropdown-item" onclick="selectClient('${client.id}', '${client.name}', '${client.phone}', '${client.location}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${client.name}</strong>
                                    <div class="small text-dark">${client.location}</div>
                                </div>
                                <div class="small text-dark">${client.phone}</div>
                            </div>
                        </div>
                    `).join('');
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        // Add click outside handler to close dropdown
        document.addEventListener('click', function(e) {
            const clientSearch = document.getElementById('clientSearch');
            const clientSearchResults = document.getElementById('clientSearchResults');
            
            // Only proceed if both elements exist
            if (!clientSearch || !clientSearchResults) {
                return;
            }

            const isClickInside = clientSearch.contains(e.target) || 
                                 clientSearchResults.contains(e.target) ||
                                 e.target.closest('.btn-light');

            if (!isClickInside && clientSearchResults.style.display === 'block') {
                clientSearchResults.style.display = 'none';
            }
        });

        // Update the saveQuotation function
        function saveQuotation() {
            try {
                const form = document.getElementById('newQuotationForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const clientInput = document.getElementById('clientSearch');
                const clientId = clientInput.dataset.clientId;
                
                if (!clientId) {
                    alert('Please select a client from the list');
                    return;
                }

                const quotationNumber = document.getElementById('quotationNumber').value;
                
                // Get all items using helper functions
                const cabinetItems = getCabinetItems();
                const worktopItems = getWorktopItems();
                const accessoriesItems = getAccessoriesItems();

                // Get all totals
                const cabinetTotal = parseFloat(document.getElementById('cabinetTotal').textContent) || 0;
                const worktopTotal = parseFloat(document.getElementById('worktopTotal').textContent) || 0;
                const accessoriesTotal = parseFloat(document.getElementById('accessoriesTotal').textContent) || 0;
                const grandTotal = parseFloat(document.getElementById('grandTotal').textContent) || 0;

                // Get labour percentage
                const labourPercentageElement = document.querySelector('.labour-percentage');
                const labourPercentage = parseFloat(labourPercentageElement?.value || labourPercentageElement?.textContent) || 30;

                const quotationData = {
                    id: Date.now(),
                    quotationNumber: quotationNumber,
                    date: new Date().toISOString(),
                    clientId: clientId,
                    clientName: clientInput.value,
                    clientPhone: clientInput.dataset.clientPhone,
                    clientLocation: clientInput.dataset.clientLocation,
                    cabinetItems: cabinetItems,
                    worktopItems: worktopItems,
                    accessoriesItems: accessoriesItems,
                    labourPercentage: labourPercentage,
                    cabinetTotal: cabinetTotal,
                    worktopTotal: worktopTotal,
                    accessoriesTotal: accessoriesTotal,
                    grandTotal: grandTotal,
                    includeAccessories: document.getElementById('accessoriesToggle').checked,
                    status: 'Pending'
                };

                // Confirm the quotation number before saving
                if (confirmQuotationNumber(quotationNumber)) {
                    // Check if this is an edit
                    const editId = document.getElementById('quotationNumber').dataset.editId;
                    if (editId) {
                        const index = quotations.findIndex(q => q.id === parseInt(editId));
                        if (index !== -1) {
                            quotations[index] = { ...quotations[index], ...quotationData, id: parseInt(editId) };
                        }
                        delete document.getElementById('quotationNumber').dataset.editId;
                    } else {
                        quotations.unshift(quotationData);
                    }

                    saveQuotations();
                    renderQuotationsTable();

                    const modal = bootstrap.Modal.getInstance(document.getElementById('newQuotationModal'));
                    modal.hide();
                    form.reset();

                    // After successful save, reset modal title
                    document.querySelector('#newQuotationModal .modal-title').textContent = 'New Quotation';
                } else {
                    alert('Error saving quotation. Please try again.');
                }
            } catch (error) {
                console.error('Error saving quotation:', error);
                alert('An error occurred while saving the quotation. Please try again.');
            }
        }

        // Add function to render quotations table
        function renderQuotationsTable() {
            const tbody = document.getElementById('quotationsTable').getElementsByTagName('tbody')[0];
            tbody.innerHTML = '';

            // Sort quotations by date and order number (newest first)
            const sortedQuotations = [...quotations].sort((a, b) => {
                // First sort by date (newest first)
                const dateComparison = new Date(b.date) - new Date(a.date);
                
                // If dates are the same, sort by quotation number (newest first)
                if (dateComparison === 0 && a.quotationNumber && b.quotationNumber) {
                    // Extract year and month from quotation numbers (assuming format QYYMMXXX)
                    const aYear = a.quotationNumber.substring(1, 3);
                    const aMonth = a.quotationNumber.substring(3, 5);
                    const aNumber = parseInt(a.quotationNumber.substring(5));
                    
                    const bYear = b.quotationNumber.substring(1, 3);
                    const bMonth = b.quotationNumber.substring(3, 5);
                    const bNumber = parseInt(b.quotationNumber.substring(5));
                    
                    // Compare year
                    if (bYear !== aYear) return bYear - aYear;
                    
                    // If year is the same, compare month
                    if (bMonth !== aMonth) return bMonth - aMonth;
                    
                    // If month is the same, compare number
                    return bNumber - aNumber;
                }
                
                return dateComparison;
            });

            sortedQuotations.forEach(quotation => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${quotation.quotationNumber}</td>
                    <td>${new Date(quotation.date).toLocaleDateString()}</td>
                    <td>${quotation.clientName}</td>
                    <td>KES ${(quotation.grandTotal || 0).toFixed(2)}</td>
                    <td>
                        <span class="badge" ${getStatusBadgeClass(quotation.status)}>
                            ${quotation.status}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            ${quotation.status === 'Converted' ? 
                                `<button class="action-btn" onclick="viewQuotation(${quotation.id})">
                                    <i class="fas fa-eye"></i>
                                </button>` :
                                `<button class="action-btn" onclick="editQuotation(${quotation.id})">
                                    <i class="fas fa-edit"></i>
                                </button>`
                            }
                            <button class="action-btn" onclick="printQuotation(${quotation.id})">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="action-btn" onclick="downloadQuotation(${quotation.id})">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                `;
            });

            // Update client filter options
            const clientFilter = document.getElementById('quotationClientFilter');
            const uniqueClients = [...new Set(quotations.map(q => q.clientName))];
            clientFilter.innerHTML = '<option value="">All Clients</option>' +
                uniqueClients.map(client => `<option value="${client}">${client}</option>`).join('');
        }

        // Add helper function for status badge classes
        function getStatusBadgeClass(status) {
            let statusStyle = '';
            
            switch (status?.toLowerCase()) {
                case 'pending':
                    return 'style="background-color: #fff3e0; color: #f57c00; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'approved':
                    return 'style="background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'rejected':
                    return 'style="background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'converted':
                    return 'style="background-color: #e3f2fd; color: #1976d2; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                default:
                    return 'style="background-color: #f5f5f5; color: #757575; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
            }
        }

        // Add this to the saveQuotations function
        function saveQuotations() {
            localStorage.setItem('quotations', JSON.stringify(quotations));
        }

        // Add quotation row
        function addItemRow(tableId) {
            const tbody = document.getElementById(tableId).getElementsByTagName('tbody')[0];
            const row = tbody.insertRow();
            row.innerHTML = `
                <td><input type="text" class="form-control description" name="description" form="newQuotationForm" required></td>
                <td><input type="text" class="form-control unit" name="unit" form="newQuotationForm" required></td>
                <td><input type="number" class="form-control quantity" name="quantity" value="1" min="1" onchange="updateRowTotal(this)" form="newQuotationForm" required></td>
                <td><input type="number" class="form-control price" name="price" step="0.01" onchange="updateRowTotal(this)" form="newQuotationForm" required></td>
                <td class="amount">0.00</td>
                <td>
                    <button type="button" class="action-btn" onclick="this.closest('tr').remove(); updateAllTotals();">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
        }

        // Update quotation amount
        function updateRowTotal(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const price = parseFloat(row.querySelector('.price').value) || 0;
            const amount = quantity * price;
            row.querySelector('.amount').textContent = amount.toFixed(2);
            updateAllTotals();
        }

        // Update quotation total
        function updateAllTotals() {
            // Calculate cabinet subtotal
            let cabinetSubtotal = 0;
            document.querySelectorAll('#cabinetItemsTable tbody .amount').forEach(cell => {
                cabinetSubtotal += parseFloat(cell.textContent) || 0;
            });
            document.getElementById('cabinetSubtotal').textContent = cabinetSubtotal.toFixed(2);
            
            // Update labour amount based on new subtotal
            updateLabourAmount();
            
            // Update Worktop Total
            let worktopTotal = 0;
            document.querySelectorAll('#worktopItemsTable tbody .amount').forEach(cell => {
                worktopTotal += parseFloat(cell.textContent) || 0;
            });
            document.getElementById('worktopTotal').textContent = worktopTotal.toFixed(2);
            document.getElementById('grandWorktopTotal').textContent = worktopTotal.toFixed(2);

            // Update Accessories Total only if enabled
            let accessoriesTotal = 0;
            if (document.getElementById('accessoriesToggle').checked) {
                document.querySelectorAll('#accessoriesItemsTable tbody .amount').forEach(cell => {
                    accessoriesTotal += parseFloat(cell.textContent) || 0;
                });
            }
            document.getElementById('accessoriesTotal').textContent = accessoriesTotal.toFixed(2);
            document.getElementById('grandAccessoriesTotal').textContent = accessoriesTotal.toFixed(2);

            // Calculate grand total based on toggle state
            const cabinetTotal = parseFloat(document.getElementById('cabinetTotal').textContent) || 0;
            const grandTotal = cabinetTotal + worktopTotal + (document.getElementById('accessoriesToggle').checked ? accessoriesTotal : 0);
            document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
        }

        // Update the updateLabourAmount function
        function updateLabourAmount() {
            const labourPercentageElement = document.querySelector('.labour-percentage');
            if (!labourPercentageElement) return;

            // Get the labour percentage value, handling both input and contenteditable elements
            let labourPercentage;
            if (labourPercentageElement.tagName.toLowerCase() === 'input') {
                labourPercentage = parseFloat(labourPercentageElement.value) || 0;
            } else {
                labourPercentage = parseFloat(labourPercentageElement.textContent) || 0;
            }

            const subtotal = parseFloat(document.getElementById('cabinetSubtotal').textContent) || 0;
            
            // Calculate labour amount based on subtotal and percentage
            const labourAmount = (subtotal * labourPercentage) / 100;
            
            const labourAmountElement = document.getElementById('labourAmount');
            if (labourAmountElement) {
                labourAmountElement.textContent = labourAmount.toFixed(2);
            }
            
            // Update cabinet total (subtotal + labour amount)
            const cabinetTotal = subtotal + labourAmount;
            const cabinetTotalElement = document.getElementById('cabinetTotal');
            if (cabinetTotalElement) {
                cabinetTotalElement.textContent = cabinetTotal.toFixed(2);
            }

            // Update grand cabinet total
            const grandCabinetTotalElement = document.getElementById('grandCabinetTotal');
            if (grandCabinetTotalElement) {
                grandCabinetTotalElement.textContent = cabinetTotal.toFixed(2);
            }
            
            // Update grand total
            const worktopTotal = parseFloat(document.getElementById('grandWorktopTotal').textContent) || 0;
            const accessoriesTotal = document.getElementById('accessoriesToggle')?.checked ? 
                (parseFloat(document.getElementById('grandAccessoriesTotal').textContent) || 0) : 0;
            const grandTotal = cabinetTotal + worktopTotal + accessoriesTotal;
            
            const grandTotalElement = document.getElementById('grandTotal');
            if (grandTotalElement) {
                grandTotalElement.textContent = grandTotal.toFixed(2);
            }
        }

        // Filter quotations
        function filterQuotations() {
            const searchTerm = document.getElementById('quotationSearch').value.toLowerCase();
            const clientFilter = document.getElementById('quotationClientFilter').value;
            const dateFilter = document.getElementById('quotationDateFilter').value;
            const specificDate = document.getElementById('quotationSpecificDate').value;
            
            // Get period dates if the period filter is selected
            let periodStartDate = null;
            let periodEndDate = null;
            if (dateFilter === 'period') {
                periodStartDate = document.getElementById('quotationPeriodStartDate').value;
                periodEndDate = document.getElementById('quotationPeriodEndDate').value;
            }
            
            const rows = document.querySelectorAll('#quotationsTable tbody tr');
            
            rows.forEach(row => {
                const quotation = row.children;
                const quotationNumber = quotation[0].textContent.toLowerCase();
                const client = quotation[2].textContent.toLowerCase();
                const date = quotation[1].textContent; // Format: YYYY-MM-DD
                
                // Search filter
                const matchesSearch = 
                    quotationNumber.includes(searchTerm) || 
                    client.includes(searchTerm);
                
                // Client filter
                const matchesClient = !clientFilter || client.includes(clientFilter.toLowerCase());
                
                // Date filter
                let matchesDate = true;
                if (dateFilter === 'specific' && specificDate) {
                    const rowDate = new Date(date);
                    rowDate.setHours(0, 0, 0, 0);
                    const selectedDate = new Date(specificDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    matchesDate = rowDate.getTime() === selectedDate.getTime();
                } else if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                    matchesDate = checkDateFilter(date, 'period', periodStartDate, periodEndDate);
                } else {
                    matchesDate = !dateFilter || checkDateFilter(date, dateFilter);
                }

                // Apply all filters
                row.style.display = (matchesSearch && matchesClient && matchesDate) ? '' : 'none';
            });
        }

        // Add checkDateFilter function if not already present
        function checkDateFilter(date, filter, specificStartDate = null, specificEndDate = null) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const dateToCheck = new Date(date);
            dateToCheck.setHours(0, 0, 0, 0);

            switch (filter) {
                case 'today':
                    return dateToCheck.getTime() === today.getTime();
                case 'week': {
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - today.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    weekEnd.setHours(23, 59, 59, 999);
                    return dateToCheck >= weekStart && dateToCheck <= weekEnd;
                }
                case 'month': {
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    const monthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    monthEnd.setHours(23, 59, 59, 999);
                    return dateToCheck >= monthStart && dateToCheck <= monthEnd;
                }
                case 'year': {
                    const yearStart = new Date(today.getFullYear(), 0, 1);
                    const yearEnd = new Date(today.getFullYear(), 11, 31);
                    yearEnd.setHours(23, 59, 59, 999);
                    return dateToCheck >= yearStart && dateToCheck <= yearEnd;
                }
                case 'specific': {
                    if (!specificStartDate) return true;
                    const specificDate = new Date(specificStartDate);
                    specificDate.setHours(0, 0, 0, 0);
                    return dateToCheck.getTime() === specificDate.getTime();
                }
                case 'period': {
                    if (!specificStartDate || !specificEndDate) return true;
                    const startDate = new Date(specificStartDate);
                    startDate.setHours(0, 0, 0, 0);
                    const endDate = new Date(specificEndDate);
                    endDate.setHours(23, 59, 59, 999);
                    return dateToCheck >= startDate && dateToCheck <= endDate;
                }
                default:
                    return true;
            }
        }

        // Update the exportQuotations function to match payments export style
        function exportQuotations() {
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.text('Quotations Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary section
            doc.setFontSize(14);
            doc.text('Quotation Summary', 20, 45);

            // Add quotations table
            const headers = [['Quotation #', 'Date', 'Client', 'Total Amount', 'Status']];
            const data = [];
            
            document.querySelectorAll('#quotationsTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent
                ]);
            });

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 55,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] },
                columnStyles: {
                    0: { cellWidth: 18 }, // Item Code
                    1: { cellWidth: 35 }, // Product
                    2: { cellWidth: 22 }, // Category
                    3: { cellWidth: 18 }, // Quantity
                    4: { cellWidth: 18 }, // Unit Price
                    5: { cellWidth: 22 }, // Total Value
                    6: { cellWidth: 18 }  // Status
                },
                margin: { left: 15, right: 15 },
            });

            // Add total at the bottom
            const total = data.reduce((sum, row) => {
                const amount = parseFloat(row[3].replace('KES ', '')) || 0;
                return sum + amount;
            }, 0);

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Quotations Value: KES ${total.toFixed(2)}`, 20, finalY);

            doc.save('quotations_report.pdf');
        }

        // Load quotations
        function loadQuotations() {
            const storedQuotations = localStorage.getItem('quotations');
            if (storedQuotations) {
                quotations = JSON.parse(storedQuotations);
            }
            renderQuotationsTable();
        }

        // Update the editQuotation function
        function editQuotation(id) {
            const quotation = quotations.find(q => q.id === id);
            if (!quotation) return;

            // Update modal classes for A4 layout
            const modal = document.getElementById('newQuotationModal');
            modal.classList.add('a4-modal');

            // Create A4 document layout
            document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                <form id="newQuotationForm" class="a4-document">
                    <!-- Company Header -->
                    <div class="document-header">
                        <div class="company-name">Cabinet Master Styles And Finishes</div>
                        <div class="company-details">
                            <div>cabinetmasterstyles@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone No: 0729554475</div>
                        </div>
                    </div>

                    <!-- Document Info -->
                    <div class="document-info">
                        <!-- Left Column -->
                        <div class="document-info-group">
                            <h3>QUOTATION</h3>
                            <div class="info-row">
                                <span class="info-label">Quotation #</span>
                                <input type="text" class="info-value" id="quotationNumber" value="${quotation.quotationNumber}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Date</span>
                                <input type="text" class="info-value" value="${new Date(quotation.date).toLocaleDateString()}" readonly>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="document-info-group">
                            <div class="info-row">
                                <span class="info-label">Client</span>
                                <input type="text" class="info-value" id="clientSearch" value="${quotation.clientName}" 
                                    data-client-id="${quotation.clientId}"
                                    data-client-phone="${quotation.clientPhone}"
                                    data-client-location="${quotation.clientLocation}" required>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone No</span>
                                <input type="text" class="info-value" value="${quotation.clientPhone}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Location</span>
                                <input type="text" class="info-value" value="${quotation.clientLocation}" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Kitchen Cabinets Section -->
                    <div class="section-title" style="margin-top: 0px;">Kitchen Cabinets</div>
                    <table class="quotation-table" id="cabinetItemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotation.cabinetItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                    <td style="position: relative; " class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>SUBTOTAL</strong></td>
                                <td><strong><span id="cabinetSubtotal">${quotation.cabinetTotal.toFixed(2)}</span></strong></td>
                            </tr>
                            <tr>
                                <td><strong>ADD LABOUR</strong></td>
                                <td>%</td>
                                <td><input type="number" class="labour-percentage" value="${quotation.labourPercentage || 30}" onchange="updateLabourAmount()" min="0" max="100" required></td>
                                <td></td>
                                <td><span id="labourAmount">0.00</span></td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="cabinetTotal">${quotation.cabinetTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Worktop Section -->
                    <div class="section-title">Worktop</div>
                    <table class="quotation-table" id="worktopItemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotation.worktopItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                     <td style="position: relative; " class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="worktopTotal">${quotation.worktopTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Accessories Section -->
                    <div class="section-title">
                        <span>Accessories</span>
                        <div class="toggle-switch-container ms-auto">
                            <span></span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="accessoriesToggle" 
                                    ${quotation.includeAccessories && quotation.accessoriesItems?.length > 0 ? 'checked' : ''} 
                                    onchange="toggleEditAccessories(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <table class="quotation-table" id="accessoriesItemsTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotation.accessoriesItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                    <td style="position: relative;" class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="accessoriesTotal">${quotation.accessoriesTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Cabinets Total</span>
                            <span>KES <span id="grandCabinetTotal">${quotation.cabinetTotal.toFixed(2)}</span></span>
                        </div>
                        <div class="total-row">
                            <span>Worktop Total</span>
                            <span>KES <span id="grandWorktopTotal">${quotation.worktopTotal.toFixed(2)}</span></span>
                        </div>
                        <div class="total-row" data-accessories-total style="display: none;">
                            <span>Accessories Total</span>
                            <span>KES <span id="grandAccessoriesTotal">${quotation.accessoriesTotal.toFixed(2)}</span></span>
                        </div>
                        <div class="total-row grand-total">
                            <span>GRAND TOTAL</span>
                            <span>KES <span id="grandTotal">${quotation.grandTotal.toFixed(2)}</span></span>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h5>Terms and Conditions:</h5>
                        <ol>
                            <li>Please note that the above prices are subject to changes in case of variation in quantity or specifications and market rates.</li>
                            <li>Materials cost is payable either directly to the supplying company or through our pay bill number provided.</li>
                            <li>70% of the material cost is paid as deposit and 30% paid on delivery date.</li>
                            <li>DESIGN AND LABOUR COST MUST be paid through our pay bill number below;</li>
                            <div class="ms-4">
                                <div>PAYBILL NUMBER: 400200</div>
                                <div>ACCOUNT NUMBER: 845763</div>
                            </div>
                            <li>Job will commence upon payment of 70% of the quoted labor cost.</li>
                            <li>For supply and fix, deposit payable is 70%, 20% on the first day on site and 10% upon completion</li>
                            <li>The cost of transportation of materials to site is not included in the above quote</li>
                        </ol>
                    </div>
                </form>
            `;

            // Set quotation number edit ID
            document.getElementById('quotationNumber').dataset.editId = id;

            // Initialize accessories visibility based on quotation data
            const hasAccessories = quotation.includeAccessories && quotation.accessoriesItems?.length > 0;
            const accessoriesToggle = document.getElementById('accessoriesToggle');
            if (accessoriesToggle) {
                accessoriesToggle.checked = hasAccessories;
                toggleEditAccessories(hasAccessories);
            }

            // Calculate initial labour amount and totals
            setTimeout(() => {
                const labourPercentageInput = document.querySelector('.labour-percentage');
                if (labourPercentageInput) {
                    // Trigger change event to recalculate labour amount
                    const event = new Event('change');
                    labourPercentageInput.dispatchEvent(event);
                }
                updateAllTotals();
            }, 100);

            // Update modal title
            document.querySelector('#newQuotationModal .modal-title').textContent = 'Edit Quotation';

            // Update modal footer with conditional button text
            const modalFooter = document.querySelector('#newQuotationModal .modal-footer');
            
            // Get payments and calculate totals
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const quotationPayments = payments.filter(p => p.paidTo === quotation.quotationNumber);
            const totalPaid = quotationPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            const isFullyPaid = totalPaid >= quotation.grandTotal;

            modalFooter.innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="saveQuotation()">Save Quotation</button>
                ${isFullyPaid ? 
                    `<button type="button" class="btn btn-add" onclick="proceedToCashSale(${id})">
                        <i class="fas fa-cash-register me-2"></i>Proceed to Cash Sale
                    </button>` :
                    `<button type="button" class="btn btn-add" onclick="proceedToSalesOrder(${id})">
                        <i class="fas fa-clipboard-list me-2"></i>Proceed to Sales Order
                    </button>`
                }
            `;

            // Show modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }

         // Add this function to handle proceeding to cash sale
        function proceedToCashSale(quotationId) {
            try {
                const quotation = quotations.find(q => q.id === parseInt(quotationId));
                if (!quotation) {
                    alert('Quotation not found');
                    return;
                }

                // Generate cash sale number
                const cashSaleNumber = generateCashSaleNumber();

                // Create cash sale object
                const cashSale = {
                    id: Date.now(),
                    cashSaleNumber: cashSaleNumber,
                    date: new Date().toISOString(),
                    quotationNumber: quotation.quotationNumber,
                    clientId: quotation.clientId,
                    clientName: quotation.clientName,
                    clientPhone: quotation.clientPhone,
                    clientLocation: quotation.clientLocation,
                    cabinetItems: quotation.cabinetItems,
                    worktopItems: quotation.worktopItems,
                    accessoriesItems: quotation.accessoriesItems,
                    labourPercentage: quotation.labourPercentage,
                    cabinetTotal: quotation.cabinetTotal,
                    worktopTotal: quotation.worktopTotal,
                    accessoriesTotal: quotation.accessoriesTotal,
                    grandTotal: quotation.grandTotal,
                    includeAccessories: quotation.includeAccessories,
                    status: 'Pending Payment',
                    payments: [],
                    totalPaid: 0,
                    balance: quotation.grandTotal
                };

                // Save cash sale to localStorage
                let cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
                cashSales.unshift(cashSale);
                localStorage.setItem('cashSales', JSON.stringify(cashSales));

                // Update quotation status
                quotation.status = 'Converted to Cash Sale';
                saveQuotations();

                // Show cash sale modal
                showCashSaleModal(cashSale);

            } catch (error) {
                console.error('Error proceeding to cash sale:', error);
                alert('An error occurred while proceeding to cash sale. Please try again.');
            }
        }

        // Add function to show cash sale modal
        function showCashSaleModal(cashSale) {
            const modal = document.getElementById('newQuotationModal');
            modal.classList.add('a4-modal');

            // Update modal title
            document.querySelector('#newQuotationModal .modal-title').textContent = 'Cash Sale';

            // Create modal content
            document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                <form id="newQuotationForm" class="a4-document">
                    <!-- Company Header -->
                    <div class="document-header">
                        <div class="company-name">Cabinet Master Styles And Finishes</div>
                        <div class="company-details">
                            <div>cabinetmasterstyles@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone No: 0729554475</div>
                        </div>
                    </div>

                    <!-- Document Info -->
                    <div class="document-info">
                        <div class="document-info-group">
                            <h3>CASH SALE</h3>
                            <div class="info-row">
                                <span class="info-label">Cash Sale #</span>
                                <input type="text" class="info-value" value="${cashSale.cashSaleNumber}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Date</span>
                                <input type="text" class="info-value" value="${new Date(cashSale.date).toLocaleDateString()}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Quotation #</span>
                                <input type="text" class="info-value" value="${cashSale.quotationNumber}" readonly>
                            </div>
                        </div>

                        <div class="document-info-group">
                            <div class="info-row">
                                <span class="info-label">Client</span>
                                <input type="text" class="info-value" value="${cashSale.clientName}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone</span>
                                <input type="text" class="info-value" value="${cashSale.clientPhone}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Location</span>
                                <input type="text" class="info-value" value="${cashSale.clientLocation}" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="section-title">Items</div>
                    <table class="quotation-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${[...cashSale.cabinetItems, ...cashSale.worktopItems,
                               ...(cashSale.includeAccessories ? cashSale.accessoriesItems : [])]
                              .map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.unit}</td>
                                    <td>${item.quantity}</td>
                                    <td>KES ${item.rate.toFixed(2)}</td>
                                    <td>KES ${item.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>Cabinets Total</strong></td>
                                <td><strong>KES ${cashSale.cabinetTotal.toFixed(2)}</strong></td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>Worktop Total</strong></td>
                                <td><strong>KES ${cashSale.worktopTotal.toFixed(2)}</strong></td>
                            </tr>
                            ${cashSale.includeAccessories ? `
                                <tr>
                                    <td colspan="3"></td>
                                    <td><strong>Accessories Total</strong></td>
                                    <td><strong>KES ${cashSale.accessoriesTotal.toFixed(2)}</strong></td>
                                </tr>
                            ` : ''}
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>GRAND TOTAL</strong></td>
                                <td><strong>KES ${cashSale.grandTotal.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Payment Section -->
                    <div class="section-title mt-4">Payment Details</div>
                    <div class="payment-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Payment Method</label>
                                <select class="form-select" id="paymentMethod" required>
                                    <option value="">Select payment method</option>
                                    <option value="Cash">Cash</option>
                                    <option value="M-Pesa">M-Pesa</option>
                                    <option value="Bank Transfer">Bank Transfer</option>
                                    <option value="Card">Card</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="paymentAmount" 
                                       value="${cashSale.grandTotal}" required>
                            </div>
                        </div>
                    </div>
                </form>
            `;

            // Update modal footer
            document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="saveCashSale(${cashSale.id})">
                    Complete Cash Sale
                </button>
            `;

            // Show modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }

        // Add function to save cash sale
        function saveCashSale(cashSaleId) {
            try {
                const paymentMethod = document.getElementById('paymentMethod').value;
                const paymentAmount = parseFloat(document.getElementById('paymentAmount').value);

                if (!paymentMethod) {
                    alert('Please select a payment method');
                    return;
                }

                if (!paymentAmount || paymentAmount <= 0) {
                    alert('Please enter a valid payment amount');
                    return;
                }

                // Get cash sale
                let cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
                const cashSaleIndex = cashSales.findIndex(cs => cs.id === cashSaleId);
                if (cashSaleIndex === -1) {
                    alert('Cash sale not found');
                    return;
                }

                const cashSale = cashSales[cashSaleIndex];

                // Create payment record
                const payment = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    description: `Cash Sale Payment - ${cashSale.cashSaleNumber}`,
                    amount: paymentAmount,
                    method: paymentMethod,
                    paidTo: cashSale.quotationNumber,
                    clientId: cashSale.clientId,
                    clientName: cashSale.clientName
                };

                // Update cash sale
                cashSale.payments.push(payment);
                cashSale.totalPaid = paymentAmount;
                cashSale.balance = cashSale.grandTotal - paymentAmount;
                cashSale.status = cashSale.balance <= 0 ? 'Paid' : 'Partially Paid';

                // Save updated cash sale
                cashSales[cashSaleIndex] = cashSale;
                localStorage.setItem('cashSales', JSON.stringify(cashSales));

                // Save payment
                let payments = JSON.parse(localStorage.getItem('payments') || '[]');
                payments.unshift(payment);
                localStorage.setItem('payments', JSON.stringify(payments));

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newQuotationModal'));
                modal.hide();

                // Show success message
                alert('Cash sale completed successfully');

                // Refresh tables
                renderQuotationsTable();
                renderPaymentsTable();
                if (typeof renderCashSalesTable === 'function') {
                    renderCashSalesTable();
                }

            } catch (error) {
                console.error('Error saving cash sale:', error);
                alert('An error occurred while saving the cash sale. Please try again.');
            }
        }

        // Add new function to handle proceeding to sales order
        function proceedToSalesOrder(quotationId) {
            const quotation = quotations.find(q => q.id === quotationId);
            if (!quotation) {
                alert('Quotation not found');
                return;
            }

            // Check if any payments exist for this quotation
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const quotationPayments = payments.filter(p => p.paidTo === quotation.quotationNumber);
            
            if (quotationPayments.length === 0) {
                alert('Cannot convert to sales order. At least one payment must be made for this quotation.');
                return;
            }

            // Calculate total payments made
            const totalPayments = quotationPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            
            // Validate that there is at least some payment made
            if (totalPayments <= 0) {
                alert('Invalid payment amount. Payment must be greater than 0.');
                return;
            }

            // Generate sales order number using the new progressive system
            const orderNumber = generateSalesOrderNumber();

            // Update modal classes for A4 layout
            const modal = document.getElementById('newQuotationModal');
            modal.classList.add('a4-modal');

            // Create A4 document layout
            document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                <form id="newQuotationForm" class="a4-document">
                    <!-- Company Header -->
                    <div class="document-header">
                        <div class="company-name">Cabinet Master Styles And Finishes</div>
                        <div class="company-details">
                            <div>cabinetmasterstyles@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone No: 0729554475</div>
                        </div>
                    </div>

                    <!-- Document Info -->
                    <div class="document-info">
                        <!-- Left Column -->
                        <div class="document-info-group">
                            <h3>SALES ORDER</h3>
                            <div class="info-row">
                                <span class="info-label">Sales Order #</span>
                                <input type="text" class="info-value" id="orderNumber" value="${orderNumber}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Date</span>
                                <input type="text" class="info-value" value="${new Date().toLocaleDateString()}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Original Quotation #</span>
                                <input type="text" class="info-value" value="${quotation.quotationNumber}" readonly>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="document-info-group">
                            <div class="info-row">
                                <span class="info-label">Client</span>
                                <input type="text" class="info-value" id="clientSearch" value="${quotation.clientName}" 
                                    data-client-id="${quotation.clientId}"
                                    data-client-phone="${quotation.clientPhone}"
                                    data-client-location="${quotation.clientLocation}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone No</span>
                                <input type="text" class="info-value" value="${quotation.clientPhone}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Location</span>
                                <input type="text" class="info-value" value="${quotation.clientLocation}" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Kitchen Cabinets Section -->
                    <div class="section-title">Kitchen Cabinets</div>
                    <table class="quotation-table" id="cabinetItemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotation.cabinetItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                    <td style="position: relative;" class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>SUBTOTAL</strong></td>
                                <td><strong><span id="cabinetSubtotal">${quotation.cabinetTotal.toFixed(2)}</span></strong></td>
                            </tr>
                            <tr>
                                <td><strong>LABOUR</strong></td>
                                <td>%</td>
                                <td><input type="number" class="labour-percentage" value="${quotation.labourPercentage}" onchange="updateLabourAmount()" required></td>
                                <td></td>
                                <td><span id="labourAmount">0.00</span></td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="cabinetTotal">${quotation.cabinetTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Worktop Section -->
                    <div class="section-title">Worktop</div>
                    <table class="quotation-table" id="worktopItemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotation.worktopItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                    <td style="position: relative;" class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="worktopTotal">${quotation.worktopTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    ${quotation.includeAccessories ? `
                        <!-- Accessories Section -->
                        <div class="section-title">Accessories</div>
                        <table class="quotation-table" id="accessoriesItemsTable">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Units</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${quotation.accessoriesItems?.map(item => `
                                    <tr>
                                        <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                            <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </td>
                                        <td><input type="text" class="unit" value="${item.unit}" required></td>
                                        <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                        <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                        <td style="position: relative;" class="amount">${item.amount.toFixed(2)}
                                            <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"></td>
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong><span id="accessoriesTotal">${quotation.accessoriesTotal.toFixed(2)}</span></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    ` : ''}

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Cabinets Total</span>
                            <span>KES <span id="grandCabinetTotal">${quotation.cabinetTotal.toFixed(2)}</span></span>
                        </div>
                        <div class="total-row">
                            <span>Worktop Total</span>
                            <span>KES <span id="grandWorktopTotal">${quotation.worktopTotal.toFixed(2)}</span></span>
                        </div>
                        ${quotation.includeAccessories ? `
                            <div class="total-row">
                                <span>Accessories Total</span>
                                <span>KES <span id="grandAccessoriesTotal">${quotation.accessoriesTotal.toFixed(2)}</span></span>
                            </div>
                        ` : ''}
                        <div class="total-row grand-total">
                            <span>GRAND TOTAL</span>
                            <span>KES <span id="grandTotal">${quotation.grandTotal.toFixed(2)}</span></span>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h5>Terms and Conditions:</h5>
                        <ol>
                            <li>Please note that the above prices are subject to changes in case of variation in quantity or specifications and market rates.</li>
                            <li>Materials cost is payable either directly to the supplying company or through our pay bill number provided.</li>
                            <li>70% of the material cost is paid as deposit and 30% paid on delivery date.</li>
                            <li>DESIGN AND LABOUR COST MUST be paid through our pay bill number below;</li>
                            <div class="ms-4">
                                <div>PAYBILL NUMBER: 400200</div>
                                <div>ACCOUNT NUMBER: 845763</div>
                            </div>
                            <li>Job will commence upon payment of 70% of the quoted labor cost.</li>
                            <li>For supply and fix, deposit payable is 70%, 20% on the first day on site and 10% upon completion</li>
                            <li>The cost of transportation of materials to site is not included in the above quote</li>
                        </ol>
                    </div>
                </form>
            `;

            // Store quotation ID for reference when saving
            document.getElementById('orderNumber').dataset.quotationId = quotationId;

            // Update modal title and footer
            document.querySelector('#newQuotationModal .modal-title').textContent = 'Edit Sales Order';
            document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="saveSalesOrder()">Save Order</button>
            `;
            

            // Show modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }

        // Add new helper functions for row manipulation
        function addRowBelow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td style="position: relative;"><input type="text" class="description" required>
                <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                <i class="fas fa-plus"></i>
                </button>
                </td>
                <td><input type="text" class="unit" required></td>
                <td><input type="number" class="quantity" value="1" onchange="updateRowTotal(this)" required></td>
                <td><input type="number" class="price" step="0.01" onchange="updateRowTotal(this)" required></td>
                <td style="position: relative;" class="amount">0.00
                <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                <i class="fas fa-trash"></i>
                </button>
                </td>
            `;
            
            tbody.insertBefore(newRow, row.nextSibling);
            updateAllTotals();
        }

        function deleteRow(button) {
            const row = button.closest('tr');
            const tbody = row.parentNode;
            
            // Don't delete if it's the last row
            if (tbody.children.length > 1) {
                row.remove();
                updateAllTotals();
            }
        }

        // Print quotation
        function printQuotation(id) {
            const quotation = quotations.find(q => q.id === id);
            if (!quotation) return;

            const includeAccessories = document.getElementById('accessoriesToggle').checked;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Quotation #${quotation.quotationNumber}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @media print {
                            .no-print {
                                display: none;
                            }
                            body {
                                background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png') !important;
                                background-size: cover !important;
                                background-position: center !important;
                                background-repeat: no-repeat !important;
                            }
                        }
                        body {
                            background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png');
                            background-size: cover;
                            background-position: center;
                            background-repeat: no-repeat;
                            min-height: 100vh;
                            padding: 20px;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                        }
                        .company-name {
                            font-size: 24px;
                            font-weight: bold;
                        }
                        .quotation-details {
                            margin-bottom: 20px;
                        }
                        .table th {
                            background-color: #00000000 !important;
                        }
                    </style>
                </head>
                <body>
                    <div class="container p-4">
                        <div class="header">
                            <div class="company-name">Cabinet Master Styles And Finishes</div>
                            <div>cabinetmasterstylesandfinishes@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone: 0729554475</div>
                        </div>

                        <div class="quotation-details">
                            <div class="row">
                                <div class="col-6">
                                    <h2>QUOTATION</h2>
                                    <p><strong>Quotation #:</strong> ${quotation.quotationNumber}</p>
                                    <p><strong>Date:</strong> ${new Date(quotation.date).toLocaleDateString()}</p>
                                </div>
                                <div class="col-6 text-end">
                                    <p><strong>Client:</strong> ${quotation.clientName}</p>
                                    <p><strong>Phone:</strong> ${quotation.clientPhone}</p>
                                    <p><strong>Location:</strong> ${quotation.clientLocation}</p>
                                </div>
                            </div>
                        </div>

                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Unit</th>
                                    <th>Quantity</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${quotation.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.unit}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.rate.toFixed(2)}</td>
                                        <td>KES ${item.amount.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                                ${includeAccessories ? quotation.accessories?.map(item => `
                                    <tr>
                                        <td>${item.description} (Accessory)</td>
                                        <td>${item.unit}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.rate.toFixed(2)}</td>
                                        <td>KES ${item.amount.toFixed(2)}</td>
                                    </tr>
                                `).join('') || '' : ''}
                            </tbody>
                        </table>

                        <div class="row">
                            <div class="col-6 offset-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Total Amount:</strong></td>
                                        <td class="text-end"><strong>KES ${quotation.total.toFixed(2)}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="mt-4">
                            <h5>Terms and Conditions:</h5>
                            <ol>
                                <li>Please note that the above prices are subject to changes in case of variation in quantity or specifications and market rates.</li>
                                <li>Materials cost is payable either directly to the supplying company or through our pay bill number provided.</li>
                                <li>70% of the material cost is paid as deposit and 30% paid on delivery date.</li>
                                <li>DESIGN AND LABOUR COST MUST be paid through our pay bill number below;</li>
                                <div class="ms-4">
                                    <div>PAYBILL NUMBER: 400200</div>
                                    <div>ACCOUNT NUMBER: 845763</div>
                                </div>
                                <li>Job will commence upon payment of 70% of the quoted labor cost.</li>
                                <li>For supply and fix, deposit payable is 70%, 20% on the first day on site and 10% upon completion</li>
                                <li>The cost of transportation of materials to site is not included in the above quote</li>
                            </ol>
                        </div>

                        <div class="text-center mt-4 no-print">
                            <button onclick="window.print()" class="btn btn-primary">Print Quotation</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        // Download quotation
        async function downloadQuotation(id) {
            const quotation = quotations.find(q => q.id === id);
            if (!quotation) return;

            const doc = new jsPDF();
            
            // Add background
            await addBackgroundToPDF(doc);
            
            // Add header
            doc.setFontSize(20);
            doc.text('QUOTATION', 105, 20, { align: 'center' });
            
            // Add company details
            doc.setFontSize(12);
            doc.text('Cabinet Master Styles And Finishes', 105, 30, { align: 'center' });
            doc.text('cabinetmasterstylesandfinishes@gmail.com', 105, 35, { align: 'center' });
            doc.text('Kamakis-Ruiru, Kenya', 105, 40, { align: 'center' });
            doc.text('Phone: 0729554475', 105, 45, { align: 'center' });

            // Add quotation details
            doc.text(`Quotation #: ${quotation.quotationNumber}`, 20, 60);
            doc.text(`Date: ${new Date(quotation.date).toLocaleDateString()}`, 20, 65);
            
            // Add client details
            doc.text('To:', 120, 60);
            doc.text(quotation.clientName, 120, 65);
            doc.text(quotation.clientPhone, 120, 70);
            doc.text(quotation.clientLocation, 120, 75);

            // Add items table
            const headers = [['Description', 'Unit', 'Quantity', 'Rate', 'Amount']];
            const data = quotation.items.map(item => [
                item.description,
                item.unit,
                item.quantity.toString(),
                `KES ${item.rate.toFixed(2)}`,
                `KES ${item.amount.toFixed(2)}`
            ]);

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 85,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Add total
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Amount: KES ${quotation.total.toFixed(2)}`, 150, finalY, { align: 'right' });

            // Add Terms and Conditions
            doc.text('Terms and Conditions:', 20, finalY + 20);
            doc.setFontSize(10);
            doc.text('1. Please note that the above prices are subject to changes in case of variation in', 25, finalY + 30);
            doc.text('   quantity or specifications and market rates.', 25, finalY + 35);
            doc.text('2. Materials cost is payable either directly to the supplying company or through our', 25, finalY + 40);
            doc.text('   pay bill number provided.', 25, finalY + 45);
            doc.text('3. 70% of the material cost is paid as deposit and 30% paid on delivery date.', 25, finalY + 50);
            doc.text('4. DESIGN AND LABOUR COST MUST be paid through our pay bill number below;', 25, finalY + 55);
            doc.text('   PAYBILL NUMBER: 400200', 30, finalY + 60);
            doc.text('   ACCOUNT NUMBER: 845763', 30, finalY + 65);
            doc.text('5. Job will commence upon payment of 70% of the quoted labor cost.', 25, finalY + 70);
            doc.text('6. For supply and fix, deposit payable is 70%, 20% on the first day on site and', 25, finalY + 75);
            doc.text('   10% upon completion', 25, finalY + 80);
            doc.text('7. The cost of transportation of materials to site is not included in the above quote', 25, finalY + 85);

            // Save the PDF
            doc.save(`quotation_${quotation.quotationNumber}.pdf`);
        }

        // Update toggleAccessories function
        function toggleAccessories(show) {
            // Get all required elements
            const accessoriesHeader = document.querySelector('h4.mb-3.d-flex.justify-content-between.align-items-center');
            const accessoriesTable = document.getElementById('accessoriesItemsTable')?.closest('.table-responsive');
            const accessoriesTotalRow = document.querySelector('[data-accessories-total]');
            
            // Only proceed if we have the required elements
            if (!accessoriesHeader || !accessoriesTable || !accessoriesTotalRow) {
                console.warn('Some accessories elements not found');
                return;
            }

            const accessoriesSpan = accessoriesHeader.querySelector('span:first-child');
            const accessoriesTotalLabel = accessoriesTotalRow.querySelector('strong');
            const accessoriesTotalValue = accessoriesTotalRow.querySelector('span');
            const toggleLabel = accessoriesHeader.querySelector('.toggle-switch-container .small.text-muted');
            
            if (!accessoriesSpan || !accessoriesTotalLabel || !accessoriesTotalValue || !toggleLabel) {
                console.warn('Some accessories child elements not found');
                return;
            }
            
            // Set display styles
            accessoriesHeader.style.display = show ? 'flex' : 'none';
            accessoriesSpan.style.display = show ? 'inline' : 'none';
            accessoriesTable.style.display = show ? 'block' : 'none';
            accessoriesTotalRow.style.display = show ? 'flex' : 'none';
            accessoriesTotalLabel.style.display = show ? 'inline' : 'none';
            accessoriesTotalValue.style.display = show ? 'inline' : 'none';
            
            // Update toggle label text
            toggleLabel.textContent = show ? 'Exclude Accessories' : 'Include Accessories';
            
            // Update calculations
            updateAllTotals();
            
            // If toggle is off, ensure the accessories total is not included in calculations
            if (!show) {
                const grandAccessoriesTotal = document.getElementById('grandAccessoriesTotal');
                if (grandAccessoriesTotal) {
                    grandAccessoriesTotal.textContent = '0.00';
                }
            }
        }

        // Add new function for handling accessories toggle in edit quotation
        function toggleEditAccessories(show) {
            // Get all required elements
            const accessoriesSection = document.querySelector('.section-title');
            const accessoriesTable = document.getElementById('accessoriesItemsTable');
            const accessoriesTotalRow = document.querySelector('[data-accessories-total]');
            
            if (!accessoriesSection || !accessoriesTable || !accessoriesTotalRow) {
                console.warn('Some accessories elements not found in edit mode');
                return;
            }

            // Show/hide accessories table and total
            accessoriesTable.style.display = show ? 'table' : 'none';
            accessoriesTotalRow.style.display = show ? 'flex' : 'none';

            // Handle table rows
            const tbody = accessoriesTable.querySelector('tbody');
            
            if (show) {
                // If showing and table is empty, add a new row
                if (!tbody.children.length) {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td style="position: relative;"><input type="text" class="description" required>
                            <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </td>
                        <td><input type="text" class="unit" required></td>
                        <td><input type="number" class="quantity" value="1" onchange="updateRowTotal(this)" required></td>
                        <td><input type="number" class="price" step="0.01" onchange="updateRowTotal(this)" required></td>
                        <td style="position: relative;" class="amount">0.00
                            <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(newRow);
                }
            } else {
                // When hiding, only remove empty rows
                Array.from(tbody.children).forEach(row => {
                    const description = row.querySelector('.description').value;
                    const unit = row.querySelector('.unit').value;
                    const quantity = row.querySelector('.quantity').value;
                    const price = row.querySelector('.price').value;
                    
                    // Remove row if all fields are empty
                    if (!description && !unit && (!quantity || quantity === '1') && !price) {
                        row.remove();
                    }
                });
            }

            // Update calculations
            updateAllTotals();
            
            // If toggle is off, ensure the accessories total is not included in calculations
            if (!show) {
                const accessoriesTotal = document.getElementById('accessoriesTotal');
                const grandAccessoriesTotal = document.getElementById('grandAccessoriesTotal');
                if (accessoriesTotal) accessoriesTotal.textContent = '0.00';
                if (grandAccessoriesTotal) grandAccessoriesTotal.textContent = '0.00';
                
                // Update grand total to exclude accessories
                const cabinetTotal = parseFloat(document.getElementById('cabinetTotal').textContent) || 0;
                const worktopTotal = parseFloat(document.getElementById('worktopTotal').textContent) || 0;
                const grandTotal = cabinetTotal + worktopTotal;
                document.getElementById('grandTotal').textContent = grandTotal.toFixed(2);
            }
        }

        // Update the DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            loadRegisteredEntities();
            
            // Initialize accessories visibility
            const accessoriesToggle = document.getElementById('accessoriesToggle');
            if (accessoriesToggle) {
                accessoriesToggle.checked = false;
                toggleAccessories(false);
            }
        });

        // Payment related functions
        function togglePaymentClientDropdown() {
            const resultsContainer = document.getElementById('paymentClientSearchResults');
            const isVisible = resultsContainer.style.display === 'block';
            
            if (!isVisible) {
                const filteredClients = registeredEntities
                    .filter(entity => entity.type === 'client')
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

                resultsContainer.innerHTML = filteredClients
                    .map(client => `
                        <div class="dropdown-item" onclick="selectPaymentClient('${client.id}', '${client.name}', '${client.phone}', '${client.location}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${client.name}</strong>
                                    <div class="small text-dark">${client.location}</div>
                                </div>
                                <div class="small text-dark">${client.phone}</div>
                            </div>
                        </div>
                    `).join('');
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.style.display = 'none';
            }
        }

        // Initialize payment client search
        document.getElementById('paymentClientSearch')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('paymentClientSearchResults');
            
            if (searchTerm.length > 0) {
                const filteredClients = registeredEntities
                    .filter(entity => 
                        entity.type === 'client' && 
                        entity.name.toLowerCase().includes(searchTerm)
                    )
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

                if (filteredClients.length > 0) {
                    resultsContainer.innerHTML = filteredClients
                        .map(client => `
                            <div class="dropdown-item" onclick="selectPaymentClient('${client.id}', '${client.name}', '${client.phone}', '${client.location}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>${highlightMatch(client.name, searchTerm)}</strong>
                                        <div class="small text-dark">${client.location}</div>
                                    </div>
                                    <div class="small text-dark">${client.phone}</div>
                                </div>
                            </div>
                        `).join('');
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.innerHTML = '<div class="dropdown-item">No clients found</div>';
                    resultsContainer.style.display = 'block';
                }
            } else {
                resultsContainer.style.display = 'none';
            }
        });

        function selectPaymentClient(id, name, phone, location) {
            const input = document.getElementById('paymentClientSearch');
            input.value = name;
            input.dataset.clientId = id;
            input.dataset.clientPhone = phone;
            input.dataset.clientLocation = location;
            
            // Hide dropdown
            document.getElementById('paymentClientSearchResults').style.display = 'none';

            // Populate quotation numbers for this client
            populateClientQuotations(id);
        }

        // Add new function to populate quotation numbers
        function populateClientQuotations(clientId) {
            const paidToSelect = document.querySelector('select[name="paidTo"]');
            if (!paidToSelect) return;

            // Clear existing options
            paidToSelect.innerHTML = '<option value="">Select Quotation</option>';

            try {
                // Get all quotations from localStorage
                const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
                
                // Filter quotations for this client and sort by date (newest first)
                const clientQuotations = quotations
                    .filter(q => q.clientId === clientId)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                // Add options for each quotation
                clientQuotations.forEach(quotation => {
                    const option = document.createElement('option');
                    option.value = quotation.quotationNumber;
                    const date = new Date(quotation.date).toLocaleDateString();
                    option.textContent = `${quotation.quotationNumber} (${date}) - KES ${quotation.grandTotal.toFixed(2)}`;
                    paidToSelect.appendChild(option);
                });

                // Select the latest quotation by default
                if (clientQuotations.length > 0) {
                    paidToSelect.value = clientQuotations[0].quotationNumber;
                }
            } catch (error) {
                console.error('Error populating quotations:', error);
            }
        }

        // Update savePayment function to include paidTo
        function savePayment() {
            try {
            const form = document.getElementById('paymentForm');
            if (!form) {
                console.error('Payment form not found');
                return;
            }

            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const clientInput = document.getElementById('paymentClientSearch');
            if (!clientInput || !clientInput.dataset.clientId) {
                alert('Please select a client from the list');
                return;
            }

                // Get form data
                const paymentData = {
                    id: Date.now(),
                    date: document.getElementById('paymentDate').value,
                    clientId: clientInput.dataset.clientId,
                    clientName: clientInput.value,
                    clientPhone: clientInput.dataset.clientPhone || '',
                    clientLocation: clientInput.dataset.clientLocation || '',
                    description: form.querySelector('[name="description"]').value,
                    amount: parseFloat(form.querySelector('[name="amount"]').value) || 0,
                    paidTo: form.querySelector('[name="paidTo"]').value,
                    account: form.querySelector('[name="account"]').value
                };

                // Validate payment amount
                if (paymentData.amount <= 0) {
                    alert('Payment amount must be greater than 0');
                    return;
                }

                // Generate payment number
                paymentData.paymentNumber = generatePaymentNumber();

                // Save payment data
                let payments = JSON.parse(localStorage.getItem('payments') || '[]');
                payments.unshift(paymentData); // Add new payment at the beginning
                localStorage.setItem('payments', JSON.stringify(payments));

                // Update related documents based on paidTo value
                const paidTo = paymentData.paidTo;
                if (paidTo) {
                    // Update quotations
                    let quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
                    const quotationIndex = quotations.findIndex(q => q.quotationNumber === paidTo);
                    if (quotationIndex !== -1) {
                        const quotation = quotations[quotationIndex];
                        quotation.payments = quotation.payments || [];
                        quotation.payments.push(paymentData);
                        quotation.totalPaid = (quotation.totalPaid || 0) + paymentData.amount;
                        quotation.balance = quotation.grandTotal - quotation.totalPaid;
                        localStorage.setItem('quotations', JSON.stringify(quotations));
                    }

                    // Update sales orders
                    let salesOrders = JSON.parse(localStorage.getItem('salesOrders') || '[]');
                    const salesOrderIndex = salesOrders.findIndex(so => so.orderNumber === paidTo);
                    if (salesOrderIndex !== -1) {
                        const salesOrder = salesOrders[salesOrderIndex];
                        salesOrder.payments = salesOrder.payments || [];
                        salesOrder.payments.push(paymentData);
                        salesOrder.totalPaid = (salesOrder.totalPaid || 0) + paymentData.amount;
                        salesOrder.balance = salesOrder.grandTotal - salesOrder.totalPaid;
                        localStorage.setItem('salesOrders', JSON.stringify(salesOrders));
                    }

                    // Update invoices
                    let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                    const invoiceIndex = invoices.findIndex(i => i.invoiceNumber === paidTo);
                    if (invoiceIndex !== -1) {
                        const invoice = invoices[invoiceIndex];
                        invoice.payments = invoice.payments || [];
                        invoice.payments.push(paymentData);
                        invoice.totalPaid = (invoice.totalPaid || 0) + paymentData.amount;
                        invoice.balance = invoice.grandTotal - invoice.totalPaid;
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                    }
                }

                // Force immediate UI update
                requestAnimationFrame(() => {
                    // Force update all data and UI
                    updatePaymentSummaries(true);
                    
                    // Show success message after UI is updated
                    alert('Payment saved successfully');
                });
                
                // Close modal and reset form
                const modalElement = document.getElementById('makePaymentModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // Reset the form
                form.reset();
                
                // Clear client search data
                if (clientInput) {
                    clientInput.value = '';
                    delete clientInput.dataset.clientId;
                    delete clientInput.dataset.clientPhone;
                    delete clientInput.dataset.clientLocation;
                }
            } catch (error) {
                console.error('Error saving payment:', error);
                alert('An error occurred while saving the payment. Please try again.');
            }
        }

        // ... existing code ...

        // Payment related functions
        function filterPayments() {
            const searchTerm = document.getElementById('paymentsSearch').value.toLowerCase();
            const clientFilter = document.getElementById('paymentClientFilter').value;
            const dateFilter = document.getElementById('paymentsDateFilter').value;
            const specificDate = document.getElementById('paymentsSpecificDate').value;
            
            // Get period dates if the period filter is selected
            let periodStartDate = null;
            let periodEndDate = null;
            if (dateFilter === 'period') {
                periodStartDate = document.getElementById('paymentsPeriodStartDate').value;
                periodEndDate = document.getElementById('paymentsPeriodEndDate').value;
            }
            
            const rows = document.querySelectorAll('#paymentsTable tbody tr');
            
            rows.forEach(row => {
                const payment = row.children;
                const paymentNumber = payment[0].textContent.toLowerCase();
                const client = payment[1].textContent.toLowerCase();
                const date = payment[2].textContent; // Format: YYYY-MM-DD
                
                // Search filter
                const matchesSearch = 
                    paymentNumber.includes(searchTerm) || 
                    client.includes(searchTerm);
                
                // Client filter
                const matchesClient = !clientFilter || client.includes(clientFilter.toLowerCase());
                
                // Date filter
                let matchesDate = true;
                if (dateFilter === 'specific' && specificDate) {
                    const rowDate = new Date(date);
                    rowDate.setHours(0, 0, 0, 0);
                    const selectedDate = new Date(specificDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    matchesDate = rowDate.getTime() === selectedDate.getTime();
                } else if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                    matchesDate = checkDateFilter(date, 'period', periodStartDate, periodEndDate);
                } else {
                    matchesDate = !dateFilter || checkDateFilter(date, dateFilter);
                }
                
                // Apply all filters
                row.style.display = (matchesSearch && matchesClient && matchesDate) ? '' : 'none';
            });
        }

        // Handle date filter for payments
        function handleDateFilter(type) {
            const dateFilter = document.getElementById(`${type}DateFilter`);
            const specificDate = document.getElementById(`${type}SpecificDate`);
            const periodStartDate = document.getElementById(`${type}PeriodStartDate`);
            const periodEndDate = document.getElementById(`${type}PeriodEndDate`);
            
            if (!dateFilter || !specificDate || !periodStartDate || !periodEndDate) {
                console.error(`Date filter elements not found for type: ${type}`);
                return;
            }
            
            if (dateFilter.value === 'specific') {
                specificDate.style.display = 'block';
                periodStartDate.style.display = 'none';
                periodEndDate.style.display = 'none';
                // Set to today's date in local timezone
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                specificDate.value = `${year}-${month}-${day}`;
            } else if (dateFilter.value === 'period') {
                specificDate.style.display = 'none';
                periodStartDate.style.display = 'block';
                periodEndDate.style.display = 'block';
            } else {
                specificDate.style.display = 'none';
                periodStartDate.style.display = 'none';
                periodEndDate.style.display = 'none';
            }
            
            filterPayments();
        }

        // Export payments report
        async function exportPaymentsReport() {
            const doc = new jsPDF();
            
            // Add background image
            await addBackgroundToPDF(doc);
            
            // Add title
            doc.setFontSize(20);
            doc.text('Payments Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary if needed
            doc.setFontSize(14);
            doc.text('Payment Summary', 20, 45);

            // Add payments table
            const headers = [['Client', 'Date', 'Paid To', 'Description', 'Amount', 'Account', 'Actions']];
            const data = [];
            
            document.querySelectorAll('#paymentsTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    `KES ${parseFloat(row.cells[4].textContent).toFixed(2)}`,
                    row.cells[5].textContent,
                    `
                        <div class="d-flex gap-1">
                            <button class="action-btn" onclick="viewPaymentDetails(${row.cells[0].textContent})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn" onclick="printPaymentReceipt(${row.cells[0].textContent})">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="action-btn" onclick="downloadPaymentReceipt(${row.cells[0].textContent})">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    `
                ]);
            });

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 55,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Add total at the bottom
            const total = data.reduce((sum, row) => {
                const amount = parseFloat(row[4].replace('KES ', '')) || 0;
                return sum + amount;
            }, 0);

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Payments: KES ${total.toFixed(2)}`, 20, finalY);

            doc.save('payments_report.pdf');
        }

        // Save payment to storage
        function savePaymentToStorage(paymentData) {
            try {
                // Generate payment number if not already present
                if (!paymentData.paymentNumber) {
                    paymentData.paymentNumber = generatePaymentNumber();
                }
                
                let payments = JSON.parse(localStorage.getItem('payments') || '[]');
                payments.push(paymentData);
                localStorage.setItem('payments', JSON.stringify(payments));
                
                // Update the payments table
                renderPaymentsTable();
                // Update client filter options
                updatePaymentClientFilter();
                return true;
            } catch (error) {
                console.error('Error saving payment:', error);
                return false;
            }
        }

        // Update payment client filter
        function updatePaymentClientFilter() {
            const clientFilter = document.getElementById('paymentClientFilter');
            if (!clientFilter) return;

            try {
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                
                // Filter out any payments with undefined or null client names
                const uniqueClients = [...new Set(payments
                    .filter(p => p && p.clientName)
                    .map(p => p.clientName))]
                    .filter(Boolean)
                    .sort();
                
                clientFilter.innerHTML = '<option value="">All Clients</option>';
                uniqueClients.forEach(client => {
                    if (client) {
                        const option = document.createElement('option');
                        option.value = client.toLowerCase();
                        option.textContent = client;
                        clientFilter.appendChild(option);
                    }
                });
            } catch (error) {
                console.error('Error updating client filter:', error);
                clientFilter.innerHTML = '<option value="">All Clients</option>';
            }
        }

        // Render payments table
        function renderPaymentsTable() {
            const tbody = document.getElementById('paymentsTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.warn('Payments table body not found');
                return;
            }

            try {
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                tbody.innerHTML = '';
                
                // Sort payments by date in descending order (latest first)
                const sortedPayments = payments
                    .filter(payment => payment && payment.clientName)
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                sortedPayments.forEach(payment => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${payment.paymentNumber || ''}</td>
                        <td>${payment.clientName || ''}</td>
                        <td>${payment.date ? new Date(payment.date).toLocaleDateString() : ''}</td>
                        <td>${payment.paidTo || ''}</td>
                        <td>${payment.description || ''}</td>
                        <td>KES ${(payment.amount || 0).toFixed(2)}</td>
                        <td>${payment.account || ''}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="action-btn" onclick="viewPaymentDetails(${payment.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="printPaymentReceipt(${payment.id})">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="action-btn" onclick="downloadPaymentReceipt(${payment.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });

                // Update client filter options
                updatePaymentClientFilter();
            } catch (error) {
                console.error('Error rendering payments table:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Error loading payments</td></tr>';
            }
        }

        // Initialize payments section
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Initialize payments section
            renderPaymentsTable();
            updatePaymentClientFilter();
        });

        // Initialize sales orders array
        let salesOrders = [];

        // Load sales orders from localStorage
        function loadSalesOrders() {
            const storedOrders = localStorage.getItem('salesOrders');
            if (storedOrders) {
                salesOrders = JSON.parse(storedOrders);
            }
            renderSalesOrdersTable();
        }

        // Save sales orders to localStorage
        function saveSalesOrders() {
            localStorage.setItem('salesOrders', JSON.stringify(salesOrders));
        }

        // Update renderSalesOrdersTable function
        function renderSalesOrdersTable() {
            const table = document.getElementById('salesOrdersTable');
            if (!table) {
                console.warn('Sales orders table not found');
                return;
            }

            const tbody = table.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.warn('Sales orders table body not found');
                return;
            }

            tbody.innerHTML = '';

            // Sort sales orders by date in descending order (latest first)
            const sortedOrders = [...salesOrders].sort((a, b) => 
                new Date(b.date) - new Date(a.date)
            );

            sortedOrders.forEach(order => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${order.orderNumber}</td>
                    <td>${new Date(order.date).toLocaleDateString()}</td>
                    <td>${order.clientName}</td>
                    <td>KES ${(order.grandTotal || 0).toFixed(2)}</td>
                    <td>
                        <span class="badge" ${getStatusBadgeClass(order.status)}>
                            ${order.status}
                        </span>
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="action-btn" onclick="editSalesOrder(${order.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="printSalesOrder(${order.id})">
                                <i class="fas fa-print"></i>
                            </button>
                            <button class="action-btn" onclick="downloadSalesOrder(${order.id})">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </td>
                `;
            });

            // Update client filter options
            const clientFilter = document.getElementById('salesOrderClientFilter');
            if (clientFilter) {
                const uniqueClients = [...new Set(salesOrders.map(o => o.clientName))];
                clientFilter.innerHTML = '<option value="">All Clients</option>' +
                    uniqueClients.map(client => `<option value="${client}">${client}</option>`).join('');
            }
        }

        // Filter sales orders
        function filterSalesOrders() {
            const searchTerm = document.getElementById('salesOrderSearch').value.toLowerCase();
            const clientFilter = document.getElementById('salesOrderClientFilter').value.toLowerCase();
            const dateFilter = document.getElementById('salesOrderDateFilter').value;
            const specificDate = document.getElementById('salesOrderSpecificDate').value;
            
            // Get period dates if the period filter is selected
            let periodStartDate = null;
            let periodEndDate = null;
            if (dateFilter === 'period') {
                periodStartDate = document.getElementById('salesOrderPeriodStartDate').value;
                periodEndDate = document.getElementById('salesOrderPeriodEndDate').value;
            }
            
            const rows = document.querySelectorAll('#salesOrdersTable tbody tr');
            
            rows.forEach(row => {
                const order = row.children;
                const orderNumber = order[0].textContent.toLowerCase();
                const client = order[2].textContent.toLowerCase();
                const date = order[1].textContent; // Format: YYYY-MM-DD
                
                // Search filter
                const matchesSearch = 
                    orderNumber.includes(searchTerm) || 
                    client.includes(searchTerm);
                
                // Client filter
                const matchesClient = !clientFilter || client.includes(clientFilter.toLowerCase());
                
                // Date filter
                let matchesDate = true;
                if (dateFilter === 'specific' && specificDate) {
                    const rowDate = new Date(date);
                    rowDate.setHours(0, 0, 0, 0);
                    const selectedDate = new Date(specificDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    matchesDate = rowDate.getTime() === selectedDate.getTime();
                } else if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                    matchesDate = checkDateFilter(date, 'period', periodStartDate, periodEndDate);
                } else {
                    matchesDate = !dateFilter || checkDateFilter(date, dateFilter);
                }

                // Apply all filters
                row.style.display = (matchesSearch && matchesClient && matchesDate) ? '' : 'none';
            });
        }

        // Export sales orders
        async function exportSalesOrders() {
            const doc = new jsPDF();
            
            // Add background image
            await addBackgroundToPDF(doc);
            
            // Add title
            doc.setFontSize(20);
            doc.text('Sales Orders Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary section
            doc.setFontSize(14);
            doc.text('Sales Order Summary', 20, 45);

            // Add sales orders table
            const headers = [['Order #', 'Date', 'Client', 'Total Amount', 'Status']];
            const data = [];
            
            document.querySelectorAll('#salesOrdersTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent
                ]);
            });

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 55,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Add total at the bottom
            const total = data.reduce((sum, row) => {
                const amount = parseFloat(row[3].replace('KES ', '')) || 0;
                return sum + amount;
            }, 0);

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Sales Orders Value: KES ${total.toFixed(2)}`, 20, finalY);

            doc.save('sales_orders_report.pdf');
        }

        // Add to DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            loadSalesOrders();
        });

        function editSalesOrder(id) {
            const salesOrder = salesOrders.find(o => o.id === id);
            if (!salesOrder) {
                alert('Sales order not found');
                return;
            }

            // Update modal classes for A4 layout
            const modal = document.getElementById('newQuotationModal');
            modal.classList.add('a4-modal');

            // Create A4 document layout
            document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                <form id="newQuotationForm" class="a4-document">
                    <!-- Company Header -->
                    <div class="document-header">
                        <div class="company-name">Cabinet Master Styles And Finishes</div>
                        <div class="company-details">
                            <div>cabinetmasterstyles@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone No: 0729554475</div>
                        </div>
                    </div>

                    <!-- Document Info -->
                    <div class="document-info">
                        <!-- Left Column -->
                        <div class="document-info-group">
                            <h3>SALES ORDER</h3>
                            <div class="info-row">
                                <span class="info-label">Order #</span>
                                <input type="text" class="info-value" id="orderNumber" value="${salesOrder.orderNumber}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Date</span>
                                <input type="text" class="info-value" value="${new Date(salesOrder.date).toLocaleDateString()}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Quotation #</span>
                                <input type="text" class="info-value" value="${salesOrder.quotationNumber}" readonly>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="document-info-group">
                            <div class="info-row">
                                <span class="info-label">Client</span>
                                <input type="text" class="info-value" id="clientSearch" value="${salesOrder.clientName}" 
                                    data-client-id="${salesOrder.clientId}"
                                    data-client-phone="${salesOrder.clientPhone}"
                                    data-client-location="${salesOrder.clientLocation}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone No</span>
                                <input type="text" class="info-value" value="${salesOrder.clientPhone}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Location</span>
                                <input type="text" class="info-value" value="${salesOrder.clientLocation}" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Kitchen Cabinets Section -->
                    <div class="section-title">Kitchen Cabinets</div>
                    <table class="quotation-table" id="cabinetItemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesOrder.cabinetItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                    <td style="position: relative;" class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>SUBTOTAL</strong></td>
                                <td><strong><span id="cabinetSubtotal">${salesOrder.cabinetTotal.toFixed(2)}</span></strong></td>
                            </tr>
                            <tr>
                                <td><strong>ADD LABOUR</strong></td>
                                <td>%</td>
                                <td><input type="number" class="labour-percentage" value="${salesOrder.labourPercentage || 30}" onchange="updateLabourAmount()" min="0" max="100" required></td>
                                <td></td>
                                <td><span id="labourAmount">0.00</span></td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="cabinetTotal">${salesOrder.cabinetTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Worktop Section -->
                    <div class="section-title">Worktop</div>
                    <table class="quotation-table" id="worktopItemsTable">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesOrder.worktopItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                    <td style="position: relative;" class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="worktopTotal">${salesOrder.worktopTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Accessories Section -->
                    <div class="section-title">
                        <span>Accessories</span>
                        <div class="toggle-switch-container ms-auto">
                            <label class="toggle-switch">
                                <input type="checkbox" id="accessoriesToggle" 
                                    ${salesOrder.includeAccessories ? 'checked' : ''} 
                                    onchange="toggleEditAccessories(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <table class="quotation-table" id="accessoriesItemsTable" style="display: ${salesOrder.includeAccessories ? 'table' : 'none'};">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${salesOrder.accessoriesItems?.map(item => `
                                <tr>
                                    <td style="position: relative;"><input type="text" class="description" value="${item.description}" required>
                                        <button type="button" class="hover-action add-row" onclick="addRowBelow(this)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <td><input type="text" class="unit" value="${item.unit}" required></td>
                                    <td><input type="number" class="quantity" value="${item.quantity}" onchange="updateRowTotal(this)" required></td>
                                    <td><input type="number" class="price" value="${item.rate}" onchange="updateRowTotal(this)" required></td>
                                    <td style="position: relative;" class="amount">${item.amount.toFixed(2)}
                                        <button type="button" class="hover-action delete-row" onclick="deleteRow(this)">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong><span id="accessoriesTotal">${salesOrder.accessoriesTotal.toFixed(2)}</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Cabinets Total</span>
                            <span>KES <span id="grandCabinetTotal">${salesOrder.cabinetTotal.toFixed(2)}</span></span>
                        </div>
                        <div class="total-row">
                            <span>Worktop Total</span>
                            <span>KES <span id="grandWorktopTotal">${salesOrder.worktopTotal.toFixed(2)}</span></span>
                        </div>
                        <div class="total-row" data-accessories-total style="display: ${salesOrder.includeAccessories ? 'flex' : 'none'};">
                            <span>Accessories Total</span>
                            <span>KES <span id="grandAccessoriesTotal">${salesOrder.accessoriesTotal.toFixed(2)}</span></span>
                        </div>
                        <div class="total-row grand-total">
                            <span>GRAND TOTAL</span>
                            <span>KES <span id="grandTotal">${salesOrder.grandTotal.toFixed(2)}</span></span>
                        </div>
                    </div>

                    <!-- Payment Summary Section -->
                    <div class="section-title" style="margin-top: 30px;">Payment Summary</div>
                    <table class="quotation-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Account</th>
                            </tr>
                        </thead>
                        <tbody id="paymentSummaryTableBody">
                            <!-- Payment data will be dynamically added here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2"><strong>Total Paid</strong></td>
                                <td colspan="2"><strong>KES <span id="totalPaidAmount">0.00</span></strong></td>
                            </tr>
                            <tr>
                                <td colspan="2"><strong>Balance</strong></td>
                                <td colspan="2"><strong>KES <span id="balanceAmount">0.00</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h5>Terms and Conditions:</h5>
                        <ol>
                            <li>Please note that the above prices are subject to changes in case of variation in quantity or specifications and market rates.</li>
                            <li>Materials cost is payable either directly to the supplying company or through our pay bill number provided.</li>
                            <li>70% of the material cost is paid as deposit and 30% paid on delivery date.</li>
                            <li>DESIGN AND LABOUR COST MUST be paid through our pay bill number below;</li>
                            <div class="ms-4">
                                <div>PAYBILL NUMBER: 400200</div>
                                <div>ACCOUNT NUMBER: 845763</div>
                            </div>
                            <li>Job will commence upon payment of 70% of the quoted labor cost.</li>
                            <li>For supply and fix, deposit payable is 70%, 20% on the first day on site and 10% upon completion</li>
                            <li>The cost of transportation of materials to site is not included in the above quote</li>
                        </ol>
                    </div>
                </form>
            `;

            // Store sales order ID for reference when saving
            document.getElementById('orderNumber').dataset.salesOrderId = id;

            // Update modal title and footer
            document.querySelector('#newQuotationModal .modal-title').textContent = 'Edit Sales Order';
            document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="updateSalesOrder()">Save Changes</button>
                <button type="button" class="btn btn-add" onclick="proceedToInvoice(${id})">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Proceed to Invoice
                </button>
            `;

            // Show modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            // Calculate initial labour amount and totals
            setTimeout(() => {
                const labourPercentageInput = document.querySelector('.labour-percentage');
                if (labourPercentageInput) {
                    const event = new Event('change');
                    labourPercentageInput.dispatchEvent(event);
                }
                updateAllTotals();
            }, 100);

            // Update payment summary table
            requestAnimationFrame(() => {
                updatePaymentSummaryTable(salesOrder);
            });
        }

        function printSalesOrder(id) {
            const salesOrder = salesOrders.find(o => o.id === id);
            if (!salesOrder) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Sales Order #${salesOrder.orderNumber}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 0;
                        }
                        @media print {
                            .no-print {
                                display: none;
                            }
                            html, body {
                                width: 210mm;
                                height: 297mm;
                                margin: 0;
                                padding: 0;
                            }
                            .container {
                                width: 100%;
                                max-width: none;
                                margin: 0;
                                padding: 20mm;
                                background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png');
                                background-size: 100% 100%;
                                background-position: center;
                                background-repeat: no-repeat;
                                min-height: 100%;
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }
                        }
                        html, body {
                            margin: 0;
                            padding: 0;
                            min-height: 100vh;
                        }
                        .container {
                            background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png');
                            background-size: 100% 100%;
                            background-position: center;
                            background-repeat: no-repeat;
                            min-height: 100vh;
                            padding: 40px;
                            margin: 0;
                            max-width: none;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            position: relative;
                            z-index: 1;
                        }
                        .company-name {
                            font-size: 24px;
                            font-weight: bold;
                        }
                        .order-details {
                            margin-bottom: 20px;
                            position: relative;
                            z-index: 1;
                        }
                        .table {
                            position: relative;
                            z-index: 1;
                            background-color: rgba(0, 0, 0, 0);
                        }
                        .table th {
                            background-color: #00000000 !important;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="company-name">Cabinet Master Styles And Finishes</div>
                            <div>cabinetmasterstyles@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone: 0729554475</div>
                        </div>

                        <div class="order-details">
                            <div class="row">
                                <div class="col-6">
                                    <h2>SALES ORDER</h2>
                                    <p><strong>Order #:</strong> ${salesOrder.orderNumber}</p>
                                    <p><strong>Date:</strong> ${new Date(salesOrder.date).toLocaleDateString()}</p>
                                    <p><strong>Quotation #:</strong> ${salesOrder.quotationNumber}</p>
                                </div>
                                <div class="col-6 text-end">
                                    <p><strong>Client:</strong> ${salesOrder.clientName}</p>
                                    <p><strong>Phone:</strong> ${salesOrder.clientPhone}</p>
                                    <p><strong>Location:</strong> ${salesOrder.clientLocation}</p>
                                </div>
                            </div>
                        </div>

                        <h4>Payment Summary</h4>
                        <table class="table table-bordered mb-4">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Account Credited</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${salesOrder.payments.map(payment => `
                                    <tr>
                                        <td>${new Date(payment.date).toLocaleDateString()}</td>
                                        <td>${payment.description}</td>
                                        <td>KES ${payment.amount.toFixed(2)}</td>
                                        <td>${payment.account}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2"><strong>Total Paid</strong></td>
                                    <td colspan="2"><strong>KES ${salesOrder.totalPaid.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="2"><strong>Balance</strong></td>
                                    <td colspan="2"><strong>KES ${salesOrder.balance.toFixed(2)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>

                        <h4>Order Items</h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Unit</th>
                                    <th>Quantity</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${[...salesOrder.cabinetItems, ...salesOrder.worktopItems, 
                                   ...(salesOrder.includeAccessories ? salesOrder.accessoriesItems : [])]
                                  .map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.unit}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.rate.toFixed(2)}</td>
                                        <td>KES ${item.amount.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="row mt-4">
                            <div class="col-6 offset-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Cabinets Total:</strong></td>
                                        <td class="text-end">KES ${salesOrder.cabinetTotal.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Worktop Total:</strong></td>
                                        <td class="text-end">KES ${salesOrder.worktopTotal.toFixed(2)}</td>
                                    </tr>
                                    ${salesOrder.includeAccessories ? `
                                        <tr>
                                            <td><strong>Accessories Total:</strong></td>
                                            <td class="text-end">KES ${salesOrder.accessoriesTotal.toFixed(2)}</td>
                                        </tr>
                                    ` : ''}
                                    <tr class="border-top">
                                        <td><strong>GRAND TOTAL:</strong></td>
                                        <td class="text-end"><strong>KES ${salesOrder.grandTotal.toFixed(2)}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="text-center mt-4 no-print">
                            <button onclick="window.print()" class="btn btn-primary">Print Sales Order</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        async function downloadSalesOrder(id) {
            const salesOrder = salesOrders.find(o => o.id === id);
            if (!salesOrder) return;

            const doc = new jsPDF();
            
            // Add background
            await addBackgroundToPDF(doc);
            
            // Add header
            doc.setFontSize(20);
            doc.text('SALES ORDER', 105, 20, { align: 'center' });
            
            // Add company details
            doc.setFontSize(12);
            doc.text('Cabinet Master Styles And Finishes', 105, 30, { align: 'center' });
            doc.text('cabinetmasterstyles@gmail.com', 105, 35, { align: 'center' });
            doc.text('Kamakis-Ruiru, Kenya', 105, 40, { align: 'center' });
            doc.text('Phone: 0729554475', 105, 45, { align: 'center' });

            // Add order details
            doc.text(`Order #: ${salesOrder.orderNumber}`, 20, 60);
            doc.text(`Date: ${new Date(salesOrder.date).toLocaleDateString()}`, 20, 65);
            doc.text(`Quotation #: ${salesOrder.quotationNumber}`, 20, 70);
            
            // Add client details
            doc.text('To:', 120, 60);
            doc.text(salesOrder.clientName, 120, 65);
            doc.text(salesOrder.clientPhone, 120, 70);
            doc.text(salesOrder.clientLocation, 120, 75);

            // Add payment summary
            doc.text('Payment Summary:', 20, 85);
            const paymentHeaders = [['Date', 'Description', 'Amount', 'Account']];
            const paymentData = salesOrder.payments.map(payment => [
                new Date(payment.date).toLocaleDateString(),
                payment.description,
                `KES ${payment.amount.toFixed(2)}`,
                payment.account
            ]);
            paymentData.push(
                ['', 'Total Paid', `KES ${salesOrder.totalPaid.toFixed(2)}`, ''],
                ['', 'Balance', `KES ${salesOrder.balance.toFixed(2)}`, '']
            );

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 90,
                head: paymentHeaders,
                body: paymentData,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Add items table
            const itemHeaders = [['Description', 'Unit', 'Quantity', 'Rate', 'Amount']];
            const itemData = [...salesOrder.cabinetItems, ...salesOrder.worktopItems, 
                             ...(salesOrder.includeAccessories ? salesOrder.accessoriesItems : [])]
                .map(item => [
                    item.description,
                    item.unit,
                    item.quantity.toString(),
                    `KES ${item.rate.toFixed(2)}`,
                    `KES ${item.amount.toFixed(2)}`
                ]);

            doc.text('Order Items:', 20, doc.lastAutoTable.finalY + 20);
            doc.autoTable({
                textColor: [0, 0, 0],
                startY: doc.lastAutoTable.finalY + 25,
                head: itemHeaders,
                body: itemData,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Add totals
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Cabinets Total: KES ${salesOrder.cabinetTotal.toFixed(2)}`, 120, finalY);
            doc.text(`Worktop Total: KES ${salesOrder.worktopTotal.toFixed(2)}`, 120, finalY + 7);
            if (salesOrder.includeAccessories) {
                doc.text(`Accessories Total: KES ${salesOrder.accessoriesTotal.toFixed(2)}`, 120, finalY + 14);
            }
            doc.setFontSize(14);
            doc.text(`GRAND TOTAL: KES ${salesOrder.grandTotal.toFixed(2)}`, 120, finalY + (salesOrder.includeAccessories ? 24 : 17));

            // Save the PDF
            doc.save(`sales_order_${salesOrder.orderNumber}.pdf`);
        }

        // ... existing code ...

        // Add new function to handle view-only quotation display
        function viewQuotation(id) {
            const quotation = quotations.find(q => q.id === id);
            if (!quotation) return;

            // Update modal classes for A4 layout
            const modal = document.getElementById('newQuotationModal');
            modal.classList.add('a4-modal');

            // Create A4 document layout with read-only fields
            document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                <form id="newQuotationForm" class="a4-document">
                    <!-- Company Header -->
                    <div class="document-header">
                        <div class="company-name">Cabinet Master Styles And Finishes</div>
                        <div class="company-details">
                            <div>cabinetmasterstyles@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone No: 0729554475</div>
                        </div>
                    </div>

                    <!-- Document Info -->
                    <div class="document-info">
                        <!-- Left Column -->
                        <div class="document-info-group">
                            <h3>QUOTATION</h3>
                            <div class="info-row">
                                <span class="info-label">Quotation #</span>
                                <input type="text" class="info-value" value="${quotation.quotationNumber}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Date</span>
                                <input type="text" class="info-value" value="${new Date(quotation.date).toLocaleDateString()}" readonly>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="document-info-group">
                            <div class="info-row">
                                <span class="info-label">Client</span>
                                <input type="text" class="info-value" value="${quotation.clientName}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Phone No</span>
                                <input type="text" class="info-value" value="${quotation.clientPhone}" readonly>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Location</span>
                                <input type="text" class="info-value" value="${quotation.clientLocation}" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Kitchen Cabinets Section -->
                    <div class="section-title">Kitchen Cabinets</div>
                    <table class="quotation-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price (KES)</th>
                                <th>Total (KES)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotation.cabinetItems?.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.unit}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.rate.toFixed(2)}</td>
                                    <td>${item.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>SUBTOTAL</strong></td>
                                <td><strong>${quotation.cabinetTotal.toFixed(2)}</strong></td>
                            </tr>
                            <tr>
                                <td><strong>LABOUR (${quotation.labourPercentage}%)</strong></td>
                                <td colspan="3"></td>
                                <td><strong>${((quotation.cabinetTotal * quotation.labourPercentage) / 100).toFixed(2)}</strong></td>
                            </tr>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong>${quotation.cabinetTotal.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- Worktop Section -->
                    <div class="section-title">Worktop</div>
                    <table class="quotation-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price (KES)</th>
                                <th>Total (KES)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quotation.worktopItems?.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.unit}</td>
                                    <td>${item.quantity}</td>
                                    <td>${item.rate.toFixed(2)}</td>
                                    <td>${item.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"></td>
                                <td><strong>TOTAL</strong></td>
                                <td><strong>${quotation.worktopTotal.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    ${quotation.includeAccessories ? `
                        <!-- Accessories Section -->
                        <div class="section-title">Accessories</div>
                        <table class="quotation-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Units</th>
                                    <th>Quantity</th>
                                    <th>Unit Price (KES)</th>
                                    <th>Total (KES)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${quotation.accessoriesItems?.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.unit}</td>
                                        <td>${item.quantity}</td>
                                        <td>${item.rate.toFixed(2)}</td>
                                        <td>${item.amount.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"></td>
                                    <td><strong>TOTAL</strong></td>
                                    <td><strong>${quotation.accessoriesTotal.toFixed(2)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    ` : ''}

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Cabinets Total (KES)</span>
                            <span>${quotation.cabinetTotal.toFixed(2)}</span>
                        </div>
                        <div class="total-row">
                            <span>Worktop Total (KES)</span>
                            <span>${quotation.worktopTotal.toFixed(2)}</span>
                        </div>
                        ${quotation.includeAccessories ? `
                            <div class="total-row">
                                <span>Accessories Total (KES)</span>
                                <span>${quotation.accessoriesTotal.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="total-row grand-total">
                            <span>GRAND TOTAL (KES)</span>
                            <span>${quotation.grandTotal.toFixed(2)}</span>
                        </div>
                    </div>

                    <!-- Terms Section -->
                    <div class="terms-section">
                        <h5>Terms and Conditions:</h5>
                        <ol>
                            <li>Please note that the above prices are subject to changes in case of variation in quantity or specifications and market rates.</li>
                            <li>Materials cost is payable either directly to the supplying company or through our pay bill number provided.</li>
                            <li>70% of the material cost is paid as deposit and 30% paid on delivery date.</li>
                            <li>DESIGN AND LABOUR COST MUST be paid through our pay bill number below;</li>
                            <div class="ms-4">
                                <div>PAYBILL NUMBER: 400200</div>
                                <div>ACCOUNT NUMBER: 845763</div>
                            </div>
                            <li>Job will commence upon payment of 70% of the quoted labor cost.</li>
                            <li>For supply and fix, deposit payable is 70%, 20% on the first day on site and 10% upon completion</li>
                            <li>The cost of transportation of materials to site is not included in the above quote</li>
                        </ol>
                    </div>
                </form>
            `;

            // Update modal title and footer

            document.querySelector('#newQuotationModal .modal-title').textContent = 'Edit Sales Order';
            document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="updateSalesOrder()">Save Order</button>
                <button type="button" class="btn btn-add" onclick="proceedToInvoice(${id})">
                    <i class="fas fa-file-invoice-dollar me-2"></i>Proceed to Invoice
                </button>
            `;


            // Show modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();
        }

        // Update the show functions
        function showQuotationsView() {
            // Hide all views
            document.getElementById('salesOrderView').style.display = 'none';
            document.getElementById('quotationsView').style.display = 'block';
            document.getElementById('invoiceView').style.display = 'none';
            document.getElementById('cashSaleView').style.display = 'none';
            
            // Update button states
            document.getElementById('quotationsBtn').classList.add('active');
            document.getElementById('salesOrderBtn').classList.remove('active');
            document.getElementById('invoiceBtn').classList.remove('active');
            document.getElementById('cashSaleBtn').classList.remove('active');
        }

        function showSalesOrderView() {
            // Hide all views
            document.getElementById('quotationsView').style.display = 'none';
            document.getElementById('salesOrderView').style.display = 'block';
            document.getElementById('invoiceView').style.display = 'none';
            document.getElementById('cashSaleView').style.display = 'none';
            
            // Update button states
            document.getElementById('salesOrderBtn').classList.add('active');
            document.getElementById('quotationsBtn').classList.remove('active');
            document.getElementById('invoiceBtn').classList.remove('active');
            document.getElementById('cashSaleBtn').classList.remove('active');
        }

        function showinvoiceView() {
            // Hide all views
            document.getElementById('quotationsView').style.display = 'none';
            document.getElementById('salesOrderView').style.display = 'none';
            document.getElementById('invoiceView').style.display = 'block';
            document.getElementById('cashSaleView').style.display = 'none';
            
            // Update button states
            document.getElementById('invoiceBtn').classList.add('active');
            document.getElementById('quotationsBtn').classList.remove('active');
            document.getElementById('salesOrderBtn').classList.remove('active');
            document.getElementById('cashSaleBtn').classList.remove('active');
        }


        // Add this to your DOMContentLoaded event
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sales view state if not set
            if (!localStorage.getItem('activeSalesView')) {
                localStorage.setItem('activeSalesView', 'quotations');
            }
            
            // Force initial data refresh
            updatePaymentSummaries(true);
            
            // Initialize all tables
            renderPaymentsTable();
            renderQuotationsTable();
            renderSalesOrdersTable();
            renderInvoicesTable();
            
            // Add click handler for sales section button
            document.querySelector('[data-section="salesSection"]').addEventListener('click', showSalesSection);
            
            // Update when switching sections - with force refresh
            document.querySelectorAll('[data-section]').forEach(element => {
                element.addEventListener('click', function() {
                    const section = this.dataset.section;
                    if (section === 'paymentsSection' || section === 'salesSection') {
                        // Force refresh data when entering relevant sections
                        requestAnimationFrame(() => {
                            updatePaymentSummaries(true);
                        });
                    }
                });
            });

            // Refresh data every 30 seconds
            setInterval(() => {
                requestAnimationFrame(() => {
                    updatePaymentSummaries(true);
                });
            }, 30000);
        });

        // Add helper functions to collect items from tables
        function getCabinetItems() {
            const items = [];
            document.querySelectorAll('#cabinetItemsTable tbody tr').forEach(row => {
                const description = row.querySelector('.description').value;
                const unit = row.querySelector('.unit').value;
                const quantity = parseFloat(row.querySelector('.quantity').value);
                const rate = parseFloat(row.querySelector('.price').value);
                const amount = quantity * rate;

                if (description && unit && quantity && rate) {
                    items.push({
                        description,
                        unit,
                        quantity,
                        rate,
                        amount,
                        type: 'cabinet'
                    });
                }
            });
            return items;
        }

        function getWorktopItems() {
            const items = [];
            document.querySelectorAll('#worktopItemsTable tbody tr').forEach(row => {
                const description = row.querySelector('.description').value;
                const unit = row.querySelector('.unit').value;
                const quantity = parseFloat(row.querySelector('.quantity').value);
                const rate = parseFloat(row.querySelector('.price').value);
                const amount = quantity * rate;

                if (description && unit && quantity && rate) {
                    items.push({
                        description,
                        unit,
                        quantity,
                        rate,
                        amount,
                        type: 'worktop'
                    });
                }
            });
            return items;
        }

        function getAccessoriesItems() {
            const items = [];
            const accessoriesTable = document.getElementById('accessoriesItemsTable');
            if (!accessoriesTable) return items;

            accessoriesTable.querySelectorAll('tbody tr').forEach(row => {
                const description = row.querySelector('.description').value;
                const unit = row.querySelector('.unit').value;
                const quantity = parseFloat(row.querySelector('.quantity').value);
                const rate = parseFloat(row.querySelector('.price').value);
                const amount = quantity * rate;

                if (description && unit && quantity && rate) {
                    items.push({
                        description,
                        unit,
                        quantity,
                        rate,
                        amount,
                        type: 'accessory'
                    });
                }
            });
            return items;
        }

        // Add saveSalesOrder function
        function saveSalesOrder() {
            try {
                // Get and validate form first
                const form = document.getElementById('newQuotationForm');
                if (!form || !form.checkValidity()) {
                    form?.reportValidity();
                    return;
                }

                // Get and validate order number
                const orderNumber = document.getElementById('orderNumber');
                if (!orderNumber || !orderNumber.dataset.quotationId) {
                    console.error('Order number or quotation ID not found');
                    return;
                }

                // Store necessary data before any DOM manipulation
                const orderNumberValue = orderNumber.value;
                const quotationId = parseInt(orderNumber.dataset.quotationId);
                
                // Find quotation
                const quotation = quotations.find(q => q.id === quotationId);
                if (!quotation) {
                    alert('Original quotation not found');
                    return;
                }

                // Create sales order object and save data
                const salesOrder = createSalesOrder(quotation, orderNumberValue);
                if (!salesOrder) {
                    throw new Error('Failed to create sales order object');
                }

                // Update quotation status and save
                quotation.status = 'Converted';
                saveQuotations();

                // Add new sales order and save
                salesOrders.unshift(salesOrder);
                saveSalesOrders();

                // Store success message
                const successMessage = `Quotation successfully converted to Sales Order #${orderNumberValue}`;

                // Close modal first
                const modal = document.getElementById('newQuotationModal');
                if (modal) {
                    // Clear dataset before closing
                    if (orderNumber) {
                        delete orderNumber.dataset.quotationId;
                    }

                    // Remove focus from any elements inside modal
                    const focusedElement = modal.querySelector(':focus');
                    if (focusedElement) {
                        focusedElement.blur();
                    }

                    // Remove aria-hidden attribute
                    modal.removeAttribute('aria-hidden');

                    // Get modal instance and hide it
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.dispose();
                    }

                    // Remove modal-specific classes and styles
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    document.body.style.removeProperty('padding-right');
                    document.body.style.overflow = '';

                    // Remove backdrop
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.remove();
                    }
                }

                // Update views and tables after modal is closed
                requestAnimationFrame(() => {
                    showSalesOrderView();
                    renderQuotationsTable();
                    renderSalesOrdersTable();

                    // Show success message
                    setTimeout(() => alert(successMessage), 100);
                });

            } catch (error) {
                console.error('Error saving sales order:', error);
                alert('An error occurred while saving the sales order. Please try again.');
            }
        }

        // Add helper function to create sales order object
        function createSalesOrder(quotation, orderNumberValue) {
            try {
                // Get payments
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                const quotationPayments = payments.filter(p => p.paidTo === quotation.quotationNumber);
                const totalPayments = quotationPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);

                // Get all items and totals
                const cabinetItems = getCabinetItems();
                const worktopItems = getWorktopItems();
                const accessoriesItems = getAccessoriesItems();
                const cabinetTotal = parseFloat(document.getElementById('cabinetTotal')?.textContent) || 0;
                const worktopTotal = parseFloat(document.getElementById('worktopTotal')?.textContent) || 0;
                const accessoriesTotal = parseFloat(document.getElementById('accessoriesTotal')?.textContent) || 0;
                const grandTotal = parseFloat(document.getElementById('grandTotal')?.textContent) || 0;
                const labourPercentageElement = document.querySelector('.labour-percentage');
                const labourPercentage = parseFloat(labourPercentageElement?.value || labourPercentageElement?.textContent) || 30;

                return {
                    id: Date.now(),
                    orderNumber: orderNumberValue,
                    date: new Date().toISOString(),
                    quotationId: quotation.id,
                    quotationNumber: quotation.quotationNumber,
                    clientId: quotation.clientId,
                    clientName: quotation.clientName,
                    clientPhone: quotation.clientPhone,
                    clientLocation: quotation.clientLocation,
                    cabinetItems: cabinetItems,
                    worktopItems: worktopItems,
                    accessoriesItems: accessoriesItems,
                    labourPercentage: labourPercentage,
                    cabinetTotal: cabinetTotal,
                    worktopTotal: worktopTotal,
                    accessoriesTotal: accessoriesTotal,
                    grandTotal: grandTotal,
                    includeAccessories: accessoriesItems.length > 0,
                    status: 'Active',
                    payments: quotationPayments,
                    totalPaid: totalPayments,
                    balance: grandTotal - totalPayments
                };
            } catch (error) {
                console.error('Error creating sales order object:', error);
                return null;
            }
        }

        // Update modal initialization
        document.addEventListener('DOMContentLoaded', function() {
            const newQuotationModal = document.getElementById('newQuotationModal');
            if (newQuotationModal) {
                // Initialize modal with options
                const modalOptions = {
                    backdrop: true,
                    keyboard: false,
                    focus: false // Disable automatic focus
                };
                const modal = new bootstrap.Modal(newQuotationModal, modalOptions);

                // Handle close button click
                const closeButton = newQuotationModal.querySelector('[data-bs-dismiss="modal"]');
                if (closeButton) {
                    closeButton.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Remove focus and aria-hidden
                        const focusedElement = newQuotationModal.querySelector(':focus');
                        if (focusedElement) {
                            focusedElement.blur();
                        }
                        newQuotationModal.removeAttribute('aria-hidden');

                        // Get modal instance and dispose
                        const modalInstance = bootstrap.Modal.getInstance(newQuotationModal);
                        if (modalInstance) {
                            modalInstance.dispose();
                        }

                        // Remove modal-specific classes and styles
                        newQuotationModal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        document.body.style.removeProperty('padding-right');
                        document.body.style.overflow = '';

                        // Remove backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    });
                }

                // Handle modal cleanup on hide
                newQuotationModal.addEventListener('hide.bs.modal', function(event) {
                    // Remove focus from any elements
                    const focusedElement = this.querySelector(':focus');
                    if (focusedElement) {
                        focusedElement.blur();
                    }
                    this.removeAttribute('aria-hidden');
                });

                // Handle modal cleanup on hidden
                newQuotationModal.addEventListener('hidden.bs.modal', function() {
                    try {
                        // Reset form if exists
                        const form = this.querySelector('form');
                        if (form) {
                            form.reset();
                        }

                        // Clear any stored data
                        const orderNumber = document.getElementById('orderNumber');
                        if (orderNumber) {
                            delete orderNumber.dataset.quotationId;
                        }

                        // Remove focus and aria-hidden
                        const focusedElement = this.querySelector(':focus');
                        if (focusedElement) {
                            focusedElement.blur();
                        }
                        this.removeAttribute('aria-hidden');

                        // Cleanup modal
                        this.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        document.body.style.removeProperty('padding-right');
                        document.body.style.overflow = '';

                        // Remove backdrop
                        const backdrop = document.querySelector('.modal-backdrop');
                        if (backdrop) {
                            backdrop.remove();
                        }
                    } catch (error) {
                        console.error('Error in modal hidden handler:', error);
                    }
                });

                // Handle modal show
                newQuotationModal.addEventListener('show.bs.modal', function() {
                    // Remove aria-hidden attribute
                    this.removeAttribute('aria-hidden');
                });
            }
        });

        // Add sidebar toggle functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.createElement('button');
            sidebarToggle.className = 'sidebar-toggle';
            sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
            document.body.appendChild(sidebarToggle);

            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
            });

            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !sidebarToggle.contains(e.target) && 
                    sidebar.classList.contains('show')) {
                    sidebar.classList.remove('show');
                }
            });

            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show');
                }
            });
        });

        // Add modal event handler functions
        function handleModalHide(event) {
            try {
                const orderNumber = document.getElementById('orderNumber');
                if (orderNumber && orderNumber.dataset.quotationId) {
                    delete orderNumber.dataset.quotationId;
                }
            } catch (error) {
                console.error('Error in modal hide handler:', error);
            }
        }

        function handleModalHidden() {
            try {
                const orderNumber = document.getElementById('orderNumber');
                if (orderNumber && orderNumber.dataset.quotationId) {
                    delete orderNumber.dataset.quotationId;
                }
            } catch (error) {
                console.error('Error in modal hidden handler:', error);
            }
        }

        function updateSalesOrder() {
            try {
                // Get and validate form first
                const form = document.getElementById('newQuotationForm');
                if (!form || !form.checkValidity()) {
                    form?.reportValidity();
                    return;
                }

                // Get and validate order number
                const orderNumber = document.getElementById('orderNumber');
                if (!orderNumber || !orderNumber.dataset.salesOrderId) {
                    console.error('Order number or sales order ID not found');
                    return;
                }

                // Find the sales order to update
                const salesOrderId = parseInt(orderNumber.dataset.salesOrderId);
                const index = salesOrders.findIndex(o => o.id === salesOrderId);
                if (index === -1) {
                    alert('Sales order not found');
                    return;
                }

                // Get all items from tables
                const cabinetItems = getCabinetItems();
                const worktopItems = getWorktopItems();
                const accessoriesItems = getAccessoriesItems();

                // Calculate totals
                const cabinetTotal = parseFloat(document.getElementById('cabinetTotal')?.textContent) || 0;
                const worktopTotal = parseFloat(document.getElementById('worktopTotal')?.textContent) || 0;
                const accessoriesTotal = parseFloat(document.getElementById('accessoriesTotal')?.textContent) || 0;
                const grandTotal = parseFloat(document.getElementById('grandTotal')?.textContent) || 0;

                // Get labour percentage
                const labourPercentageElement = document.querySelector('.labour-percentage');
                const labourPercentage = parseFloat(labourPercentageElement?.value || labourPercentageElement?.textContent) || 30;

                // Update the sales order
                const updatedSalesOrder = {
                    ...salesOrders[index],
                    cabinetItems,
                    worktopItems,
                    accessoriesItems,
                    labourPercentage,
                    cabinetTotal,
                    worktopTotal,
                    accessoriesTotal,
                    grandTotal,
                    includeAccessories: accessoriesItems.length > 0,
                    balance: grandTotal - salesOrders[index].totalPaid
                };

                // Save the updated sales order
                salesOrders[index] = updatedSalesOrder;
                saveSalesOrders();

                // Close modal
                const modal = document.getElementById('newQuotationModal');
                if (modal) {
                    const modalInstance = bootstrap.Modal.getInstance(modal);
                    if (modalInstance) {
                        modalInstance.hide();
                    }
                }

                // Update the table
                renderSalesOrdersTable();

                // Show success message
                alert('Sales order updated successfully');

            } catch (error) {
                console.error('Error updating sales order:', error);
                alert('An error occurred while updating the sales order. Please try again.');
            }
        }

        // Add new functions for progressive number generation
        function getNextNumber(type) {
            const lastNumbers = JSON.parse(localStorage.getItem('lastNumbers') || '{}');
            const currentYear = new Date().getFullYear().toString().slice(-2); // Get last 2 digits of year
            const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            // Initialize if not exists for current year/month
            if (!lastNumbers[currentYear]) {
                lastNumbers[currentYear] = {};
            }
            if (!lastNumbers[currentYear][currentMonth]) {
                lastNumbers[currentYear][currentMonth] = {
                    QT: 0,
                    SO: 0,
                    INV: 0,
                    CS: 0,
                    PN: 0,
                    EN: 0, // Added for expense numbers
                    lastGenerated: {
                        QT: null,
                        SO: null,
                        INV: null,
                        CS: null,
                        PN: null,
                        EN: null // Added for expense numbers
                    }
                };
            }
            
            // Make sure PN is initialized if it's a legacy record
            if (lastNumbers[currentYear][currentMonth].PN === undefined) {
                lastNumbers[currentYear][currentMonth].PN = 0;
                if (!lastNumbers[currentYear][currentMonth].lastGenerated) {
                    lastNumbers[currentYear][currentMonth].lastGenerated = {};
                }
                lastNumbers[currentYear][currentMonth].lastGenerated.PN = null;
            }
            
            // For quotations, we'll generate a temporary number without incrementing the counter
            if (type === 'QT') {
                const nextNumber = lastNumbers[currentYear][currentMonth].QT + 1;
                const formattedNumber = `${type}${currentYear}${currentMonth}${nextNumber.toString().padStart(3, '0')}`;
                lastNumbers[currentYear][currentMonth].lastGenerated.QT = formattedNumber;
                localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
                return formattedNumber;
            }
            
            // For sales orders, invoices, cash sales, payments, and expenses, increment counter immediately
            lastNumbers[currentYear][currentMonth][type]++;
            const number = lastNumbers[currentYear][currentMonth][type];
            
            // Store the generated number
            const formattedNumber = `${type}${currentYear}${currentMonth}${number.toString().padStart(3, '0')}`;
            if (lastNumbers[currentYear][currentMonth].lastGenerated) {
                lastNumbers[currentYear][currentMonth].lastGenerated[type] = formattedNumber;
            }
            
            localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
            return formattedNumber;
        }
        // Add function to confirm quotation number allocation
        function confirmQuotationNumber(quotationNumber) {
            const lastNumbers = JSON.parse(localStorage.getItem('lastNumbers') || '{}');
            const year = quotationNumber.slice(2, 4);
            const month = quotationNumber.slice(4, 6);
            
            if (lastNumbers[year]?.[month]?.lastGenerated?.QT === quotationNumber) {
                // Increment the actual counter since the quotation was saved
                lastNumbers[year][month].QT++;
                localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
                return true;
            }
            return false;
        }

        // Update the saveQuotation function to confirm number allocation
        function saveQuotation() {
            try {
                const form = document.getElementById('newQuotationForm');
                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const clientInput = document.getElementById('clientSearch');
                const clientId = clientInput.dataset.clientId;
                
                if (!clientId) {
                    alert('Please select a client from the list');
                    return;
                }

                const quotationNumber = document.getElementById('quotationNumber').value;
                const editId = document.getElementById('quotationNumber').dataset.editId;
                
                // Get all items and totals
                const cabinetItems = getCabinetItems();
                const worktopItems = getWorktopItems();
                const accessoriesItems = getAccessoriesItems();
                const cabinetTotal = parseFloat(document.getElementById('cabinetTotal').textContent) || 0;
                const worktopTotal = parseFloat(document.getElementById('worktopTotal').textContent) || 0;
                const accessoriesTotal = parseFloat(document.getElementById('accessoriesTotal').textContent) || 0;
                const grandTotal = parseFloat(document.getElementById('grandTotal').textContent) || 0;
                const labourPercentageElement = document.querySelector('.labour-percentage');
                const labourPercentage = parseFloat(labourPercentageElement?.value || labourPercentageElement?.textContent) || 30;

                const quotationData = {
                    id: Date.now(),
                    quotationNumber: quotationNumber,
                    date: new Date().toISOString(),
                    clientId: clientId,
                    clientName: clientInput.value,
                    clientPhone: clientInput.dataset.clientPhone,
                    clientLocation: clientInput.dataset.clientLocation,
                    cabinetItems: cabinetItems,
                    worktopItems: worktopItems,
                    accessoriesItems: accessoriesItems,
                    labourPercentage: labourPercentage,
                    cabinetTotal: cabinetTotal,
                    worktopTotal: worktopTotal,
                    accessoriesTotal: accessoriesTotal,
                    grandTotal: grandTotal,
                    includeAccessories: document.getElementById('accessoriesToggle').checked,
                    status: 'Pending'
                };

                // If editing an existing quotation
                if (editId) {
                    const index = quotations.findIndex(q => q.id === parseInt(editId));
                    if (index !== -1) {
                        quotations[index] = { ...quotations[index], ...quotationData, id: parseInt(editId) };
                    }
                    delete document.getElementById('quotationNumber').dataset.editId;
                    saveQuotations();
                    renderQuotationsTable();
                    const modal = bootstrap.Modal.getInstance(document.getElementById('newQuotationModal'));
                    modal.hide();
                    form.reset();
                    document.querySelector('#newQuotationModal .modal-title').textContent = 'New Quotation';
                } else {
                    // For new quotations, confirm the number
                    if (confirmQuotationNumber(quotationNumber)) {
                        quotations.unshift(quotationData);
                        saveQuotations();
                        renderQuotationsTable();
                        const modal = bootstrap.Modal.getInstance(document.getElementById('newQuotationModal'));
                        modal.hide();
                        form.reset();
                        document.querySelector('#newQuotationModal .modal-title').textContent = 'New Quotation';
                    } else {
                        alert('Error saving quotation. Please try again.');
                    }
                }
            } catch (error) {
                console.error('Error saving quotation:', error);
                alert('An error occurred while saving the quotation. Please try again.');
            }
        }

        // ... rest of the existing code ...

        // Add function for sales order number generation
        function generateSalesOrderNumber() {
            return getNextNumber('SO');
        }

        // Add function for invoice number generation
        function generateInvoiceNumber() {
            return getNextNumber('INV');
        }

        // Add function for cash sale number generation
        function generateCashSaleNumber() {
            return getNextNumber('CS');
        }

        // Add function for payment number generation
        function generatePaymentNumber() {
            return getNextNumber('PN');
        }

        // Add function for expense number generation
        function generateExpenseNumber() {
            return getNextNumber('EN');
        }

        // Update the getNextNumber function to handle cash sale numbers
        function getNextNumber(type) {
            const lastNumbers = JSON.parse(localStorage.getItem('lastNumbers') || '{}');
            const currentYear = new Date().getFullYear().toString().slice(-2); // Get last 2 digits of year
            const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            // Initialize if not exists for current year/month
            if (!lastNumbers[currentYear]) {
                lastNumbers[currentYear] = {};
            }
            if (!lastNumbers[currentYear][currentMonth]) {
                lastNumbers[currentYear][currentMonth] = {
                    QT: 0,
                    SO: 0,
                    INV: 0,
                    CS: 0,
                    PN: 0,
                    EN: 0, // Added for expense numbers
                    lastGenerated: {
                        QT: null,
                        SO: null,
                        INV: null,
                        CS: null,
                        PN: null,
                        EN: null // Added for expense numbers
                    }
                };
            }
            
            // Make sure PN is initialized if it's a legacy record
            if (lastNumbers[currentYear][currentMonth].PN === undefined) {
                lastNumbers[currentYear][currentMonth].PN = 0;
                if (!lastNumbers[currentYear][currentMonth].lastGenerated) {
                    lastNumbers[currentYear][currentMonth].lastGenerated = {};
                }
                lastNumbers[currentYear][currentMonth].lastGenerated.PN = null;
            }
            
            // For quotations, we'll generate a temporary number without incrementing the counter
            if (type === 'QT') {
                const nextNumber = lastNumbers[currentYear][currentMonth].QT + 1;
                const formattedNumber = `${type}${currentYear}${currentMonth}${nextNumber.toString().padStart(3, '0')}`;
                lastNumbers[currentYear][currentMonth].lastGenerated.QT = formattedNumber;
                localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
                return formattedNumber;
            }
            
            // For sales orders, invoices, cash sales, payments, and expenses, increment counter immediately
            lastNumbers[currentYear][currentMonth][type]++;
            const number = lastNumbers[currentYear][currentMonth][type];
            
            // Store the generated number
            const formattedNumber = `${type}${currentYear}${currentMonth}${number.toString().padStart(3, '0')}`;
            if (lastNumbers[currentYear][currentMonth].lastGenerated) {
                lastNumbers[currentYear][currentMonth].lastGenerated[type] = formattedNumber;
            }
            
            localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
            return formattedNumber;
        }

        // ... rest of the existing code ...

        // Add function to handle proceeding to invoice
        function proceedToInvoice(salesOrderId) {
            const salesOrder = salesOrders.find(o => o.id === salesOrderId);
            if (!salesOrder) {
                alert('Sales order not found');
                    return;
                }

            // Get latest payment data
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const orderPayments = payments.filter(p => p.paidTo === salesOrder.quotationNumber);
            const totalPaid = orderPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            const balance = salesOrder.grandTotal - totalPaid;
            
            // Separate 80% validation
            const requiredPayment = salesOrder.grandTotal * 0.8;
            if (totalPaid < requiredPayment) {
                const remainingAmount = requiredPayment - totalPaid;
                alert(`Cannot proceed to invoice. At least 80% payment (KES ${requiredPayment.toFixed(2)}) is required.\nRemaining amount needed: KES ${remainingAmount.toFixed(2)}`);
                return;
            }

            // Generate invoice number
            const invoiceNumber = generateInvoiceNumber();

            // Update modal classes for A4 layout
            const modal = document.getElementById('newQuotationModal');
            modal.classList.add('a4-modal');

            // Create A4 document layout with updated payment summary
            document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                <form id="newQuotationForm" class="a4-document">
                    <!-- ... rest of the invoice layout ... -->
                    
                    <!-- Payment Summary Section with updated data -->
                    <div class="section-title" style="margin-top: 30px;">Payment Summary</div>
                    <table class="quotation-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Account</th>
                            </tr>
                        </thead>
                        <tbody id="paymentSummaryTableBody">
                            <!-- Payment data will be dynamically added here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2"><strong>Total Paid</strong></td>
                                <td colspan="2"><strong>KES <span id="totalPaidAmount">0.00</span></strong></td>
                            </tr>
                            <tr>
                                <td colspan="2"><strong>Balance</strong></td>
                                <td colspan="2"><strong>KES <span id="balanceAmount">0.00</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </form>
            `;

            // Store sales order ID for reference when saving
            document.getElementById('invoiceNumber').dataset.salesOrderId = salesOrderId;

            // Update modal title and footer
            document.querySelector('#newQuotationModal .modal-title').textContent = 'Generate Invoice';
            document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="saveInvoice()">Save Invoice</button>
            `;

            // Show modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            // Update payment summary table
            requestAnimationFrame(() => {
                const updatedSalesOrder = {
                    ...salesOrder,
                    payments: orderPayments,
                    totalPaid: totalPaid,
                    balance: balance
                };
                updatePaymentSummaryTable(updatedSalesOrder);
            });
        }

        // Initialize invoices array
        let invoices = [];

        // Save invoice function
        async function saveInvoice() {
            try {
                const invoiceNumber = document.getElementById('invoiceNumber');
                if (!invoiceNumber || !invoiceNumber.dataset.salesOrderId) {
                    console.error('Invoice number or sales order ID not found');
                    return;
                }

                const salesOrderId = parseInt(invoiceNumber.dataset.salesOrderId);
                const salesOrder = salesOrders.find(o => o.id === salesOrderId);
                if (!salesOrder) {
                    alert('Sales order not found');
                    return;
                }

                const invoiceData = {
                    id: Date.now(),
                    invoiceNumber: invoiceNumber.value,
                    date: new Date().toISOString(),
                    salesOrderId: salesOrderId,
                    salesOrderNumber: salesOrder.orderNumber,
                    clientId: salesOrder.clientId,
                    clientName: salesOrder.clientName,
                    clientPhone: salesOrder.clientPhone,
                    clientLocation: salesOrder.clientLocation,
                    items: [
                        ...salesOrder.cabinetItems,
                        ...salesOrder.worktopItems,
                        ...(salesOrder.includeAccessories ? salesOrder.accessoriesItems : [])
                    ],
                    cabinetTotal: salesOrder.cabinetTotal,
                    worktopTotal: salesOrder.worktopTotal,
                    accessoriesTotal: salesOrder.accessoriesTotal,
                    grandTotal: salesOrder.grandTotal,
                    payments: salesOrder.payments,
                    totalPaid: salesOrder.totalPaid,
                    balance: salesOrder.balance,
                    status: salesOrder.balance <= 0 ? 'Paid' : 'Pending'
                };

                // Get existing invoices or initialize empty array
                invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                
                // Add new invoice at the beginning
                invoices.unshift(invoiceData);
                
                // Save to localStorage
                localStorage.setItem('invoices', JSON.stringify(invoices));

                // Update sales order status
                salesOrder.status = 'Invoiced';
                saveSalesOrders();

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('newQuotationModal'));
                if (modal) {
                modal.hide();
                }

                // Switch to invoice view
                showinvoiceView();
                
                // Re-render tables to show updates
                renderInvoicesTable();
                renderSalesOrdersTable();

                // Show success message
                alert('Invoice generated successfully');

            } catch (error) {
                console.error('Error saving invoice:', error);
                alert('An error occurred while saving the invoice. Please try again.');
            }
        }

        // Add this to your existing DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Load invoices from localStorage
            const storedInvoices = localStorage.getItem('invoices');
            if (storedInvoices) {
                invoices = JSON.parse(storedInvoices);
            }
        });

        // ... existing code ...

        // Add function to render invoices table
        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.warn('Invoices table body not found');
                return;
            }

            try {
                // Get invoices from localStorage
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                tbody.innerHTML = '';
                
                // Sort invoices by date and order number (newest first)
                const sortedInvoices = invoices
                    .filter(invoice => invoice && invoice.clientName)
                    .sort((a, b) => {
                        // First sort by date (newest first)
                        const dateComparison = new Date(b.date) - new Date(a.date);
                        
                        // If dates are the same, sort by invoice number (newest first)
                        if (dateComparison === 0 && a.invoiceNumber && b.invoiceNumber) {
                            // Extract year and month from invoice numbers (assuming format INVYYMMXXX)
                            const aYear = a.invoiceNumber.substring(3, 5);
                            const aMonth = a.invoiceNumber.substring(5, 7);
                            const aNumber = parseInt(a.invoiceNumber.substring(7));
                            
                            const bYear = b.invoiceNumber.substring(3, 5);
                            const bMonth = b.invoiceNumber.substring(5, 7);
                            const bNumber = parseInt(b.invoiceNumber.substring(7));
                            
                            // Compare year
                            if (bYear !== aYear) return bYear - aYear;
                            
                            // If year is the same, compare month
                            if (bMonth !== aMonth) return bMonth - aMonth;
                            
                            // If month is the same, compare number
                            return bNumber - aNumber;
                        }
                        
                        return dateComparison;
                    });

                sortedInvoices.forEach(invoice => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${invoice.invoiceNumber}</td>
                        <td>${new Date(invoice.date).toLocaleDateString()}</td>
                        <td>${invoice.clientName}</td>
                        <td>KES ${(invoice.grandTotal || 0).toFixed(2)}</td>
                        <td>KES ${(invoice.balance || 0).toFixed(2)}</td>
                        <td>
                            <span class="badge" ${getInvoiceStatusBadgeClass(invoice.status)}>
                                ${invoice.status}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="action-btn" onclick="viewInvoice(${invoice.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="printInvoice(${invoice.id})">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="action-btn" onclick="downloadInvoice(${invoice.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });

                // Update client filter options
                updateInvoiceClientFilter();
            } catch (error) {
                console.error('Error rendering invoices table:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Error loading invoices</td></tr>';
            }
        }

        // Add helper function for invoice status badge classes
        function getInvoiceStatusBadgeClass(status) {
            let statusStyle = '';
            
            switch (status?.toLowerCase()) {
                case 'pending':
                    return 'style="background-color: #fff3e0; color: #f57c00; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'paid':
                    return 'style="background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'overdue':
                    return 'style="background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'approved':
                    return 'style="background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'rejected':
                    return 'style="background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'converted':
                    return 'style="background-color: #e3f2fd; color: #1976d2; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                default:
                    return 'style="background-color: #f5f5f5; color: #757575; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
            }
        }

        // Add function to update invoice client filter
        function updateInvoiceClientFilter() {
            const clientFilter = document.getElementById('invoiceClientFilter');
            if (!clientFilter) return;

            try {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                
                // Get unique client names
                const uniqueClients = [...new Set(invoices
                    .filter(i => i && i.clientName)
                    .map(i => i.clientName))]
                    .filter(Boolean)
                    .sort();
                
                clientFilter.innerHTML = '<option value="">All Clients</option>';
                uniqueClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.toLowerCase();
                    option.textContent = client;
                    clientFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error updating invoice client filter:', error);
                clientFilter.innerHTML = '<option value="">All Clients</option>';
            }
        }

        // Add function to filter invoices
        function filterInvoices() {
            const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
            const clientFilter = document.getElementById('invoiceClientFilter').value.toLowerCase();
            const dateFilter = document.getElementById('invoiceDateFilter').value;
            const specificDate = document.getElementById('invoiceSpecificDate').value;
            
            // Get period dates if the period filter is selected
            let periodStartDate = null;
            let periodEndDate = null;
            if (dateFilter === 'period') {
                periodStartDate = document.getElementById('invoicePeriodStartDate').value;
                periodEndDate = document.getElementById('invoicePeriodEndDate').value;
            }
            
            const rows = document.querySelectorAll('#invoicesTable tbody tr');
            
            rows.forEach(row => {
                const invoice = row.children;
                const invoiceNumber = invoice[0].textContent.toLowerCase();
                const client = invoice[2].textContent.toLowerCase();
                const date = invoice[1].textContent; // Format: YYYY-MM-DD
                
                // Search filter
                const matchesSearch = 
                    invoiceNumber.includes(searchTerm) || 
                    client.includes(searchTerm);
                
                // Client filter
                const matchesClient = !clientFilter || client.includes(clientFilter.toLowerCase());
                
                // Date filter
                let matchesDate = true;
                if (dateFilter === 'specific' && specificDate) {
                    const rowDate = new Date(date);
                    rowDate.setHours(0, 0, 0, 0);
                    const selectedDate = new Date(specificDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    matchesDate = rowDate.getTime() === selectedDate.getTime();
                } else if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                    matchesDate = checkDateFilter(date, 'period', periodStartDate, periodEndDate);
                } else {
                    matchesDate = !dateFilter || checkDateFilter(date, dateFilter);
                }

                // Apply all filters
                row.style.display = (matchesSearch && matchesClient && matchesDate) ? '' : 'none';
            });
        }

        // Add function to export invoices
        async function exportInvoices() {
            const doc = new jsPDF();
            
            // Add background
            await addBackgroundToPDF(doc);
            
            // Add title
            doc.setFontSize(20);
            doc.text('Invoices Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary section
            doc.setFontSize(14);
            doc.text('Invoice Summary', 20, 45);

            // Add invoices table
            const headers = [['Invoice #', 'Date', 'Client', 'Total Amount', 'Balance', 'Status']];
            const data = [];
            
            document.querySelectorAll('#invoicesTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent,
                    row.cells[5].textContent.trim()
                ]);
            });

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 55,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] },
                columnStyles: {
                    0: { cellWidth: 18 }, // Item Code
                    1: { cellWidth: 35 }, // Product
                    2: { cellWidth: 22 }, // Category
                    3: { cellWidth: 18 }, // Quantity
                    4: { cellWidth: 18 }, // Unit Price
                    5: { cellWidth: 22 }, // Total Value
                    6: { cellWidth: 18 }  // Status
                },
                margin: { left: 15, right: 15 },
            });

            // Add totals at the bottom
            const totals = data.reduce((acc, row) => {
                const amount = parseFloat(row[3].replace('KES ', '')) || 0;
                const balance = parseFloat(row[4].replace('KES ', '')) || 0;
                return {
                    totalAmount: acc.totalAmount + amount,
                    totalBalance: acc.totalBalance + balance
                };
            }, { totalAmount: 0, totalBalance: 0 });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Invoice Amount: KES ${totals.totalAmount.toFixed(2)}`, 20, finalY);
            doc.text(`Total Outstanding Balance: KES ${totals.totalBalance.toFixed(2)}`, 20, finalY + 7);

            doc.save('invoices_report.pdf');
        }

        // Add to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Initialize invoices view
            renderInvoicesTable();
            updateInvoiceClientFilter();
        });

        // ... rest of the existing code ...

        // Add functions for invoice actions
        function viewInvoice(id) {
                const invoice = invoices.find(i => i.id === id);
                if (!invoice) {
                    alert('Invoice not found');
                    return;
                }

                // Update modal classes for A4 layout
                const modal = document.getElementById('newQuotationModal');
                modal.classList.add('a4-modal');

                // Create A4 document layout
                document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                    <form id="newQuotationForm" class="a4-document">
                        <!-- Company Header -->
                        <div class="document-header">
                            <div class="company-name">Cabinet Master Styles And Finishes</div>
                            <div class="company-details">
                                <div>cabinetmasterstyles@gmail.com</div>
                                <div>Kamakis-Ruiru, Kenya</div>
                                <div>Phone No: 0729554475</div>
                            </div>
                        </div>

                        <!-- Document Info -->
                        <div class="document-info">
                            <!-- Left Column -->
                            <div class="document-info-group">
                                <h3>INVOICE</h3>
                                <div class="info-row">
                                    <span class="info-label">Invoice #</span>
                                    <input type="text" class="info-value" value="${invoice.invoiceNumber}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Date</span>
                                    <input type="text" class="info-value" value="${new Date(invoice.date).toLocaleDateString()}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Sales Order #</span>
                                    <input type="text" class="info-value" value="${invoice.salesOrderNumber}" readonly>
                                </div>
                            </div>

                            <!-- Right Column -->
                            <div class="document-info-group">
                                <div class="info-row">
                                    <span class="info-label">Client</span>
                                    <input type="text" class="info-value" value="${invoice.clientName}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Phone No</span>
                                    <input type="text" class="info-value" value="${invoice.clientPhone}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Location</span>
                                    <input type="text" class="info-value" value="${invoice.clientLocation}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Items Section -->
                        <div class="section-title">Items</div>
                        <table class="quotation-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Units</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.unit}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.rate.toFixed(2)}</td>
                                        <td>KES ${item.amount.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <!-- Totals Section -->
                        <div class="totals-section">
                            <div class="total-row">
                                <span>Cabinets Total</span>
                                <span>KES ${invoice.cabinetTotal.toFixed(2)}</span>
                            </div>
                            <div class="total-row">
                                <span>Worktop Total</span>
                                <span>KES ${invoice.worktopTotal.toFixed(2)}</span>
                            </div>
                            ${invoice.accessoriesTotal > 0 ? `
                                <div class="total-row">
                                    <span>Accessories Total</span>
                                    <span>KES ${invoice.accessoriesTotal.toFixed(2)}</span>
                                </div>
                            ` : ''}
                            <div class="total-row grand-total">
                                <span>GRAND TOTAL</span>
                                <span>KES ${invoice.grandTotal.toFixed(2)}</span>
                            </div>
                        </div>

                        <!-- Payment Summary Section -->
                        <div class="section-title" style="margin-top: 30px;">Payment Summary</div>
                        <table class="quotation-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody id="paymentSummaryTableBody">
                                <!-- Payment data will be dynamically added here -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2"><strong>Total Paid</strong></td>
                                    <td colspan="2"><strong>KES <span id="totalPaidAmount">0.00</span></strong></td>
                                </tr>
                                <tr>
                                    <td colspan="2"><strong>Balance</strong></td>
                                    <td colspan="2"><strong>KES <span id="balanceAmount">0.00</span></strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </form>
                `;

                // Update modal title and footer
                document.querySelector('#newQuotationModal .modal-title').textContent = 'View Invoice';
                document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-add" onclick="printInvoice(${id})">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                    <button type="button" class="btn btn-add" onclick="downloadInvoice(${id})">
                        <i class="fas fa-download me-2"></i>Download
                    </button>
                `;

                // Show modal
                const modalInstance = new bootstrap.Modal(modal);
                modalInstance.show();

                // Update payment summary table
                updatePaymentSummaryTable(invoice);
        }

        async function printInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            if (!invoice) return;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Invoice #${invoice.invoiceNumber}</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 0;
                        }
                        @media print {
                            .no-print {
                                display: none;
                            }
                            html, body {
                                width: 210mm;
                                height: 297mm;
                                margin: 0;
                                padding: 0;
                            }
                            .container {
                                width: 100%;
                                max-width: none;
                                margin: 0;
                                padding: 20mm;
                                background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png');
                                background-size: 100% 100%;
                                background-position: center;
                                background-repeat: no-repeat;
                                min-height: 100%;
                                -webkit-print-color-adjust: exact !important;
                                print-color-adjust: exact !important;
                            }
                        }
                        html, body {
                            margin: 0;
                            padding: 0;
                            min-height: 100vh;
                        }
                        .container {
                            background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png');
                            background-size: 100% 100%;
                            background-position: center;
                            background-repeat: no-repeat;
                            min-height: 100vh;
                            padding: 40px;
                            margin: 0;
                            max-width: none;
                        }
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            position: relative;
                            z-index: 1;
                        }
                        .company-name {
                            font-size: 24px;
                            font-weight: bold;
                        }
                        .invoice-details {
                            margin-bottom: 20px;
                            position: relative;
                            z-index: 1;
                        }
                        .table {
                            position: relative;
                            z-index: 1;
                            background-color: rgba(0, 0, 0, 0);
                        }
                        .table th {
                            background-color: #00000000 !important;
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <div class="company-name">Cabinet Master Styles And Finishes</div>
                            <div>cabinetmasterstyles@gmail.com</div>
                            <div>Kamakis-Ruiru, Kenya</div>
                            <div>Phone: 0729554475</div>
                        </div>

                        <div class="invoice-details">
                            <div class="row">
                                <div class="col-6">
                                    <h2>INVOICE</h2>
                                    <p><strong>Invoice #:</strong> ${invoice.invoiceNumber}</p>
                                    <p><strong>Date:</strong> ${new Date(invoice.date).toLocaleDateString()}</p>
                                    <p><strong>Sales Order #:</strong> ${invoice.salesOrderNumber}</p>
                                </div>
                                <div class="col-6 text-end">
                                    <p><strong>Client:</strong> ${invoice.clientName}</p>
                                    <p><strong>Phone:</strong> ${invoice.clientPhone}</p>
                                    <p><strong>Location:</strong> ${invoice.clientLocation}</p>
                                </div>
                            </div>
                        </div>

                        <h4>Items</h4>
                        <table class="table table-bordered mb-4">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Units</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.unit}</td>
                                        <td>${item.quantity}</td>
                                        <td>KES ${item.rate.toFixed(2)}</td>
                                        <td>KES ${item.amount.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>

                        <div class="row">
                            <div class="col-6 offset-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>Cabinets Total:</strong></td>
                                        <td class="text-end">KES ${invoice.cabinetTotal.toFixed(2)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Worktop Total:</strong></td>
                                        <td class="text-end">KES ${invoice.worktopTotal.toFixed(2)}</td>
                                    </tr>
                                    ${invoice.accessoriesTotal > 0 ? `
                                        <tr>
                                            <td><strong>Accessories Total:</strong></td>
                                            <td class="text-end">KES ${invoice.accessoriesTotal.toFixed(2)}</td>
                                        </tr>
                                    ` : ''}
                                    <tr class="border-top">
                                        <td><strong>GRAND TOTAL:</strong></td>
                                        <td class="text-end"><strong>KES ${invoice.grandTotal.toFixed(2)}</strong></td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <h4 class="mt-4">Payment Summary</h4>
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Account</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${invoice.payments.map(payment => `
                                    <tr>
                                        <td>${new Date(payment.date).toLocaleDateString()}</td>
                                        <td>${payment.description}</td>
                                        <td>KES ${payment.amount.toFixed(2)}</td>
                                        <td>${payment.account}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="2"><strong>Total Paid</strong></td>
                                    <td colspan="2"><strong>KES ${invoice.totalPaid.toFixed(2)}</strong></td>
                                </tr>
                                <tr>
                                    <td colspan="2"><strong>Balance</strong></td>
                                    <td colspan="2"><strong>KES ${invoice.balance.toFixed(2)}</strong></td>
                                </tr>
                            </tfoot>
                        </table>

                        <div class="text-center mt-4 no-print">
                            <button onclick="window.print()" class="btn btn-primary">Print Invoice</button>
                        </div>
                    </div>
                </body>
                </html>
            `);
        }

        async function downloadInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            if (!invoice) return;

            const doc = new jsPDF();
            
            // Add background
            await addBackgroundToPDF(doc);
            
            // Add header
            doc.setFontSize(20);
            doc.text('INVOICE', 105, 20, { align: 'center' });
            
            // Add company details
            doc.setFontSize(12);
            doc.text('Cabinet Master Styles And Finishes', 105, 30, { align: 'center' });
            doc.text('cabinetmasterstyles@gmail.com', 105, 35, { align: 'center' });
            doc.text('Kamakis-Ruiru, Kenya', 105, 40, { align: 'center' });
            doc.text('Phone: 0729554475', 105, 45, { align: 'center' });

            // Add invoice details
            doc.text(`Invoice #: ${invoice.invoiceNumber}`, 20, 60);
            doc.text(`Date: ${new Date(invoice.date).toLocaleDateString()}`, 20, 65);
            doc.text(`Sales Order #: ${invoice.salesOrderNumber}`, 20, 70);
            
            // Add client details
            doc.text('To:', 120, 60);
            doc.text(invoice.clientName, 120, 65);
            doc.text(invoice.clientPhone, 120, 70);
            doc.text(invoice.clientLocation, 120, 75);

            // Add items table
            const itemHeaders = [['Description', 'Units', 'Quantity', 'Unit Price', 'Total']];
            const itemData = invoice.items.map(item => [
                item.description,
                item.unit,
                item.quantity.toString(),
                `KES ${item.rate.toFixed(2)}`,
                `KES ${item.amount.toFixed(2)}`
            ]);

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 85,
                head: itemHeaders,
                body: itemData,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Add totals
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Cabinets Total: KES ${invoice.cabinetTotal.toFixed(2)}`, 120, finalY);
            doc.text(`Worktop Total: KES ${invoice.worktopTotal.toFixed(2)}`, 120, finalY + 7);
            if (invoice.accessoriesTotal > 0) {
                doc.text(`Accessories Total: KES ${invoice.accessoriesTotal.toFixed(2)}`, 120, finalY + 14);
            }
            doc.setFontSize(14);
            doc.text(`GRAND TOTAL: KES ${invoice.grandTotal.toFixed(2)}`, 120, finalY + (invoice.accessoriesTotal > 0 ? 24 : 17));

            // Add payment summary
            doc.setFontSize(12);
            doc.text('Payment Summary:', 20, finalY + 40);
            
            const paymentHeaders = [['Date', 'Description', 'Amount', 'Account']];
            const paymentData = invoice.payments.map(payment => [
                new Date(payment.date).toLocaleDateString(),
                payment.description,
                `KES ${payment.amount.toFixed(2)}`,
                payment.account
            ]);
            paymentData.push(
                ['', 'Total Paid', `KES ${invoice.totalPaid.toFixed(2)}`, ''],
                ['', 'Balance', `KES ${invoice.balance.toFixed(2)}`, '']
            );

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: finalY + 45,
                head: paymentHeaders,
                body: paymentData,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] }
            });

            // Save the PDF
            doc.save(`invoice_${invoice.invoiceNumber}.pdf`);
        }

        function updatePaymentSummaryTable(data) {
            const paymentSummaryTableBody = document.getElementById('paymentSummaryTableBody');
            const totalPaidAmount = document.getElementById('totalPaidAmount');
            const balanceAmount = document.getElementById('balanceAmount');
            
            if (!paymentSummaryTableBody || !totalPaidAmount || !balanceAmount) return;

            // Get payments and calculate totals
            const payments = data.payments || [];
            const totalPaid = payments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            const balance = (data.grandTotal || 0) - totalPaid;

            // Update payment rows
            paymentSummaryTableBody.innerHTML = payments.map(payment => `
                <tr>
                    <td>${new Date(payment.date).toLocaleDateString()}</td>
                    <td>${payment.description}</td>
                    <td>KES ${payment.amount.toFixed(2)}</td>
                    <td>${payment.account}</td>
                </tr>
            `).join('');

            // Update totals
            totalPaidAmount.textContent = totalPaid.toFixed(2);
            balanceAmount.textContent = balance.toFixed(2);
        }

        // Add function to update payment summaries in real-time
        function updatePaymentSummaries(forceUpdate = false) {
            try {
                // Always get fresh data from localStorage
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
                const salesOrders = JSON.parse(localStorage.getItem('salesOrders') || '[]');
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                
                let quotationsUpdated = false;
                let salesOrdersUpdated = false;
                let invoicesUpdated = false;

                // Update quotations with latest payments
                quotations.forEach(quotation => {
                    const quotationPayments = payments.filter(p => p.paidTo === quotation.quotationNumber);
                    const totalPaid = quotationPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                    
                    if (forceUpdate || quotation.totalPaid !== totalPaid) {
                        quotation.payments = quotationPayments;
                        quotation.totalPaid = totalPaid;
                        quotation.balance = quotation.grandTotal - totalPaid;
                        quotationsUpdated = true;
                    }
                });

                // Update sales orders with latest payments
                salesOrders.forEach(order => {
                    const quotation = quotations.find(q => q.quotationNumber === order.quotationNumber);
                    if (quotation) {
                        if (forceUpdate || order.totalPaid !== quotation.totalPaid) {
                            order.payments = quotation.payments;
                            order.totalPaid = quotation.totalPaid;
                            order.balance = order.grandTotal - quotation.totalPaid;
                            salesOrdersUpdated = true;
                        }
                    }
                });

                // Update invoices with latest payments
                invoices.forEach(invoice => {
                    const salesOrder = salesOrders.find(o => o.orderNumber === invoice.salesOrderNumber);
                    if (salesOrder) {
                        if (forceUpdate || invoice.totalPaid !== salesOrder.totalPaid) {
                            invoice.payments = salesOrder.payments;
                            invoice.totalPaid = salesOrder.totalPaid;
                            invoice.balance = invoice.grandTotal - salesOrder.totalPaid;
                            invoice.status = invoice.balance <= 0 ? 'Paid' : 'Pending';
                            invoicesUpdated = true;
                        }
                    }
                });

                // Save updated data back to localStorage
                if (quotationsUpdated) {
                    localStorage.setItem('quotations', JSON.stringify(quotations));
                }
                if (salesOrdersUpdated) {
                    localStorage.setItem('salesOrders', JSON.stringify(salesOrders));
                }
                if (invoicesUpdated) {
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                }

                // Update UI if there were changes or force update is true
                if (quotationsUpdated || salesOrdersUpdated || invoicesUpdated || forceUpdate) {
                    // Update tables
                    renderQuotationsTable();
                    renderSalesOrdersTable();
                    renderInvoicesTable();
                    renderPaymentsTable();

                    // Update payment summaries in open modals
                    const openModals = document.querySelectorAll('.modal.show');
                    openModals.forEach(modal => {
                        // Check for sales order modal
                        const salesOrderId = modal.querySelector('#orderNumber')?.dataset.salesOrderId;
                        if (salesOrderId) {
                            const salesOrder = salesOrders.find(o => o.id === parseInt(salesOrderId));
                            if (salesOrder) {
                                updatePaymentSummaryTable(salesOrder);
                            }
                        }

                        // Check for invoice modal
                        const invoiceNumber = modal.querySelector('#invoiceNumber')?.value;
                        if (invoiceNumber) {
                            const invoice = invoices.find(i => i.invoiceNumber === invoiceNumber);
                            if (invoice) {
                                updatePaymentSummaryTable(invoice);
                            }
                        }
                    });
                }

                return { quotationsUpdated, salesOrdersUpdated, invoicesUpdated };
            } catch (error) {
                console.error('Error updating payment summaries:', error);
                return { quotationsUpdated: false, salesOrdersUpdated: false, invoicesUpdated: false };
            }
        }

        // Update savePayment function to ensure immediate updates
        function savePayment() {
            try {
                const form = document.getElementById('paymentForm');
                if (!form) {
                    console.error('Payment form not found');
                    return;
                }

                if (!form.checkValidity()) {
                    form.reportValidity();
                    return;
                }

                const clientInput = document.getElementById('paymentClientSearch');
                if (!clientInput || !clientInput.dataset.clientId) {
                    alert('Please select a client from the list');
                    return;
                }

                // Get form data
                const paymentData = {
                    id: Date.now(),
                    date: document.getElementById('paymentDate').value,
                    clientId: clientInput.dataset.clientId,
                    clientName: clientInput.value,
                    clientPhone: clientInput.dataset.clientPhone || '',
                    clientLocation: clientInput.dataset.clientLocation || '',
                    description: form.querySelector('[name="description"]').value,
                    amount: parseFloat(form.querySelector('[name="amount"]').value) || 0,
                    paidTo: form.querySelector('[name="paidTo"]').value,
                    account: form.querySelector('[name="account"]').value
                };

                // Validate payment amount
                if (paymentData.amount <= 0) {
                    alert('Payment amount must be greater than 0');
                    return;
                }

                // Generate payment number
                paymentData.paymentNumber = generatePaymentNumber();

                // Save payment data
                let payments = JSON.parse(localStorage.getItem('payments') || '[]');
                payments.unshift(paymentData); // Add new payment at the beginning
                localStorage.setItem('payments', JSON.stringify(payments));

                // Update related documents based on paidTo value
                const paidTo = paymentData.paidTo;
                if (paidTo) {
                    // Update quotations
                    let quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
                    const quotationIndex = quotations.findIndex(q => q.quotationNumber === paidTo);
                    if (quotationIndex !== -1) {
                        const quotation = quotations[quotationIndex];
                        quotation.payments = quotation.payments || [];
                        quotation.payments.push(paymentData);
                        quotation.totalPaid = (quotation.totalPaid || 0) + paymentData.amount;
                        quotation.balance = quotation.grandTotal - quotation.totalPaid;
                        localStorage.setItem('quotations', JSON.stringify(quotations));
                    }

                    // Update sales orders
                    let salesOrders = JSON.parse(localStorage.getItem('salesOrders') || '[]');
                    const salesOrderIndex = salesOrders.findIndex(so => so.orderNumber === paidTo);
                    if (salesOrderIndex !== -1) {
                        const salesOrder = salesOrders[salesOrderIndex];
                        salesOrder.payments = salesOrder.payments || [];
                        salesOrder.payments.push(paymentData);
                        salesOrder.totalPaid = (salesOrder.totalPaid || 0) + paymentData.amount;
                        salesOrder.balance = salesOrder.grandTotal - salesOrder.totalPaid;
                        localStorage.setItem('salesOrders', JSON.stringify(salesOrders));
                    }

                    // Update invoices
                    let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                    const invoiceIndex = invoices.findIndex(i => i.invoiceNumber === paidTo);
                    if (invoiceIndex !== -1) {
                        const invoice = invoices[invoiceIndex];
                        invoice.payments = invoice.payments || [];
                        invoice.payments.push(paymentData);
                        invoice.totalPaid = (invoice.totalPaid || 0) + paymentData.amount;
                        invoice.balance = invoice.grandTotal - invoice.totalPaid;
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                    }
                }

                // Force immediate UI update
                requestAnimationFrame(() => {
                    // Force update all data and UI
                updatePaymentSummaries(true);
                    
                    // Show success message after UI is updated
                    alert('Payment saved successfully');
                });
                
                // Close modal and reset form
                const modalElement = document.getElementById('makePaymentModal');
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
                
                // Reset the form
                form.reset();
                
                // Clear client search data
                if (clientInput) {
                    clientInput.value = '';
                    delete clientInput.dataset.clientId;
                    delete clientInput.dataset.clientPhone;
                    delete clientInput.dataset.clientLocation;
                }
            } catch (error) {
                console.error('Error saving payment:', error);
                alert('An error occurred while saving the payment. Please try again.');
            }
        }

        // Update proceedToInvoice function to use real-time payment data
        function proceedToInvoice(salesOrderId) {
            const salesOrder = salesOrders.find(o => o.id === salesOrderId);
            if (!salesOrder) {
                alert('Sales order not found');
                return;
            }

            // Get latest payment data
            const payments = JSON.parse(localStorage.getItem('payments') || '[]');
            const orderPayments = payments.filter(p => p.paidTo === salesOrder.quotationNumber);
            const totalPaid = orderPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
            const balance = salesOrder.grandTotal - totalPaid;
            
            // Separate 80% validation
            const requiredPayment = salesOrder.grandTotal * 0.8;
            if (totalPaid < requiredPayment) {
                const remainingAmount = requiredPayment - totalPaid;
                alert(`Cannot proceed to invoice. At least 80% payment (KES ${requiredPayment.toFixed(2)}) is required.\nRemaining amount needed: KES ${remainingAmount.toFixed(2)}`);
                return;
            }

            // Generate invoice number
            const invoiceNumber = generateInvoiceNumber();

            // Update modal classes for A4 layout
            const modal = document.getElementById('newQuotationModal');
            modal.classList.add('a4-modal');

            // Create A4 document layout with updated payment summary
            document.querySelector('#newQuotationModal .modal-body').innerHTML = `
                <form id="newQuotationForm" class="a4-document">
                        <!-- Company Header -->
                        <div class="document-header">
                            <div class="company-name">Cabinet Master Styles And Finishes</div>
                            <div class="company-details">
                                <div>cabinetmasterstyles@gmail.com</div>
                                <div>Kamakis-Ruiru, Kenya</div>
                                <div>Phone No: 0729554475</div>
                            </div>
                        </div>
    
                        <!-- Document Info -->
                        <div class="document-info">
                            <!-- Left Column -->
                            <div class="document-info-group">
                                <h3>INVOICE</h3>
                                <div class="info-row">
                                    <span class="info-label">Invoice #</span>
                                    <input type="text" class="info-value" id="invoiceNumber" value="${invoiceNumber}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Date</span>
                                    <input type="text" class="info-value" value="${new Date().toLocaleDateString()}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Sales Order #</span>
                                    <input type="text" class="info-value" value="${salesOrder.orderNumber}" readonly>
                                </div>
                            </div>
    
                            <!-- Right Column -->
                            <div class="document-info-group">
                                <div class="info-row">
                                    <span class="info-label">Client</span>
                                    <input type="text" class="info-value" value="${salesOrder.clientName}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Phone No</span>
                                    <input type="text" class="info-value" value="${salesOrder.clientPhone}" readonly>
                                </div>
                                <div class="info-row">
                                    <span class="info-label">Location</span>
                                    <input type="text" class="info-value" value="${salesOrder.clientLocation}" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="section-title">Items</div>
                    <table class="quotation-table">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                                ${[...salesOrder.cabinetItems, ...salesOrder.worktopItems,
                                   ...(salesOrder.includeAccessories ? salesOrder.accessoriesItems : [])]
                              .map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.unit}</td>
                                    <td>${item.quantity}</td>
                                    <td>KES ${item.rate.toFixed(2)}</td>
                                    <td>KES ${item.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <!-- Totals Section -->
                    <div class="totals-section">
                        <div class="total-row">
                            <span>Cabinets Total</span>
                                <span>KES ${salesOrder.cabinetTotal.toFixed(2)}</span>
                        </div>
                        <div class="total-row">
                            <span>Worktop Total</span>
                                <span>KES ${salesOrder.worktopTotal.toFixed(2)}</span>
                        </div>
                            ${salesOrder.includeAccessories ? `
                            <div class="total-row">
                                <span>Accessories Total</span>
                                    <span>KES ${salesOrder.accessoriesTotal.toFixed(2)}</span>
                            </div>
                        ` : ''}
                        <div class="total-row grand-total">
                            <span>GRAND TOTAL</span>
                                <span>KES ${salesOrder.grandTotal.toFixed(2)}</span>
                        </div>
                    </div>

                    <!-- Payment Summary Section with updated data -->
                    <div class="section-title" style="margin-top: 30px;">Payment Summary</div>
                    <table class="quotation-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Account</th>
                            </tr>
                        </thead>
                        <tbody id="paymentSummaryTableBody">
                            <!-- Payment data will be dynamically added here -->
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="2"><strong>Total Paid</strong></td>
                                <td colspan="2"><strong>KES <span id="totalPaidAmount">0.00</span></strong></td>
                            </tr>
                            <tr>
                                <td colspan="2"><strong>Balance</strong></td>
                                <td colspan="2"><strong>KES <span id="balanceAmount">0.00</span></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </form>
            `;

            // Store sales order ID for reference when saving
            document.getElementById('invoiceNumber').dataset.salesOrderId = salesOrderId;

            // Update modal title and footer
            document.querySelector('#newQuotationModal .modal-title').textContent = 'Generate Invoice';
            document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-add" onclick="saveInvoice()">Save Invoice</button>
            `;

            // Show modal
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            // Update payment summary table
            requestAnimationFrame(() => {
                const updatedSalesOrder = {
                    ...salesOrder,
                    payments: orderPayments,
                    totalPaid: totalPaid,
                    balance: balance
                };
                updatePaymentSummaryTable(updatedSalesOrder);
            });
        }

        // Add event listener to update payment summaries when payments view is shown
        document.getElementById('paymentsBtn')?.addEventListener('click', function() {
            updatePaymentSummaries();
        });

        // Update DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sales view state if not set
            if (!localStorage.getItem('activeSalesView')) {
                localStorage.setItem('activeSalesView', 'quotations');
            }
            
            // Force initial data refresh
            updatePaymentSummaries(true);
            
            // Initialize all tables
            renderPaymentsTable();
            renderQuotationsTable();
            renderSalesOrdersTable();
            renderInvoicesTable();
            
            // Add click handler for sales section button
            document.querySelector('[data-section="salesSection"]').addEventListener('click', showSalesSection);
            
            // Update when switching sections - with force refresh
            document.querySelectorAll('[data-section]').forEach(element => {
                element.addEventListener('click', function() {
                    const section = this.dataset.section;
                    if (section === 'paymentsSection' || section === 'salesSection') {
                        // Force refresh data when entering relevant sections
                        requestAnimationFrame(() => {
                        updatePaymentSummaries(true);
                        });
                    }
                });
            });

            // Refresh data every 30 seconds
            setInterval(() => {
                requestAnimationFrame(() => {
                    updatePaymentSummaries(true);
                });
            }, 30000);
        });

            // ... existing code ...

        function updatePaymentSummaries(forceUpdate = false) {
            try {
                // Always get fresh data from localStorage
                const payments = JSON.parse(localStorage.getItem('payments') || '[]');
                const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
                const salesOrders = JSON.parse(localStorage.getItem('salesOrders') || '[]');
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                
                let quotationsUpdated = false;
                let salesOrdersUpdated = false;
                let invoicesUpdated = false;

                // Update quotations with latest payments
                quotations.forEach(quotation => {
                    const quotationPayments = payments.filter(p => p.paidTo === quotation.quotationNumber);
                    const totalPaid = quotationPayments.reduce((sum, payment) => sum + (payment.amount || 0), 0);
                    
                    if (forceUpdate || quotation.totalPaid !== totalPaid) {
                        quotation.payments = quotationPayments;
                        quotation.totalPaid = totalPaid;
                        quotation.balance = quotation.grandTotal - totalPaid;
                        quotationsUpdated = true;
                    }
                });

                // Update sales orders with latest payments
                salesOrders.forEach(order => {
                    const quotation = quotations.find(q => q.quotationNumber === order.quotationNumber);
                    if (quotation) {
                        if (forceUpdate || order.totalPaid !== quotation.totalPaid) {
                            order.payments = quotation.payments;
                            order.totalPaid = quotation.totalPaid;
                            order.balance = order.grandTotal - quotation.totalPaid;
                            salesOrdersUpdated = true;
                        }
                    }
                });

                // Update invoices with latest payments
                invoices.forEach(invoice => {
                    const salesOrder = salesOrders.find(o => o.orderNumber === invoice.salesOrderNumber);
                    if (salesOrder) {
                        if (forceUpdate || invoice.totalPaid !== salesOrder.totalPaid) {
                            invoice.payments = salesOrder.payments;
                            invoice.totalPaid = salesOrder.totalPaid;
                            invoice.balance = invoice.grandTotal - salesOrder.totalPaid;
                            invoice.status = invoice.balance <= 0 ? 'Paid' : 'Pending';
                            invoicesUpdated = true;
                        }
                    }
                });

                // Save updated data back to localStorage
                if (quotationsUpdated) {
                    localStorage.setItem('quotations', JSON.stringify(quotations));
                }
                if (salesOrdersUpdated) {
                    localStorage.setItem('salesOrders', JSON.stringify(salesOrders));
                 }
                if (invoicesUpdated) {
                    localStorage.setItem('invoices', JSON.stringify(invoices));
                }

                // Update UI if there were changes or force update is true
                if (quotationsUpdated || salesOrdersUpdated || invoicesUpdated || forceUpdate) {
                    // Update tables
                    renderQuotationsTable();
                    renderSalesOrdersTable();
                    renderInvoicesTable();
                    renderPaymentsTable();

                    // Update payment summaries in open modals
                    const openModals = document.querySelectorAll('.modal.show');
                    openModals.forEach(modal => {
                        // Check for sales order modal
                        const salesOrderId = modal.querySelector('#orderNumber')?.dataset.salesOrderId;
                        if (salesOrderId) {
                            const salesOrder = salesOrders.find(o => o.id === parseInt(salesOrderId));
                            if (salesOrder) {
                                updatePaymentSummaryTable(salesOrder);
                            }
                        }

                        // Check for invoice modal
                        const invoiceNumber = modal.querySelector('#invoiceNumber')?.value;
                        if (invoiceNumber) {
                            const invoice = invoices.find(i => i.invoiceNumber === invoiceNumber);
                            if (invoice) {
                                updatePaymentSummaryTable(invoice);
                            }
                        }
                    });
                }

                return { quotationsUpdated, salesOrdersUpdated, invoicesUpdated };
            } catch (error) {
                console.error('Error updating payment summaries:', error);
                return { quotationsUpdated: false, salesOrdersUpdated: false, invoicesUpdated: false };
            }
        }

        // Add event listeners for automatic updates
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize sales view state if not set
            if (!localStorage.getItem('activeSalesView')) {
                localStorage.setItem('activeSalesView', 'quotations');
            }
            
            // Force initial data refresh
            updatePaymentSummaries(true);
            
            // Initialize all tables
            renderPaymentsTable();
            renderQuotationsTable();
            renderSalesOrdersTable();
            renderInvoicesTable();
            
            // Add click handler for sales section button
            document.querySelector('[data-section="salesSection"]').addEventListener('click', showSalesSection);
            
            // Update when switching sections - with force refresh
            document.querySelectorAll('[data-section]').forEach(element => {
                element.addEventListener('click', function() {
                    const section = this.dataset.section;
                    if (section === 'paymentsSection' || section === 'salesSection') {
                        // Force refresh data when entering relevant sections
                        requestAnimationFrame(() => {
                            updatePaymentSummaries(true);
                        });
                    }
                });
            });

            // Refresh data every 30 seconds
            setInterval(() => {
                requestAnimationFrame(() => {
                    updatePaymentSummaries(true);
                });
            }, 30000);
        });

            // ... existing code ...

        // Add this to your existing DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Load invoices from localStorage
            const storedInvoices = localStorage.getItem('invoices');
            if (storedInvoices) {
                invoices = JSON.parse(storedInvoices);
            }
        });

        // Add function to render invoices table
        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) {
                console.warn('Invoices table body not found');
                return;
            }

            try {
                // Get invoices from localStorage
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            tbody.innerHTML = '';

                // Sort invoices by date and order number (newest first)
                const sortedInvoices = invoices
                    .filter(invoice => invoice && invoice.clientName)
                    .sort((a, b) => {
                        // First sort by date (newest first)
                        const dateComparison = new Date(b.date) - new Date(a.date);
                        
                        // If dates are the same, sort by invoice number (newest first)
                        if (dateComparison === 0 && a.invoiceNumber && b.invoiceNumber) {
                            // Extract year and month from invoice numbers (assuming format INVYYMMXXX)
                            const aYear = a.invoiceNumber.substring(3, 5);
                            const aMonth = a.invoiceNumber.substring(5, 7);
                            const aNumber = parseInt(a.invoiceNumber.substring(7));
                            
                            const bYear = b.invoiceNumber.substring(3, 5);
                            const bMonth = b.invoiceNumber.substring(5, 7);
                            const bNumber = parseInt(b.invoiceNumber.substring(7));
                            
                            // Compare year
                            if (bYear !== aYear) return bYear - aYear;
                            
                            // If year is the same, compare month
                            if (bMonth !== aMonth) return bMonth - aMonth;
                            
                            // If month is the same, compare number
                            return bNumber - aNumber;
                        }
                        
                        return dateComparison;
                    });

                sortedInvoices.forEach(invoice => {
                    const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${invoice.invoiceNumber}</td>
                        <td>${new Date(invoice.date).toLocaleDateString()}</td>
                    <td>${invoice.clientName}</td>
                        <td>KES ${(invoice.grandTotal || 0).toFixed(2)}</td>
                        <td>KES ${(invoice.balance || 0).toFixed(2)}</td>
                        <td>
                            <span class="badge" ${getInvoiceStatusBadgeClass(invoice.status)}>
                                ${invoice.status}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="action-btn" onclick="viewInvoice(${invoice.id})">
                                    <i class="fas fa-eye"></i>
                            </button>
                                <button class="action-btn" onclick="printInvoice(${invoice.id})">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="action-btn" onclick="downloadInvoice(${invoice.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                `;
                });

                // Update client filter options
                updateInvoiceClientFilter();
            } catch (error) {
                console.error('Error rendering invoices table:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Error loading invoices</td></tr>';
            }
        }

        // Add helper function for invoice status badge classes
        function getInvoiceStatusBadgeClass(status) {
            let statusStyle = '';
            
            switch (status?.toLowerCase()) {
                case 'pending':
                    return 'style="background-color: #fff3e0; color: #f57c00; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'paid':
                    return 'style="background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'overdue':
                    return 'style="background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'approved':
                    return 'style="background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'rejected':
                    return 'style="background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                case 'converted':
                    return 'style="background-color: #e3f2fd; color: #1976d2; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
                default:
                    return 'style="background-color: #f5f5f5; color: #757575; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;"';
            }
        }

        // Add function to update invoice client filter
        function updateInvoiceClientFilter() {
            const clientFilter = document.getElementById('invoiceClientFilter');
            if (!clientFilter) return;

            try {
                const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                
                // Get unique client names
                const uniqueClients = [...new Set(invoices
                    .filter(i => i && i.clientName)
                    .map(i => i.clientName))]
                    .filter(Boolean)
                    .sort();
                
                clientFilter.innerHTML = '<option value="">All Clients</option>';
                uniqueClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.toLowerCase();
                    option.textContent = client;
                    clientFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error updating invoice client filter:', error);
                clientFilter.innerHTML = '<option value="">All Clients</option>';
            }
        }

        // Add function to filter invoices
        function filterInvoices() {
            const searchTerm = document.getElementById('invoiceSearch').value.toLowerCase();
            const clientFilter = document.getElementById('invoiceClientFilter').value.toLowerCase();
            const dateFilter = document.getElementById('invoiceDateFilter').value;
            const specificDate = document.getElementById('invoiceSpecificDate').value;
            
            // Get period dates if the period filter is selected
            let periodStartDate = null;
            let periodEndDate = null;
            if (dateFilter === 'period') {
                periodStartDate = document.getElementById('invoicePeriodStartDate').value;
                periodEndDate = document.getElementById('invoicePeriodEndDate').value;
            }
            
            const rows = document.querySelectorAll('#invoicesTable tbody tr');
            
            rows.forEach(row => {
                const invoice = row.children;
                const invoiceNumber = invoice[0].textContent.toLowerCase();
                const client = invoice[2].textContent.toLowerCase();
                const date = invoice[1].textContent; // Format: YYYY-MM-DD
                
                // Search filter
                const matchesSearch = 
                    invoiceNumber.includes(searchTerm) || 
                    client.includes(searchTerm);
                
                // Client filter
                const matchesClient = !clientFilter || client.includes(clientFilter.toLowerCase());
                
                // Date filter
                let matchesDate = true;
                if (dateFilter === 'specific' && specificDate) {
                    const rowDate = new Date(date);
                    rowDate.setHours(0, 0, 0, 0);
                    const selectedDate = new Date(specificDate);
                    selectedDate.setHours(0, 0, 0, 0);
                    matchesDate = rowDate.getTime() === selectedDate.getTime();
                } else if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                    matchesDate = checkDateFilter(date, 'period', periodStartDate, periodEndDate);
                } else {
                    matchesDate = !dateFilter || checkDateFilter(date, dateFilter);
                }

                // Apply all filters
                row.style.display = (matchesSearch && matchesClient && matchesDate) ? '' : 'none';
            });
        }

        // Add function to export invoices
        async function exportInvoices() {
            const doc = new jsPDF();
            
            // Add background
            await addBackgroundToPDF(doc);
            
            // Add title
            doc.setFontSize(20);
            doc.text('Invoices Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });

            // Add summary section
            doc.setFontSize(14);
            doc.text('Invoice Summary', 20, 45);

            // Add invoices table
            const headers = [['Invoice #', 'Date', 'Client', 'Total Amount', 'Balance', 'Status']];
            const data = [];
            
            document.querySelectorAll('#invoicesTable tbody tr:not([style*="display: none"])').forEach(row => {
                data.push([
                    row.cells[0].textContent,
                    row.cells[1].textContent,
                    row.cells[2].textContent,
                    row.cells[3].textContent,
                    row.cells[4].textContent,
                    row.cells[5].textContent.trim()
                ]);
            });

            doc.autoTable({
                textColor: [0, 0, 0],
                startY: 55,
                head: headers,
                body: data,
                theme: 'grid',
                styles: { fontSize: 10 },
                headStyles: { fillColor: [59, 130, 246] },
                columnStyles: {
                    0: { cellWidth: 18 }, // Invoice #
                    1: { cellWidth: 22 }, // Date
                    2: { cellWidth: 35 }, // Client
                    3: { cellWidth: 22 }, // Total Amount
                    4: { cellWidth: 22 }, // Balance
                    5: { cellWidth: 18 }  // Status
                },
                margin: { left: 15, right: 15 },
            });

            // Add totals at the bottom
            const totals = data.reduce((acc, row) => {
                const amount = parseFloat(row[3].replace('KES ', '')) || 0;
                const balance = parseFloat(row[4].replace('KES ', '')) || 0;
                return {
                    totalAmount: acc.totalAmount + amount,
                    totalBalance: acc.totalBalance + balance
                };
            }, { totalAmount: 0, totalBalance: 0 });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.text(`Total Invoice Amount: KES ${totals.totalAmount.toFixed(2)}`, 20, finalY);
            doc.text(`Total Outstanding Balance: KES ${totals.totalBalance.toFixed(2)}`, 20, finalY + 7);

            doc.save('invoices_report.pdf');
        }

        // Add function to render cash sales table
        function renderCashSalesTable() {
            try {
                const tbody = document.querySelector('#cashSalesTable tbody');
                const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
                const searchTerm = document.getElementById('cashSaleSearch')?.value.toLowerCase() || '';
                const clientFilter = document.getElementById('cashSaleClientFilter')?.value || '';
                const dateFilter = document.getElementById('cashSaleDateFilter')?.value || '';
                const specificDate = document.getElementById('cashSaleSpecificDate')?.value || '';

                // Get period dates if the period filter is selected
                let periodStartDate = null;
                let periodEndDate = null;
                if (dateFilter === 'period') {
                    periodStartDate = document.getElementById('cashSalePeriodStartDate').value;
                    periodEndDate = document.getElementById('cashSalePeriodEndDate').value;
                }

                // Filter cash sales based on search, client, and date
                let filteredCashSales = cashSales.filter(sale => {
                    const matchesSearch = 
                        sale.cashSaleNumber.toLowerCase().includes(searchTerm) ||
                        sale.clientName.toLowerCase().includes(searchTerm) ||
                        sale.quotationNumber.toLowerCase().includes(searchTerm);

                    const matchesClient = !clientFilter || sale.clientId === clientFilter;

                    let matchesDate = true;
                    if (dateFilter) {
                        const saleDate = new Date(sale.date);
                        const today = new Date();
                        
                        if (dateFilter === 'specific' && specificDate) {
                            const selectedDate = new Date(specificDate);
                            selectedDate.setHours(0, 0, 0, 0);
                            saleDate.setHours(0, 0, 0, 0);
                            matchesDate = saleDate.getTime() === selectedDate.getTime();
                        } else if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                            matchesDate = checkDateFilter(sale.date, 'period', periodStartDate, periodEndDate);
                        } else {
                            matchesDate = checkDateFilter(sale.date, dateFilter);
                        }
                    }

                    return matchesSearch && matchesClient && matchesDate;
                });

                // Sort cash sales by date (newest first)
                filteredCashSales.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Clear existing table content
                tbody.innerHTML = '';

                // Handle empty state
                if (filteredCashSales.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center">No cash sales found</td>
                                </tr>
                    `;
                    return;
                }

                // Render cash sales
                filteredCashSales.forEach(sale => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${sale.cashSaleNumber}</td>
                        <td>${new Date(sale.date).toLocaleDateString()}</td>
                        <td>${sale.clientName}</td>
                        <td>KES ${sale.grandTotal.toFixed(2)}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="action-btn" onclick="viewCashSaleDetails(${sale.id})">
                                    <i class="fas fa-eye"></i>
                    </button>
                                <button class="action-btn" onclick="printCashSale(${sale.id})">
                                    <i class="fas fa-print"></i>
                    </button>
                                <button class="action-btn" onclick="downloadCashSale(${sale.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                `;
                });

                // Update client filter options
                updateCashSaleClientFilter();

            } catch (error) {
                console.error('Error rendering cash sales table:', error);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">Error loading cash sales</td></tr>';
            }
        }

        // Function to update client filter for cash sales
        function updateCashSaleClientFilter() {
            try {
                const select = document.getElementById('cashSaleClientFilter');
                if (!select) return;

                const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
                const clients = [...new Set(cashSales.map(sale => JSON.stringify({ 
                    id: sale.clientId, 
                    name: sale.clientName 
                })))].map(client => JSON.parse(client));

                // Sort clients by name
                clients.sort((a, b) => a.name.localeCompare(b.name));

                // Clear existing options
                select.innerHTML = '<option value="">All Clients</option>';

                // Add client options
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error updating cash sale client filter:', error);
            }
        }

        // Function to handle date filter changes for cash sales
        function handleDateFilter(type) {
            const dateFilter = document.getElementById(`${type}DateFilter`);
            const specificDate = document.getElementById(`${type}SpecificDate`);
            const periodStartDate = document.getElementById(`${type}PeriodStartDate`);
            const periodEndDate = document.getElementById(`${type}PeriodEndDate`);
            
            if (dateFilter.value === 'specific') {
                specificDate.style.display = 'block';
                periodStartDate.style.display = 'none';
                periodEndDate.style.display = 'none';
            } else if (dateFilter.value === 'period') {
                specificDate.style.display = 'none';
                periodStartDate.style.display = 'block';
                periodEndDate.style.display = 'block';
            } else {
                specificDate.style.display = 'none';
                periodStartDate.style.display = 'none';
                periodEndDate.style.display = 'none';
                specificDate.value = '';
                periodStartDate.value = '';
                periodEndDate.value = '';
            }
            
            if (type === 'cashSale') {
                renderCashSalesTable();
            }
        }

        // Function to export cash sales
        function exportCashSales() {
            try {
                const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
                if (cashSales.length === 0) {
                    alert('No cash sales to export');
                    return;
                }

                // Create CSV content
                const headers = ['Receipt #', 'Date', 'Client', 'Quotation #', 'Total Amount', 'Status'];
                const csvContent = [
                    headers.join(','),
                    ...cashSales.map(sale => [
                        sale.cashSaleNumber,
                        new Date(sale.date).toLocaleDateString(),
                        sale.clientName,
                        sale.quotationNumber,
                        sale.grandTotal.toFixed(2),
                        sale.status
                    ].join(','))
                ].join('\n');

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cash_sales_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

            } catch (error) {
                console.error('Error exporting cash sales:', error);
                alert('An error occurred while exporting cash sales');
            }
        }

        // Add to your DOMContentLoaded event listener
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing code ...
            
            // Initialize cash sales table
            renderCashSalesTable();
            updateCashSaleClientFilter();
        });

        // Add after the existing functions

function viewCashSaleDetails(id) {
    try {
        const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
        const cashSale = cashSales.find(sale => sale.id === id);
        
        if (!cashSale) {
            alert('Cash sale not found');
            return;
        }

        // Update modal classes for A4 layout
        const modal = document.getElementById('newQuotationModal');
        modal.classList.add('a4-modal');

        // Create A4 document layout
        document.querySelector('#newQuotationModal .modal-body').innerHTML = `
            <form id="newQuotationForm" class="a4-document">
                <!-- Company Header -->
                <div class="document-header">
                    <div class="company-name">Cabinet Master Styles And Finishes</div>
                    <div class="company-details">
                        <div>cabinetmasterstyles@gmail.com</div>
                        <div>Kamakis-Ruiru, Kenya</div>
                        <div>Phone No: 0729554475</div>
                    </div>
                </div>

                <!-- Document Info -->
                <div class="document-info">
                    <!-- Left Column -->
                    <div class="document-info-group">
                        <h3>CASH SALE RECEIPT</h3>
                        <div class="info-row">
                            <span class="info-label">Receipt #</span>
                            <input type="text" class="info-value" value="${cashSale.cashSaleNumber}" readonly>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Date</span>
                            <input type="text" class="info-value" value="${new Date(cashSale.date).toLocaleDateString()}" readonly>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Quotation #</span>
                            <input type="text" class="info-value" value="${cashSale.quotationNumber}" readonly>
                        </div>
                    </div>

                    <!-- Right Column -->
                    <div class="document-info-group">
                        <div class="info-row">
                            <span class="info-label">Client</span>
                            <input type="text" class="info-value" value="${cashSale.clientName}" readonly>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone No</span>
                            <input type="text" class="info-value" value="${cashSale.clientPhone}" readonly>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Location</span>
                            <input type="text" class="info-value" value="${cashSale.clientLocation}" readonly>
                        </div>
                    </div>
                </div>

                <!-- Items Section -->
                <div class="section-title">Items</div>
                <table class="quotation-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Units</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${[...cashSale.cabinetItems, ...cashSale.worktopItems,
                           ...(cashSale.includeAccessories ? cashSale.accessoriesItems : [])]
                          .map(item => `
                            <tr>
                                <td>${item.description}</td>
                                <td>${item.unit}</td>
                                <td>${item.quantity}</td>
                                <td>KES ${item.rate.toFixed(2)}</td>
                                <td>KES ${item.amount.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <!-- Totals Section -->
                <div class="totals-section">
                    <div class="total-row">
                        <span>Cabinets Total</span>
                        <span>KES ${cashSale.cabinetTotal.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>Worktop Total</span>
                        <span>KES ${cashSale.worktopTotal.toFixed(2)}</span>
                    </div>
                    ${cashSale.includeAccessories ? `
                        <div class="total-row">
                            <span>Accessories Total</span>
                            <span>KES ${cashSale.accessoriesTotal.toFixed(2)}</span>
                        </div>
                    ` : ''}
                    <div class="total-row grand-total">
                        <span>GRAND TOTAL</span>
                        <span>KES ${cashSale.grandTotal.toFixed(2)}</span>
                    </div>
                </div>

                <!-- Payment Details -->
                <div class="section-title" style="margin-top: 30px;">Payment Details</div>
                <table class="quotation-table">
                    <thead>
                        <tr>
                            <th>Payment Method</th>
                            <th>Amount</th>
                            <th>Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${cashSale.payments.map(payment => `
                            <tr>
                                <td>${payment.method}</td>
                                <td>KES ${payment.amount.toFixed(2)}</td>
                                <td>${new Date(payment.date).toLocaleDateString()}</td>
                                <td>${payment.status || 'Completed'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3"><strong>Total Paid</strong></td>
                            <td><strong>KES ${cashSale.totalPaid.toFixed(2)}</strong></td>
                        </tr>
                    </tfoot>
                </table>
            </form>
        `;

        // Update modal title and footer
        document.querySelector('#newQuotationModal .modal-title').textContent = 'Cash Sale Details';
        document.querySelector('#newQuotationModal .modal-footer').innerHTML = `
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-add" onclick="printCashSale(${id})">
                <i class="fas fa-print me-2"></i>Print
            </button>
            <button type="button" class="btn btn-add" onclick="downloadCashSale(${id})">
                <i class="fas fa-download me-2"></i>Download
            </button>
        `;

        // Show modal
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();

    } catch (error) {
        console.error('Error viewing cash sale details:', error);
        alert('An error occurred while viewing the cash sale details');
    }
}

// Add printCashSale function
function printCashSale(id) {
    try {
        const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
        const cashSale = cashSales.find(sale => sale.id === id);
        
        if (!cashSale) {
            alert('Cash sale not found');
            return;
        }

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>Cash Sale Receipt #${cashSale.cashSaleNumber}</title>
                <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
                <style>
                    @page {
                        size: A4;
                        margin: 0;
                    }
                    @media print {
                        .no-print {
                            display: none;
                        }
                        html, body {
                            width: 210mm;
                            height: 297mm;
                            margin: 0;
                            padding: 0;
                        }
                        .container {
                            width: 100%;
                            max-width: none;
                            margin: 0;
                            padding: 20mm;
                            background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png');
                            background-size: 100% 100%;
                            background-position: center;
                            background-repeat: no-repeat;
                            min-height: 100%;
                            -webkit-print-color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    }
                    html, body {
                        margin: 0;
                        padding: 0;
                        min-height: 100vh;
                    }
                    .container {
                        background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png');
                        background-size: 100% 100%;
                        background-position: center;
                        background-repeat: no-repeat;
                        min-height: 100vh;
                        padding: 40px;
                        margin: 0;
                        max-width: none;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 30px;
                        position: relative;
                        z-index: 1;
                    }
                    .company-name {
                        font-size: 24px;
                        font-weight: bold;
                    }
                    .receipt-details {
                        margin-bottom: 20px;
                        position: relative;
                        z-index: 1;
                    }
                    .table {
                        position: relative;
                        z-index: 1;
                        background-color: rgba(0, 0, 0, 0);
                    }
                    .table th {
                        background-color: #00000000 !important;
                    }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <div class="company-name">Cabinet Master Styles And Finishes</div>
                        <div>cabinetmasterstyles@gmail.com</div>
                        <div>Kamakis-Ruiru, Kenya</div>
                        <div>Phone: 0729554475</div>
                    </div>

                    <div class="receipt-details">
                        <div class="row">
                            <div class="col-6">
                                <h2>CASH SALE RECEIPT</h2>
                                <p><strong>Receipt #:</strong> ${cashSale.cashSaleNumber}</p>
                                <p><strong>Date:</strong> ${new Date(cashSale.date).toLocaleDateString()}</p>
                                <p><strong>Quotation #:</strong> ${cashSale.quotationNumber}</p>
                            </div>
                            <div class="col-6 text-end">
                                <p><strong>Client:</strong> ${cashSale.clientName}</p>
                                <p><strong>Phone:</strong> ${cashSale.clientPhone}</p>
                                <p><strong>Location:</strong> ${cashSale.clientLocation}</p>
                            </div>
                        </div>
                    </div>

                    <h4>Items</h4>
                    <table class="table table-bordered mb-4">
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Units</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${[...cashSale.cabinetItems, ...cashSale.worktopItems,
                               ...(cashSale.includeAccessories ? cashSale.accessoriesItems : [])]
                              .map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.unit}</td>
                                    <td>${item.quantity}</td>
                                    <td>KES ${item.rate.toFixed(2)}</td>
                                    <td>KES ${item.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="row">
                        <div class="col-6 offset-6">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong>Cabinets Total:</strong></td>
                                    <td class="text-end">KES ${cashSale.cabinetTotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td><strong>Worktop Total:</strong></td>
                                    <td class="text-end">KES ${cashSale.worktopTotal.toFixed(2)}</td>
                                </tr>
                                ${cashSale.includeAccessories ? `
                                    <tr>
                                        <td><strong>Accessories Total:</strong></td>
                                        <td class="text-end">KES ${cashSale.accessoriesTotal.toFixed(2)}</td>
                                    </tr>
                                ` : ''}
                                <tr class="border-top">
                                    <td><strong>GRAND TOTAL:</strong></td>
                                    <td class="text-end"><strong>KES ${cashSale.grandTotal.toFixed(2)}</strong></td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <h4 class="mt-4">Payment Details</h4>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Payment Method</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${cashSale.payments.map(payment => `
                                <tr>
                                    <td>${payment.method}</td>
                                    <td>KES ${payment.amount.toFixed(2)}</td>
                                    <td>${new Date(payment.date).toLocaleDateString()}</td>
                                    <td>${payment.status || 'Completed'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3"><strong>Total Paid</strong></td>
                                <td><strong>KES ${cashSale.totalPaid.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>

                    <div class="text-center mt-4 no-print">
                        <button onclick="window.print()" class="btn btn-primary">Print Receipt</button>
                    </div>
                </div>
            </body>
            </html>
        `);
    } catch (error) {
        console.error('Error printing cash sale:', error);
        alert('An error occurred while printing the cash sale');
    }
}

// Add downloadCashSale function
async function downloadCashSale(id) {
            try {
                const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
                const cashSale = cashSales.find(sale => sale.id === id);
                
                if (!cashSale) {
                    alert('Cash sale not found');
                    return;
                }

                const doc = new jsPDF();
                
        // Add background image
        await addBackgroundToPDF(doc);
        
        // Add header
        doc.setFontSize(20);
        doc.text('CASH SALE RECEIPT', 105, 20, { align: 'center' });
        
        // Add company details
        doc.setFontSize(12);
        doc.text('Cabinet Master Styles And Finishes', 105, 30, { align: 'center' });
        doc.text('cabinetmasterstyles@gmail.com', 105, 35, { align: 'center' });
        doc.text('Kamakis-Ruiru, Kenya', 105, 40, { align: 'center' });
        doc.text('Phone: 0729554475', 105, 45, { align: 'center' });

        // Add receipt details
        doc.text(`Receipt #: ${cashSale.cashSaleNumber}`, 20, 60);
        doc.text(`Date: ${new Date(cashSale.date).toLocaleDateString()}`, 20, 65);
        doc.text(`Quotation #: ${cashSale.quotationNumber}`, 20, 70);
        
        // Add client details
        doc.text('To:', 120, 60);
        doc.text(cashSale.clientName, 120, 65);
        doc.text(cashSale.clientPhone, 120, 70);
        doc.text(cashSale.clientLocation, 120, 75);

        // Add items table
        const itemHeaders = [['Description', 'Units', 'Quantity', 'Unit Price', 'Total']];
        const itemData = [...cashSale.cabinetItems, ...cashSale.worktopItems,
                         ...(cashSale.includeAccessories ? cashSale.accessoriesItems : [])]
            .map(item => [
                item.description,
                item.unit,
                item.quantity.toString(),
                `KES ${item.rate.toFixed(2)}`,
                `KES ${item.amount.toFixed(2)}`
            ]);

        doc.autoTable({
                textColor: [0, 0, 0],
            startY: 85,
            head: itemHeaders,
            body: itemData,
            theme: 'grid',
            styles: { fontSize: 10 },
            headStyles: { fillColor: [59, 130, 246] }
        });

        // Add totals
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.text(`Cabinets Total: KES ${cashSale.cabinetTotal.toFixed(2)}`, 120, finalY);
        doc.text(`Worktop Total: KES ${cashSale.worktopTotal.toFixed(2)}`, 120, finalY + 7);
        if (cashSale.includeAccessories) {
            doc.text(`Accessories Total: KES ${cashSale.accessoriesTotal.toFixed(2)}`, 120, finalY + 14);
        }
        doc.setFontSize(14);
        doc.text(`GRAND TOTAL: KES ${cashSale.grandTotal.toFixed(2)}`, 120, finalY + (cashSale.includeAccessories ? 24 : 17));

        // Add payment details
        doc.setFontSize(12);
        doc.text('Payment Details:', 20, finalY + 40);
        
        const paymentHeaders = [['Payment Method', 'Amount', 'Date', 'Status']];
        const paymentData = cashSale.payments.map(payment => [
            payment.method,
            `KES ${payment.amount.toFixed(2)}`,
            new Date(payment.date).toLocaleDateString(),
            payment.status || 'Completed'
        ]);
        paymentData.push(
            ['Total Paid', `KES ${cashSale.totalPaid.toFixed(2)}`, '', '']
        );

        doc.autoTable({
                textColor: [0, 0, 0],
            startY: finalY + 45,
            head: paymentHeaders,
            body: paymentData,
            theme: 'grid',
            styles: { fontSize: 10 },
            headStyles: { fillColor: [59, 130, 246] }
        });

        // Save the PDF
        doc.save(`cash_sale_${cashSale.cashSaleNumber}.pdf`);
            } catch (error) {
                console.error('Error downloading cash sale:', error);
                alert('An error occurred while downloading the cash sale');
            }
        }

        // Client Expenses Functions
        function showclientExpensesModal() {
            // Set default date to today
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            // Reset form and show modal
            document.getElementById('clientExpensesForm').reset();
            document.getElementById('expenseTotal').value = '0.00';
            
            // Reset expense items container to have one empty item
            const container = document.getElementById('expenseItemsContainer');
            container.innerHTML = `
                <div class="expense-item mb-3">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control border-0 shadow-sm description" 
                                placeholder="Description"
                                style="border-radius: 16px; height: 45px;"
                                required>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control border-0 shadow-sm unit" 
                                placeholder="Unit"
                                style="border-radius: 16px; height: 45px;"
                                required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control border-0 shadow-sm quantity" 
                                placeholder="Quantity" 
                                min="1"
                                style="border-radius: 16px; height: 45px;"
                                onchange="updateExpenseItemTotal(this)"
                                required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control border-0 shadow-sm rate" 
                                placeholder="Rate" 
                                step="0.01" 
                                min="0"
                                style="border-radius: 16px; height: 45px;"
                                onchange="updateExpenseItemTotal(this)"
                                required>
                        </div>
                        <div class="col-md-2">
                            <div class="d-flex align-items-center h-100">
                                <span class="amount me-2">0.00</span>
                                <button type="button" class="btn btn-sm btn-danger" 
                                    onclick="removeExpenseItem(this)"
                                    style="border-radius: 12px; width: 35px; height: 35px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('clientExpensesModal'));
            modal.show();
        }

        function addExpenseItem() {
            const container = document.getElementById('expenseItemsContainer');
            const newItem = container.children[0].cloneNode(true);
            
            // Clear input values
            newItem.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            newItem.querySelector('.amount').textContent = '0.00';
            
            container.appendChild(newItem);
        }

        function removeExpenseItem(button) {
            const container = document.getElementById('expenseItemsContainer');
            if (container.children.length > 1) {
                button.closest('.expense-item').remove();
                updateExpenseTotal();
            }
        }

        function updateExpenseItemTotal(input) {
            const item = input.closest('.expense-item');
            const quantity = parseFloat(item.querySelector('.quantity').value) || 0;
            const rate = parseFloat(item.querySelector('.rate').value) || 0;
            const amount = quantity * rate;
            
            item.querySelector('.amount').textContent = amount.toFixed(2);
            updateExpenseTotal();
        }

        function updateExpenseTotal() {
            const total = Array.from(document.getElementById('expenseItemsContainer').querySelectorAll('.amount'))
                .reduce((sum, element) => sum + (parseFloat(element.textContent) || 0), 0);
            document.getElementById('expenseTotal').value = total.toFixed(2);
        }

        // Initialize expense client search
        document.getElementById('expenseClientSearch')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const resultsContainer = document.getElementById('expenseClientSearchResults');
            
            if (searchTerm.length > 0) {
                const filteredClients = registeredEntities
                    .filter(entity => 
                        entity.type === 'client' && 
                        entity.name.toLowerCase().includes(searchTerm)
                    )
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

                if (filteredClients.length > 0) {
                    resultsContainer.innerHTML = filteredClients
                        .map(client => `
                            <div class="dropdown-item" onclick="selectExpenseClient('${client.id}', '${client.name}', '${client.phone}', '${client.location}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong><div class="small text-dark">${highlightMatch(client.name, searchTerm)}</div></strong>
                                        <div class="small text-dark">${client.location}</div>
                                    </div>
                                    <div class="small text-dark">${client.phone}</div>
                                </div>
                            </div>
                        `).join('');
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.innerHTML = '<div class="dropdown-item">No clients found</div>';
                    resultsContainer.style.display = 'block';
                }
            } else {
                resultsContainer.style.display = 'none';
            }
        });

        function selectExpenseClient(id, name, phone, location) {
            const clientSearch = document.getElementById('expenseClientSearch');
            clientSearch.value = name;
            clientSearch.dataset.clientId = id;
            clientSearch.dataset.clientPhone = phone;
            clientSearch.dataset.clientLocation = location;
            document.getElementById('expenseClientSearchResults').style.display = 'none';
            
            // Populate quotations for this client
            populateExpenseQuotations(id);
        }

        function populateExpenseQuotations(clientId) {
            const quotationSelect = document.getElementById('expenseQuotationSelect');
            if (!quotationSelect) return;

            // Get all quotations from localStorage
            const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
            
            // Filter and sort quotations for this client
            const clientQuotations = quotations
                .filter(q => q.clientId === clientId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            // Clear existing options
            quotationSelect.innerHTML = '<option value="">Select Quotation</option>';
            
            // Add quotation options
            clientQuotations.forEach(quotation => {
                const option = document.createElement('option');
                option.value = quotation.id;
                
                // Get total amount and payment info
                const totalAmount = quotation.grandTotal || 0;
                const totalPaid = quotation.totalPaid || 0;
                const balance = totalAmount - totalPaid;
                
                // Format the option text with amount and payment info
                option.textContent = `${quotation.quotationNumber} - KES ${totalAmount.toLocaleString()} (Paid: ${totalPaid.toLocaleString()}, Balance: ${balance.toLocaleString()}) - ${new Date(quotation.date).toLocaleDateString()}`;
                quotationSelect.appendChild(option);
            });

            // Select the latest quotation by default if available
            if (clientQuotations.length > 0) {
                quotationSelect.value = clientQuotations[0].id;
            }
        }

        function saveClientExpense() {
            const form = document.getElementById('clientExpensesForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const clientSearch = document.getElementById('expenseClientSearch');
            const quotationSelect = document.getElementById('expenseQuotationSelect');
            const expenseData = {
                id: Date.now(),
                date: document.getElementById('expenseDate').value,
                clientId: clientSearch.dataset.clientId,
                clientName: clientSearch.value,
                clientPhone: clientSearch.dataset.clientPhone,
                clientLocation: clientSearch.dataset.clientLocation,
                quotationId: quotationSelect.value,
                quotationNumber: quotationSelect.options[quotationSelect.selectedIndex].text,
                account: document.getElementById('expenseAccount').value,
                items: [],
                total: parseFloat(document.getElementById('expenseTotal').value) || 0,
                expenseNumber: generateExpenseNumber() // Added expense number generation
            };

            // Collect items
            document.querySelectorAll('.expense-item').forEach(item => {
                const description = item.querySelector('.description').value;
                const unit = item.querySelector('.unit').value;
                const quantity = parseFloat(item.querySelector('.quantity').value);
                const rate = parseFloat(item.querySelector('.rate').value);
                const amount = quantity * rate;

                if (description && unit && quantity && rate) {
                    expenseData.items.push({
                        description,
                        unit,
                        quantity,
                        rate,
                        amount
                    });
                }
            });

            // Save to localStorage
            let clientExpenses = JSON.parse(localStorage.getItem('clientExpenses') || '[]');
            clientExpenses.unshift(expenseData);
            localStorage.setItem('clientExpenses', JSON.stringify(clientExpenses));

            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('clientExpensesModal'));
            modal.hide();
            form.reset();

            // Refresh table
            renderClientExpensesTable();
        }

        function renderClientExpensesTable() {
            const tbody = document.getElementById('clientExpensesTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) return;

            const clientExpenses = JSON.parse(localStorage.getItem('clientExpenses') || '[]');
            tbody.innerHTML = '';

            clientExpenses.forEach(expense => {
                expense.items.forEach(item => {
                    const row = tbody.insertRow();
                    // Format the date consistently using YYYY-MM-DD format
                    const expenseDate = new Date(expense.date);
                    const formattedDate = expenseDate.toISOString().split('T')[0];
                    row.innerHTML = `
                        <td>${expense.expenseNumber || ''}</td>
                        <td data-date="${formattedDate}">${expenseDate.toLocaleDateString()}</td>
                        <td>${expense.clientName}</td>
                        <td>${item.description}</td>
                        <td>${item.unit}</td>
                        <td>${item.quantity}</td>
                        <td>KES ${item.rate.toFixed(2)}</td>
                        <td>KES ${item.amount.toFixed(2)}</td>
                        <td>${expense.account}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="action-btn" onclick="viewClientExpense(${expense.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="printClientExpense(${expense.id})">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="action-btn" onclick="downloadClientExpense(${expense.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });
            });

            // Update client filter options
            updateClientExpensesFilter();
        }

        function updateClientExpensesFilter() {
            const select = document.getElementById('clientExpensesTypeFilter');
            if (!select) return;

            const clientExpenses = JSON.parse(localStorage.getItem('clientExpenses') || '[]');
            const uniqueClients = [...new Set(clientExpenses.map(expense => expense.clientName))];
            
            select.innerHTML = '<option value="">All Clients</option>' +
                uniqueClients.map(client => `<option value="${client}">${client}</option>`).join('');
        }

        function filterClientExpenses() {
            const searchTerm = document.getElementById('clientExpensesSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('clientExpensesTypeFilter').value;
            const dateFilter = document.getElementById('clientExpensesDateFilter').value;
            const specificDate = document.getElementById('clientExpensesSpecificDate').value;
            const periodStartDate = document.getElementById('clientExpensesPeriodStartDate').value;
            const periodEndDate = document.getElementById('clientExpensesPeriodEndDate').value;
            const tbody = document.getElementById('clientExpensesTable').getElementsByTagName('tbody')[0];

            // If tbody is empty, re-render the table
            if (!tbody.children.length) {
                renderClientExpensesTable();
                return;
            }

            const rows = tbody.getElementsByTagName('tr');

            // Show all rows first
            Array.from(rows).forEach(row => row.style.display = '');

            // If no filters are active, return early
            if (!searchTerm && !categoryFilter && (dateFilter === 'all' || !dateFilter)) {
                return;
            }

            for (let row of rows) {
                const expenseNumber = row.cells[0].textContent.toLowerCase();
                const clientName = row.cells[2].textContent.toLowerCase();
                const description = row.cells[3].textContent.toLowerCase();
                const dateCell = row.cells[1];
                const rowDate = dateCell.getAttribute('data-date'); // Get the ISO date string
                let show = true;

                // Apply client filter
                if (categoryFilter && clientName !== categoryFilter.toLowerCase()) {
                    show = false;
                }

                // Apply search filter (now includes expense number)
                if (searchTerm && !description.includes(searchTerm) && !clientName.includes(searchTerm) && !expenseNumber.includes(searchTerm)) {
                    show = false;
                }

                // Apply date filter using the unified checkDateFilter function
                if (dateFilter && dateFilter !== 'all') {
                    if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                        show = show && checkDateFilter(rowDate, 'period', periodStartDate, periodEndDate);
                    } else if (dateFilter === 'specific' && specificDate) {
                        show = show && checkDateFilter(rowDate, 'specific', specificDate);
                    } else {
                        show = show && checkDateFilter(rowDate, dateFilter);
                    }
                }

                row.style.display = show ? '' : 'none';
            }
        }

        // Update the handleDateFilter function to ensure proper filtering
        function handleDateFilter(type) {
            const dateFilter = document.getElementById(`${type}DateFilter`);
            const specificDate = document.getElementById(`${type}SpecificDate`);
            const periodDates = document.getElementById(`${type}PeriodDates`);
            
            // Hide both specific date and period dates by default
            specificDate.style.display = 'none';
            if (periodDates) periodDates.style.display = 'none';
            
            if (dateFilter.value === 'specific') {
                specificDate.style.display = 'block';
                specificDate.value = '';
            } else if (dateFilter.value === 'period') {
                if (periodDates) {
                    periodDates.style.display = 'block';
                    document.getElementById(`${type}PeriodStartDate`).value = '';
                    document.getElementById(`${type}PeriodEndDate`).value = '';
                }
            } else {
                // Reset values when switching to other filters
                specificDate.value = '';
                if (periodDates) {
                    document.getElementById(`${type}PeriodStartDate`).value = '';
                    document.getElementById(`${type}PeriodEndDate`).value = '';
                }
            }
            
            // Trigger filter update
            if (type === 'clientExpenses') {
                filterClientExpenses();
            } else if (type === 'companyExpenses') {
                filterCompanyExpenses();
            }
        }

        // Initialize client expenses table on page load
        document.addEventListener('DOMContentLoaded', function() {
            renderClientExpensesTable();
        });

        function toggleExpenseClientDropdown() {
            const resultsContainer = document.getElementById('expenseClientSearchResults');
            const input = document.getElementById('expenseClientSearch');
            
            // Toggle dropdown visibility
            const isVisible = resultsContainer.style.display === 'block';
            resultsContainer.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                // Clear search input and show all clients when opening
                input.value = '';
                const filteredClients = registeredEntities
                    .filter(entity => entity.type === 'client')
                    .sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));

                resultsContainer.innerHTML = filteredClients
                    .map(client => `
                        <div class="dropdown-item" onclick="selectExpenseClient('${client.id}', '${client.name}', '${client.phone}', '${client.location}')">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong><div class="small text-dark">${client.name}</div></strong>
                                    <div class="small text-dark">${client.location}</div>
                                </div>
                                <div class="small text-dark">${client.phone}</div>
                            </div>
                        </div>
                    `).join('');
                input.focus();
            }
        }

        // Company Expenses Functions
        function showCompanyExpensesModal() {
            // Set default date to today
            document.getElementById('companyExpenseDate').valueAsDate = new Date();
            
            // Reset form and show modal
            document.getElementById('companyExpensesForm').reset();
            document.getElementById('companyExpenseTotal').value = '0.00';
            
            // Reset expense items container to have one empty item
            const container = document.getElementById('companyExpenseItemsContainer');
            container.innerHTML = `
                <div class="expense-item mb-3">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control border-0 shadow-sm description" 
                                placeholder="Description"
                                style="border-radius: 16px; height: 45px;"
                                required>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control border-0 shadow-sm unit" 
                                placeholder="Unit"
                                style="border-radius: 16px; height: 45px;"
                                required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control border-0 shadow-sm quantity" 
                                placeholder="Quantity" 
                                min="1"
                                style="border-radius: 16px; height: 45px;"
                                onchange="updateCompanyExpenseItemTotal(this)"
                                required>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control border-0 shadow-sm rate" 
                                placeholder="Rate" 
                                min="0"
                                style="border-radius: 16px; height: 45px;"
                                onchange="updateCompanyExpenseItemTotal(this)"
                                required>
                        </div>
                        <div class="col-md-2">
                            <div class="d-flex align-items-center h-100">
                                <span class="amount me-2">0.00</span>
                                <button type="button" class="btn btn-sm btn-danger" 
                                    onclick="removeCompanyExpenseItem(this)"
                                    style="border-radius: 12px; width: 35px; height: 35px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('companyExpensesModal'));
            modal.show();
        }

        function addCompanyExpenseItem() {
            const container = document.getElementById('companyExpenseItemsContainer');
            const newItem = container.children[0].cloneNode(true);
            
            // Clear input values
            newItem.querySelectorAll('input').forEach(input => {
                input.value = '';
            });
            newItem.querySelector('.amount').textContent = '0.00';
            
            container.appendChild(newItem);
        }

        function removeCompanyExpenseItem(button) {
            const container = document.getElementById('companyExpenseItemsContainer');
            if (container.children.length > 1) {
                button.closest('.expense-item').remove();
                updateCompanyExpenseTotal();
            }
        }

        function updateCompanyExpenseItemTotal(input) {
            const item = input.closest('.expense-item');
            const quantity = parseFloat(item.querySelector('.quantity').value) || 0;
            const rate = parseFloat(item.querySelector('.rate').value) || 0;
            const amount = quantity * rate;
            
            item.querySelector('.amount').textContent = amount.toFixed(2);
            updateCompanyExpenseTotal();
        }

        function updateCompanyExpenseTotal() {
            const total = Array.from(document.getElementById('companyExpenseItemsContainer').querySelectorAll('.amount'))
                .reduce((sum, element) => sum + (parseFloat(element.textContent) || 0), 0);
            document.getElementById('companyExpenseTotal').value = total.toFixed(2);
        }

        function saveCompanyExpense() {
            const form = document.getElementById('companyExpensesForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const expenseData = {
                id: Date.now(),
                date: document.getElementById('companyExpenseDate').value,
                department: document.getElementById('expenseDepartment').value,
                category: document.getElementById('expenseCategory').value,
                account: document.getElementById('companyExpenseAccount').value,
                items: [],
                total: parseFloat(document.getElementById('companyExpenseTotal').value) || 0,
                expenseNumber: generateExpenseNumber() // Added expense number generation
            };

            // Collect items
            document.querySelectorAll('#companyExpenseItemsContainer .expense-item').forEach(item => {
                const description = item.querySelector('.description').value;
                const unit = item.querySelector('.unit').value;
                const quantity = parseFloat(item.querySelector('.quantity').value);
                const rate = parseFloat(item.querySelector('.rate').value);
                const amount = quantity * rate;

                if (description && unit && quantity && rate) {
                    expenseData.items.push({
                        description,
                        unit,
                        quantity,
                        rate,
                        amount
                    });
                }
            });

            // Save to localStorage
            let companyExpenses = JSON.parse(localStorage.getItem('companyExpenses') || '[]');
            companyExpenses.unshift(expenseData);
            localStorage.setItem('companyExpenses', JSON.stringify(companyExpenses));

            // Close modal and reset form
            const modal = bootstrap.Modal.getInstance(document.getElementById('companyExpensesModal'));
            modal.hide();
            form.reset();

            // Refresh table
            renderCompanyExpensesTable();
        }

        function renderCompanyExpensesTable() {
            const tbody = document.getElementById('companyExpensesTable')?.getElementsByTagName('tbody')[0];
            if (!tbody) return;

            const companyExpenses = JSON.parse(localStorage.getItem('companyExpenses') || '[]');
            tbody.innerHTML = '';

            companyExpenses.forEach(expense => {
                expense.items.forEach(item => {
                    const row = tbody.insertRow();
                    // Format the date consistently using YYYY-MM-DD format
                    const expenseDate = new Date(expense.date);
                    const formattedDate = expenseDate.toISOString().split('T')[0];
                    row.innerHTML = `
                        <td>${expense.expenseNumber || ''}</td>
                        <td data-date="${formattedDate}">${expenseDate.toLocaleDateString()}</td>
                        <td>${expense.department}</td>
                        <td>${expense.category}</td>
                        <td>${item.description}</td>
                        <td>${item.unit}</td>
                        <td>${item.quantity}</td>
                        <td>KES ${item.rate.toFixed(2)}</td>
                        <td>KES ${item.amount.toFixed(2)}</td>
                        <td>${expense.account}</td>
                        <td>
                            <div class="d-flex gap-1">
                                <button class="action-btn" onclick="viewCompanyExpense(${expense.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="action-btn" onclick="printCompanyExpense(${expense.id})">
                                    <i class="fas fa-print"></i>
                                </button>
                                <button class="action-btn" onclick="downloadCompanyExpense(${expense.id})">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </td>
                    `;
                });
            });

            // Update category filter options
            updateCompanyExpensesFilter();
        }

        function updateCompanyExpensesFilter() {
            const select = document.getElementById('companyExpensesTypeFilter');
            if (!select) return;

            const companyExpenses = JSON.parse(localStorage.getItem('companyExpenses') || '[]');
            const uniqueCategories = [...new Set(companyExpenses.map(expense => expense.category))];
            
            select.innerHTML = '<option value="">All Categories</option>' +
                uniqueCategories.map(category => `<option value="${category}">${category}</option>`).join('');
        }

        function filterCompanyExpenses() {
            const searchTerm = document.getElementById('companyExpensesSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('companyExpensesTypeFilter').value;
            const dateFilter = document.getElementById('companyExpensesDateFilter').value;
            const specificDate = document.getElementById('companyExpensesSpecificDate').value;
            const periodStartDate = document.getElementById('companyExpensesPeriodStartDate').value;
            const periodEndDate = document.getElementById('companyExpensesPeriodEndDate').value;
            
            const rows = document.querySelectorAll('#companyExpensesTable tbody tr');
            
            rows.forEach(row => {
                const expense = row.children;
                const expenseNumber = expense[0].textContent.toLowerCase();
                const department = expense[2].textContent.toLowerCase();
                const category = expense[3].textContent.toLowerCase();
                const description = expense[4].textContent.toLowerCase();
                const date = expense[1].getAttribute('data-date'); // Format: YYYY-MM-DD
                
                // Search filter
                const matchesSearch = 
                    expenseNumber.includes(searchTerm) || 
                    department.includes(searchTerm) || 
                    category.includes(searchTerm) || 
                    description.includes(searchTerm);
                
                // Category filter
                const matchesCategory = !categoryFilter || category === categoryFilter.toLowerCase();
                
                // Date filter using the unified checkDateFilter function
                let matchesDate = true;
                if (dateFilter && dateFilter !== 'all') {
                    if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                        matchesDate = checkDateFilter(date, 'period', periodStartDate, periodEndDate);
                    } else if (dateFilter === 'specific' && specificDate) {
                        matchesDate = checkDateFilter(date, 'specific', specificDate);
                    } else {
                        matchesDate = checkDateFilter(date, dateFilter);
                    }
                }
                
                // Apply all filters
                row.style.display = (matchesSearch && matchesCategory && matchesDate) ? '' : 'none';
            });
        }

        // Initialize company expenses table when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            renderClientExpensesTable();
            renderCompanyExpensesTable();
        });

        // Purchase Management Functions
        let purchases = JSON.parse(localStorage.getItem('purchases') || '[]');

        // Sort purchases by date and order number (newest first)
        purchases.sort((a, b) => {
            // First sort by date (newest first)
            const dateComparison = new Date(b.date) - new Date(a.date);
            
            // If dates are the same, sort by purchase order number (newest first)
            if (dateComparison === 0 && a.orderNumber && b.orderNumber) {
                // Extract year and month from order numbers (assuming format POYYMMXXX)
                const aYear = a.orderNumber.substring(2, 4);
                const aMonth = a.orderNumber.substring(4, 6);
                const aNumber = parseInt(a.orderNumber.substring(6));
                
                const bYear = b.orderNumber.substring(2, 4);
                const bMonth = b.orderNumber.substring(4, 6);
                const bNumber = parseInt(b.orderNumber.substring(6));
                
                // Compare year
                if (bYear !== aYear) return bYear - aYear;
                
                // If year is the same, compare month
                if (bMonth !== aMonth) return bMonth - aMonth;
                
                // If month is the same, compare number
                return bNumber - aNumber;
            }
            
            return dateComparison;
        });

        let selectedSupplier = null;

        // Initialize purchase section
        document.addEventListener('DOMContentLoaded', function() {
            // Make sure registeredEntities is loaded before updating supplier filter
            loadRegisteredEntities();
            renderPurchasesTable();
            updateSupplierFilter();
            initializePurchaseModal();
        });

        function initializePurchaseModal() {
            // Generate purchase order number when modal opens
            const purchaseModal = document.getElementById('newPurchaseModal');
            purchaseModal.addEventListener('show.bs.modal', function() {
                document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('purchaseOrderNumber').value = generatePurchaseOrderNumber();
                document.getElementById('supplierSearch').value = '';
                selectedSupplier = null;
                
                // Clear any previous items
                const container = document.getElementById('purchaseItems');
                container.innerHTML = '';
                
                // Add first empty row
                addPurchaseItemRow();
                
                // Reset totals
                updatePurchaseTotals();

                // Initialize supplier search
                initializeSupplierSearch();

                // Initialize add item button
                document.getElementById('addPurchaseItemBtn').onclick = function() {
                    addPurchaseItemRow();
                };
            });
        }

        function updatePurchaseTotals() {
            let subtotal = 0;
            document.querySelectorAll('.purchase-item').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                subtotal += quantity * price;
            });
            
            const total = document.getElementById('total');
            total.value = subtotal.toFixed(2);
        }

        function removePurchaseItemRow(button) {
            const container = document.getElementById('purchaseItems');
            if (container.children.length > 1) {
                button.closest('.purchase-item').remove();
                updatePurchaseTotals();
            }
        }

        function initializeSupplierSearch() {
            const supplierSearch = document.getElementById('supplierSearch');
            const supplierList = document.querySelector('.supplier-list');
            const supplierDropdownBtn = document.querySelector('.supplier-dropdown');
            const supplierSearchContainer = document.querySelector('.supplier-search-container');
            
            function updateSupplierList(searchTerm = '') {
                const suppliers = registeredEntities.filter(entity => entity.type === 'supplier');
                const filteredSuppliers = searchTerm ? 
                    suppliers.filter(supplier => 
                        supplier.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        supplier.phone.includes(searchTerm)
                    ) : suppliers;

                supplierList.innerHTML = filteredSuppliers.map(supplier => `
                    <li>
                        <a class="dropdown-item" href="#" data-supplier-id="${supplier.id}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${supplier.name}</strong>
                                    <div class="small text-dark">${supplier.location || ''}</div>
                                </div>
                                <div class="small text-dark">${supplier.phone || ''}</div>
                            </div>
                        </a>
                    </li>
                `).join('') || '<li><span class="dropdown-item">No suppliers found</span></li>';
            }

            // Toggle dropdown on button click
            supplierDropdownBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                updateSupplierList(''); // Show all suppliers when clicking button
                
                // Force show the dropdown regardless of current state
                if (!supplierList.classList.contains('show')) {
                    supplierList.classList.add('show');
                } else {
                    supplierList.classList.remove('show');
                }
            });

            // Search input handler - separate from selection
            supplierSearch.addEventListener('input', function() {
                updateSupplierList(this.value);
                supplierList.classList.add('show');
            });

            // Handle supplier selection
            supplierList.addEventListener('click', function(e) {
                const item = e.target.closest('.dropdown-item');
                if (item && item.dataset.supplierId) {
                    const supplier = registeredEntities.find(entity => 
                        entity.type === 'supplier' && entity.id.toString() === item.dataset.supplierId
                    );
                    if (supplier) {
                        selectedSupplier = supplier;
                        supplierSearch.value = supplier.name;
                        supplierList.classList.remove('show');
                        e.preventDefault();
                    }
                }
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!supplierSearchContainer.contains(e.target)) {
                    supplierList.classList.remove('show');
                }
            });
        }

        // Update the updateSupplierFilter function
        function updateSupplierFilter() {
            // Get suppliers from registeredEntities instead of localStorage
            const suppliers = registeredEntities.filter(entity => entity.type === 'supplier');
            const select = document.getElementById('supplierFilter');
            if (!select) return;
            
            // Get unique supplier IDs from purchases
            const uniqueSupplierIds = [...new Set(purchases.map(p => p.supplier?.id).filter(id => id))];
            
            // Create options for each supplier
            select.innerHTML = '<option value="">All Suppliers</option>';
            
            // Sort suppliers by name before adding to dropdown
            const relevantSuppliers = suppliers
                .filter(supplier => uniqueSupplierIds.includes(supplier.id))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            // Add each supplier to the dropdown
            relevantSuppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                select.appendChild(option);
            });
            
            // Add change event listener to filter purchases when supplier is selected
            select.addEventListener('change', function() {
                renderPurchasesTable();
            });
        }
         

        function selectSupplier(supplierId) {
            // Find supplier in registeredEntities
            const supplier = registeredEntities.find(entity => 
                entity.type === 'supplier' && entity.id.toString() === supplierId
            );
            
            if (supplier) {
                selectedSupplier = supplier;
                const input = document.getElementById('supplierSearch');
                input.value = supplier.name;
                input.closest('.input-group').querySelector('.dropdown-menu').classList.remove('show');
            }
        }

        function initializePurchaseModal() {
            // Generate purchase order number when modal opens
            const purchaseModal = document.getElementById('newPurchaseModal');
            purchaseModal.addEventListener('show.bs.modal', function() {
                document.getElementById('purchaseDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('purchaseOrderNumber').value = generatePurchaseOrderNumber();
                document.getElementById('supplierSearch').value = '';
                selectedSupplier = null;
                
                // Clear any previous items
                const container = document.getElementById('purchaseItems');
                container.innerHTML = '';
                
                // Add first empty row
                addPurchaseItemRow();
                
                // Reset totals
                updatePurchaseTotals();

                // Initialize supplier search
                initializeSupplierSearch();

                // Initialize add item button
                document.getElementById('addPurchaseItemBtn').onclick = function() {
                    addPurchaseItemRow();
                };
            });
        }

        function updatePurchaseTotals() {
            let subtotal = 0;
            document.querySelectorAll('.purchase-item').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                subtotal += quantity * price;
            });
            
            const total = document.getElementById('total');
            total.value = subtotal.toFixed(2);
        }

        function removePurchaseItemRow(button) {
            const container = document.getElementById('purchaseItems');
            if (container.children.length > 1) {
                button.closest('.purchase-item').remove();
                updatePurchaseTotals();
            }
        }

        function addPurchaseItemRow() {
            const container = document.getElementById('purchaseItems');
            const newRow = document.createElement('div');
            newRow.className = 'row mb-2 purchase-item';
            newRow.innerHTML = `
                <div class="col-md-4" style="padding-left: 12px; padding-right: 6px;">
                    <div class="input-group shadow-sm item-search-container">
                        <input type="text" class="form-control border-0 item-search" 
                            placeholder="Search and select item..." required 
                            style="border-radius: 16px 0 0 16px; height: 45px;">
                        <button class="btn btn-outline-secondary border-0 item-dropdown dropdown-toggle" type="button" 
                            style="border-radius: 0 16px 16px 0; height: 45px; width: 20%; background: white; transition: all 0.3s ease;">
                            <i class="fas fa-box" style="color: #6c757d; transition: all 0.3s ease;"></i>
                        </button>
                        <ul class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto;">
                        </ul>
                    </div>
                </div>
                <div class="col-md-2"  style="padding-left: 3px; padding-right: 3px;">
                    <select class="form-select border-0 shadow-sm unit-select" required 
                        style="border-radius: 16px; height: 45px;">
                        <option value="">Units</option>
                    </select>
                </div>
                <div class="col-md-2"  style="padding-left: 3px; padding-right: 3px;">
                    <input type="number" class="form-control border-0 shadow-sm quantity-input" 
                        placeholder="Qty" min="1" required 
                        style="border-radius: 16px; height: 45px;"
                        onchange="updatePurchaseItemTotal(this)">
                </div>
                <div class="col-md-2" style="padding-left: 3px; padding-right: 3px;">
                    <input type="number" class="form-control border-0 shadow-sm price-input" 
                        placeholder="Unit Price" step="0.01" min="0" required 
                        style="border-radius: 16px; height: 45px;"
                        onchange="updatePurchaseItemTotal(this)">
                </div>
                <div class="col-md-2"  style="padding-left: 0px;">
                    <div class="d-flex align-items-center h-100">
                     <input type="number" class="form-control text-light text-center total-input" 
                        placeholder="0.00" readonly
                        style="border: none; height: 45px; overflow: visible; color: #ffffff; background-color: #00000000; padding: 0px;">
                    <button type="button" class="btn btn-danger btn-sm remove-item" 
                        onclick="removePurchaseItemRow(this)"
                        style="height: 45px; width: 45px; border-radius: 12px;">
                        <i class="fas fa-times"></i>
                    </button>
                    </div>
                </div>`;
            
            container.appendChild(newRow);

            // Initialize item search functionality
            const itemSearch = newRow.querySelector('.item-search');
            const itemDropdownBtn = newRow.querySelector('.dropdown-toggle');
            const dropdownMenu = newRow.querySelector('.dropdown-menu');
            const itemSearchContainer = newRow.querySelector('.item-search-container');

            function updateItemList(searchTerm = '') {
                const stock = JSON.parse(localStorage.getItem('stock') || '[]');
                const filteredItems = searchTerm ? 
                    stock.filter(item => 
                        (item.name && item.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                        (item.itemCode && item.itemCode.toLowerCase().includes(searchTerm.toLowerCase()))
                    ) : stock;

                dropdownMenu.innerHTML = filteredItems.map(item => `
                    <div class="dropdown-item py-2 px-3" style="cursor: pointer;" 
                        data-item-id="${item.id}"
                        data-item-name="${item.name || ''}"
                        data-item-unit="${item.unit || ''}"
                        data-item-price="${item.lastPurchasePrice || 0}"
                        data-current-stock="${item.currentStock || 0}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                <strong>${item.name || item.description}</strong>
                                <div class="small text-dark">${item.itemCode}</div>
                                    </div>
                            <div class="text-end">
                                <div>${item.currentStock || 0} ${item.unit}</div>
                                <div class="small text-dark">KES ${(item.lastPurchasePrice || 0).toFixed(2)}</div>
                                </div>
                        </div>
                    </div>
                `).join('') || '<div class="dropdown-item py-2">No items found</div>';

                // Add click handlers to dropdown items
                dropdownMenu.querySelectorAll('.dropdown-item[data-item-id]').forEach(item => {
                    item.addEventListener('mouseover', () => item.style.backgroundColor = '#f8f9fa');
                    item.addEventListener('mouseout', () => item.style.backgroundColor = '');
                    item.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Get the parent row containing all the inputs
                        const parentRow = this.closest('.dropdown-menu').closest('.row');
                        if (!parentRow) return;
                        
                        // Get all required inputs from the parent row
                        const itemSearch = parentRow.querySelector('.item-search');
                        const unitSelect = parentRow.querySelector('.unit-select');
                        const priceInput = parentRow.querySelector('.price-input');
                        
                        if (!itemSearch || !unitSelect || !priceInput) {
                            console.error('Required inputs not found in row');
                            return;
                        }
                        
                        // Get data from the clicked item
                        const itemData = this.dataset;
                        
                        // Update inputs
                        itemSearch.value = itemData.itemName;
                        
                        // Update unit select
                        unitSelect.innerHTML = `<option value="${itemData.itemUnit}">${itemData.itemUnit}</option>`;
                        unitSelect.value = itemData.itemUnit;
                        
                        // Update price
                        if (itemData.itemPrice) {
                            priceInput.value = parseFloat(itemData.itemPrice).toFixed(2);
                            updatePurchaseItemTotal(priceInput);
                        }
                        
                        // Store item data
                        itemSearch.dataset.itemId = itemData.itemId;
                        itemSearch.dataset.currentStock = itemData.currentStock;
                        
                        // Hide dropdown
                        dropdownMenu.classList.remove('show');
                    });
                });
            }

            // Toggle dropdown on button click
            itemDropdownBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const isVisible = dropdownMenu.classList.contains('show');
                updateItemList(''); // Show all items when clicking button
                dropdownMenu.classList.toggle('show');
            });

            // Search input handler - separate from selection
            itemSearch.addEventListener('input', function() {
                const searchTerm = this.value.trim();
                updateItemList(searchTerm);
                dropdownMenu.classList.add('show');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!itemSearchContainer.contains(e.target)) {
                    dropdownMenu.classList.remove('show');
                }
            });

            // Initialize with all items
            updateItemList('');
        }

        function updatePurchaseItemTotal(input) {
            const row = input.closest('.purchase-item');
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const total = quantity * price;
            row.querySelector('.total-input').value = total.toFixed(2);
            updatePurchaseTotals();
        }

        function updatePurchaseTotals() {
            let subtotal = 0;
            document.querySelectorAll('.purchase-item').forEach(row => {
                const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
                const price = parseFloat(row.querySelector('.price-input').value) || 0;
                subtotal += quantity * price;
            });
            
            const total = document.getElementById('total');
            total.value = subtotal.toFixed(2);
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                // Create toast container if it doesn't exist
                const container = document.createElement('div');
                container.id = 'toastContainer';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            toast.className = `toast align-items-center border-0 ${type === 'error' ? 'bg-danger' : 'bg-success'} text-white`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            document.getElementById('toastContainer').appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 3000 });
            bsToast.show();

            // Remove the toast after it's hidden
            toast.addEventListener('hidden.bs.toast', function() {
                toast.remove();
            });
        }

        function savePurchase() {
            if (!validatePurchaseForm()) return;
            
            const orderNumber = document.getElementById('purchaseOrderNumber').value;
            
            if (!confirmPurchaseOrderNumber(orderNumber)) {
                showToast('Error saving purchase. Please try again.', 'error');
                return;
            }
            
            const purchaseData = {
                id: generateUUID(),
                orderNumber: orderNumber,
                date: document.getElementById('purchaseDate').value,
                supplier: selectedSupplier,
                items: [],
                total: parseFloat(document.getElementById('total').value),
                createdAt: new Date().toISOString()
            };
            
            // Collect items
            document.querySelectorAll('.purchase-item').forEach(row => {
                const itemSearch = row.querySelector('.item-search');
                const item = {
                    itemId: itemSearch.dataset.itemId,
                    description: itemSearch.value,
                    unit: row.querySelector('.unit-select').value,
                    quantity: parseFloat(row.querySelector('.quantity-input').value),
                    rate: parseFloat(row.querySelector('.price-input').value),
                    amount: (parseFloat(row.querySelector('.quantity-input').value) || 0) * 
                           (parseFloat(row.querySelector('.price-input').value) || 0)
                };
                if (item.description && item.unit && item.quantity && item.rate) {
                    purchaseData.items.push(item);
                }
            });
            
            // Save to localStorage
            purchases.push(purchaseData);
            localStorage.setItem('purchases', JSON.stringify(purchases));
            
            // Update stock levels
            updateStockLevels(purchaseData);
            
            // Close modal and refresh table
            const modal = bootstrap.Modal.getInstance(document.getElementById('newPurchaseModal'));
            modal.hide();
            
            renderPurchasesTable();
            showToast('Purchase saved successfully!', 'success');
        }

        function validatePurchaseForm() {
            if (!selectedSupplier) {
                showToast('Please select a supplier', 'error');
                return false;
            }
            
            const items = document.querySelectorAll('.purchase-item');
            let hasValidItems = false;
            
            for (const row of items) {
                const description = row.querySelector('.item-search').value;
                const unit = row.querySelector('.unit-select').value;
                const quantity = parseFloat(row.querySelector('.quantity-input').value);
                const rate = parseFloat(row.querySelector('.price-input').value);
                
                if (description && unit && quantity > 0 && rate > 0) {
                    hasValidItems = true;
                } else if (description || unit || quantity > 0 || rate > 0) {
                    showToast('Please complete all item details', 'error');
                    return false;
                }
            }
            
            if (!hasValidItems) {
                showToast('Please add at least one item', 'error');
                return false;
            }
            
            return true;
        }


        function updateStockLevels(purchase) {
            let stock = JSON.parse(localStorage.getItem('stock') || '[]');
            
            purchase.items.forEach(item => {
                let existingItem;
                
                if (item.itemId) {
                    // If we have an itemId, find by id first
                    existingItem = stock.find(s => s.id === item.itemId);
                }
                
                if (!existingItem) {
                    // Fallback to finding by name/description if no id match
                    existingItem = stock.find(s => 
                        (s.name && s.name.toLowerCase() === item.description.toLowerCase()) ||
                        (s.description && s.description.toLowerCase() === item.description.toLowerCase()) &&
                    s.unit.toLowerCase() === item.unit.toLowerCase()
                );
                }
                
                if (existingItem) {
                    // Update existing item
                    existingItem.currentStock = (parseFloat(existingItem.currentStock) || 0) + item.quantity;
                    existingItem.lastPurchaseDate = purchase.date;
                    existingItem.lastPurchasePrice = item.rate;
                    
                    // Add to batches if batch tracking is used
                    if (Array.isArray(existingItem.batches)) {
                        existingItem.batches.push({
                            batchNo: generateBatchNumber(),
                            quantity: item.quantity,
                            rate: item.rate,
                            dateReceived: purchase.date
                        });
                    }
                } else {
                    // Create new item
                    stock.push({
                        id: generateUUID(),
                        itemCode: generateItemCode(),
                        name: item.description,
                        description: '',
                        category: 'Uncategorized',
                        unit: item.unit,
                        currentStock: item.quantity,
                        lastPurchaseDate: purchase.date,
                        lastPurchasePrice: item.rate,
                        minimumLevel: 0,
                        maximumLevel: item.quantity * 2,
                        batches: [{
                            batchNo: generateBatchNumber(),
                            quantity: item.quantity,
                            rate: item.rate,
                            dateReceived: purchase.date
                        }]
                    });
                }
            });
            
            localStorage.setItem('stock', JSON.stringify(stock));
            renderStockTable();
            updateStockItemDropdowns();
        }

        function generateBatchNumber() {
            const timestamp = new Date().getTime().toString();
            return `BATCH${timestamp.slice(-8)}`;
        }

function generateItemCode() {
    const lastNumbers = JSON.parse(localStorage.getItem('lastNumbers') || '{}');
    const currentYear = new Date().getFullYear().toString().slice(-2);
    const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
    
    // Initialize if not exists for current year/month
    if (!lastNumbers[currentYear]) {
        lastNumbers[currentYear] = {};
    }
    if (!lastNumbers[currentYear][currentMonth]) {
        lastNumbers[currentYear][currentMonth] = {
            ...lastNumbers[currentYear][currentMonth] || {},
            ITM: 0
        };
    }

    // Ensure ITM exists and is a number
    if (typeof lastNumbers[currentYear][currentMonth].ITM !== 'number') {
        lastNumbers[currentYear][currentMonth].ITM = 0;
    }
    
    // Increment the counter
    lastNumbers[currentYear][currentMonth].ITM++;
    const number = lastNumbers[currentYear][currentMonth].ITM;
    
    // Save the updated numbers
    localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
    
    // Return formatted item code, ensuring it starts with 001 if it's the first item
    return `ITM${currentYear}${currentMonth}${number.toString().padStart(3, '0')}`;
}


        // Stock Management Functions
function showNewStockItemModal() {
    document.getElementById('newStockItemForm').reset();
    const modal = new bootstrap.Modal(document.getElementById('newStockItemModal'));
    modal.show();
}

function saveStockItem() {
    // Get form values
    const name = document.getElementById('stockItemName').value.trim();
    const category = document.getElementById('stockItemCategory').value.trim();
    const unit = document.getElementById('stockItemUnit').value.trim();
    const minimumLevel = parseFloat(document.getElementById('stockItemMinLevel').value);
    const description = document.getElementById('stockItemDescription').value.trim();

    if (!name || !unit || isNaN(minimumLevel)) {
        alert('Please fill in all required fields');
        return;
    }

    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    
    const newItem = {
        id: Date.now().toString(),
        itemCode: generateItemCode(),
        name: name,
        category: category || 'Uncategorized',
        unit: unit,
        currentStock: 0,
        minimumLevel: minimumLevel,
        description: description,
        lastPurchasePrice: 0,
        status: 'outstock'
    };

    stock.push(newItem);
    localStorage.setItem('stock', JSON.stringify(stock));

    // Close modal and refresh table
    const modal = bootstrap.Modal.getInstance(document.getElementById('newStockItemModal'));
    modal.hide();

    // Clear form
    document.getElementById('newStockItemForm').reset();

    // Update UI
    renderStockTable();
    updateStockSummaryCards();

    // Show success message
    alert('Stock item added successfully');
}

function showInStockModal() {
    // Set default date to today
    document.getElementById('stockInDate').valueAsDate = new Date();
    
    // Reset form
    document.getElementById('inStockForm').reset();
    document.getElementById('stockInTotal').value = '0.00';
    
    // Reset items container
    const container = document.getElementById('stockInItemsContainer');
    container.innerHTML = `
        <div class="stock-item mb-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <select class="form-select border-0 shadow-sm item-select" 
                        style="border-radius: 16px; height: 45px;"
                        required>
                        <option value="">Select Item</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control border-0 shadow-sm quantity" 
                        placeholder="Quantity" 
                        min="1"
                        style="border-radius: 16px; height: 45px;"
                        onchange="updateStockInItemTotal(this)"
                        required>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control border-0 shadow-sm rate" 
                        placeholder="Rate" 
                        min="0"
                        style="border-radius: 16px; height: 45px;"
                        onchange="updateStockInItemTotal(this)"
                        required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control border-0 shadow-sm batch" 
                        placeholder="Batch No."
                        style="border-radius: 16px; height: 45px;"
                        required>
                </div>
                <div class="col-md-2">
                    <div class="d-flex align-items-center h-100">
                        <span class="amount me-2">0.00</span>
                        <button type="button" class="btn btn-sm btn-danger" 
                            onclick="removeStockInItem(this)"
                            style="border-radius: 12px; width: 35px; height: 35px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Update stock items dropdown
    updateStockItemDropdowns();
    
    const modal = new bootstrap.Modal(document.getElementById('inStockModal'));
    modal.show();
}

function showOutStockModal() {
    // Set default date to today
    document.getElementById('stockOutDate').valueAsDate = new Date();
    
    // Reset form
    document.getElementById('outStockForm').reset();
    
    // Reset items container
    const container = document.getElementById('stockOutItemsContainer');
    container.innerHTML = `
        <div class="stock-item mb-3">
            <div class="row g-3">
                <div class="col-md-4">
                    <select class="form-select border-0 shadow-sm item-select" 
                        style="border-radius: 16px; height: 45px;"
                        onchange="updateAvailableQuantity(this)"
                        required>
                        <option value="">Select Item</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select border-0 shadow-sm batch-select" 
                        style="border-radius: 16px; height: 45px;"
                        required>
                        <option value="">Select Batch</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="number" class="form-control border-0 shadow-sm quantity" 
                        placeholder="Quantity" 
                        min="1"
                        style="border-radius: 16px; height: 45px;"
                        required>
                </div>
                <div class="col-md-2">
                    <input type="text" class="form-control border-0 shadow-sm purpose" 
                        placeholder="Purpose"
                        style="border-radius: 16px; height: 45px;"
                        required>
                </div>
                <div class="col-md-2">
                    <div class="d-flex align-items-center h-100">
                        <span class="available-qty me-2">0</span>
                        <button type="button" class="btn btn-sm btn-danger" 
                            onclick="removeStockOutItem(this)"
                            style="border-radius: 12px; width: 35px; height: 35px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Update stock items dropdown
    updateStockItemDropdowns();
    
    const modal = new bootstrap.Modal(document.getElementById('outStockModal'));
    modal.show();
}

function addStockInItem() {
    const container = document.getElementById('stockInItemsContainer');
    const newItem = container.children[0].cloneNode(true);
    
    // Clear input values
    newItem.querySelectorAll('input').forEach(input => {
        input.value = '';
    });
    newItem.querySelector('.amount').textContent = '0.00';
    
    // Update stock items dropdown
    updateStockItemDropdowns(newItem.querySelector('.item-select'));
    
    container.appendChild(newItem);
}

function addStockOutItem() {
    const container = document.getElementById('stockOutItemsContainer');
    const newItem = container.children[0].cloneNode(true);
    
    // Clear input values
    newItem.querySelectorAll('input').forEach(input => {
        input.value = '';
    });
    newItem.querySelector('.available-qty').textContent = '0';
    
    // Update stock items dropdown
    updateStockItemDropdowns(newItem.querySelector('.item-select'));
    
    container.appendChild(newItem);
}

function removeStockInItem(button) {
    const container = document.getElementById('stockInItemsContainer');
    if (container.children.length > 1) {
        button.closest('.stock-item').remove();
        updateStockInTotal();
    }
}

function removeStockOutItem(button) {
    const container = document.getElementById('stockOutItemsContainer');
    if (container.children.length > 1) {
        button.closest('.stock-item').remove();
    }
}

function updateStockInItemTotal(input) {
    const item = input.closest('.stock-item');
    const quantity = parseFloat(item.querySelector('.quantity').value) || 0;
    const rate = parseFloat(item.querySelector('.rate').value) || 0;
    const amount = quantity * rate;
    
    item.querySelector('.amount').textContent = amount.toFixed(2);
    updateStockInTotal();
}

function updateStockInTotal() {
    const total = Array.from(document.querySelectorAll('#stockInItemsContainer .amount'))
        .reduce((sum, element) => sum + (parseFloat(element.textContent) || 0), 0);
    document.getElementById('stockInTotal').value = total.toFixed(2);
}

function updateAvailableQuantity(select) {
    const item = select.closest('.stock-item');
    const batchSelect = item.querySelector('.batch-select');
    const availableQty = item.querySelector('.available-qty');
    
    // Clear batch select
    batchSelect.innerHTML = '<option value="">Select Batch</option>';
    availableQty.textContent = '0';
    
    if (!select.value) return;
    
    // Get stock item
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const selectedItem = stock.find(item => item.id === parseInt(select.value));
    
    if (selectedItem && selectedItem.batches) {
        // Add batch options
        selectedItem.batches.forEach(batch => {
            if (batch.quantity > 0) {
                batchSelect.innerHTML += `
                    <option value="${batch.batchNo}" data-qty="${batch.quantity}">
                        ${batch.batchNo} (${batch.quantity} ${selectedItem.unit})
                    </option>
                `;
            }
        });
        
        // Update available quantity when batch is selected
        batchSelect.onchange = function() {
            const selectedOption = this.options[this.selectedIndex];
            availableQty.textContent = selectedOption.dataset.qty || '0';
        };
    }
}

function updateStockItemDropdowns(select) {
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const dropdowns = select ? [select] : document.querySelectorAll('.item-select');
    
    dropdowns.forEach(dropdown => {
        const currentValue = dropdown.value;
        dropdown.innerHTML = '<option value="">Select Item</option>';
        
        stock.forEach(item => {
            dropdown.innerHTML += `
                <option value="${item.id}" 
                    data-unit="${item.unit}"
                    data-current-stock="${item.currentStock || 0}"
                    data-last-price="${item.lastPurchasePrice || 0}">
                    ${item.name || item.description} (${item.currentStock || 0} ${item.unit})
                </option>
            `;
        });

        // If there was a previously selected value, try to restore it
        if (currentValue) {
            dropdown.value = currentValue;
        }
    });
}

function toggleSupplierDropdown() {
    const resultsContainer = document.getElementById('supplierSearchResults');
    const input = document.getElementById('stockInSupplierSearch');
    
    // Toggle dropdown visibility
    const isVisible = resultsContainer.style.display === 'block';
    resultsContainer.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
        // Clear search input and show all suppliers
        input.value = '';
        const suppliers = JSON.parse(localStorage.getItem('suppliers') || '[]');
        
        resultsContainer.innerHTML = suppliers
            .map(supplier => `
                <div class="dropdown-item" onclick="selectSupplier('${supplier.id}', '${supplier.name}', '${supplier.phone}', '${supplier.location}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong><div class="small text-dark">${supplier.name}</div></strong>
                            <div class="small text-dark">${supplier.location}</div>
                        </div>
                        <div class="small text-dark">${supplier.phone}</div>
                    </div>
                </div>
            `).join('') || '<div class="dropdown-item">No suppliers found</div>';
        input.focus();
    }
}

function selectSupplier(id, name, phone, location) {
    const input = document.getElementById('stockInSupplierSearch');
    input.value = name;
    input.dataset.supplierId = id;
    input.dataset.supplierPhone = phone;
    input.dataset.supplierLocation = location;
    document.getElementById('supplierSearchResults').style.display = 'none';
}

function saveStockIn() {
    const form = document.getElementById('inStockForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const supplierSearch = document.getElementById('stockInSupplierSearch');
    const stockInData = {
        id: Date.now(),
        date: document.getElementById('stockInDate').value,
        supplierId: supplierSearch.dataset.supplierId,
        supplierName: supplierSearch.value,
        supplierPhone: supplierSearch.dataset.supplierPhone,
        supplierLocation: supplierSearch.dataset.supplierLocation,
        items: [],
        total: parseFloat(document.getElementById('stockInTotal').value) || 0
    };

    // Collect items and update stock
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    document.querySelectorAll('#stockInItemsContainer .stock-item').forEach(item => {
        const itemSelect = item.querySelector('.item-select');
        const quantity = parseFloat(item.querySelector('.quantity').value);
        const rate = parseFloat(item.querySelector('.rate').value);
        const batchNo = item.querySelector('.batch').value;
        const amount = quantity * rate;

        if (itemSelect.value && quantity && rate && batchNo) {
            const stockItem = stock.find(si => si.id === parseInt(itemSelect.value));
            if (stockItem) {
                // Add batch
                stockItem.batches.push({
                    batchNo,
                    quantity,
                    rate,
                    dateReceived: stockInData.date
                });
                // Update current stock
                stockItem.currentStock += quantity;

                stockInData.items.push({
                    itemId: stockItem.id,
                    itemName: stockItem.name,
                    unit: stockItem.unit,
                    quantity,
                    rate,
                    amount,
                    batchNo
                });
            }
        }
    });

    // Save stock in record
    let stockInRecords = JSON.parse(localStorage.getItem('stockInRecords') || '[]');
    stockInRecords.unshift(stockInData);
    localStorage.setItem('stockInRecords', JSON.stringify(stockInRecords));

    // Update stock items
    localStorage.setItem('stock', JSON.stringify(stock));

    // Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('inStockModal'));
    modal.hide();
    form.reset();

    // Refresh stock items in dropdowns
    updateStockItemDropdowns();
}

function saveStockOut() {
    const form = document.getElementById('outStockForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const stockOutData = {
        id: Date.now(),
        date: document.getElementById('stockOutDate').value,
        department: document.getElementById('stockOutDepartment').value,
        items: []
    };

    // Collect items and update stock
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    let isValid = true;

    document.querySelectorAll('#stockOutItemsContainer .stock-item').forEach(item => {
        const itemSelect = item.querySelector('.item-select');
        const batchSelect = item.querySelector('.batch-select');
        const quantity = parseFloat(item.querySelector('.quantity').value);
        const purpose = item.querySelector('.purpose').value;
        const availableQty = parseFloat(item.querySelector('.available-qty').textContent);

        if (itemSelect.value && batchSelect.value && quantity && purpose) {
            if (quantity > availableQty) {
                alert('Cannot issue more than available quantity');
                isValid = false;
                return;
            }

            const stockItem = stock.find(si => si.id === parseInt(itemSelect.value));
            if (stockItem) {
                // Update batch quantity
                const batch = stockItem.batches.find(b => b.batchNo === batchSelect.value);
                if (batch) {
                    batch.quantity -= quantity;
                    stockItem.currentStock -= quantity;

                    stockOutData.items.push({
                        itemId: stockItem.id,
                        itemName: stockItem.name,
                        unit: stockItem.unit,
                        quantity,
                        batchNo: batch.batchNo,
                        purpose
                    });
                }
            }
        }
    });

    if (!isValid) return;

    // Save stock out record
    let stockOutRecords = JSON.parse(localStorage.getItem('stockOutRecords') || '[]');
    stockOutRecords.unshift(stockOutData);
    localStorage.setItem('stockOutRecords', JSON.stringify(stockOutRecords));

    // Update stock items
    localStorage.setItem('stock', JSON.stringify(stock));

    // Close modal and reset form
    const modal = bootstrap.Modal.getInstance(document.getElementById('outStockModal'));
    modal.hide();
    form.reset();

    // Refresh stock items in dropdowns
    updateStockItemDropdowns();
}

// Initialize stock management when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    renderClientExpensesTable();
    renderCompanyExpensesTable();
    updateStockItemDropdowns();
    renderStockTable(); // This will also call updateStockSummaryCards which calls updateCategoryFilterDropdown
});

function renderStockTable() {
    const tbody = document.querySelector('#stockTable tbody');
    const thead = document.querySelector('#stockTable thead');
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    
    // Update table headers
    thead.innerHTML = `
        <tr>
            <th>Item Code</th>
            <th>Product</th>
            <th>Category</th>
            <th>Quantity</th>
            <th>Unit Price</th>
            <th>Total Value</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    `;
    
    tbody.innerHTML = '';
    
    stock.forEach(item => {
        const totalValue = item.currentStock * item.lastPurchasePrice;
        
        // Determine status based on quantity levels
        let status = '';
        let statusStyle = '';
        
        if (!item.currentStock || item.currentStock <= 0) {
            status = 'Out of Stock';
            statusStyle = 'background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        } else if (item.minimumLevel !== undefined && item.currentStock <= item.minimumLevel) {
            status = 'Low Stock';
            statusStyle = 'background-color: #fff3e0; color: #f57c00; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        } else {
            status = 'In Stock';
            statusStyle = 'background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.itemCode || 'No Code'}</td>
            <td>
                <div class="position-relative" style="cursor: help;" data-bs-toggle="tooltip" data-bs-placement="top" title="${item.description || 'No description available'}">
                    ${item.name || item.description}
                </div>
            </td>
            <td>${item.category || 'Uncategorized'}</td>
            <td>${(item.currentStock || 0).toFixed(2)} ${item.unit}</td>
            <td>KES ${(item.lastPurchasePrice || 0).toFixed(2)}</td>
            <td>KES ${totalValue.toFixed(2)}</td>
            <td><span style="${statusStyle}">${status}</span></td>
            <td>
                <div class="d-flex gap-2">
                    <button class="btn action-btn" onclick="updateStockStatus('${item.id}', 'instock')" title="Stock In Entry">
                        <i class="fas fa-box"></i>
                    </button>
                    <button class="btn action-btn" onclick="openStockOutModal('${item.id}')" title="Stock Out Entry">
                        <i class="fas fa-box-open"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Initialize tooltips
    const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // Update summary cards
    updateStockSummaryCards();
}

function updateStockSummaryCards() {
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    
    // Calculate totals
    const totalItems = stock.length;
    let inStockCount = 0;
    let lowStockCount = 0;
    let outOfStockCount = 0;
    
    stock.forEach(item => {
        if (!item.currentStock || item.currentStock <= 0) {
            outOfStockCount++;
        } else if (item.minimumLevel !== undefined && item.currentStock <= item.minimumLevel) {
            lowStockCount++;
        } else {
            inStockCount++;
        }
    });
    
    // Update the cards
    document.getElementById('totalItems').textContent = totalItems;
    document.getElementById('inStock').textContent = inStockCount;
    document.getElementById('lowStock').textContent = lowStockCount;
    document.getElementById('outOfStock').textContent = outOfStockCount;
    
    // Remove active class from all cards
    document.querySelectorAll('.stock-summary-card').forEach(card => {
        card.classList.remove('active');
    });
    
    // Update category filter dropdown
    updateCategoryFilterDropdown();
}

// Function to populate category filter dropdown with unique categories
function updateCategoryFilterDropdown() {
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const categoryFilter = document.getElementById('stockCategoryFilter');
    
    if (!categoryFilter) {
        console.error('Category filter dropdown not found');
        return;
    }
    
    // Get unique categories
    const categories = [...new Set(stock.map(item => item.category || 'Uncategorized'))];
    
    // Save current selection if any
    const currentSelection = categoryFilter.value;
    
    // Clear dropdown except for the first option
    categoryFilter.innerHTML = '<option value="">All Categories</option>';
    
    // Add categories to dropdown
    categories.sort().forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
    });
    
    // Restore selection if it still exists
    if (currentSelection && categories.includes(currentSelection)) {
        categoryFilter.value = currentSelection;
    }
}

// Helper function to determine stock status
function getStockStatus(quantity, reorderLevel) {
    if (quantity <= 0) {
        return 'outOfStock';
    } else if (quantity <= reorderLevel) {
        return 'lowStock';
    } else {
        return 'inStock';
    }
}

function filterByCard(status) {
    console.log('Filtering by status:', status); // Debug log
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const tbody = document.querySelector('#stockTable tbody');
    
    if (!tbody) {
        console.error('Stock table body not found');
        return;
    }
    
    // Add active class to clicked card and remove from others
    document.querySelectorAll('.stock-summary-card').forEach(card => {
        if (card.getAttribute('onclick').includes(status)) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
    
    // Clear the table body
    tbody.innerHTML = '';
    
    // Filter the stock based on status
    const filteredStock = stock.filter(item => {
        const currentStock = parseFloat(item.currentStock) || 0;
        const minimumLevel = parseFloat(item.minimumLevel);
        
        switch(status) {
            case 'all':
                return true;
            case 'inStock':
                return currentStock > 0 && (!minimumLevel || currentStock > minimumLevel);
            case 'lowStock':
                return currentStock > 0 && !isNaN(minimumLevel) && currentStock <= minimumLevel;
            case 'outOfStock':
                return currentStock <= 0;
            default:
                return true;
        }
    });
    
    // Render the filtered items
    filteredStock.forEach(item => {
        const totalValue = (item.currentStock || 0) * (item.lastPurchasePrice || 0);
        
        // Fix: Call getStockStatus with the correct parameters
        const stockStatus = getStockStatus(item.currentStock || 0, item.minimumLevel || 0);
        
        // Determine status text and style based on the stock status
        let itemStatus = '';
        let statusStyle = '';
        
        if (stockStatus === 'outOfStock') {
            itemStatus = 'Out of Stock';
            statusStyle = 'background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        } else if (stockStatus === 'lowStock') {
            itemStatus = 'Low Stock';
            statusStyle = 'background-color: #fff3e0; color: #f57c00; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        } else {
            itemStatus = 'In Stock';
            statusStyle = 'background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.itemCode || 'No Code'}</td>
            <td>
                <div class="position-relative" style="cursor: help;" data-bs-toggle="tooltip" data-bs-placement="top" title="${item.description || 'No description available'}">
                    ${item.name || item.description}
                </div>
            </td>
            <td>${item.category || 'Uncategorized'}</td>
            <td>${(item.currentStock || 0).toFixed(2)} ${item.unit}</td>
            <td>KES ${(item.lastPurchasePrice || 0).toFixed(2)}</td>
            <td>KES ${totalValue.toFixed(2)}</td>
            <td><span style="${statusStyle}">${itemStatus}</span></td>
            <td>
                <div class="d-flex gap-2">
                    <button class="btn action-btn" onclick="updateStockStatus('${item.id}', 'instock')" title="Stock In Entry">
                        <i class="fas fa-box"></i>
                    </button>
                    <button class="btn action-btn" onclick="openStockOutModal('${item.id}')" title="Stock Out Entry">
                        <i class="fas fa-box-open"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Initialize tooltips
    const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

function filterStock() {
    const searchTerm = document.getElementById('stockSearch').value.toLowerCase();
    const categoryFilter = document.getElementById('stockCategoryFilter').value;
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const tbody = document.querySelector('#stockTable tbody');
    
    tbody.innerHTML = '';
    
    stock.filter(item => {
        // Check if item matches search term
        const matchesSearch = 
            (item.name && item.name.toLowerCase().includes(searchTerm)) ||
            (item.description && item.description.toLowerCase().includes(searchTerm)) ||
            (item.itemCode || '').toLowerCase().includes(searchTerm) ||
            (item.category || '').toLowerCase().includes(searchTerm);
        
        // Check if item matches selected category
        const matchesCategory = !categoryFilter || (item.category || 'Uncategorized') === categoryFilter;
        
        // Return true if item matches both search term and category
        return matchesSearch && matchesCategory;
    }).forEach(item => {
        const totalValue = item.currentStock * item.lastPurchasePrice;
        
        // Fix: Call getStockStatus with the correct parameters
        const stockStatus = getStockStatus(item.currentStock || 0, item.minimumLevel || 0);
        
        // Determine status text and style based on the stock status
        let status = '';
        let statusStyle = '';
        
        if (stockStatus === 'outOfStock') {
            status = 'Out of Stock';
            statusStyle = 'background-color: #ffebee; color: #d32f2f; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        } else if (stockStatus === 'lowStock') {
            status = 'Low Stock';
            statusStyle = 'background-color: #fff3e0; color: #f57c00; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        } else {
            status = 'In Stock';
            statusStyle = 'background-color: #e8f5e9; color: #2e7d32; border-radius: 50px; padding: 6px 16px; font-weight: 500; font-size: 0.875rem;';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${item.itemCode || 'No Code'}</td>
            <td>
                <div class="position-relative" style="cursor: help;" data-bs-toggle="tooltip" data-bs-placement="top" title="${item.description || 'No description available'}">
                    ${item.name || item.description}
                </div>
            </td>
            <td>${item.category || 'Uncategorized'}</td>
            <td>${(item.currentStock || 0).toFixed(2)} ${item.unit}</td>
            <td>KES ${(item.lastPurchasePrice || 0).toFixed(2)}</td>
            <td>KES ${totalValue.toFixed(2)}</td>
            <td><span style="${statusStyle}">${status}</span></td>
            <td>
                <div class="d-flex gap-2">
                    <button class="btn action-btn" onclick="updateStockStatus('${item.id}', 'instock')" title="Stock In Entry">
                        <i class="fas fa-box"></i>
                    </button>
                    <button class="btn action-btn" onclick="openStockOutModal('${item.id}')" title="Stock Out Entry">
                        <i class="fas fa-box-open"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    // Initialize tooltips
    const tooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltips.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
}

// Add this line to initialize the stock table when the page loads
document.addEventListener('DOMContentLoaded', renderStockTable);

function renderPurchasesTable() {
    const tbody = document.querySelector('#purchasesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    // Get filtered purchases
    const filteredPurchases = filterPurchases();
    
    // Update the UI to show the filtered results count
    const countElement = document.getElementById('purchasesCount');
    if (countElement) {
        countElement.textContent = filteredPurchases.length;
    }
    
    // Render the filtered purchases
    filteredPurchases.forEach(purchase => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${purchase.orderNumber}</td>
            <td>${new Date(purchase.date).toLocaleDateString()}</td>
            <td>${purchase.supplier?.name || ''}</td>
            <td>${purchase.items.length} items</td>
            <td>KES ${purchase.total.toFixed(2)}</td>
            <td>
                <div class="d-flex gap-1">
                    <button class="action-btn" onclick="viewPurchaseDetails('${purchase.id}')">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="action-btn" onclick="printPurchase('${purchase.id}')">
                        <i class="fas fa-print"></i>
                    </button>
                    <button class="action-btn" onclick="downloadPurchase('${purchase.id}')">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Add the downloadPurchase function
function downloadPurchase(purchaseId) {
    const purchase = purchases.find(p => p.id === purchaseId);
    if (!purchase) return;
    
    // Create the purchase document content
    const content = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Purchase Order - ${purchase.orderNumber}</title>
            <style>
                body { font-family: Arial, sans-serif; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { padding: 10px; border: 1px solid #ddd; }
                th { background-color: #f5f5f5; }
            </style>
        </head>
        <body>
            <h1>Purchase Order</h1>
            <div>
                <p><strong>Order Number:</strong> ${purchase.orderNumber}</p>
                <p><strong>Date:</strong> ${new Date(purchase.date).toLocaleDateString()}</p>
                <p><strong>Supplier:</strong> ${purchase.supplier?.name || ''}</p>
            </div>
            
            <table>
                <thead>
                    <tr>
                        <th>Item Description</th>
                        <th>Unit</th>
                        <th>Quantity</th>
                        <th>Rate</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${purchase.items.map(item => `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.unit}</td>
                            <td>${item.quantity}</td>
                            <td>KES ${item.rate.toFixed(2)}</td>
                            <td>KES ${item.amount.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" style="text-align: right;"><strong>Subtotal:</strong></td>
                        <td>KES ${purchase.subtotal.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="text-align: right;"><strong>VAT (16%):</strong></td>
                        <td>KES ${purchase.vat.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="4" style="text-align: right;"><strong>Total:</strong></td>
                        <td>KES ${purchase.total.toFixed(2)}</td>
                    </tr>
                </tfoot>
            </table>
        </body>
        </html>
    `;
    
    // Create a Blob and download
    const blob = new Blob([content], { type: 'text/html' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `purchase_order_${purchase.orderNumber}.html`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function filterPurchases() {
    const searchTerm = document.getElementById('purchaseSearch').value?.toLowerCase() || '';
    const supplierFilter = document.getElementById('supplierFilter').value;
    const dateFilter = document.getElementById('purchasesDateFilter').value;
    const specificDate = document.getElementById('purchasesSpecificDate').value;
    const periodStartDate = document.getElementById('purchasesPeriodStartDate').value;
    const periodEndDate = document.getElementById('purchasesPeriodEndDate').value;
    
    console.log('Filtering purchases with:', {
        searchTerm,
        supplierFilter,
        dateFilter,
        specificDate,
        periodStartDate,
        periodEndDate
    });
    
    // Filter the purchases
    const filteredPurchases = purchases.filter(purchase => {
        // Search filter - check order number, supplier name, and item descriptions
        const matchesSearch = !searchTerm || (
            (purchase.orderNumber?.toLowerCase() || '').includes(searchTerm) ||
            (purchase.supplier?.name?.toLowerCase() || '').includes(searchTerm) ||
            (purchase.items || []).some(item => (item?.description?.toLowerCase() || '').includes(searchTerm))
        );
            
        // Supplier filter - convert both to strings for comparison
        const matchesSupplier = !supplierFilter || purchase.supplier?.id?.toString() === supplierFilter.toString();
        
        // Date filter using the unified checkDateFilter function
        let matchesDate = true;
        if (dateFilter && dateFilter !== '') {
            if (dateFilter === 'period' && periodStartDate && periodEndDate) {
                matchesDate = checkDateFilter(purchase.date, 'period', periodStartDate, periodEndDate);
                console.log(`Period filter for ${purchase.orderNumber}: ${matchesDate}`, {
                    purchaseDate: purchase.date,
                    periodStartDate,
                    periodEndDate
                });
            } else if (dateFilter === 'specific' && specificDate) {
                matchesDate = checkDateFilter(purchase.date, 'specific', specificDate);
                console.log(`Specific date filter for ${purchase.orderNumber}: ${matchesDate}`, {
                    purchaseDate: purchase.date,
                    specificDate
                });
            } else {
                matchesDate = checkDateFilter(purchase.date, dateFilter);
                console.log(`Standard date filter (${dateFilter}) for ${purchase.orderNumber}: ${matchesDate}`, {
                    purchaseDate: purchase.date
                });
            }
        }
        
        // For debugging
        if (supplierFilter && purchase.supplier) {
            console.log(`Comparing supplier: ${purchase.supplier.id} (${typeof purchase.supplier.id}) with filter: ${supplierFilter} (${typeof supplierFilter})`);
            console.log(`Match result: ${matchesSupplier}`);
        }
        
        return matchesSearch && matchesSupplier && matchesDate;
    }).sort((a, b) => {
        // First sort by date (newest first)
        const dateComparison = new Date(b.date) - new Date(a.date);
        
        // If dates are the same, sort by purchase order number (newest first)
        if (dateComparison === 0 && a.orderNumber && b.orderNumber) {
            // Extract year and month from order numbers (assuming format POYYMMXXX)
            const aYear = a.orderNumber.substring(2, 4);
            const aMonth = a.orderNumber.substring(4, 6);
            const aNumber = parseInt(a.orderNumber.substring(6));
            
            const bYear = b.orderNumber.substring(2, 4);
            const bMonth = b.orderNumber.substring(4, 6);
            const bNumber = parseInt(b.orderNumber.substring(6));
            
            // Compare year
            if (bYear !== aYear) return bYear - aYear;
            
            // If year is the same, compare month
            if (bMonth !== aMonth) return bMonth - aMonth;
            
            // If month is the same, compare number
            return bNumber - aNumber;
        }
        
        return dateComparison;
    });
    
    console.log(`Filtered ${purchases.length} purchases down to ${filteredPurchases.length}`);
    
    return filteredPurchases;
}

function updateSupplierFilter() {
    // Get suppliers from registeredEntities instead of localStorage
    const suppliers = registeredEntities.filter(entity => entity.type === 'supplier');
    const select = document.getElementById('supplierFilter');
    if (!select) return;
    
    // Get unique supplier IDs from purchases
    const uniqueSupplierIds = [...new Set(purchases.map(p => p.supplier?.id).filter(id => id))];
    
    // Create options for each supplier
    select.innerHTML = '<option value="">All Suppliers</option>';
    
    // Sort suppliers by name before adding to dropdown
    const relevantSuppliers = suppliers
        .filter(supplier => uniqueSupplierIds.includes(supplier.id))
        .sort((a, b) => a.name.localeCompare(b.name));
    
    // Add each supplier to the dropdown
    relevantSuppliers.forEach(supplier => {
        const option = document.createElement('option');
        option.value = supplier.id;
        option.textContent = supplier.name;
        select.appendChild(option);
    });
    
    // Add change event listener to filter purchases when supplier is selected
    select.addEventListener('change', function() {
        renderPurchasesTable();
    });
}

function generatePurchaseOrderNumber() {
    const lastNumbers = JSON.parse(localStorage.getItem('lastNumbers') || '{}');
    const currentYear = new Date().getFullYear().toString().slice(-2);
    const currentMonth = (new Date().getMonth() + 1).toString().padStart(2, '0');
    
    // Initialize the structure if it doesn't exist
    if (!lastNumbers[currentYear]) {
        lastNumbers[currentYear] = {};
    }
    if (!lastNumbers[currentYear][currentMonth]) {
        lastNumbers[currentYear][currentMonth] = { 
            PO: 0,
            lastGenerated: {
                PO: null
            }
        };
    }
    
    // Get existing purchases for this month to ensure proper sequence
    const existingPurchases = purchases.filter(p => {
        if (!p.orderNumber || typeof p.orderNumber !== 'string') return false;
        if (p.orderNumber.length < 8) return false; // Minimum length for "POYYMMXXX"
        
        try {
            const purchaseYear = p.orderNumber.substring(2, 4);
            const purchaseMonth = p.orderNumber.substring(4, 6);
            return purchaseYear === currentYear && purchaseMonth === currentMonth;
        } catch (error) {
            return false;
        }
    });
    
    // Sort existing purchases by their number to find the highest one
    const existingNumbers = existingPurchases
        .map(p => parseInt(p.orderNumber.slice(-3)))
        .filter(num => !isNaN(num))
        .sort((a, b) => b - a);
    
    // Get the highest number or 0 if none exist
    const highestNumber = existingNumbers.length > 0 ? existingNumbers[0] : 0;
    
    // Generate next number
    const nextNumber = highestNumber + 1;
    
    // Format the new number
    const formattedNumber = `PO${currentYear}${currentMonth}${nextNumber.toString().padStart(3, '0')}`;
    
    // Store as last generated
    lastNumbers[currentYear][currentMonth].lastGenerated.PO = formattedNumber;
    lastNumbers[currentYear][currentMonth].PO = nextNumber;
    localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
    
    return formattedNumber;
}

function confirmPurchaseOrderNumber(orderNumber) {
    const lastNumbers = JSON.parse(localStorage.getItem('lastNumbers') || '{}');
    const year = orderNumber.slice(2, 4);
    const month = orderNumber.slice(4, 6);
    
    if (lastNumbers[year]?.[month]?.lastGenerated?.PO === orderNumber) {
        // Get the number part of the order number
        const currentNumber = parseInt(orderNumber.slice(-3));
        
        // Update the counter to match the current number
        lastNumbers[year][month].PO = currentNumber;
        localStorage.setItem('lastNumbers', JSON.stringify(lastNumbers));
        return true;
    }
    return false;
}

function viewPurchaseDetails(purchaseId) {
    const purchase = purchases.find(p => p.id === purchaseId);
    if (!purchase) return;
    
    const modal = document.getElementById('purchaseDetailsModal');
    modal.querySelector('.modal-body').innerHTML = `
        <div class="mb-4">
            <h6 class="mb-2">Purchase Details</h6>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Order Number:</strong> ${purchase.orderNumber}</p>
                    <p><strong>Date:</strong> ${new Date(purchase.date).toLocaleDateString()}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Supplier:</strong> ${purchase.supplier?.name || ''}</p>
                    <p><strong>Contact:</strong> ${purchase.supplier?.phone || ''}</p>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Item Description</th>
                        <th>Unit</th>
                        <th>Quantity</th>
                        <th>Rate</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    ${purchase.items.map(item => `
                        <tr>
                            <td>${item.description}</td>
                            <td>${item.unit}</td>
                            <td>${item.quantity}</td>
                            <td>KES ${item.rate.toFixed(2)}</td>
                            <td>KES ${item.amount.toFixed(2)}</td>
                        </tr>
                    `).join('')}
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                        <td>KES ${purchase.subtotal.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end"><strong>VAT (16%):</strong></td>
                        <td>KES ${purchase.vat.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <td colspan="4" class="text-end"><strong>Total:</strong></td>
                        <td><strong>KES ${purchase.total.toFixed(2)}</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function printPurchase(purchaseId) {
    const purchase = purchases.find(p => p.id === purchaseId);
    if (!purchase) return;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Purchase Order - ${purchase.orderNumber}</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
            <style>
                body { padding: 20px; }
                @media print {
                    .no-print { display: none; }
                    @page { margin: 0.5cm; }
                }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="row mb-4">
                    <div class="col">
                        <h2>Purchase Order</h2>
                        <p><strong>Order Number:</strong> ${purchase.orderNumber}</p>
                        <p><strong>Date:</strong> ${new Date(purchase.date).toLocaleDateString()}</p>
                    </div>
                    <div class="col text-end">
                        <h3>Cabinet Master Styles And Finishes</h3>
                        <p>Kamakis-Ruiru, Kenya</p>
                        <p>Phone: 0729554475</p>
                    </div>
                </div>
                
                <div class="row mb-4">
                    <div class="col">
                        <h5>Supplier Details</h5>
                        <p><strong>${purchase.supplier?.name || ''}</strong></p>
                        <p>${purchase.supplier?.location || ''}</p>
                        <p>Phone: ${purchase.supplier?.phone || ''}</p>
                    </div>
                </div>
                
                <div class="table-responsive mb-4">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Item Description</th>
                                <th>Unit</th>
                                <th>Quantity</th>
                                <th>Rate</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${purchase.items.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.unit}</td>
                                    <td>${item.quantity}</td>
                                    <td>KES ${item.rate.toFixed(2)}</td>
                                    <td>KES ${item.amount.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                                <td>KES ${purchase.subtotal.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="text-end"><strong>VAT (16%):</strong></td>
                                <td>KES ${purchase.vat.toFixed(2)}</td>
                            </tr>
                            <tr>
                                <td colspan="4" class="text-end"><strong>Total:</strong></td>
                                <td><strong>KES ${purchase.total.toFixed(2)}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="row mb-4">
                    <div class="col">
                        <h5>Terms and Conditions</h5>
                        <ol>
                            <li>Please supply the goods as per the specifications mentioned above.</li>
                            <li>Any variations must be communicated and approved before delivery.</li>
                            <li>Delivery must be accompanied by a delivery note and invoice.</li>
                            <li>Payment will be processed as per agreed terms.</li>
                        </ol>
                    </div>
                </div>
                
                <div class="row mt-5">
                    <div class="col">
                        <p>Authorized By: _______________________</p>
                        <p>Date: _______________________</p>
                    </div>
                    <div class="col">
                        <p>Received By: _______________________</p>
                        <p>Date: _______________________</p>
                    </div>
                </div>
                
                <div class="no-print text-center mt-4">
                    <button onclick="window.print()" class="btn btn-primary">Print</button>
                </div>
            </div>
        </body>
        </html>
    `);
    printWindow.document.close();
}

function deletePurchase(purchaseId) {
    if (!confirm('Are you sure you want to delete this purchase? This action cannot be undone.')) return;
    
    purchases = purchases.filter(p => p.id !== purchaseId);
    localStorage.setItem('purchases', JSON.stringify(purchases));
    renderPurchasesTable();
    showToast('Purchase deleted successfully!', 'success');
}

function exportPurchaseReport() {
    const filteredPurchases = filterPurchases();
    
    // Create CSV content
    const csvContent = [
        ['Order Number', 'Date', 'Supplier', 'Items', 'Subtotal', 'VAT', 'Total'],
        ...filteredPurchases.map(p => [
            p.orderNumber,
            new Date(p.date).toLocaleDateString(),
            p.supplier?.name || '',
            p.items.length,
            p.subtotal.toFixed(2),
            p.vat.toFixed(2),
            p.total.toFixed(2)
        ])
    ].map(row => row.join(',')).join('\n');
    
    // Create and trigger download
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `purchases_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}

function updateStockStatus(itemId, status) {
    if (status === 'instock') {
        openStockInModal(itemId);
    } else if (status === 'outstock') {
        openStockOutModal(itemId);
    }
}

function openStockInModal(itemId) {
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const item = stock.find(i => i.id === itemId);
    
    if (!item) {
        alert('Item not found');
        return;
    }

    // Populate the modal fields
    document.getElementById('stockInItemId').value = itemId;
    document.getElementById('stockInProductName').value = item.name;
    document.getElementById('stockInCurrentQty').value = `${item.currentStock} ${item.unit}`;
    document.getElementById('stockInQuantity').value = '';
    document.getElementById('stockInPrice').value = item.lastPurchasePrice || '';
    document.getElementById('stockInBatch').value = '';

    // Apply global modal styling
    const inputs = document.querySelectorAll('#stockInModal .form-control');
    inputs.forEach(input => {
        input.classList.add('border-0', 'shadow-sm');
        input.style.borderRadius = '16px';
        input.style.height = input.tagName.toLowerCase() === 'textarea' ? 'auto' : '45px';
    });

    // Show the modal
    const stockInModal = new bootstrap.Modal(document.getElementById('stockInModal'));
    stockInModal.show();
}

function submitStockIn() {
    const itemId = document.getElementById('stockInItemId').value;
    const quantity = parseFloat(document.getElementById('stockInQuantity').value);
    const price = parseFloat(document.getElementById('stockInPrice').value);
    const batchNumber = document.getElementById('stockInBatch').value.trim();

    if (!quantity || !price) {
        alert('Please fill in all required fields');
        return;
    }

    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const itemIndex = stock.findIndex(i => i.id === itemId);
    
    if (itemIndex === -1) {
        alert('Item not found');
        return;
    }

    // Update stock quantity and price
    const previousStock = stock[itemIndex].currentStock;
    stock[itemIndex].currentStock = parseFloat(stock[itemIndex].currentStock || 0) + quantity;
    stock[itemIndex].lastPurchasePrice = price;
    
    // Update status based on new quantity and minimum level
    const currentStock = stock[itemIndex].currentStock;
    const minimumLevel = parseFloat(stock[itemIndex].minimumLevel);
    
    if (currentStock <= 0) {
        stock[itemIndex].status = 'outstock';
    } else if (!isNaN(minimumLevel) && currentStock <= minimumLevel) {
        stock[itemIndex].status = 'lowstock';
    } else {
        stock[itemIndex].status = 'instock';
    }

    // Save stock in transaction history
    const stockInHistory = JSON.parse(localStorage.getItem('stockInHistory') || '[]');
    stockInHistory.push({
        id: Date.now().toString(),
        itemId: itemId,
        itemName: stock[itemIndex].name,
        quantity: quantity,
        unit: stock[itemIndex].unit,
        price: price,
        batchNumber: batchNumber,
        date: new Date().toISOString(),
        previousStock: previousStock,
        newStock: currentStock,
        status: stock[itemIndex].status
    });

    // Save both stock and history
    localStorage.setItem('stock', JSON.stringify(stock));
    localStorage.setItem('stockInHistory', JSON.stringify(stockInHistory));

    // Close modal and refresh table
    const modal = bootstrap.Modal.getInstance(document.getElementById('stockInModal'));
    modal.hide();
    
    // Update the UI
    renderStockTable();
    updateStockSummaryCards();

    // Show success message
    alert('Stock in entry recorded successfully');
}

function openStockOutModal(itemId) {
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const item = stock.find(i => i.id === itemId);
    
    if (!item) {
        alert('Item not found');
        return;
    }

    // Populate the modal fields
    document.getElementById('stockOutItemId').value = itemId;
    document.getElementById('stockOutProductName').value = item.name;
    document.getElementById('stockOutCurrentQty').value = `${item.currentStock} ${item.unit}`;
    document.getElementById('stockOutQuantity').value = '';
    document.getElementById('stockOutReason').value = '';

    // Apply global modal styling
    const inputs = document.querySelectorAll('#stockOutModal .form-control');
    inputs.forEach(input => {
        input.classList.add('border-0', 'shadow-sm');
        input.style.borderRadius = '16px';
        input.style.height = input.tagName.toLowerCase() === 'textarea' ? 'auto' : '45px';
    });

    // Show the modal
    const stockOutModal = new bootstrap.Modal(document.getElementById('stockOutModal'));
    stockOutModal.show();
}

function submitStockOut() {
    const itemId = document.getElementById('stockOutItemId').value;
    const quantity = parseFloat(document.getElementById('stockOutQuantity').value);
    const reason = document.getElementById('stockOutReason').value.trim();

    if (!quantity || !reason) {
        alert('Please fill in all required fields');
        return;
    }

    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    const itemIndex = stock.findIndex(i => i.id === itemId);
    
    if (itemIndex === -1) {
        alert('Item not found');
        return;
    }

    if (quantity > stock[itemIndex].currentStock) {
        alert('Cannot remove more than current stock quantity');
        return;
    }

    // Update stock quantity
    const previousStock = stock[itemIndex].currentStock;
    stock[itemIndex].currentStock = parseFloat(stock[itemIndex].currentStock) - quantity;
    
    // Update status based on new quantity and minimum level
    const currentStock = stock[itemIndex].currentStock;
    const minimumLevel = parseFloat(stock[itemIndex].minimumLevel);
    
    if (currentStock <= 0) {
        stock[itemIndex].status = 'outstock';
    } else if (!isNaN(minimumLevel) && currentStock <= minimumLevel) {
        stock[itemIndex].status = 'lowstock';
    } else {
        stock[itemIndex].status = 'instock';
    }

    // Save stock out transaction history
    const stockOutHistory = JSON.parse(localStorage.getItem('stockOutHistory') || '[]');
    stockOutHistory.push({
        id: Date.now().toString(),
        itemId: itemId,
        itemName: stock[itemIndex].name,
        quantity: quantity,
        unit: stock[itemIndex].unit,
        reason: reason,
        date: new Date().toISOString(),
        previousStock: previousStock,
        newStock: currentStock,
        status: stock[itemIndex].status
    });

    // Save both stock and history
    localStorage.setItem('stock', JSON.stringify(stock));
    localStorage.setItem('stockOutHistory', JSON.stringify(stockOutHistory));

    // Close modal and refresh table
    const modal = bootstrap.Modal.getInstance(document.getElementById('stockOutModal'));
    modal.hide();
    
    // Update the UI
    renderStockTable();
    updateStockSummaryCards();

    // Show success message
    alert('Stock out entry recorded successfully');
}

// Add this line to initialize the stock table when the page loads
document.addEventListener('DOMContentLoaded', renderStockTable);

// Function to export stock to PDF
function exportStockToPDF() {
            // Get the current filtered stock data
            const stock = JSON.parse(localStorage.getItem('stock') || '[]');
            const searchTerm = document.getElementById('stockSearch')?.value || '';
            const categoryFilter = document.getElementById('stockCategoryFilter')?.value || '';
            
            // Filter the stock based on current filters
            const filteredStock = stock.filter(item => {
                // Apply search filter
                const matchesSearch = searchTerm === '' || 
                    (item.name && item.name.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (item.itemCode && item.itemCode.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm.toLowerCase()));
                
                // Apply category filter
                const matchesCategory = categoryFilter === '' || categoryFilter === 'all' || 
                    (item.category && item.category === categoryFilter);
                
                return matchesSearch && matchesCategory;
            });
            
            // Create a new jsPDF instance
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            // Define A4 dimensions in mm
            const pageWidth = 210;
            const pageHeight = 297;
            
            // Add background image to first page
            const firstPageBackground = 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/OFFICIALQUOTATIONCABINETMASTERTEMPLATE-AlNKxy1S9NznusS3MnOATsMB3sfSoq.png';
            const otherPagesBackground = 'https://hebbkx1anhila5yf.public.blob.vercel-storage.com/BLANKCABINETMASTERTEMPLATE-wXezK3xTao2XdSwlFR55BijsFNsCdW.jpeg';
            
            // Function to add background to pages
            const addBackgroundToPage = (pageNum) => {
                const bgImage = pageNum === 1 ? firstPageBackground : otherPagesBackground;
                doc.setPage(pageNum);
                
                // Save the current graphics state
                doc.saveGraphicsState();
                
                // Set a lower z-index for the background by using a separate graphics state
                doc.setGState(new doc.GState({ opacity: 1.0 }));
                doc.addImage(bgImage, 'JPEG', 0, 0, pageWidth, pageHeight);
                
                // Restore the graphics state for text to be on top
                doc.restoreGraphicsState();
            };
            
            // Add background to first page
            addBackgroundToPage(1);
            
            // Set font styles
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            // Explicitly set text color to ensure visibility
            doc.setTextColor(0, 0, 0);
            
            // Start content below company details (approximately 70mm from top)
            const startY = 70;
            
            // Add title
            doc.text('STOCK INVENTORY REPORT', pageWidth / 2, startY, { align: 'center' });
            
            // Add date
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            const today = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            doc.text(`Generated on: ${today}`, pageWidth / 2, startY + 8, { align: 'center' });
            
            // Add summary information
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('Inventory Summary:', 20, startY + 20);

            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            // Get summary counts
            const totalItems = filteredStock.length;
            let inStockCount = 0;
            let lowStockCount = 0;
            let outOfStockCount = 0;
            let totalValue = 0;
            
            filteredStock.forEach(item => {
                const currentStock = parseFloat(item.currentStock) || 0;
                const minimumLevel = parseFloat(item.minimumLevel) || 0;
                const itemValue = currentStock * (parseFloat(item.lastPurchasePrice) || 0);
                totalValue += itemValue;
                
                if (currentStock <= 0) {
                    outOfStockCount++;
                } else if (currentStock <= minimumLevel) {
                    lowStockCount++;
                } else {
                    inStockCount++;
                }
            });
            
            // Add summary stats
            const summaryY = startY + 25;
            doc.text(`Total Items: ${totalItems}`, 25, summaryY);
            doc.text(`In Stock: ${inStockCount}`, 25, summaryY + 6);
            doc.text(`Low Stock: ${lowStockCount}`, 25, summaryY + 12);
            doc.text(`Out of Stock: ${outOfStockCount}`, 25, summaryY + 18);
            doc.text(`Total Inventory Value: KES ${totalValue.toFixed(2)}`, 25, summaryY + 24);
            
            // Add filter information if any
            if (searchTerm || (categoryFilter && categoryFilter !== 'all')) {
                doc.setFontSize(9);
                doc.text('Applied Filters:', 20, summaryY + 34);
                let filterText = '';
                if (searchTerm) {
                    filterText += `Search: "${searchTerm}" `;
                }
                if (categoryFilter && categoryFilter !== 'all') {
                    filterText += `Category: ${categoryFilter}`;
                }
                doc.text(filterText, 25, summaryY + 39);
            }
            
            // Table headers
            const headers = [
                { header: 'Item Code', dataKey: 'itemCode' },
                { header: 'Product', dataKey: 'name' },
                { header: 'Category', dataKey: 'category' },
                { header: 'Quantity', dataKey: 'quantity' },
                { header: 'Unit Price', dataKey: 'price' },
                { header: 'Total Value', dataKey: 'value' },
                { header: 'Status', dataKey: 'status' }
            ];
            
            // Prepare table data
            const tableData = filteredStock.map(item => {
                const currentStock = parseFloat(item.currentStock) || 0;
                const minimumLevel = parseFloat(item.minimumLevel) || 0;
                const price = parseFloat(item.lastPurchasePrice) || 0;
                const value = currentStock * price;
                
                let status = 'In Stock';
                if (currentStock <= 0) {
                    status = 'Out of Stock';
                } else if (currentStock <= minimumLevel) {
                    status = 'Low Stock';
                }
                
                return {
                    itemCode: item.itemCode || 'No Code',
                    name: item.name || item.description || 'No Name',
                    category: item.category || 'Uncategorized',
                    quantity: `${currentStock.toFixed(2)} ${item.unit || ''}`,
                    price: `KES ${price.toFixed(2)}`,
                    value: `KES ${value.toFixed(2)}`,
                    status: status
                };
            });
            
            // Add the table starting below the summary
            doc.autoTable({
                textColor: [0, 0, 0],
                startY: summaryY + 45,
                head: [headers.map(h => h.header)],
                body: tableData.map(item => headers.map(h => item[h.dataKey])),
                theme: 'grid',
                headStyles: {
                    fillColor: [50, 50, 50],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                    textColor: [0, 0, 0], // Ensure black text color for all cells
                    lineColor: [0, 0, 0], // Ensure black lines
                    lineWidth: 0.1
                },
                columnStyles: {
                    0: { cellWidth: 18 }, // Item Code
                    1: { cellWidth: 35 }, // Product
                    2: { cellWidth: 22 }, // Category
                    3: { cellWidth: 18 }, // Quantity
                    4: { cellWidth: 18 }, // Unit Price
                    5: { cellWidth: 22 }, // Total Value
                    6: { cellWidth: 18 }  // Status
                },
                margin: { left: 15, right: 15 },
                didDrawPage: function(data) {
                    // Add background to each new page
                    addBackgroundToPage(doc.internal.getNumberOfPages());
                    
                    // Add page number at the bottom
                    doc.setFontSize(8);
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageWidth - 20, pageHeight - 10);
                    
                    // Add header to continuation pages
                    if (doc.internal.getNumberOfPages() > 1) {
                        doc.setFontSize(12);
                        doc.setFont('helvetica', 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text('Stock Inventory Report (Continued)', pageWidth / 2, 20, { align: 'center' });
                    }
                }
            });
            
            // Save the PDF
            doc.save('Stock_Inventory_Report.pdf');
        }

        // Handle date filter for all modules
        function handleDateFilter(type) {
            console.log(`Handling date filter for ${type}`);
            const dateFilter = document.getElementById(`${type}DateFilter`);
            const specificDate = document.getElementById(`${type}SpecificDate`);
            const periodDates = document.getElementById(`${type}PeriodDates`);
            
            if (!dateFilter || !specificDate) {
                console.error(`Date filter elements not found for type: ${type}`);
                return;
            }
            
            console.log(`Date filter value: ${dateFilter.value}`);
            
            // Hide both specific date and period inputs by default
            specificDate.style.display = 'none';
            if (periodDates) {
                periodDates.style.display = 'none';
            }
            
            // Set today's date in local timezone
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayFormatted = `${year}-${month}-${day}`;
            
            if (dateFilter.value === 'specific') {
                console.log(`Showing specific date for ${type}`);
                specificDate.style.display = 'block';
                specificDate.value = todayFormatted;
            } else if (dateFilter.value === 'period') {
                console.log(`Showing period dates for ${type}`);
                if (periodDates) {
                periodDates.style.display = 'block';
                
                // Set default values for period dates (today for both)
                const startDateInput = document.getElementById(`${type}PeriodStartDate`);
                const endDateInput = document.getElementById(`${type}PeriodEndDate`);
                
                if (startDateInput && endDateInput) {
                    startDateInput.value = todayFormatted;
                    endDateInput.value = todayFormatted;
                    }
                } else {
                    console.error(`Period dates container not found for ${type}`);
                }
            }
            
            // Call the appropriate filter function based on the type
            switch(type) {
                case 'quotation':
                    filterQuotations();
                    break;
                case 'salesOrder':
                    filterSalesOrders();
                    break;
                case 'invoice':
                    filterInvoices();
                    break;
                case 'cashSale':
                    filterCashSales();
                    break;
                case 'payments':
                    filterPayments();
                    break;
                case 'purchases':
                    console.log('Calling filterPurchases() from handleDateFilter');
                    filterPurchases();
                    renderPurchasesTable(); // Make sure to render the table after filtering
                    break;
                case 'stock':
                    filterStock();
                    break;
                case 'clientExpenses':
                    filterClientExpenses();
                    break;
                case 'companyExpenses':
                    filterCompanyExpenses();
                    break;
                default:
                    console.error(`Unknown filter type: ${type}`);
            }
        }

        // Analytics Section Functions
document.addEventListener('DOMContentLoaded', function() {
    // Initialize analytics if analytics section is active
    const analyticsTab = document.querySelector('[data-section="analyticsSection"]');
    if (analyticsTab) {
        analyticsTab.addEventListener('click', function() {
            // Wait a moment for the section to become visible before rendering charts
            setTimeout(initializeAnalytics, 100);
        });
    }
    
    // Ensure charts are responsive to window resizing
    window.addEventListener('resize', function() {
        if (document.querySelector('#analyticsSection') && 
            document.querySelector('#analyticsSection').style.display !== 'none') {
            resizeAllCharts();
        }
    });
    
    // Listen for date range changes
    const dateRangeSelector = document.getElementById('analyticsDateRange');
    if (dateRangeSelector) {
        dateRangeSelector.addEventListener('change', function() {
            updateAnalytics(this.value);
        });
    }
    
    // Toggle between daily/weekly/monthly views
    document.querySelectorAll('.analytics-period-selector .control-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.analytics-period-selector .control-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            updateSalesExpensesChart(this.getAttribute('data-period'));
        });
    });
});

function initializeAnalytics() {
    const dateRangeSelector = document.getElementById('analyticsDateRange');
    if (dateRangeSelector) {
        updateAnalytics(dateRangeSelector.value);
    } else {
        updateAnalytics('month'); // Default to monthly view
    }
}

function resizeAllCharts() {
    // Resize all charts to fit their containers
    if (window.salesExpensesChart) window.salesExpensesChart.resize();
    if (window.salesDistributionChart) window.salesDistributionChart.resize();
    if (window.topClientsChart) window.topClientsChart.resize();
    if (window.expenseCategoriesChart) window.expenseCategoriesChart.resize();
    if (window.stockValueChart) window.stockValueChart.resize();
}

function updateAnalytics(dateRange) {
    // Show loading spinners on chart containers
    document.querySelectorAll('.chart-container').forEach(container => {
        container.classList.add('loading');
        const spinner = document.createElement('div');
        spinner.className = 'spinner-border';
        spinner.setAttribute('role', 'status');
        const spinnerText = document.createElement('span');
        spinnerText.className = 'visually-hidden';
        spinnerText.textContent = 'Loading...';
        spinner.appendChild(spinnerText);
        
        // Clear previous spinners
        const existingSpinner = container.querySelector('.spinner-border');
        if (existingSpinner) existingSpinner.remove();
        
        container.appendChild(spinner);
    });

    // Calculate date ranges
    const endDate = new Date();
    let startDate;
    
    switch(dateRange) {
        case 'week':
            startDate = new Date();
            startDate.setDate(endDate.getDate() - 7);
            break;
        case 'month':
            startDate = new Date();
            startDate.setMonth(endDate.getMonth() - 1);
            break;
        case 'quarter':
            startDate = new Date();
            startDate.setDate(endDate.getDate() - 90);
            break;
        case 'year':
            startDate = new Date();
            startDate.setFullYear(endDate.getFullYear() - 1);
            break;
        case 'all':
            startDate = new Date(0); // Beginning of time
            break;
        default:
            startDate = new Date();
            startDate.setMonth(endDate.getMonth() - 1);
    }
    
    // Reset time components to ensure proper date range filtering
    startDate.setHours(0, 0, 0, 0);
    endDate.setHours(23, 59, 59, 999);
    
    // Previous period (for comparison)
    const prevStartDate = new Date(startDate);
    const prevEndDate = new Date(startDate);
    const duration = endDate.getTime() - startDate.getTime();
    prevStartDate.setTime(prevStartDate.getTime() - duration);
    prevEndDate.setTime(prevEndDate.getTime() - 1); // One millisecond before current period
    
    // Update all analytics components with a slight delay between each
    // to prevent UI freezing with heavy calculations
    setTimeout(() => updateSummaryCards(startDate, endDate, prevStartDate, prevEndDate), 50);
    setTimeout(() => updateSalesExpensesChart('daily', startDate, endDate), 100);
    setTimeout(() => updateSalesDistributionChart(startDate, endDate), 150);
    setTimeout(() => updateTopClientsChart(startDate, endDate), 200);
    setTimeout(() => updateExpenseCategoriesChart(startDate, endDate), 250);
    setTimeout(() => updateStockValueChart(), 300);
    
    // Remove loading indicators after all charts are loaded
    setTimeout(() => {
        document.querySelectorAll('.chart-container').forEach(container => {
            container.classList.remove('loading');
            const spinner = container.querySelector('.spinner-border');
            if (spinner) spinner.remove();
        });
    }, 350);
}

function updateSummaryCards(startDate, endDate, prevStartDate, prevEndDate) {
    // Get data from localStorage - use the same collections as your main code
    const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
    const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
    const clientExpenses = JSON.parse(localStorage.getItem('clientExpenses') || '[]');
    const companyExpenses = JSON.parse(localStorage.getItem('companyExpenses') || '[]');
    const registeredEntities = JSON.parse(localStorage.getItem('registeredEntities') || '[]');
    const clients = registeredEntities.filter(entity => entity.type === 'client');
    
    // Calculate current period metrics
    const currentSales = calculateTotalSales(cashSales, invoices, quotations, startDate, endDate);
    const currentExpenses = calculateTotalExpenses(clientExpenses, companyExpenses, startDate, endDate);
    const currentProfit = currentSales - currentExpenses;
    const currentNewClients = clients.filter(client => 
        new Date(client.dateAdded) >= startDate && 
        new Date(client.dateAdded) <= endDate
    ).length;
    
    // Calculate previous period metrics for comparison
    const prevSales = calculateTotalSales(cashSales, invoices, quotations, prevStartDate, prevEndDate);
    const prevExpenses = calculateTotalExpenses(clientExpenses, companyExpenses, prevStartDate, prevEndDate);
    const prevProfit = prevSales - prevExpenses;
    const prevNewClients = clients.filter(client => 
        new Date(client.dateAdded) >= prevStartDate && 
        new Date(client.dateAdded) <= prevEndDate
    ).length;
    
    // Calculate growth percentages
    const salesGrowth = calculateGrowthPercentage(currentSales, prevSales);
    const expensesGrowth = calculateGrowthPercentage(currentExpenses, prevExpenses);
    const profitGrowth = calculateGrowthPercentage(currentProfit, prevProfit);
    const clientsGrowth = calculateGrowthPercentage(currentNewClients, prevNewClients);
    
    // Update UI
    const totalSalesElement = document.getElementById('totalSalesAmount');
    const totalExpensesElement = document.getElementById('totalExpensesAmount');
    const netProfitElement = document.getElementById('netProfitAmount');
    const newClientsElement = document.getElementById('newClientsCount');
    
    if (totalSalesElement) {
        totalSalesElement.textContent = `KES ${formatCurrency(currentSales)}`;
        updateGrowthBadge('salesGrowthBadge', salesGrowth);
    }
    
    if (totalExpensesElement) {
        totalExpensesElement.textContent = `KES ${formatCurrency(currentExpenses)}`;
        updateGrowthBadge('expensesGrowthBadge', expensesGrowth, true);
    }
    
    if (netProfitElement) {
        netProfitElement.textContent = `KES ${formatCurrency(currentProfit)}`;
        updateGrowthBadge('profitGrowthBadge', profitGrowth);
    }
    
    if (newClientsElement) {
        newClientsElement.textContent = currentNewClients;
        updateGrowthBadge('clientsGrowthBadge', clientsGrowth);
    }
}

function formatCurrency(amount) {
    return amount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
}

function updateGrowthBadge(elementId, percentage, invertColors = false) {
    const badge = document.getElementById(elementId);
    if (!badge) return;
    
    // Clear previous content
    badge.innerHTML = '';
    
    const isPositive = percentage > 0;
    const displayText = isPositive ? `+${percentage}%` : `${percentage}%`;
    
    // For expenses, negative growth is good
    const isGood = invertColors ? !isPositive : isPositive;
    
    // Add arrow indicator for better visual feedback
    if (percentage !== 0) {
        const iconSpan = document.createElement('span');
        iconSpan.className = isPositive ? 'bi bi-arrow-up' : 'bi bi-arrow-down';
        iconSpan.style.marginRight = '2px';
        badge.appendChild(iconSpan);
    }
    
    // Add the percentage text
    const textNode = document.createTextNode(displayText);
    badge.appendChild(textNode);
    
    // Set badge style based on value
    if (percentage === 0) {
        badge.className = 'change-badge text-secondary';
    } else if (isGood) {
        badge.className = 'change-badge text-success';
        badge.style.backgroundColor = 'rgba(16, 185, 129, 0.1)';
    } else {
        badge.className = 'change-badge text-danger';
        badge.style.backgroundColor = 'rgba(239, 68, 68, 0.1)';
    }
}

function calculateGrowthPercentage(current, previous) {
    if (previous === 0) {
        return current > 0 ? 100 : 0;
    }
    const growth = ((current - previous) / previous) * 100;
    return Math.round(growth);
}

function calculateTotalSales(cashSales, invoices, quotations, startDate, endDate) {
    // Calculate total from cash sales
    const cashSalesTotal = cashSales.reduce((total, sale) => {
        const saleDate = new Date(sale.date);
        if (saleDate >= startDate && saleDate <= endDate) {
            return total + (parseFloat(sale.grandTotal) || 0);
        }
        return total;
    }, 0);
    
    // Calculate total from invoices (where payments have been made)
    const invoicesTotal = invoices.reduce((total, invoice) => {
        // Look for payments made within the date range
        if (!invoice.payments) return total;
        
        const payments = invoice.payments.filter(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
        
        return total + payments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
    }, 0);
    
    // Calculate total from payments made towards quotations
    const quotationPaymentsTotal = quotations.reduce((total, quotation) => {
        if (!quotation.payments) return total;
        
        const quotationPayments = quotation.payments.filter(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
        
        return total + quotationPayments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
    }, 0);
    
    return cashSalesTotal + invoicesTotal + quotationPaymentsTotal;
}

function calculateTotalExpenses(clientExpenses, companyExpenses, startDate, endDate) {
    // Calculate total from client expenses
    const clientExpensesTotal = clientExpenses.reduce((total, expense) => {
        const expenseDate = new Date(expense.date);
        if (expenseDate >= startDate && expenseDate <= endDate) {
            // Sum up all items in the expense
            if (expense.items && expense.items.length > 0) {
                return total + expense.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            } else {
                return total + (parseFloat(expense.total) || 0);
            }
        }
        return total;
    }, 0);
    
    // Calculate total from company expenses
    const companyExpensesTotal = companyExpenses.reduce((total, expense) => {
        const expenseDate = new Date(expense.date);
        if (expenseDate >= startDate && expenseDate <= endDate) {
            // Sum up all items in the expense
            if (expense.items && expense.items.length > 0) {
                return total + expense.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
            } else {
                return total + (parseFloat(expense.total) || 0);
            }
        }
        return total;
    }, 0);
    
    return clientExpensesTotal + companyExpensesTotal;
}

function updateSalesExpensesChart(periodType = 'daily', startDate, endDate) {
    const chartCanvas = document.getElementById('salesExpensesChart');
    if (!chartCanvas) return;
    
    const ctx = chartCanvas.getContext('2d');
    
    // Get data
    const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
    const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
    const clientExpenses = JSON.parse(localStorage.getItem('clientExpenses') || '[]');
    const companyExpenses = JSON.parse(localStorage.getItem('companyExpenses') || '[]');
    
    // Create date periods
    const periods = createDatePeriods(startDate, endDate, periodType);
    
    // Aggregate data by period
    const salesData = periods.map(period => {
        // Get all sales within this period
        return calculateTotalSales(cashSales, invoices, quotations, period.start, period.end);
    });
    
    const expensesData = periods.map(period => {
        // Get all expenses within this period
        return calculateTotalExpenses(clientExpenses, companyExpenses, period.start, period.end);
    });
    
    // Profit calculation
    const profitData = salesData.map((sale, index) => sale - expensesData[index]);
    
    // Create or update chart
    if (window.salesExpensesChart) {
        window.salesExpensesChart.destroy();
    }
    
    // Define gradient colors for better visualization
    const salesGradient = ctx.createLinearGradient(0, 0, 0, 250);
    salesGradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
    salesGradient.addColorStop(1, 'rgba(99, 102, 241, 0.05)');
    
    const expensesGradient = ctx.createLinearGradient(0, 0, 0, 250);
    expensesGradient.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
    expensesGradient.addColorStop(1, 'rgba(239, 68, 68, 0.05)');
    
    const profitGradient = ctx.createLinearGradient(0, 0, 0, 250);
    profitGradient.addColorStop(0, 'rgba(16, 185, 129, 0.3)');
    profitGradient.addColorStop(1, 'rgba(16, 185, 129, 0.05)');
    
    window.salesExpensesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: periods.map(period => formatPeriodLabel(period, periodType)),
            datasets: [
                {
                    label: 'Sales',
                    data: salesData,
                    borderColor: '#6366f1',
                    backgroundColor: salesGradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#6366f1',
                    pointBorderColor: '#fff',
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Expenses',
                    data: expensesData,
                    borderColor: '#ef4444',
                    backgroundColor: expensesGradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#ef4444',
                    pointBorderColor: '#fff',
                    pointRadius: 4,
                    pointHoverRadius: 6
                },
                {
                    label: 'Profit',
                    data: profitData,
                    borderColor: '#10b981',
                    backgroundColor: profitGradient,
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: '#10b981',
                    pointBorderColor: '#fff',
                    pointRadius: 4,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    padding: 10,
                    bodySpacing: 5,
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#1f2937',
                    bodyColor: '#1f2937',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    cornerRadius: 8,
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    usePointStyle: true,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += `KES ${formatCurrency(context.parsed.y)}`;
                            return label;
                        }
                    }
                },
                legend: {
                    position: 'top',
                    align: 'end',
                    labels: {
                        usePointStyle: true,
                        boxWidth: 8,
                        boxHeight: 8,
                        padding: 20
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return 'KES ' + value.toLocaleString('en-US', {
                                notation: 'compact',
                                compactDisplay: 'short'
                            });
                        },
                        padding: 10
                    },
                    grid: {
                        drawBorder: false,
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4
                }
            }
        }
    });
}

function createDatePeriods(startDate, endDate, periodType) {
    const periods = [];
    const currentDate = new Date(startDate);
    
    // Cap the number of periods to prevent performance issues
    const maxPeriods = 20;
    let periodCount = 0;
    
    while (currentDate <= endDate && periodCount < maxPeriods) {
        let periodEnd;
        
        if (periodType === 'daily') {
            periodEnd = new Date(currentDate);
            periodEnd.setHours(23, 59, 59, 999);
            
            periods.push({
                start: new Date(currentDate),
                end: new Date(periodEnd)
            });
            
            currentDate.setDate(currentDate.getDate() + 1);
            currentDate.setHours(0, 0, 0, 0);
        } else if (periodType === 'weekly') {
            // Find the end of the week (Sunday)
            periodEnd = new Date(currentDate);
            const dayOfWeek = currentDate.getDay();
            const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
            periodEnd.setDate(periodEnd.getDate() + daysToSunday);
            periodEnd.setHours(23, 59, 59, 999);
            
            // If period end is beyond our endDate, cap it
            if (periodEnd > endDate) {
                periodEnd = new Date(endDate);
            }
            
            periods.push({
                start: new Date(currentDate),
                end: new Date(periodEnd)
            });
            
            // Move to next Monday
            currentDate.setDate(currentDate.getDate() + 7 - dayOfWeek);
            if (dayOfWeek === 0) currentDate.setDate(currentDate.getDate() + 1); // If today is Sunday, go to next Monday
            currentDate.setHours(0, 0, 0, 0);
        } else if (periodType === 'monthly') {
            // Set to last day of current month
            periodEnd = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            periodEnd.setHours(23, 59, 59, 999);
            
            // If period end is beyond our endDate, cap it
            if (periodEnd > endDate) {
                periodEnd = new Date(endDate);
            }
            
            periods.push({
                start: new Date(currentDate),
                end: new Date(periodEnd)
            });
            
            // Move to first day of next month
            currentDate.setMonth(currentDate.getMonth() + 1);
            currentDate.setDate(1);
            currentDate.setHours(0, 0, 0, 0);
        }
        
        periodCount++;
    }
    
    // If we have too many periods, consolidate them
    if (periods.length > maxPeriods) {
        const step = Math.ceil(periods.length / maxPeriods);
        const consolidatedPeriods = [];
        
        for (let i = 0; i < periods.length; i += step) {
            const end = (i + step - 1 < periods.length) ? periods[i + step - 1].end : periods[periods.length - 1].end;
            consolidatedPeriods.push({
                start: periods[i].start,
                end: end
            });
        }
        
        return consolidatedPeriods;
    }
    
    return periods;
}

function formatPeriodLabel(period, periodType) {
    const startDate = period.start;
    const endDate = period.end;
    
    if (periodType === 'daily') {
        return startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
    } else if (periodType === 'weekly') {
        if (startDate.getMonth() === endDate.getMonth()) {
            return `${startDate.getDate()} - ${endDate.getDate()} ${startDate.toLocaleDateString('en-US', {month: 'short'})}`;
        } else {
            return `${startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})} - ${endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})}`;
        }
    } else if (periodType === 'monthly') {
        return startDate.toLocaleDateString('en-US', {month: 'short', year: 'numeric'});
    }
    
    return startDate.toLocaleDateString();
}

function updateSalesDistributionChart(startDate, endDate) {
    const chartCanvas = document.getElementById('salesDistributionChart');
    if (!chartCanvas) return;
    
    const ctx = chartCanvas.getContext('2d');
    
    // Get data
    const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
    const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
    
    // Calculate the different types of sales
    
    // 1. Cash Sales (direct cash payments)
    const filteredCashSales = cashSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= startDate && saleDate <= endDate;
    });
    const cashSalesTotal = filteredCashSales.reduce((sum, sale) => sum + (parseFloat(sale.grandTotal) || 0), 0);
    
    // 2. Invoiced Sales (amounts in invoices)
    const filteredInvoices = invoices.filter(invoice => {
        // Check invoice payments within date range
        if (!invoice.payments) return false;
        
        return invoice.payments.some(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
    });
    
    const invoicesTotal = filteredInvoices.reduce((sum, invoice) => {
        if (!invoice.payments) return sum;
        
        const relevantPayments = invoice.payments.filter(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
        
        return sum + relevantPayments.reduce((paymentSum, payment) => 
            paymentSum + (parseFloat(payment.amount) || 0), 0);
    }, 0);
    
    // 3. Quotation Payments (payments made toward quotations that aren't yet invoiced)
    let quotationPaymentsTotal = 0;
    quotations.forEach(quotation => {
        if (!quotation.payments) return;
        
        const relevantPayments = quotation.payments.filter(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
        
        quotationPaymentsTotal += relevantPayments.reduce((sum, payment) => sum + (parseFloat(payment.amount) || 0), 0);
    });
    
    // Create or update chart
    if (window.salesDistributionChart) {
        window.salesDistributionChart.destroy();
    }
    
    // Define beautiful colors with transparency
    const chartColors = [
        'rgba(99, 102, 241, 0.8)',   // Indigo
        'rgba(59, 130, 246, 0.8)',   // Blue
        'rgba(139, 92, 246, 0.8)'    // Purple
    ];
    
    const chartBorderColors = [
        'rgb(79, 82, 221)',   // Darker Indigo
        'rgb(39, 110, 226)',  // Darker Blue
        'rgb(119, 72, 226)'   // Darker Purple
    ];
    
    window.salesDistributionChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Cash Sales', 'Invoiced Sales', 'Quotation Payments'],
            datasets: [{
                data: [cashSalesTotal, invoicesTotal, quotationPaymentsTotal],
                backgroundColor: chartColors,
                borderColor: chartBorderColors,
                borderWidth: 2,
                hoverOffset: 15,
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: 20
            },
            cutout: '65%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    padding: 12,
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#1f2937',
                    bodyColor: '#1f2937',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    cornerRadius: 8,
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${context.label}: KES ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true
            }
        }
    });
    
    // Calculate and display the total
    const totalSales = cashSalesTotal + invoicesTotal + quotationPaymentsTotal;
    const totalElement = document.getElementById('salesDistributionTotal');
    if (totalElement) {
        totalElement.textContent = `Total: KES ${formatCurrency(totalSales)}`;
    }
}

function updateTopClientsChart(startDate, endDate) {
    const chartCanvas = document.getElementById('topClientsChart');
    if (!chartCanvas) return;
    
    const ctx = chartCanvas.getContext('2d');
    
    // Get data from all sales sources
    const cashSales = JSON.parse(localStorage.getItem('cashSales') || '[]');
    const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
    const quotations = JSON.parse(localStorage.getItem('quotations') || '[]');
    
    // Filter by date range
    const filteredCashSales = cashSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= startDate && saleDate <= endDate;
    });
    
    const filteredInvoices = invoices.filter(invoice => {
        if (!invoice.payments) return false;
        
        return invoice.payments.some(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
    });
    
    // Combine sales and aggregate by client
    const clientSales = {};
    
    // Add cash sales
    filteredCashSales.forEach(sale => {
        const clientId = sale.clientId;
        const clientName = sale.clientName;
        if (!clientId || !clientName) return;
        
        if (!clientSales[clientId]) {
            clientSales[clientId] = {
                name: clientName,
                total: 0
            };
        }
        
        clientSales[clientId].total += (parseFloat(sale.grandTotal) || 0);
    });
    
    // Add invoiced sales (only count paid amounts)
    filteredInvoices.forEach(invoice => {
        const clientId = invoice.clientId;
        const clientName = invoice.clientName;
        if (!clientId || !clientName || !invoice.payments) return;
        
        const relevantPayments = invoice.payments.filter(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
        
        if (relevantPayments.length === 0) return;
        
        if (!clientSales[clientId]) {
            clientSales[clientId] = {
                name: clientName,
                total: 0
            };
        }
        
        clientSales[clientId].total += relevantPayments.reduce((sum, payment) => 
            sum + (parseFloat(payment.amount) || 0), 0);
    });
    
    // Add payments from quotations
    quotations.forEach(quotation => {
        if (!quotation.payments) return;
        
        const relevantPayments = quotation.payments.filter(payment => {
            const paymentDate = new Date(payment.date);
            return paymentDate >= startDate && paymentDate <= endDate;
        });
        
        if (relevantPayments.length === 0) return;
        
        const clientId = quotation.clientId;
        const clientName = quotation.clientName;
        if (!clientId || !clientName) return;
        
        if (!clientSales[clientId]) {
            clientSales[clientId] = {
                name: clientName,
                total: 0
            };
        }
        
        clientSales[clientId].total += relevantPayments.reduce((sum, payment) => 
            sum + (parseFloat(payment.amount) || 0), 0);
    });
    
    // Convert to array and sort by total
    const sortedClients = Object.values(clientSales)
        .filter(client => client.total > 0)  // Only include clients with sales
        .sort((a, b) => b.total - a.total)
        .slice(0, 8); // Top 8 clients
    
    // Show a message if no clients found
    if (sortedClients.length === 0) {
        if (window.topClientsChart) {
            window.topClientsChart.destroy();
        }
        
        const noDataElement = document.getElementById('topClientsNoData');
        if (noDataElement) {
            noDataElement.style.display = 'flex';
        }
        return;
    } else {
        const noDataElement = document.getElementById('topClientsNoData');
        if (noDataElement) {
            noDataElement.style.display = 'none';
        }
    }
    
    // Create gradient colors for better visualization
    const gradientColors = sortedClients.map((_, index) => {
        const baseColors = [
            '#6366f1', '#8b5cf6', '#3b82f6', '#10b981', 
            '#f59e0b', '#ef4444', '#ec4899', '#64748b'
        ];
        const color = baseColors[index % baseColors.length];
        const gradient = ctx.createLinearGradient(0, 0, 300, 0);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, color + '80'); // Add some transparency at the end
        return gradient;
    });
    
    // Create or update chart
    if (window.topClientsChart) {
        window.topClientsChart.destroy();
    }
    
    window.topClientsChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: sortedClients.map(client => {
                // Truncate long client names
                const maxLength = 20;
                return client.name.length > maxLength ? 
                    client.name.substring(0, maxLength) + '...' : 
                    client.name;
            }),
            datasets: [{
                label: 'Sales Amount',
                data: sortedClients.map(client => client.total),
                backgroundColor: gradientColors,
                borderWidth: 0,
                borderRadius: 4,
                barPercentage: 0.7,
                categoryPercentage: 0.8
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: {
                    right: 20
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#1f2937',
                    bodyColor: '#1f2937',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    cornerRadius: 8,
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    callbacks: {
                        title: function(tooltipItems) {
                            // Show full client name in tooltip
                            const index = tooltipItems[0].dataIndex;
                            return sortedClients[index].name;
                        },
                        label: function(context) {
                            return `KES ${formatCurrency(context.raw)}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)',
                        drawBorder: false
                    },
                    ticks: {
                        padding: 10,
                        callback: function(value) {
                            return 'KES ' + value.toLocaleString('en-US', {
                                notation: 'compact',
                                compactDisplay: 'short'
                            });
                        }
                    }
                },
                y: {
                    grid: {
                        display: false,
                        drawBorder: false
                    },
                    ticks: {
                        padding: 10
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
}

function updateExpenseCategoriesChart(startDate, endDate) {
    const chartCanvas = document.getElementById('expenseCategoriesChart');
    if (!chartCanvas) return;
    
    const ctx = chartCanvas.getContext('2d');
    
    // Get data
    const companyExpenses = JSON.parse(localStorage.getItem('companyExpenses') || '[]');
    const clientExpenses = JSON.parse(localStorage.getItem('clientExpenses') || '[]');
    
    // Filter by date range
    const filteredCompanyExpenses = companyExpenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= startDate && expenseDate <= endDate;
    });
    
    const filteredClientExpenses = clientExpenses.filter(expense => {
        const expenseDate = new Date(expense.date);
        return expenseDate >= startDate && expenseDate <= endDate;
    });
    
    // Aggregate by category for company expenses
    const categories = {};
    
    filteredCompanyExpenses.forEach(expense => {
        const category = expense.category || 'Uncategorized';
        
        if (!categories[category]) {
            categories[category] = 0;
        }
        
        // Sum up items or use total
        if (expense.items && expense.items.length > 0) {
            categories[category] += expense.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
        } else {
            categories[category] += (parseFloat(expense.total) || 0);
        }
    });
    
    // Add client expenses as its own category
    let clientExpensesTotal = 0;
    filteredClientExpenses.forEach(expense => {
        // Sum up items or use total
        if (expense.items && expense.items.length > 0) {
            clientExpensesTotal += expense.items.reduce((sum, item) => sum + (parseFloat(item.amount) || 0), 0);
        } else {
            clientExpensesTotal += (parseFloat(expense.total) || 0);
        }
    });
    
    if (clientExpensesTotal > 0) {
        categories['Client Expenses'] = clientExpensesTotal;
    }
    
    // Check if we have expense data
    if (Object.keys(categories).length === 0) {
        if (window.expenseCategoriesChart) {
            window.expenseCategoriesChart.destroy();
        }
        
        const noDataElement = document.getElementById('expenseCategoriesNoData');
        if (noDataElement) {
            noDataElement.style.display = 'flex';
        }
        return;
    } else {
        const noDataElement = document.getElementById('expenseCategoriesNoData');
        if (noDataElement) {
            noDataElement.style.display = 'none';
        }
    }
    
    // Convert to arrays and sort by value
    const sortedCategories = Object.entries(categories)
        .sort((a, b) => b[1] - a[1])
        .reduce((obj, [key, value]) => {
            obj[key] = value;
            return obj;
        }, {});
    
    const categoryLabels = Object.keys(sortedCategories);
    const categoryValues = Object.values(sortedCategories);
    
    // Beautiful color palette for expenses
    const colors = [
        'rgba(239, 68, 68, 0.8)',    // Red
        'rgba(249, 115, 22, 0.8)',   // Orange
        'rgba(245, 158, 11, 0.8)',   // Amber
        'rgba(16, 185, 129, 0.8)',   // Emerald
        'rgba(59, 130, 246, 0.8)',   // Blue
        'rgba(99, 102, 241, 0.8)',   // Indigo
        'rgba(139, 92, 246, 0.8)',   // Purple
        'rgba(236, 72, 153, 0.8)'    // Pink
    ];
    
    // Create or update chart
    if (window.expenseCategoriesChart) {
        window.expenseCategoriesChart.destroy();
    }
    
    window.expenseCategoriesChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryValues,
                backgroundColor: categoryLabels.map((_, index) => colors[index % colors.length]),
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverBorderWidth: 4,
                hoverBorderColor: '#ffffff',
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: 20
            },
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 12
                        },
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map(function(label, i) {
                                    const meta = chart.getDatasetMeta(0);
                                    const style = meta.controller.getStyle(i);
                                    const value = chart.data.datasets[0].data[i];
                                    const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    
                                    return {
                                        text: `${label} (${percentage}%)`,
                                        fillStyle: style.backgroundColor,
                                        strokeStyle: style.borderColor,
                                        lineWidth: style.borderWidth,
                                        hidden: isNaN(value) || meta.data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    padding: 12,
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#1f2937',
                    bodyColor: '#1f2937',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    cornerRadius: 8,
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${context.label}: KES ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1000,
                easing: 'easeOutQuart'
            }
        }
    });
    
    // Calculate and display the total
    const totalExpenses = categoryValues.reduce((sum, value) => sum + value, 0);
    const totalElement = document.getElementById('expenseCategoriesTotal');
    if (totalElement) {
        totalElement.textContent = `Total: KES ${formatCurrency(totalExpenses)}`;
    }
}

function updateStockValueChart() {
    const chartCanvas = document.getElementById('stockValueChart');
    if (!chartCanvas) return;
    
    const ctx = chartCanvas.getContext('2d');
    
    // Get stock data from localStorage
    const stock = JSON.parse(localStorage.getItem('stock') || '[]');
    
    // If no stock, display a message
    if (stock.length === 0) {
        if (window.stockValueChart) {
            window.stockValueChart.destroy();
        }
        
        const noDataElement = document.getElementById('stockValueNoData');
        if (noDataElement) {
            noDataElement.style.display = 'flex';
        }
        return;
    } else {
        const noDataElement = document.getElementById('stockValueNoData');
        if (noDataElement) {
            noDataElement.style.display = 'none';
        }
    }
    
    // Group stock by category
    const categories = {};
    
    stock.forEach(item => {
        const category = item.category || 'Uncategorized';
        const value = (parseFloat(item.currentStock) || 0) * (parseFloat(item.lastPurchasePrice) || 0);
        
        if (!categories[category]) {
            categories[category] = 0;
        }
        
        categories[category] += value;
    });
    
    // Sort by value (descending)
    const sortedCategories = Object.entries(categories)
        .sort(([, a], [, b]) => b - a)
        .reduce((r, [k, v]) => ({ ...r, [k]: v }), {});
    
    // Convert to arrays
    const categoryLabels = Object.keys(sortedCategories);
    const categoryValues = Object.values(sortedCategories);
    
    // Beautiful colors for the doughnut chart
    const colors = [
        'rgba(16, 185, 129, 0.8)',   // Emerald
        'rgba(59, 130, 246, 0.8)',   // Blue
        'rgba(245, 158, 11, 0.8)',   // Amber
        'rgba(99, 102, 241, 0.8)',   // Indigo
        'rgba(139, 92, 246, 0.8)',   // Purple
        'rgba(236, 72, 153, 0.8)',   // Pink
        'rgba(100, 116, 139, 0.8)'   // Slate
    ];
    
    // Create or update chart
    if (window.stockValueChart) {
        window.stockValueChart.destroy();
    }
    
    window.stockValueChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: categoryLabels,
            datasets: [{
                data: categoryValues,
                backgroundColor: categoryLabels.map((_, index) => colors[index % colors.length]),
                borderColor: '#ffffff',
                borderWidth: 2,
                hoverOffset: 15,
                hoverBorderWidth: 3
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: 20
            },
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'right',
                    align: 'center',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            size: 12
                        },
                        // Show percentage in legend
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                return data.labels.map(function(label, i) {
                                    const meta = chart.getDatasetMeta(0);
                                    const style = meta.controller.getStyle(i);
                                    const value = chart.data.datasets[0].data[i];
                                    const total = chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                    
                                    return {
                                        text: `${label} (${percentage}%)`,
                                        fillStyle: style.backgroundColor,
                                        strokeStyle: style.borderColor,
                                        lineWidth: style.borderWidth,
                                        hidden: isNaN(value) || meta.data[i].hidden,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    padding: 12,
                    backgroundColor: 'rgba(255, 255, 255, 0.9)',
                    titleColor: '#1f2937',
                    bodyColor: '#1f2937',
                    borderColor: '#e5e7eb',
                    borderWidth: 1,
                    cornerRadius: 8,
                    boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                            return `${context.label}: KES ${formatCurrency(value)} (${percentage}%)`;
                        }
                    }
                }
            },
            animation: {
                animateRotate: true,
                animateScale: true,
                duration: 1000
            }
        }
    });
    
    // Calculate and display the total stock value
    const totalStockValue = categoryValues.reduce((sum, value) => sum + value, 0);
    const totalElement = document.getElementById('stockValueTotal');
    if (totalElement) {
        totalElement.textContent = `Total: KES ${formatCurrency(totalStockValue)}`;
    }
}

// Report generation functions
function generateSalesReport() {
    showReportModal('Sales Report', 'sales');
}

function generateExpenseReport() {
    showReportModal('Expense Report', 'expenses');
}

function generateInventoryReport() {
    showReportModal('Inventory Report', 'inventory');
}

function generateClientReport() {
    showReportModal('Client Report', 'clients');
}

function generateFinancialReport() {
    showReportModal('Financial Summary', 'financial');
}

function generateCustomReport() {
    showReportModal('Custom Report', 'custom');
}

function showReportModal(title, type) {
    // Create modal if it doesn't exist
    if (!document.getElementById('reportModal')) {
        const modalHTML = `
            <div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content" style="border-radius: 16px; border: none; overflow: hidden;">
                        <div class="modal-header border-0" id="reportModalHeader">
                            <h5 class="modal-title" id="reportModalTitle"></h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body" id="reportModalBody">
                            <!-- Dynamic content will be inserted here -->
                        </div>
                        <div class="modal-footer border-0">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" id="generateReportBtn">Generate Report</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHTML;
        document.body.appendChild(modalContainer);
    }
    
    // Update modal title
    document.getElementById('reportModalTitle').textContent = title;
    
    // Update header style based on report type
    const headerColors = {
        sales: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
        expenses: 'linear-gradient(135deg, #ef4444 0%, #f97316 100%)',
        inventory: 'linear-gradient(135deg, #10b981 0%, #34d399 100%)',
        clients: 'linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%)',
        financial: 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)',
        custom: 'linear-gradient(135deg, #ec4899 0%, #f472b6 100%)'
    };
    
    document.getElementById('reportModalHeader').style.background = headerColors[type] || headerColors.custom;
    document.getElementById('reportModalHeader').style.color = '#ffffff';
    
    // Update generate button style
    const buttonColors = {
        sales: 'btn-primary',
        expenses: 'btn-danger',
        inventory: 'btn-success',
        clients: 'btn-info',
        financial: 'btn-warning',
        custom: 'btn-secondary'
    };
    
    const generateBtn = document.getElementById('generateReportBtn');
    // Clear existing classes except btn
    generateBtn.className = 'btn';
    generateBtn.classList.add(buttonColors[type] || 'btn-primary');
    
    // Set report generation function
    generateBtn.onclick = function() {
        executeReportGeneration(type);
    };
    
    // Update modal body with appropriate form
    updateReportModalBody(type);
    
    // Show modal
    const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    reportModal.show();
}

function updateReportModalBody(type) {
    const modalBody = document.getElementById('reportModalBody');
    
    // Common date range selector
    const dateRangeSelector = `
        <div class="mb-4">
            <label class="form-label">Date Range</label>
            <select class="form-select" id="reportDateRange">
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="week">Current Week</option>
                <option value="lastWeek">Last Week</option>
                <option value="month" selected>Current Month</option>
                <option value="lastMonth">Last Month</option>
                <option value="quarter">Current Quarter</option>
                <option value="year">Current Year</option>
                <option value="custom">Custom Range</option>
            </select>
        </div>
        <div class="row mb-4" id="customDateRange" style="display: none;">
            <div class="col-md-6">
                <label class="form-label">Start Date</label>
                <input type="date" class="form-control" id="reportStartDate">
            </div>
            <div class="col-md-6">
                <label class="form-label">End Date</label>
                <input type="date" class="form-control" id="reportEndDate">
            </div>
        </div>
    `;
    
    let formContent = '';
    
    switch (type) {
        case 'sales':
            formContent = `
                ${dateRangeSelector}
                <div class="mb-4">
                    <label class="form-label">Group By</label>
                    <select class="form-select" id="salesGroupBy">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month" selected>Month</option>
                        <option value="client">Client</option>
                        <option value="product">Product/Service</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Include</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeCashSales" checked>
                        <label class="form-check-label" for="includeCashSales">Cash Sales</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeInvoices" checked>
                        <label class="form-check-label" for="includeInvoices">Invoiced Sales</label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="reportFormat">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            `;
            break;
            
        case 'expenses':
            formContent = `
                ${dateRangeSelector}
                <div class="mb-4">
                    <label class="form-label">Group By</label>
                    <select class="form-select" id="expensesGroupBy">
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month" selected>Month</option>
                        <option value="category">Category</option>
                        <option value="department">Department</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Include</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeClientExpenses" checked>
                        <label class="form-check-label" for="includeClientExpenses">Client Expenses</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeCompanyExpenses" checked>
                        <label class="form-check-label" for="includeCompanyExpenses">Company Expenses</label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="reportFormat">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            `;
            break;
            
        case 'inventory':
            formContent = `
                <div class="mb-4">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" id="inventoryReportType">
                        <option value="current">Current Inventory Levels</option>
                        <option value="movement">Inventory Movement</option>
                        <option value="value">Inventory Valuation</option>
                        <option value="lowStock">Low Stock Items</option>
                    </select>
                </div>
                ${dateRangeSelector}
                <div class="mb-4">
                    <label class="form-label">Group By</label>
                    <select class="form-select" id="inventoryGroupBy">
                        <option value="category" selected>Category</option>
                        <option value="item">Individual Items</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="reportFormat">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            `;
            break;
            
        case 'clients':
            formContent = `
                ${dateRangeSelector}
                <div class="mb-4">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" id="clientReportType">
                        <option value="activity">Client Activity</option>
                        <option value="sales">Sales by Client</option>
                        <option value="balance">Outstanding Balances</option>
                        <option value="newClients">New Clients</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Client</label>
                    <select class="form-select" id="clientSelection">
                        <option value="all" selected>All Clients</option>
                        <!-- Dynamically populate with client list -->
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="reportFormat">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            `;
            break;
            
        case 'financial':
            formContent = `
                ${dateRangeSelector}
                <div class="mb-4">
                    <label class="form-label">Report Type</label>
                    <select class="form-select" id="financialReportType">
                        <option value="summary">Financial Summary</option>
                        <option value="profitLoss">Profit & Loss Statement</option>
                        <option value="balanceSheet">Balance Sheet</option>
                        <option value="cashFlow">Cash Flow Statement</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Comparison</label>
                    <select class="form-select" id="comparisonPeriod">
                        <option value="none">None</option>
                        <option value="previousPeriod">Previous Period</option>
                        <option value="previousYear">Same Period Last Year</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="reportFormat">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            `;
            break;
            
        case 'custom':
            formContent = `
                ${dateRangeSelector}
                <div class="mb-4">
                    <label class="form-label">Include Data From</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeClients" checked>
                        <label class="form-check-label" for="includeClients">Clients</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeSales" checked>
                        <label class="form-check-label" for="includeSales">Sales</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeExpenses" checked>
                        <label class="form-check-label" for="includeExpenses">Expenses</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="includeInventory">
                        <label class="form-check-label" for="includeInventory">Inventory</label>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="form-label">Group By</label>
                    <select class="form-select" id="customGroupBy">
                        <option value="none">No Grouping</option>
                        <option value="day">Day</option>
                        <option value="week">Week</option>
                        <option value="month" selected>Month</option>
                        <option value="client">Client</option>
                        <option value="category">Category</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label class="form-label">Format</label>
                    <select class="form-select" id="reportFormat">
                        <option value="pdf">PDF</option>
                        <option value="excel">Excel</option>
                        <option value="csv">CSV</option>
                    </select>
                </div>
            `;
            break;
    }
    
    modalBody.innerHTML = formContent;
    
    // Update client dropdown if needed
    if (type === 'clients') {
        const clientSelect = document.getElementById('clientSelection');
        if (clientSelect) {
            const clients = registeredEntities.filter(entity => entity.type === 'client');
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
        }
    }
    
    // Add event listener for custom date range
    const dateRangeSelect = document.getElementById('reportDateRange');
    const customDateRange = document.getElementById('customDateRange');
    
    if (dateRangeSelect && customDateRange) {
        dateRangeSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDateRange.style.display = 'flex';
                
                // Set default dates (today and 30 days ago)
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                document.getElementById('reportEndDate').valueAsDate = today;
                document.getElementById('reportStartDate').valueAsDate = thirtyDaysAgo;
            } else {
                customDateRange.style.display = 'none';
            }
        });
    }
}

function executeReportGeneration(type) {
    // Get date range
    const dateRange = document.getElementById('reportDateRange').value;
    let startDate, endDate;
    
    if (dateRange === 'custom') {
        startDate = new Date(document.getElementById('reportStartDate').value);
        endDate = new Date(document.getElementById('reportEndDate').value);
        endDate.setHours(23, 59, 59, 999); // End of day
    } else {
        [startDate, endDate] = getDateRangeFromSelection(dateRange);
    }
    
    // Get format
    const format = document.getElementById('reportFormat').value;
    
    // Generate appropriate report based on type
    let reportData, filename;
    
    switch (type) {
        case 'sales':
            const groupBy = document.getElementById('salesGroupBy').value;
            const includeCashSales = document.getElementById('includeCashSales').checked;
            const includeInvoices = document.getElementById('includeInvoices').checked;
            
            reportData = generateSalesReportData(startDate, endDate, groupBy, includeCashSales, includeInvoices);
            filename = `sales_report_${formatDateForFilename(new Date())}`;
            break;
            
        case 'expenses':
            const expensesGroupBy = document.getElementById('expensesGroupBy').value;
            const includeClientExpenses = document.getElementById('includeClientExpenses').checked;
            const includeCompanyExpenses = document.getElementById('includeCompanyExpenses').checked;
            
            reportData = generateExpensesReportData(startDate, endDate, expensesGroupBy, includeClientExpenses, includeCompanyExpenses);
            filename = `expenses_report_${formatDateForFilename(new Date())}`;
            break;
            
        case 'inventory':
            const inventoryReportType = document.getElementById('inventoryReportType').value;
            const inventoryGroupBy = document.getElementById('inventoryGroupBy').value;
            
            reportData = generateInventoryReportData(startDate, endDate, inventoryReportType, inventoryGroupBy);
            filename = `inventory_report_${formatDateForFilename(new Date())}`;
            break;
            
        case 'clients':
            const clientReportType = document.getElementById('clientReportType').value;
            const clientSelection = document.getElementById('clientSelection').value;
            
            reportData = generateClientReportData(startDate, endDate, clientReportType, clientSelection);
            filename = `client_report_${formatDateForFilename(new Date())}`;
            break;
            
        case 'financial':
            const financialReportType = document.getElementById('financialReportType').value;
            const comparisonPeriod = document.getElementById('comparisonPeriod').value;
            
            reportData = generateFinancialReportData(startDate, endDate, financialReportType, comparisonPeriod);
            filename = `financial_report_${formatDateForFilename(new Date())}`;
            break;
            
        case 'custom':
            const includeClients = document.getElementById('includeClients').checked;
            const includeSales = document.getElementById('includeSales').checked;
            const includeExpenses = document.getElementById('includeExpenses').checked;
            const includeInventory = document.getElementById('includeInventory').checked;
            const customGroupBy = document.getElementById('customGroupBy').value;
            
            reportData = generateCustomReportData(startDate, endDate, includeClients, includeSales, includeExpenses, includeInventory, customGroupBy);
            filename = `custom_report_${formatDateForFilename(new Date())}`;
            break;
    }
    
    // Download report in selected format
    downloadReport(reportData, format, filename);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
    modal.hide();
    
    // Show success message
    const toastHTML = `
        <div class="position-fixed top-0 end-0 p-3" style="z-index: 5">
            <div class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-check-circle me-2"></i> Report generated successfully!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        </div>
    `;
    
    const toastContainer = document.createElement('div');
    toastContainer.innerHTML = toastHTML;
    document.body.appendChild(toastContainer);
    
    const toastElement = toastContainer.querySelector('.toast');
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Remove toast element after hiding
    toastElement.addEventListener('hidden.bs.toast', () => {
        toastContainer.remove();
    });
}

function getDateRangeFromSelection(selection) {
    const today = new Date();
    today.setHours(23, 59, 59, 999); // End of today
    
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    yesterday.setHours(0, 0, 0, 0); // Start of yesterday
    
    const startOfToday = new Date(today);
    startOfToday.setHours(0, 0, 0, 0); // Start of today
    
    const startOfThisWeek = new Date(today);
    startOfThisWeek.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
    startOfThisWeek.setHours(0, 0, 0, 0);
    
    const startOfLastWeek = new Date(startOfThisWeek);
    startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);
    
    const endOfLastWeek = new Date(startOfThisWeek);
    endOfLastWeek.setDate(endOfLastWeek.getDate() - 1);
    endOfLastWeek.setHours(23, 59, 59, 999);
    
    const startOfThisMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    startOfThisMonth.setHours(0, 0, 0, 0);
    
    const startOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
    startOfLastMonth.setHours(0, 0, 0, 0);
    
    const endOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
    endOfLastMonth.setHours(23, 59, 59, 999);
    
    const startOfThisQuarter = new Date(today);
    startOfThisQuarter.setMonth(Math.floor(today.getMonth() / 3) * 3, 1);
    startOfThisQuarter.setHours(0, 0, 0, 0);
    
    const startOfThisYear = new Date(today.getFullYear(), 0, 1);
    startOfThisYear.setHours(0, 0, 0, 0);
    
    switch (selection) {
        case 'today':
            return [startOfToday, today];
        case 'yesterday':
            return [yesterday, new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59, 999)];
        case 'week':
            return [startOfThisWeek, today];
        case 'lastWeek':
            return [startOfLastWeek, endOfLastWeek];
        case 'month':
            return [startOfThisMonth, today];
        case 'lastMonth':
            return [startOfLastMonth, endOfLastMonth];
        case 'quarter':
            return [startOfThisQuarter, today];
        case 'year':
            return [startOfThisYear, today];
        default:
            return [startOfThisMonth, today];
    }
}

function formatDateForFilename(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}${month}${day}`;
}

// Implement the actual report generation functions here
// These would be more complex in a real implementation
function generateSalesReportData(startDate, endDate, groupBy, includeCashSales, includeInvoices) {
    // This would be a complex function to generate detailed sales data
    // For this example, we'll return a simple placeholder
    return {
        title: 'Sales Report',
        dateRange: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
        groupBy: groupBy,
        summary: {
            totalSales: 12345.67,
            cashSales: 5678.90,
            invoicedSales: 6666.77,
            topProducts: [
                { name: 'Product A', amount: 3456.78 },
                { name: 'Product B', amount: 2345.67 },
                { name: 'Product C', amount: 1234.56 }
            ],
            topClients: [
                { name: 'Client X', amount: 4567.89 },
                { name: 'Client Y', amount: 3456.78 },
                { name: 'Client Z', amount: 2345.67 }
            ]
        },
        data: [
            { date: '2023-01-01', cashSales: 234.56, invoicedSales: 345.67, total: 580.23 },
            { date: '2023-01-02', cashSales: 345.67, invoicedSales: 456.78, total: 802.45 },
            { date: '2023-01-03', cashSales: 456.78, invoicedSales: 567.89, total: 1024.67 }
        ]
    };
}

function generateExpensesReportData(startDate, endDate, groupBy, includeClientExpenses, includeCompanyExpenses) {
    // Placeholder
    return {
        title: 'Expenses Report',
        dateRange: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
        groupBy: groupBy,
        summary: {
            totalExpenses: 9876.54,
            clientExpenses: 5432.10,
            companyExpenses: 4444.44,
            topCategories: [
                { name: 'Category A', amount: 3210.98 },
                { name: 'Category B', amount: 2109.87 },
                { name: 'Category C', amount: 1098.76 }
            ]
        },
        data: [
            { date: '2023-01-01', clientExpenses: 123.45, companyExpenses: 234.56, total: 358.01 },
            { date: '2023-01-02', clientExpenses: 234.56, companyExpenses: 345.67, total: 580.23 },
            { date: '2023-01-03', clientExpenses: 345.67, companyExpenses: 456.78, total: 802.45 }
        ]
    };
}

function generateInventoryReportData(startDate, endDate, reportType, groupBy) {
    // Placeholder
    return {
        title: 'Inventory Report',
        dateRange: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
        reportType: reportType,
        groupBy: groupBy,
        summary: {
            totalItems: 123,
            totalValue: 67890.12,
            lowStockItems: 12,
            outOfStockItems: 5
        },
        data: [
            { category: 'Category A', items: 45, value: 23456.78 },
            { category: 'Category B', items: 34, value: 12345.67 },
            { category: 'Category C', items: 44, value: 34567.89 }
        ]
    };
}

function generateClientReportData(startDate, endDate, reportType, clientSelection) {
    // Placeholder
    return {
        title: 'Client Report',
        dateRange: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
        reportType: reportType,
        clientSelection: clientSelection,
        summary: {
            totalClients: 45,
            newClients: 5,
            activeClients: 30,
            totalOutstandingBalance: 12345.67
        },
        data: [
            { client: 'Client X', sales: 4567.89, expenses: 1234.56, balance: 567.89 },
            { client: 'Client Y', sales: 3456.78, expenses: 2345.67, balance: 456.78 },
            { client: 'Client Z', sales: 2345.67, expenses: 3456.78, balance: 345.67 }
        ]
    };
}

function generateFinancialReportData(startDate, endDate, reportType, comparisonPeriod) {
    // Placeholder
    return {
        title: 'Financial Report',
        dateRange: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
        reportType: reportType,
        comparisonPeriod: comparisonPeriod,
        summary: {
            totalRevenue: 87654.32,
            totalExpenses: 54321.09,
            netProfit: 33333.23,
            profitMargin: 38.03
        },
        data: [
            { month: 'January', revenue: 12345.67, expenses: 9876.54, profit: 2469.13 },
            { month: 'February', revenue: 23456.78, expenses: 8765.43, profit: 14691.35 },
            { month: 'March', revenue: 34567.89, expenses: 7654.32, profit: 26913.57 }
        ]
    };
}

function generateCustomReportData(startDate, endDate, includeClients, includeSales, includeExpenses, includeInventory, groupBy) {
    // Placeholder
    return {
        title: 'Custom Report',
        dateRange: `${startDate.toLocaleDateString()} - ${endDate.toLocaleDateString()}`,
        selections: {
            includeClients,
            includeSales,
            includeExpenses,
            includeInventory
        },
        groupBy: groupBy,
        data: [
            { date: '2023-01-01', clients: 10, sales: 1234.56, expenses: 987.65, stock: 45 },
            { date: '2023-01-02', clients: 12, sales: 2345.67, expenses: 876.54, stock: 43 },
            { date: '2023-01-03', clients: 15, sales: 3456.78, expenses: 765.43, stock: 47 }
        ]
    };
}

function downloadReport(reportData, format, filename) {
    switch (format) {
        case 'pdf':
            downloadPDFReport(reportData, filename);
            break;
        case 'excel':
            downloadExcelReport(reportData, filename);
            break;
        case 'csv':
            downloadCSVReport(reportData, filename);
            break;
    }
}

function downloadPDFReport(reportData, filename) {
    // Create a new PDF document using jsPDF
    const doc = new jsPDF();
    
    // Add title
    doc.setFontSize(20);
    doc.text(reportData.title, 105, 20, { align: 'center' });
    
    // Add date range
    doc.setFontSize(12);
    doc.text(`Date Range: ${reportData.dateRange}`, 105, 30, { align: 'center' });
    
    // Add summary section
    doc.setFontSize(16);
    doc.text('Summary', 20, 45);
    
    // Add summary data
    let y = 55;
    if (reportData.summary) {
        for (const [key, value] of Object.entries(reportData.summary)) {
            if (typeof value !== 'object') {
                const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                let formattedValue = value;
                
                // Format currency if it looks like an amount
                if (typeof value === 'number' && key.toLowerCase().includes('amount') || 
                    key.toLowerCase().includes('total') || 
                    key.toLowerCase().includes('sales') || 
                    key.toLowerCase().includes('expenses') || 
                    key.toLowerCase().includes('profit') || 
                    key.toLowerCase().includes('balance') || 
                    key.toLowerCase().includes('value')) {
                    formattedValue = `KES ${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
                
                // Format percentage
                if (typeof value === 'number' && key.toLowerCase().includes('margin') || 
                    key.toLowerCase().includes('percentage') || 
                    key.toLowerCase().includes('rate')) {
                    formattedValue = `${value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}%`;
                }
                
                doc.setFontSize(12);
                doc.text(`${formattedKey}: ${formattedValue}`, 20, y);
                y += 10;
            }
        }
    }
    
    // Add data table
    if (reportData.data && reportData.data.length > 0) {
        doc.setFontSize(16);
        doc.text('Details', 20, y + 10);
        
        y += 20;
        
        // Create table headers
        const headers = Object.keys(reportData.data[0]).map(key => {
            return key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
        });
        
        // Create table rows
        const rows = reportData.data.map(item => {
            return Object.values(item).map(value => {
                if (typeof value === 'number' && !Number.isInteger(value)) {
                    return value.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
                return value;
            });
        });
        
        // Add table
        doc.autoTable({
            startY: y,
            head: [headers],
            body: rows,
            theme: 'grid',
            styles: { fontSize: 10 },
            headStyles: { fillColor: [59, 130, 246] }
        });
    }
    
    // Add footer
    doc.setFontSize(10);
    doc.text(`Generated on: ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
    
    // Save PDF
    doc.save(`${filename}.pdf`);
}

function downloadExcelReport(reportData, filename) {
    // In a real implementation, you would use a library like SheetJS (xlsx)
    // For this demo, we'll simulate the download with a simple text file
    const content = `
${reportData.title}
Date Range: ${reportData.dateRange}

SUMMARY:
${Object.entries(reportData.summary || {})
        .filter(([key, value]) => typeof value !== 'object')
        .map(([key, value]) => {
            const formattedKey = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
            return `${formattedKey}: ${value}`;
        })
        .join('\n')
}

DETAILS:
${reportData.data ? 
    Object.keys(reportData.data[0]).join('\t') + '\n' + 
    reportData.data.map(row => Object.values(row).join('\t')).join('\n')
    : 'No data available'
}

Generated on: ${new Date().toLocaleString()}
    `;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${filename}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function downloadCSVReport(reportData, filename) {
    if (!reportData.data || reportData.data.length === 0) {
        alert('No data available to export');
        return;
    }
    
    // Create CSV header
    const headers = Object.keys(reportData.data[0]);
    
    // Create CSV content
    let csvContent = headers.join(',') + '\n';
    
    // Add data rows
    reportData.data.forEach(row => {
        const values = headers.map(header => {
            const value = row[header];
            
            // Handle commas and quotes in values
            if (typeof value === 'string' && (value.includes(',') || value.includes('"'))) {
                return `"${value.replace(/"/g, '""')}"`;
            }
            
            return value;
        });
        
        csvContent += values.join(',') + '\n';
    });
    
    // Create download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${filename}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

</script>
                    </body>